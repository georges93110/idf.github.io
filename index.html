<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Map</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --panel:#0b1118;--panel2:#0f1722;--border:#2b2f3a;--text:#e8eefb;--muted:#8892a6;--shadow:0 10px 30px rgba(0,0,0,.40);
      --logoW:110px; --logoH:44px;
      --busA:#3aa0ff; --busB:#8b5cf6; --busC:#22c55e; --busD:#f59e0b; --busE:#ef4444;
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    #map{position:fixed;inset:0}
    .leaflet-container,html,body,#map{background:#000}

    .city-label{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      color:#fff;font-weight:600;white-space:nowrap;text-align:center;
      text-shadow:0 2px 4px rgba(0,0,0,.8);
      pointer-events:auto; cursor:pointer;
    }
    .city-selected{color:#ffda3a !important;text-shadow:0 0 0 rgba(0,0,0,0),0 2px 6px rgba(0,0,0,.9)}

    .search-panel{position:fixed;top:12px;right:12px;z-index:1000;min-width:950px;max-width:min(92vw,920px)}
    .search-row{display:flex;gap:8px;align-items:center}
    .search-input{flex:1;min-width:300px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-size:15px;box-shadow:var(--shadow);outline:none}
    .search-input::placeholder{color:var(--muted)}
    .btn{padding:11px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    .btn:hover{background:#101926}
    .results{margin-top:6px;max-height:42vh;overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--panel);box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .result-item{display:flex;align-items:center;gap:12px;padding:10px 12px;cursor:pointer;border-bottom:1px solid #1f2732;color:var(--text);font-size:14px}
    .result-item:last-child{border-bottom:none}
    .result-item:hover{background:#101926}
    .result-item img.ico{width:var(--logoW);height:var(--logoH);flex:0 0 auto;border-radius:6px;object-fit:contain}
    .result-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;line-height:1.2}
    .result-empty{
      padding:10px 12px;
      color:var(--muted);
      font-size:14px;
      border-bottom:1px solid #1f2732;
    }
    .result-item img.ico {
      width: var(--logoW);
      height: var(--logoH);
    }

    .result-item img.ico.ico-service {
      width: calc(var(--logoW) / 2);
      height: calc(var(--logoH) / 2);
    }

    .result-sechead{
      padding:8px 10px;
      color:#a7b2c9;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      border-bottom:1px solid #1f2732;
      background:var(--panel2);
    }

    .dbus-panel{margin-top:6px;border:1px solid var(--border);border-radius:12px;background:var(--panel);box-shadow:var(--shadow);display:none;max-height:62vh;overflow:auto}
    .dbus-header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2732;color:var(--muted);font-size:13px}
    .dbus-list{padding:6px}
    .dbus-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #1f2732;border-radius:10px;background:var(--panel2);cursor:pointer;margin:6px}
    .dbus-item:hover{background:#101926}
    .dbus-item .badge{display:flex;align-items:center;justify-content:center;width:72px;height:32px;border-radius:8px;font-weight:800;font-size:16px}
    .dbus-item .rname{color:var(--text);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dbus-none{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed #223047;border-radius:10px;background:#0c1421;color:#9fb1cc;cursor:pointer;margin:6px}
    .dbus-item.active{ outline:2px solid #ffffff55; background:#101926; }
    .dbus-sec{margin:8px 6px 4px}
    .dbus-sec h4{
      margin:10px 6px 6px;
      color:#a7b2c9;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }

    .watermark{position:fixed;right:14px;bottom:14px;z-index:400;pointer-events:none;opacity:.125;filter:grayscale(10%);mix-blend-mode:screen}
    .watermark img{display:block;width:220px;max-width:32vw;height:auto}

    .inline-ico{
      height:1.5em;
      width:auto;
      vertical-align:-.35em;
      margin:0 .12em
    }
    .rer-invert { filter: invert(1); }
    .leaflet-popup-content{white-space:normal;overflow:visible}
    .dbus-stop-name{font-size:15px;line-height:1.35;word-break:break-word}

    @media (max-width:800px){
      .search-panel{min-width:300px;max-width:92vw}
      .search-input{min-width:180px}
      .watermark img{width:180px}
    }
    .selected-chip{margin-top:6px;display:none;width:100%}
    .line-chip{display:flex;align-items:center;padding:6px 6.5px;border:1px solid var(--border);border-radius:12px;background:color-mix(in oklab, var(--panel) 92%, #000 8%);box-shadow:var(--shadow);width:fit-content}
    .line-chip .close{margin-left:10px;border:none;background:transparent;color:#ef4444;font-weight:900;font-size:22px;cursor:pointer;line-height:1}
    .line-chip .close:hover{color:#ff6666}

    .line-preview-wrap{
      position:fixed;left:0;right:0;bottom:0;z-index:1100;
      pointer-events:none;
    }
    .line-preview{
      margin:10px auto 12px;
      max-width:min(1100px,94vw);
      background:color-mix(in oklab, var(--panel) 92%, #000 8%);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:10px 12px;
      pointer-events:auto;
    }
    .line-preview-header{
      display:flex;align-items:center;gap:10px;justify-content:space-between;
      margin-bottom:8px;
    }
    .line-preview-title{ display:flex;align-items:center;gap:10px;min-width:0; }
    .line-preview .badge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:56px;height:28px;border-radius:8px;font-weight:800;font-size:15px;
      background:#444;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.35);
    }
    .line-preview-route{
      color:var(--text);font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .line-preview-close{
      border:none;background:transparent;color:#ef4444;font-weight:900;
      font-size:22px;cursor:pointer;line-height:1;padding:2px 6px;border-radius:8px;
    }
    .line-preview-close:hover{ color:#ff6666; background:#0f1722; }

    .transit-scroll{ overflow-x:auto;overflow-y:hidden;white-space:nowrap; padding-bottom:4px; }
    .transit{
      --lineColor:#3aa0ff;
      --rail-h:26px;
      --dot:16px;
      --ringW:12px;
      --gap:18px;
      --nameH:18px;
      display:flex;align-items:flex-start;gap:0;
      min-height:calc(var(--rail-h) + var(--nameH) + 14px);
      padding:2px 2px 6px;
    }

    .stop{
      position:relative;
      display:flex; flex-direction:column; align-items:center;
      flex:0 0 auto;
      box-sizing:border-box;
      padding-top:calc(var(--rail-h) - var(--dot)/2);
      margin:0 calc(var(--gap)/2);
    }

    .segment{
      height:4px;
      flex:1 0 60px;
      min-width:120px;
      background:var(--lineColor);
      margin-top:calc(var(--rail-h)/2 - 2px);
      border-radius:2px;
    }

    .stop .dot{
      position:absolute; left:50%;
      top:calc(var(--rail-h)/2 - var(--dot)/2);
      transform:translateX(-50%);
      width:var(--dot); height:var(--dot); border-radius:50%;
      background:var(--lineColor);
      border:none; box-shadow:0 1px 2px rgba(0,0,0,.5);
    }

    .stop .name{
      color:var(--text); font-size:12px; line-height:1.25; text-align:center;
      margin-top:8px;
      font-weight:700;
      height:var(--nameH);
      white-space:nowrap;
      overflow:visible;
      text-overflow:clip;
    }

    .stop .name .inline-ico{ height:1em; vertical-align:-.2em; }
    .stop.active .name{ color:#ffda3a; }

    @media (max-width:800px){
      .stop{min-width:64px}
      .segment{min-width:36px}
    }

    .rer-ico{
      display:inline-block;
      width:1.1em; height:1.1em;
      vertical-align:-.2em;
      background-color: currentColor;
      -webkit-mask: url("./Overlays/o_rer.png") no-repeat center / contain;
              mask: url("./Overlays/o_rer.png") no-repeat center / contain;
    }

    .results::-webkit-scrollbar,
    .dbus-panel::-webkit-scrollbar,
    .transit-scroll::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    .results::-webkit-scrollbar-track,
    .dbus-panel::-webkit-scrollbar-track,
    .transit-scroll::-webkit-scrollbar-track {
      background: var(--panel2);
      border-radius: 8px;
    }
    .results::-webkit-scrollbar-thumb,
    .dbus-panel::-webkit-scrollbar-thumb,
    .transit-scroll::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 8px;
      border: 2px solid var(--panel2);
    }
    .results::-webkit-scrollbar-thumb:hover,
    .dbus-panel::-webkit-scrollbar-thumb:hover,
    .transit-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text);
    }
    .results,
    .dbus-panel,
    .transit-scroll {
      scrollbar-width: thin;
      scrollbar-color: var(--muted) var(--panel2);
    }

    .result-sechead{
      display:flex;align-items:center;justify-content:space-between;
      cursor:pointer; user-select:none;
    }
    .result-sechead .chev{
      font-size:14px; opacity:.9; transition:transform .18s ease;
    }
    .result-sechead[aria-expanded="false"] .chev{
      transform:rotate(-90deg);
    }
    .result-secbody[hidden]{ display:none !important; }
    
    .results-filters{
      position: sticky; top: 0; z-index: 2;
      display:flex; flex-wrap:wrap; align-items:center; gap:6px;
      padding:8px 10px; border-bottom:1px solid #1f2732;
      background:var(--panel2); backdrop-filter:blur(6px);
    }
    .rf-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      background:var(--panel); color:var(--text); font-size:12px; cursor:pointer; user-select:none;
    }
    .rf-chip input{ appearance:none; width:16px; height:16px; border:2px solid #5b6b85; border-radius:4px; display:inline-block; }
    .rf-chip input:checked{ background:#3aa0ff; border-color:#3aa0ff; }
    .rf-chip .dot{ width:10px; height:10px; border-radius:50%; opacity:.95; }
    .rf-chip[data-type="Ville"]              .dot{ background:#9ca3af; }
    .rf-chip[data-type="Monument"]           .dot{ background:#f59e0b; }
    .rf-chip[data-type="Atelier"]            .dot{ background:#22c55e; }
    .rf-chip[data-type="Agence"]             .dot{ background:#8b5cf6; }
    .rf-chip[data-type="Concessionnaire"]    .dot{ background:#3aa0ff; }
    .rf-chip[data-type="Entreprise"]         .dot{ background:#ef4444; }
    .rf-chip[data-type="Centre commercial"]  .dot{ background:#10b981; }

    .rf-actions{ margin-left:auto; display:flex; gap:6px; }
    .rf-btn{ padding:6px 10px; font-size:12px; border-radius:10px; border:1px solid var(--border);
      background:color-mix(in oklab, var(--panel) 92%, #000 8%); color:var(--text); cursor:pointer; }
    .rf-btn:hover{ background:#101926; }

    .rf-chip .dot{ display:none !important; }

    .result-sechead{
      display:block;
      cursor:default;
      user-select:text;
    }
    .result-sechead .chev{ display:none !important; }

  </style>
  
</head>
<body>
  <div id="map"></div>

  <div class="search-panel">
    <div class="search-row">
      <input id="search" class="search-input" type="search" placeholder="Rechercher..." autocomplete="off"/>
      <button id="btnDbus" class="btn" type="button">Lignes DBus</button>
    </div>
    
    <div id="selectedChip" class="selected-chip"></div>
    <div id="results" class="results" hidden>
      
    </div>

    <div id="dbusPanel" class="dbus-panel">
      <div class="dbus-header"></div>
      <div id="dbusList" class="dbus-list"></div>
    </div>
  </div>

  <div id="linePreviewWrap" class="line-preview-wrap" style="display:none">
    <div class="line-preview" id="linePreview">
      <div class="line-preview-header">
        <div class="line-preview-title">
          <div class="badge" id="lpBadge">?</div>
          <div class="line-preview-route" id="lpRouteTitle">—</div>
        </div>
        <button type="button" class="line-preview-close" id="lpClose" aria-label="Fermer">×</button>
      </div>
      <div class="transit-scroll">
        <div class="transit" id="lpTransit"></div>
      </div>
    </div>
  </div>

  <div class="watermark">
    <img src="./Overlays/idf_logo.png" alt="IDF logo watermark">
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const minNativeZoom=0,maxNativeZoom=8,tileSize=256,TILE_BASE="./Tiles";
    const widthPx=tileSize*Math.pow(2,maxNativeZoom),heightPx=tileSize*Math.pow(2,maxNativeZoom);

    const map=L.map('map',{crs:L.CRS.Simple,attributionControl:false,minZoom:minNativeZoom+3,maxZoom:maxNativeZoom+2,maxBoundsViscosity:1.0,inertia:true});
    const fullBounds=L.latLngBounds(map.unproject(L.point(0,heightPx),maxNativeZoom),map.unproject(L.point(widthPx,0),maxNativeZoom));
    const MARGIN=64;
    function innerBounds(m){const sw=L.point(0+m,heightPx-m),ne=L.point(widthPx-m,0+m);return L.latLngBounds(map.unproject(sw,maxNativeZoom),map.unproject(ne,maxNativeZoom));}

    L.tileLayer(`${TILE_BASE}/{z}/{x}/{y}.png`,{tileSize,minNativeZoom,maxNativeZoom,maxZoom:maxNativeZoom+2,noWrap:true,bounds:fullBounds,crossOrigin:true,referrerPolicy:"no-referrer"}).addTo(map);
    function applyBounds(){const ib=innerBounds(MARGIN);map.setMaxBounds(ib);map.panInsideBounds(ib,{animate:false});}
    map.fitBounds(innerBounds(MARGIN),{animate:false});applyBounds();map.on('zoomend resize',applyBounds);

    let TileMapInfo;
    const tileInfoReady = fetch('./TileMapInfo.json').then(r=>{ if(!r.ok) throw new Error('TileMapInfo'); return r.json(); }).then(info => (TileMapInfo = info));
    const QS = new URLSearchParams(location.search);
    const OX = parseFloat(QS.get('ox') ?? '0');
    const OY = parseFloat(QS.get('oy') ?? '0');
    const SX = parseFloat(QS.get('sx') ?? '1');
    const SY = parseFloat(QS.get('sy') ?? '1');
    
    const $search = document.getElementById("search");
    const $results = document.getElementById("results");

    const BRAND_DISPLAY = {
      renault: 'Renault Trucks',
      daf: 'DAF',
      mercedes: 'Mercedes-Benz',
      volvo : 'Volvo Trucks'
    };
    function brandLabel(key){
      const k = String(key||'').trim().toLowerCase();
      if (!k) return '';
      if (BRAND_DISPLAY[k]) return BRAND_DISPLAY[k];
      return k.charAt(0).toUpperCase() + k.slice(1);
    }
    function brandsText(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      return arr.map(brandLabel).join(', ');
    }

    let _resIdx = -1;
    function highlightResult(i){
      const items=[...$results.querySelectorAll('.result-item')];
      items.forEach((el,idx)=> el.style.background = idx===i ? "#101926" : "");
    }
    $search.addEventListener('keydown', e=>{
      const items=[...$results.querySelectorAll('.result-item')];
      if(!items.length) return;
      if(e.key==="ArrowDown"){ e.preventDefault(); _resIdx=Math.min(_resIdx+1, items.length-1); highlightResult(_resIdx); }
      if(e.key==="ArrowUp"){ e.preventDefault(); _resIdx=Math.max(_resIdx-1, 0); highlightResult(_resIdx); }
      if(e.key==="Enter" && _resIdx>=0){ items[_resIdx].click(); }
    });

    function dealerBrandKeyFrom(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      const raw = String(arr[0] || "").toLowerCase().trim();
      if (!raw) return "";

      const MAP = {
        "renault trucks": "renault",
        "DAF": "daf",
        "mercedes-benz": "mercedes",
        "volvo trucks": "volvo",
      };
      const canonical = MAP[raw] || raw;

      return canonical
        .replace(/trucks?|camions?/g, "")
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    function addSectionBlock(typeKey, label){
      const head = document.createElement("div");
      head.className = "result-sechead";
      head.textContent = label;
      $results.appendChild(head);

      const body = document.createElement("div");
      body.className = "result-secbody";
      $results.appendChild(body);

      return body;
    }

    window.addEventListener('keydown', e=>{
      if(document.getElementById("linePreviewWrap")?.style.display!=="block") return;
      if(!currentSelectedKey) return;
      const route = (()=> {
        const [lu,ru]=currentSelectedKey.split(":");
        const line=DBUS_LINES.find(l=>l.uid===lu); if(!line) return null;
        return line.routes.find(r=>r.uid===ru);
      })();
      if(!route) return;

      const ids=route.stopIds;
      const idx = ids.indexOf(currentActiveStopId);
      if(e.key==="ArrowRight" && idx>=0 && idx<ids.length-1){
        const nextId = ids[idx+1];
        const st=DBUS_STOPS.get(nextId);
        if(st?.latlng) centerWithPreview(st.latlng);
        setTimeout(()=> dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx+1]?.openPopup?.(), 120);
        setActiveStopById(nextId);
      }
      if(e.key==="ArrowLeft" && idx>0){
        const prevId = ids[idx-1];
        const st=DBUS_STOPS.get(prevId);
        if(st?.latlng) centerWithPreview(st.latlng);
        setTimeout(()=> dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx-1]?.openPopup?.(), 120);
        setActiveStopById(prevId);
      }
    });


    function applyXY(x, y){ return { x: x * SX + OX, y: y * SY + OY }; }
    function toLatLng(X,Y){
      const px=(X-TileMapInfo.x1)/(TileMapInfo.x2-TileMapInfo.x1)*widthPx;
      const py=(Y-TileMapInfo.y1)/(TileMapInfo.y2-TileMapInfo.y1)*heightPx;
      return map.unproject([px,py],maxNativeZoom);
    }

    const transitScroll = document.querySelector(".transit-scroll");
    if (transitScroll) {
      transitScroll.addEventListener("wheel", function (e) {
        if (e.shiftKey) return;
        e.preventDefault();
        transitScroll.scrollLeft += e.deltaY;
      }, { passive: false });
    }

    const cityLayer=L.layerGroup().addTo(map);
    const cityMarkers=[],searchIndex=[];
    let selectedCityMarker = null;

    const $btnDbus = document.getElementById("btnDbus");
    const $panelDbus = document.getElementById("dbusPanel");
    const $dbusList = document.getElementById("dbusList");
    const $selectedChip = document.getElementById("selectedChip");

    function wikiTitleForCity(name){
      const m = /^Paris\s+(\d{1,2})(?:er|e|eme|ème)?$/i.exec(name.trim());
      if (m){ const n = parseInt(m[1], 10); const suffix = (n === 1) ? "er" : "e"; return `${n}${suffix}_arrondissement_de_Paris`; }
      return name.replaceAll(" ", "_");
    }
    function normalizeParisArrondissement(urlOrTitle){
      const m = /Paris[_\s]+(\d{1,2})(?:er|e|eme|ème)?[_\s]+Arrondissement/i.exec(urlOrTitle);
      if(m){ const n = parseInt(m[1],10); const suffix = (n === 1) ? "er" : "e"; return `${n}${suffix}_arrondissement_de_Paris`; }
      return urlOrTitle;
    }
    async function fetchWikiSummary(title){
      const url = "https://fr.wikipedia.org/api/rest_v1/page/summary/" + encodeURIComponent(title);
      const r = await fetch(url); if (!r.ok) throw new Error("wiki fetch"); return r.json();
    }

    function escapeHTML(s){
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function trimAroundRER(s, mode ){
      const txt = String(s || "").trim();
      if (!/\bRER\b/i.test(txt)) return txt;
      if (mode === 'start'){
        const m = txt.match(/^(.*?)\s*[–—-]\s*RER\b/i);
        return (m && m[1]) ? m[1].trim() : txt;
      } else {
        const m = txt.match(/\bRER\b\s*[–—-]\s*(.+)$/i);
        return (m && m[1]) ? m[1].trim() : txt;
      }
    }

    function decodeHTML(s){
      const t = document.createElement('textarea');
      t.innerHTML = String(s ?? "");
      return t.value;
    }

    function withRERIcon(text, {caseInsensitive=false} = {}){
      const esc = escapeHTML(text ?? "");
      const flags = caseInsensitive ? "gi" : "g";
      return esc
        .replace(new RegExp("(?:\\s*[-–—]\\s*)?\\bRER\\b(?:\\s*[-–—]\\s*)?", flags),
                ' <span class="rer-ico" aria-label="RER"></span> ')
        .replace(/\s{2,}/g, " ")
        .trim();
    }

    async function openCityPopup(cityObj, marker) {
      const latlng = marker.getLatLng();
      let rawTitle = normalizeParisArrondissement(wikiTitleForCity(cityObj.Name));
      const p = L.popup({ maxWidth: 380, autoPan: true })
        .setLatLng(latlng)
        .setContent(`<b>${cityObj.Name}</b><br><i>Chargement...</i>`).openOn(map);
      try {
        const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
          try {
            const d0 = await fetchWikiSummary(baseTitle);
            if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
          } catch {}
          for (const suf of [
            "_(Commune_française)","_(Val-de-Marne)","_(Essonne)",
            "_(Hauts-de-Seine)","_(Seine-Saint-Denis)","_(Val-d'Oise)",
            "_(Seine-et-Marne)","_(Yvelines)"
          ]) {
            try {
              const d = await fetchWikiSummary(baseTitle + suf);
              if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
            } catch {}
          }
          return { title: baseTitle, data: null };
        })(rawTitle);

        const pageUrl = "https://fr.wikipedia.org/wiki/" + finalTitle;
        const desc = data?.description || "";
        const img = data?.thumbnail?.source || "";
        const html = data ? `
          <div style="display:flex;gap:10px;align-items:flex-start">
            ${img ? `<img src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
            <div style="min-width:0">
              <div style="font-weight:700;margin-bottom:4px">${cityObj.Name}</div>
              <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${desc}</div>
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">Voir sur Wikipédia</a>
            </div>
          </div>` :
          `<div style="min-width:0">
            <div style="font-weight:700;margin-bottom:6px">${cityObj.Name}</div>
            <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">Voir sur Wikipédia</a>
          </div>`;
        p.setContent(html);
      } catch {}
    }

    tileInfoReady.then(()=> fetch("Cities.json")).then(r=>r.json()).then(cities=>{
      cities.forEach(city=>{
        const icon=L.divIcon({className:"",html:`<span class="city-label">${city.Name}</span>`,iconSize:[0,0]});
        const m=L.marker(toLatLng(city.X,city.Y),{icon,interactive:true,bubblingMouseEvents:true}).addTo(cityLayer);
        m.on("click", ()=> openCityPopup(city, m));
        cityMarkers.push(m);
        searchIndex.push({type:"Ville",name:city.Name||"Ville",city:"",center:m.getLatLng(),open:()=>openCityPopup(city, m)});
      });
      updateCityLabels();
    }).catch(err=>console.error("Erreur chargement Cities.json",err));

    function updateCityLabels(){
      const zMin=map.getMinZoom(),zMax=map.getMaxZoom(),z=map.getZoom(),SMALL=8,LARGE=20,t=(z-zMin)/Math.max(1,(zMax-zMin)),px=Math.round(SMALL+t*(LARGE-SMALL));
      cityMarkers.forEach(m=>{const el=m.getElement();if(!el)return;const span=el.querySelector(".city-label");if(!span)return;span.style.fontSize=px+"px";span.style.opacity=(t<0.05)?0.8:1;});
    }
    map.on("zoomend",updateCityLabels);

    const DEDUPE_MIN_PX_BASE = 100;
    const _placedByIcon = new Map();
    function _isTooClose(iconId, latlng, minPx){
      const pt = map.project(latlng, maxNativeZoom);
      const list = _placedByIcon.get(iconId) || [];
      for(const p of list){ const dx = pt.x - p.x, dy = pt.y - p.y; if (Math.hypot(dx, dy) < minPx) return true; }
      list.push({x: pt.x, y: pt.y}); _placedByIcon.set(iconId, list); return false;
    }

    function bindPopupWithImage(layer, html){
      layer.bindPopup(html);
      layer.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => {
            try { e.popup.update(); } catch {}
          }, { once: true });
        }
      });
    }

    const homeBtn = L.control({ position: 'topleft' });

    homeBtn.onAdd = function(map) {
      const container = L.DomUtil.create('div', 'leaflet-bar leaflet-custom-home');
      const link = L.DomUtil.create('a', 'home-btn', container);
      link.innerHTML = '⟲'; 
      link.href = '#';
      link.title = 'Revenir à la vue initiale';

      L.DomEvent.on(link, 'click', (e) => {
        L.DomEvent.stop(e);
        map.fitBounds(innerBounds(MARGIN), { animate: true });
        history.replaceState(null, "", location.pathname);
      });

      return container;
    };

    homeBtn.addTo(map);

    const ICON_NAMES = {
      "gas_ico": "Station service",
      "bus_ico": "Gare routière",
      "service_ico": "Atelier de réparation",
      "garage_large_ico": "Garage",
      "recruitment_ico": "Agence de recrutement",
      "dealer_ico": "Concessionnaire",
      "border_ico": "Contrôle d'identité",
      "toll_ico": "Péage",
      "parking_ico": "Parking"
    };

    tileInfoReady
      .then(() => fetch("CentreCommerciaux.json"))
      .then(r => r.ok ? r.json() : Promise.reject("CentreCommerciaux.json"))
      .then(malls => {
        malls.forEach(ov => {
          const width = 32, height = 32;

          const centerLL = toLatLng(ov.X, ov.Y);
          const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
          const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
          const bounds = L.latLngBounds(topLeft, bottomRight);

          const key = "overlay_centrecom";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;

          const overlay = L.imageOverlay(`./Overlays/overlay_centrecom.png`, bounds, { interactive: true }).addTo(map);
          const popup = L.popup({ maxWidth: 420, autoPan: true });
          overlay.bindPopup(popup);

          overlay.on('popupopen', (e) => {
            const el = e.popup.getElement();
            const img = el && el.querySelector('img[data-autosize]');
            if (img && !img.complete) {
              img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
            }
          });

          const name = "Centre Commercial " + String(ov.Name || "").trim();
          const city = String(ov.City || "").trim();
          const wikiKey = String(ov.wiki || "").trim();

          overlay.on("click", async () => {
            const p = overlay.getPopup();
            p.setLatLng(bounds.getCenter());

            if (!wikiKey) {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
              overlay.openPopup();
              return;
            }

            p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b><br><i>Chargement…</i></div>`);
            overlay.openPopup();

            try {
              const baseTitle = wikiTitleFrom(wikiKey);
              const { title: finalTitle, data } = await (async function resolveWikiSummary(title){
                try {
                  const d0 = await fetchWikiSummary(title);
                  if (d0?.type !== "disambiguation") return { title, data: d0 };
                } catch {}
                for (const suf of [
                  "_(Paris)", "_(Île-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
                  "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
                  "_(Centre_commercial)", "_(Centre_commercial_en_France)"
                ]) {
                  try {
                    const d = await fetchWikiSummary(title + suf);
                    if (d?.type !== "disambiguation") return { title: title + suf, data: d };
                  } catch {}
                }
                return { title, data: null };
              })(baseTitle);

              const pageUrl = "https://fr.wikipedia.org/wiki/" + finalTitle;
              const desc = data?.description || "";
              const img = data?.thumbnail?.source || "";

              const html = data ? `
                <div style="display:flex;gap:10px;align-items:flex-start">
                  ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
                  <div style="min-width:0">
                    <div style="font-weight:700;margin-bottom:4px">${escapeHTML(name)}</div>
                    ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                    <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                    <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">Voir sur Wikipédia</a>
                  </div>
                </div>` :
                `<div style="min-width:0">
                  <div style="font-weight:700;margin-bottom:6px">${escapeHTML(name)}</div>
                  ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
                </div>`;

              p.setContent(html);
            } catch {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
            }
          });

          searchIndex.push({
            type: "Centre commercial",
            name,
            city,
            center: bounds.getCenter(),
            open: () => { overlay.fire('click'); },
            logo: `./Overlays/overlay_centrecom.png`,
            fallbackLogo: `./Overlays/overlay_centrecom.png`
          });
        });
      })
      .catch(err => console.error("CentreCommerciaux.json error:", err));

    tileInfoReady.then(()=> fetch("Overlays.json")).then(r=>r.json()).then(overlays=>{
      overlays.forEach(ov=>{
        let width=ov.Width, height=ov.Height;
        if(ov.IconId==="bus_ico"){ width=32; height=32; }
        const centerLL = toLatLng(ov.X, ov.Y);

        if(!ov.IconId) return;
        if(
          ov.IconId.startsWith("bus_") && ov.IconId !== "bus_ico" ||
          ov.IconId.startsWith("uk_")  ||
          ov.IconId.startsWith("fr_")  ||
          ov.IconId.startsWith("b_")   ||
          ov.IconId.startsWith("bg_")  ||
          ov.IconId.startsWith("train_ico")  ||
          ov.IconId.startsWith("port_overlay")  ||
          ov.IconId.startsWith("d334p")  ||
          ov.IconId.startsWith("viewpoint")
        ){ return; }

        const isCompany = (ov.Type === "Company");

        if (!isCompany) {
          const key = ov.IconId || ov.Type || "__misc";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width||0, height||0) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;
        }

        const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
        const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
        const bounds = L.latLngBounds(topLeft, bottomRight);

       if (ov.Type==="Company"){
        const compTopLeft=toLatLng(ov.X,ov.Y), compBottomRight=toLatLng(ov.X+20,ov.Y-20);
        const compBounds=L.latLngBounds(compTopLeft,compBottomRight);
        const overlay=L.imageOverlay(`./Overlays/button.png`,compBounds,{interactive:true}).addTo(map);

        const logoPath = `./Overlays/${ov.IconId}.png`;

        bindPopupWithImage(overlay, `
          <div style="text-align:center">
            <img data-autosize src="${logoPath}"
                style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
            <b>${escapeHTML(ov.Name)}</b><br/><i>${escapeHTML(ov.City||"")}</i>
          </div>
        `);

        searchIndex.push({
          type:"Entreprise",
          name:ov.Name||"Entreprise",
          city:ov.City||"",
          center:compBounds.getCenter(),
          open:()=>{ overlay.openPopup(compBounds.getCenter()); },
          logo:logoPath
        });
      } else if (ov.Type === "TruckDealer" || ov.IconId === "dealer_ico") {
            const overlay = L.imageOverlay(`./Overlays/${ov.IconId}.png`, bounds, { interactive: true }).addTo(map);
            const btxt = brandsText(ov) || '—';
            const titleLine = `Concessionnaire ${escapeHTML(btxt)}`;

            const brandKey = dealerBrandKeyFrom(ov);
            const brandLogo = brandKey ? `./Overlays/dealer_${brandKey}.png` : `./Overlays/dealer_ico.png`;

              bindPopupWithImage(overlay, `
                <div style="text-align:center">
                  <img data-autosize src="${brandLogo}"
                      style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
                  <b>Concessionnaire ${escapeHTML(btxt || "—")}</b><br/><i>${escapeHTML(ov.City || "")}</i>
                </div>
              `);

            overlay.on("click", () => {
              overlay.openPopup(bounds.getCenter());
            });

            searchIndex.push({
              type: "Concessionnaire",
              name: `${btxt}`.trim(),         
              brand: btxt,                   
              city: ov.City || "",
              center: bounds.getCenter(),
              open: () => { overlay.openPopup(bounds.getCenter()); },
              logo: brandLogo,
              fallbackLogo: `./Overlays/dealer_ico.png`
            });
          
        } else {
           const label = ICON_NAMES[ov.IconId] || ov.Name || ov.Type || "Lieu";
          const overlay = L.imageOverlay(`./Overlays/${ov.IconId}.png`, bounds, { interactive: true })
            .addTo(map)
            .bindPopup(`<b>${escapeHTML(label)}</b>`);

          const typeTag =
            ov.IconId === "service_ico"       ? "Atelier" :
            ov.IconId === "recruitment_ico"   ? "Agence"  :
            ov.IconId === "garage_large_ico"  ? "Garage"  :
            null;

          if (typeTag) {
            const logoPath =
              ov.IconId === "service_ico"      ? `./Overlays/service_ico.png` :
              ov.IconId === "recruitment_ico"  ? `./Overlays/recruitment_ico.png` :
              ov.IconId === "garage_large_ico" ? `./Overlays/garage_large_ico.png` :
              `./Overlays/${ov.IconId}.png`;

            const keywordName =
              typeTag === "Atelier" ? `Atelier de réparation ${ov.City || ""}` :
              typeTag === "Agence"  ? `Agence de recrutement ${ov.City || ""}` :
                          `Garage ${ov.City || ""}`;

            searchIndex.push({
              type: typeTag,               
              name: keywordName.trim(),    
              city: ov.City || "",
              center: bounds.getCenter(),
              open: () => { overlay.openPopup(bounds.getCenter()); },
              logo: logoPath,
              fallbackLogo: logoPath
            });
          }
        }
      });
    });

    function wikiTitleFrom(urlOrTitle){
      const s = String(urlOrTitle||"").trim();
      if (!s) return "";
      try{
        const u = new URL(s);
        const m = /\/wiki\/(.+)$/.exec(u.pathname);
        return m ? decodeURIComponent(m[1]) : s.replaceAll(" ", "_");
      }catch{
        return s.replaceAll(" ", "_");
      }
    }


  tileInfoReady
  .then(() => fetch("Monuments.json"))
  .then(r => r.ok ? r.json() : Promise.reject("Monuments.json"))
  .then(monuments => {
    monuments.forEach(ov => {
      const width = 32, height = 32;

      const centerLL = toLatLng(ov.X, ov.Y);
      const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
      const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
      const bounds = L.latLngBounds(topLeft, bottomRight);

      const key = "overlay_monument";
      const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
      if (_isTooClose(key, centerLL, minPx)) return;

      const overlay = L.imageOverlay(`./Overlays/overlay_monument.png`, bounds, { interactive: true }).addTo(map);
      const popup = L.popup({ maxWidth: 420, autoPan: true });
      overlay.bindPopup(popup);

      overlay.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
        }
      });

      const name = String(ov.Name || "").trim();
      const city = String(ov.City || "").trim();
      const wikiTitle = wikiTitleFrom(ov.wiki || ov.IconId || name);

      overlay.on("click", async () => {
        const p = overlay.getPopup();
        p.setLatLng(bounds.getCenter());
        p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b><br><i>Chargement…</i></div>`);
        overlay.openPopup();

        try {
          const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
            try {
              const d0 = await fetchWikiSummary(baseTitle);
              if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
            } catch {}
            for (const suf of [
              "_(Paris)", "_(Île-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
              "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
              "_(Monument)"
            ]) {
              try {
                const d = await fetchWikiSummary(baseTitle + suf);
                if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
              } catch {}
            }
            return { title: baseTitle, data: null };
          })(wikiTitle);

          const pageUrl = "https://fr.wikipedia.org/wiki/" + finalTitle;
          const desc = data?.description || "";
          const img = data?.thumbnail?.source || "";

          const html = data ? `
            <div style="display:flex;gap:10px;align-items:flex-start">
              ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
              <div style="min-width:0">
                <div style="font-weight:700;margin-bottom:4px">${escapeHTML(name)}</div>
                ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">Voir sur Wikipédia</a>
              </div>
            </div>` :
            `<div style="min-width:0">
              <div style="font-weight:700;margin-bottom:6px">${escapeHTML(name)}</div>
              ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">Voir sur Wikipédia</a>
            </div>`;

          p.setContent(html);
        } catch {
          p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
        }
      });

      searchIndex.push({
        type: "Monument",
        name,
        city,
        center: bounds.getCenter(),
        open: () => { 
          const p = overlay.getPopup();
          if (p) { p.setLatLng(bounds.getCenter()); }
          overlay.fire('click');
        },
        logo: `./Overlays/overlay_monument.png`,
        fallbackLogo: `./Overlays/overlay_monument.png`
      });
    });
  })
  .catch(err => console.error("Monuments.json error:", err));


      
    function applyInitialView() {
      const qs = new URLSearchParams(location.search);
      const x = parseFloat(qs.get("x"));
      const y = parseFloat(qs.get("y"));
      const z = parseFloat(qs.get("z"));

      if (Number.isFinite(x) && Number.isFinite(y)) {
        const ll = toLatLng(x, y);

        const ib = innerBounds(MARGIN);
        const clamped = L.latLng(
          Math.max(Math.min(ll.lat, ib.getNorth()), ib.getSouth()),
          Math.max(Math.min(ll.lng, ib.getEast()),  ib.getWest())
        );

        const targetZoom = Number.isFinite(z)
          ? Math.max(map.getMinZoom(), Math.min(map.getMaxZoom(), z))
          : map.getZoom();

        map.setView(clamped, targetZoom, { animate: false });
      }
    }

    tileInfoReady.then(() => {
      applyInitialView();
    });

    const routeAnimHandles = new Map();
    function animatePolyline(poly, { speed = 1.2, dash = "14 10", reverse = false } = {}) {
      const apply = (path) => {
        path.style.strokeDasharray = dash;
        let offset = 0, raf = 0;
        const tick = () => { offset = (offset + speed) % 10000; path.style.strokeDashoffset = reverse ? String(-offset) : String(offset); raf = requestAnimationFrame(tick); };
        tick();
        return () => { cancelAnimationFrame(raf); path.style.strokeDasharray = ""; path.style.strokeDashoffset = ""; };
      };
      let stopFn = null;
      if (poly._path) { stopFn = apply(poly._path); }
      else { poly.once("add", () => { if (poly._path) stopFn = apply(poly._path); }); }
      return { stop: () => { try { stopFn && stopFn(); } catch {} } };
    }
    function startLineAnim(key, poly) { stopLineAnim(key); const h = animatePolyline(poly, { speed: 0.1, dash: "30 10", reverse: true }); routeAnimHandles.set(key, h); }
    function stopLineAnim(key) { const h = routeAnimHandles.get(key); if (h) { h.stop(); routeAnimHandles.delete(key); } }

    const dbusRoot = "DBus/IDF MAP";
    const dbusLayers = L.layerGroup().addTo(map);
    const dbusRouteLayers = new Map();
    let currentSelectedKey = "";

    async function fetchXml(path){
      const res = await fetch(path);
      if(!res.ok) throw new Error("XML load failed: "+path);
      const txt = await res.text();
      const parser = new DOMParser();
      return parser.parseFromString(txt, "text/xml");
    }

    let DBUS_STOPS = new Map();
    async function loadStops(){
      await tileInfoReady;
      const xml = await fetchXml(`${dbusRoot}/stops.xml`);
      const nodes = [...xml.querySelectorAll("busstops > busstop")];
      DBUS_STOPS = new Map(nodes.map(node=>{
        const id = parseInt(node.querySelector("id")?.textContent.trim()||"0",10);
        const name = (node.querySelector("name")?.textContent||"").trim();
        const locRaw = (node.querySelector("location")?.textContent||"").trim();
        const parts = locRaw.split(";").map(x=>parseFloat(x));
        const X = parts[0], Z = parts[2];
        const latlng = toLatLng(X, Z);
        return [id, {id, name, X, Y: Z, latlng}];
      }));
    }

    let DBUS_LINES = [];
    async function loadLines(){
      const xml = await fetchXml(`${dbusRoot}/lines.xml`);
      DBUS_LINES = [...xml.querySelectorAll("lines > line")].map(line=>{
        const lineUid = line.getAttribute("uid");
        const number  = line.getAttribute("number") || "?";
        const routes = [...line.querySelectorAll(":scope > route")].map(rt=>{
          const rUid  = rt.getAttribute("uid");
          const rName = rt.getAttribute("name") || "";
          const stops = [...rt.querySelectorAll(":scope > busstop")]
                          .map(b => parseInt(b.getAttribute("uid"), 10));
          return { uid: rUid, name: rName, stopIds: stops };
        });
        return { uid: lineUid, number, routes };
      });
    }

    const BUS_COLORS = [getComputedStyle(document.documentElement).getPropertyValue('--busA').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busB').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busC').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busD').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busE').trim()];
    function colorFor(index){ return BUS_COLORS[index % BUS_COLORS.length] || "#3aa0ff"; }

    async function getTwoDominantColors(src){
      return new Promise(resolve => {
        const img = new Image(); img.crossOrigin = "anonymous"; img.src = src;
        img.onload = () => {
          const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d");
          canvas.width  = img.naturalWidth; canvas.height = img.naturalHeight;
          ctx.drawImage(img, 0, 0);
          const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
          const counts = {}; let whiteCount = 0; let blackCount = 0;
          const STEP = 16, WHITE_LUM = 0.92, BLACK_LUM = 0.08;
          for (let i = 0; i < data.length; i += 4*STEP) {
            const a = data[i+3]; if (a < 128) continue;
            const r = data[i], g = data[i+1], b = data[i+2];
            const lum = (0.299*r + 0.587*g + 0.114*b) / 255;
            if (lum > WHITE_LUM) { whiteCount++; continue; }
            if (lum < BLACK_LUM) { blackCount++; continue; }
            const rq = r >> 4, gq = g >> 4, bq = b >> 4;
            const key = `${rq},${gq},${bq}`; counts[key] = (counts[key] || 0) + 1;
          }
          const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
          let bg = "#444"; if (entries.length) { const [rq,gq,bq] = entries[0][0].split(",").map(v => (parseInt(v,10) << 4) + 8); bg = `rgb(${rq},${gq},${bq})`; }
          const text = (whiteCount >= blackCount) ? "#fff" : "#000";
          resolve([bg, text]);
        };
        img.onerror = () => resolve(["#444","#fff"]);
      });
    }
    const LINE_COLOR_CACHE = new Map();
    function getLineColors(number){
      const n = String(number||"").trim();
      if(LINE_COLOR_CACHE.has(n)) return LINE_COLOR_CACHE.get(n);
      const p = getTwoDominantColors(`./Overlays/bus_${n}.png`).catch(()=>["#444","#fff"]);
      LINE_COLOR_CACHE.set(n, p);
      return p;
    }
    function makeLineBadge(number, bg="#444", text="#fff", size="72x32"){
      const [w,h] = size.split("x").map(v=>parseInt(v,10));
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.style.width = w+"px"; badge.style.height = h+"px";
      badge.style.borderRadius = "8px"; badge.style.display = "flex";
      badge.style.alignItems = "center"; badge.style.justifyContent = "center";
      badge.style.fontWeight = "800"; badge.style.fontSize = (h>=32? "16px":"14px");
      badge.style.background = bg; badge.style.color = text; badge.style.textShadow = "0 1px 2px rgba(0,0,0,.35)";
      badge.textContent = String(number||"").trim();
      return badge;
    }

    function trimByDash(s, mode){
      const txt = String(s || "").trim();
      const parts = txt.split(/\s*[–—-]\s*/).filter(Boolean);
      if (parts.length < 2) return txt;
      return (mode === 'start') ? parts[0].trim() : parts[parts.length - 1].trim();
    }

    function cleanRERLabel(label){
      return String(label ?? "")
        .replace(/\s*[-–—]\s*RER\b/gi, " RER");
    }

    function withRERIconInStop(text){
      const esc = escapeHTML(text ?? "");
      return esc.replace(/\s*[–—-]?\s*RER\s*[–—-]?\s*/gi,
        ' <span class="rer-ico" aria-label="RER"></span> ');
    }

    function splitRouteEndpoints(routeTitle){
      const s = decodeHTML(String(routeTitle || "").trim());
      const parts = s.split(/\s*(?:>|→|↔|⇄|<->|->|vers|to)\s*/i).filter(Boolean);
      if (parts.length >= 2){ return [parts[0].trim(), parts[parts.length-1].trim()]; }
      return [s, s];
    }

    function drawRoute(lineIdx, line, route){
      const key = `${line.uid}:${route.uid}`;
      if(dbusRouteLayers.has(key)) return dbusRouteLayers.get(key);

      const group = L.layerGroup().addTo(dbusLayers);
      const poly  = L.polyline([], {color: colorFor(lineIdx), weight:8, opacity:1}).addTo(group);

      const latlngs = route.stopIds.map(id => DBUS_STOPS.get(id)?.latlng).filter(Boolean);

      if (latlngs.length >= 2){
        poly.setLatLngs(latlngs);
        startLineAnim(key, poly);
      }

      getLineColors(line.number).then(([bg])=>{ if(bg) poly.setStyle({color:bg}); });

      const routeTitleRaw = route.name.includes(":") ? route.name.split(":")[1].trim() : route.name;
      const [titleStart0, titleEnd0] = splitRouteEndpoints(routeTitleRaw);
      const titleStart = trimAroundRER(titleStart0, 'start');
      const titleEnd   = trimAroundRER(titleEnd0,   'end');

      const stops = route.stopIds.map((id, idx, arr)=> {
        const st = DBUS_STOPS.get(id); if(!st) return null;
        const isFirst = (idx===0), isLast=(idx===arr.length-1);
        const n = String(line.number||"").trim();
        const title = isFirst ? "Départ" : (isLast ? "Terminus" : "Arrêt");

        let displayName = st.name;
        if (isFirst) displayName = titleStart;
        if (isLast)  displayName = titleEnd;

        const stopNameHTML = withRERIconInStop(displayName);

        const html = `
          <div style="display:flex;align-items:flex-start;gap:16px;min-width:320px;max-width:420px">
            <div>
              <span class="dbus-badge"
                    style="display:inline-flex;align-items:center;justify-content:center;font-weight:800;
                           font-size:22px;background:#444;color:#fff;padding:6px 14px;border-radius:8px;
                           min-width:48px;text-align:center">${escapeHTML(n)}</span>
            </div>
            <div style="min-width:0;max-width:100%">
              <div style="font-weight:700;margin-bottom:6px">${escapeHTML(title)}</div>
              <div class="dbus-stop-name">${stopNameHTML}</div>
            </div>
          </div>`;

        const marker = L.circleMarker(st.latlng, {
          radius: isFirst || isLast ? 10 : 9, fill: true, fillOpacity: 1,
          fillColor: "#ffffff", color: "#000", weight: 1, opacity: 0.95
        }).addTo(group).bindPopup(L.popup({ maxWidth: 420, autoPan: true }).setContent(html));

        marker.on('click', ()=> {
          const stObj = DBUS_STOPS.get(id);
          if (stObj?.latlng) centerWithPreview(stObj.latlng, { zoom: map.getZoom() });
        });

        marker.on('popupopen', ()=>{
          const stObj = DBUS_STOPS.get(id);
          if (stObj?.latlng) centerWithPreview(stObj.latlng);
          setActiveStopById(id);
        });

        marker.on('popupclose', ()=>{
          if (currentActiveStopId === id) clearActiveStop();
        });

        getLineColors(n).then(([bg, text]) => {
          const pop = marker.getPopup(); if (!pop) return;
          const el = pop.getContent();
          const updated = el.replace("background:#444", `background:${bg}`).replace("color:#fff", `color:${text}`);
          if (updated !== el) pop.setContent(updated);
        });

        return marker;
      }).filter(Boolean);

      const bundle = { group, poly, stops };
      dbusRouteLayers.set(key, bundle);
      return bundle;
    }

    function hideAllRoutes(){
      dbusLayers.clearLayers();
      routeAnimHandles.forEach(h => h.stop());
      routeAnimHandles.clear();
      hideLinePreview();
      clearActiveStop()
    }

    function showOnlyRoute(lineIdx, line, route){
      hideAllRoutes();
      const key = `${line.uid}:${route.uid}`;
      const existing = dbusRouteLayers.get(key);
      let bundle;

      if (existing) {
        dbusLayers.addLayer(existing.group);
        bundle = existing;
        if (existing.poly?._path) startLineAnim(key, existing.poly);
        else existing.poly.once('add', () => startLineAnim(key, existing.poly));
      } else {
        bundle = drawRoute(lineIdx, line, route);
      }

      if(route.stopIds.length){
        const first = DBUS_STOPS.get(route.stopIds[0]);
        if(first?.latlng){
          centerWithPreview(first.latlng, { zoom: map.getZoom() });
          const marker = bundle.stops[0];
          if(marker?.openPopup) setTimeout(()=> marker.openPopup(), 300);
        }
      } else if(bundle?.poly){
        const center = bundle.poly.getBounds().getCenter();
        centerWithPreview(center, { zoom: map.getZoom() });
      }

      renderLinePreview(line, route);
      return bundle;
    }

    function getRouteEndpoints(route){
      const routeTitleRaw = route.name.includes(":") ? route.name.split(":")[1].trim() : route.name;
      const [titleStart0, titleEnd0] = splitRouteEndpoints(routeTitleRaw);
      const titleStart = trimAroundRER(titleStart0, 'start');
      const titleEnd   = trimAroundRER(titleEnd0,   'end');
      return { routeTitleRaw, titleStart, titleEnd };
    }

    let PREVIEW_STOP_ELEMS = new Map();

    function setActiveStopById(stopId){
      PREVIEW_STOP_ELEMS.forEach(({el})=> el.classList.remove('active'));
      const rec = PREVIEW_STOP_ELEMS.get(stopId);
      if (rec?.el) rec.el.classList.add('active');
      currentActiveStopId = stopId;
      if (rec?.el?.scrollIntoView) {
        rec.el.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
      }
    }

    function centerWithPreview(latlng, { zoom = null } = {}) {
      const targetZoom = zoom ?? map.getZoom();

      const paneH = document.getElementById('linePreview')?.offsetHeight || 0;
      const offsetY = Math.round(paneH / 2);

      const p = map.project(latlng, targetZoom);
      let targetPt = L.point(p.x, p.y + offsetY);

      const ib = innerBounds(MARGIN);
      const sw = map.project(ib.getSouthWest(), targetZoom);
      const ne = map.project(ib.getNorthEast(), targetZoom);
      targetPt = L.point(
        Math.min(Math.max(targetPt.x, sw.x), ne.x),
        Math.min(Math.max(targetPt.y, ne.y), sw.y)
      );

      const targetLL = map.unproject(targetPt, targetZoom);

      const prevInertia = map.options.inertia;
      map.options.inertia = false;
      map.setView(targetLL, targetZoom, { animate: true });
      map.once('moveend', () => {
        try {
          map.options.inertia = prevInertia;
          const now = map.getCenter();
          const nowP = map.project(now, targetZoom);
          if (nowP.distanceTo(targetPt) > 2) {
            map.setView(targetLL, targetZoom, { animate: false });
          }
        } catch {}
      });
    }

    function renderLinePreview(line, route){
      PREVIEW_STOP_ELEMS = new Map();

      const wrap = document.getElementById("linePreviewWrap");
      const badge = document.getElementById("lpBadge");
      const title = document.getElementById("lpRouteTitle");
      const transit = document.getElementById("lpTransit");
      if(!wrap || !badge || !title || !transit) return;

      const { titleStart, titleEnd } = getRouteEndpoints(route);
      const cleanedStart = withRERIcon(titleStart);
      const cleanedEnd   = withRERIcon(titleEnd);
      title.innerHTML = `${cleanedStart} &gt; ${cleanedEnd}`;

      badge.textContent = String(line.number || "").trim();
      badge.style.background = "#444";
      badge.style.color = "#fff";

      if (transit) transit.style.setProperty('--lineColor', '#3aa0ff');

      getLineColors(line.number).then(([bg, text]) => {
        badge.style.background = bg;
        badge.style.color = text;
        if (transit) transit.style.setProperty('--lineColor', bg);
      }).catch(()=>{});

      transit.innerHTML = "";
      const ids = route.stopIds.slice();
      ids.forEach((id, idx) => {
        const st = DBUS_STOPS.get(id); if(!st) return;
        let label = st.name;
        if (idx === 0) label = titleStart;
        else if (idx === ids.length-1) label = titleEnd;

        const stopEl = document.createElement("div");
        stopEl.className = "stop" + (idx===0 ? " first" : (idx===ids.length-1 ? " last" : ""));
        stopEl.dataset.stopId = String(id);
        stopEl.innerHTML = `
          <div class="dot"></div>
          <div class="name">${withRERIcon(label)}</div>
        `;
        stopEl.addEventListener('click', ()=>{
          const bundle = dbusRouteLayers.get(currentSelectedKey);
          const mk  = bundle?.stops?.[idx];
          const pop = mk?.getPopup?.();

          if (pop) pop.options.autoPan = false;

          const stObj = DBUS_STOPS.get(id);
          if (stObj?.latlng) centerWithPreview(stObj.latlng);

          setTimeout(()=> { if (mk?.openPopup) mk.openPopup(); }, 120);

          if (pop) pop.options.autoPan = true;

          setActiveStopById(id);
        });
        PREVIEW_STOP_ELEMS.set(id, { el: stopEl, idx });
        transit.appendChild(stopEl);

        if (idx < ids.length-1){
          const seg = document.createElement("div");
          seg.className = "segment";
          getLineColors(line.number).then(([bg]) => { if (bg) seg.style.background = bg; }).catch(()=>{});
          transit.appendChild(seg);
        }
      });

      const firstId = route.stopIds[0];
      if (typeof firstId !== 'undefined') setActiveStopById(firstId);

      wrap.style.display = "block";
    }

    function hideLinePreview(){
      const wrap = document.getElementById("linePreviewWrap");
      if (wrap) wrap.style.display = "none";
      clearActiveStop()
    }

    document.getElementById("lpClose")?.addEventListener("click", () => {
      currentSelectedKey = "";
      hideAllRoutes();
      hideLinePreview();
      document.getElementById("dbusList")?.querySelectorAll(".dbus-item")?.forEach(it => it.style.outline="none");
      renderSelectedChip();
    });

    function openDbusPanel() {
      closeSearchUI({ reset: true });
      $panelDbus.style.display = 'block';
      $btnDbus?.setAttribute('aria-expanded','true');
    }
    function closeDbusPanel() {
      $panelDbus.style.display = 'none';
      $btnDbus?.setAttribute('aria-expanded','false');
    }
    function isDbusOpen() {
      return $panelDbus.style.display === 'block';
    }
    function openSearchUI() {
      closeDbusPanel();
      $results.hidden = false;
    }
    function closeSearchUI({ reset = false } = {}) {
      if (reset) $search.value = '';
      renderResults([]); 
      $results.hidden = true;
      $search.blur();
    }
    function isSearchOpen(){ return !$results.hidden; }

    $btnDbus.addEventListener('click', () => {
      if (isDbusOpen()) closeDbusPanel();
      else openDbusPanel();
      renderSelectedChip();
    });

    function renderSelectedChip(){
      const host = $selectedChip;
      if (!currentSelectedKey) { host.style.display="none"; host.innerHTML=""; return; }
      host.style.display = "none";
      host.innerHTML = "";
    }

    function isNumericOnly(s){ return /^\d+$/.test(String(s||"").trim()); }
    function isFlix(line){
      const num = String(line.number||"").toLowerCase();
      if (num.includes("flix")) return true;
      return (line.routes||[]).some(r => String(r.name||"").toLowerCase().includes("flix"));
    }
    function getCategory(line){
      if (isFlix(line))               return "FlixBus";
      if (isNumericOnly(line.number)) return "Urbain";
      return "Autres";
    }

    async function initDbusUI(){
      try{
        await loadStops();
        await loadLines();
      }catch(err){
        console.error("DBus: chargement échoué", err);
        return;
      }

      $dbusList.innerHTML = "";

      const none = document.createElement("div");
      none.className = "dbus-none";
      none.textContent = "Aucune";
      none.addEventListener("click", ()=>{
        currentSelectedKey = "";
        hideAllRoutes();
        hideLinePreview();
        $dbusList.querySelectorAll(".dbus-item").forEach(it=>{
          it.classList.remove("active");
          it.style.outline = "none";
        });
        renderSelectedChip();
      });
      $dbusList.appendChild(none);

      const buckets = { "Urbain": [], "FlixBus": [], "Autres": [] };

      DBUS_LINES.forEach(line => {
        const cat = getCategory(line);
        buckets[cat].push(line);
      });

      buckets["Urbain"].sort((a,b)=> (parseInt(a.number,10)||0) - (parseInt(b.number,10)||0));
      buckets["FlixBus"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
      buckets["Autres"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));

      function renderSection(title, lines){
        if (!lines.length) return;
        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        sec.innerHTML = `<h4>${title}</h4>`;
        $dbusList.appendChild(sec);

        lines.forEach((line, idxBase)=>{
          line.routes.forEach(route=>{
            const item = document.createElement("div");
            item.className = "dbus-item";

            const badge = makeLineBadge(line.number, "#444", "#fff", "72x32");
            const titleEl = document.createElement("div");
            titleEl.className = "rname";
            const raw = route.name.includes(":") ? route.name.split(":")[1].trim() : route.name;
            titleEl.innerHTML = withRERIcon(raw);

            item.appendChild(badge);
            item.appendChild(titleEl);

            getLineColors(line.number).then(([bg,text])=>{ badge.style.background = bg; badge.style.color = text; });

            item.addEventListener("click", ()=>{
              $dbusList.querySelectorAll(".dbus-item").forEach(it=>{
                it.classList.remove("active");
                it.style.outline = "none";
              });
              item.classList.add("active");
              getLineColors(line.number).then(([bg])=>{
                item.style.outline = `2px solid ${bg || colorFor(idxBase)}`;
              });

              const key = `${line.uid}:${route.uid}`;
              currentSelectedKey = key;
              showOnlyRoute(idxBase, line, route);
              renderSelectedChip();

              $panelDbus.style.display = "none";
            });

            $dbusList.appendChild(item);
          });
        });
      }

      renderSection("Urbain",  buckets["Urbain"]);
      renderSection("FlixBus", buckets["FlixBus"]);
      renderSection("Autres",  buckets["Autres"]);
    }
    initDbusUI().then(()=>renderSelectedChip()).catch(()=>{});

    let currentActiveStopId = null;
    function clearActiveStop(){
      PREVIEW_STOP_ELEMS.forEach(({el}) => el.classList.remove('active'));
      currentActiveStopId = null;
    }

        function norm(s){
          return String(s||"")
            .toLowerCase()
            .normalize('NFD')
            .replace(/\p{Diacritic}/gu,'')
            .replace(/\s+/g,' ')
            .trim();
        }
        function includesNorm(hay, needle){
          return norm(hay).includes(norm(needle));
        }

      function detectTypeFilter(q){
        const n = norm(q);

        const MAP = [
          {types:["Atelier"],      keys:["atelier","atelier de reparation","reparation","atelier reparation"]},
          {types:["Agence"],       keys:["agence","agence de recrutement","recrutement"]},
          {types:["Garage"],       keys:["garage"]},
          {types:["Concessionnaire"], keys:["concessionnaire","dealer","concess"]},
          {types:["Entreprise"],   keys:["entreprise","societe","company"]},
          {types:["Ville"],        keys:["ville","commune","city"]},
          {types:["Monument"],     keys:["monument","monuments","monu","lieu","lieu emblématique","lieux emblématiques","lieux","emblématique","emblématiques"]},
          {types:["Centre commercial"], keys:["centre commercial","centrecom","centre commerciaux","mall","shopping"]},
        ];


        for(const row of MAP){
          for(const k of row.keys){
            if(n === k || n.startsWith(k+" ") || n.endsWith(" "+k) || n.includes(" "+k+" ")){
              return { types: row.types, hit: k };
            }
          }
        }
        return null;
      }
      
    let sectionState = {};
    function getExpanded(key){ return sectionState[key] !== false; }
    function setExpanded(key, val){ sectionState[key] = !!val; }
    
    const ALL_TYPES = [
      "Ville","Monument","Atelier","Agence","Concessionnaire","Entreprise","Centre commercial"
    ];
    
    const ORDER = [
      ["Ville","Villes"],
      ["Monument","Lieux Emblématiques"],
      ["Atelier","Ateliers de réparation"],
      ["Agence","Agences de recrutement"],
      ["Concessionnaire","Concessionnaires"],
      ["Entreprise","Entreprises"],
      ["Centre commercial","Centres commerciaux"]
    ];
    const PLURIEL = Object.fromEntries(ORDER);

    const DEFAULT_OFF = new Set(["Atelier","Agence","Centre commercial"]);
    let SELECTED_TYPES = new Set(ALL_TYPES.filter(t => !DEFAULT_OFF.has(t)));

    const saveSelectedTypes = () => {};

    function buildResultsFilterBar(host){
      host.querySelector(".results-filters")?.remove();

      const bar = document.createElement("div");
      bar.className = "results-filters";

      ALL_TYPES.forEach(type=>{
        const id = "rf_" + type.replace(/\s+/g,'_');
        const labelText = PLURIEL[type] || type;

        const chip = document.createElement("label");
        chip.className = "rf-chip";
        chip.dataset.type = type;
        chip.innerHTML = `
          <span>${labelText}</span>
          <input type="checkbox" id="${id}" ${SELECTED_TYPES.has(type)?'checked':''} aria-label="${labelText}">
        `;
        const input = chip.querySelector("input");
        input.addEventListener("change", () => {
          if (input.checked) SELECTED_TYPES.add(type);
          else SELECTED_TYPES.delete(type);
          saveSelectedTypes(SELECTED_TYPES);
          doSearch($search.value);
        });
        bar.appendChild(chip);
      });

      host.prepend(bar);
    }

    
    function renderResults(list){
      $results.innerHTML = "";
      buildResultsFilterBar($results);
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "result-empty";
        empty.textContent = "Aucun résultat";
        $results.appendChild(empty);
        $results.hidden = false;
        return;
      }

      const buckets = {
        "Ville": [],
        "Atelier": [],
        "Agence": [],
        "Garage": [],
        "Concessionnaire": [],
        "Entreprise": [],
        "Monument": [],
        "Centre commercial": []
      };
      for (const it of list){ if (buckets[it.type]) buckets[it.type].push(it); }

      function addSectionBlock(typeKey, label){
        const head = document.createElement("div");
        head.className = "result-sechead";
        head.textContent = label; 
        $results.appendChild(head);

        const body = document.createElement("div");
        body.className = "result-secbody";
        $results.appendChild(body);

        return body;
      }

      function addItem(container, item){
        const div = document.createElement("div");
        div.className = "result-item";
        let logoPath = item.logo;
        let useServiceSize = false;

        if (!logoPath && item.type === "Ville") {
          logoPath = "./Overlays/city_ico.png"; 
          useServiceSize = true; 
        }

        if (logoPath){
          const img = document.createElement("img");
          img.className = "ico";
          if (["Atelier","Agence","Garage","Ville","Monument","Centre commercial"].includes(item.type) || useServiceSize) {
            img.classList.add("ico-service");
          }
          img.src = logoPath;
          img.alt = "";
          img.onerror = () => {
            if (item.fallbackLogo && img.src !== item.fallbackLogo) img.src = item.fallbackLogo;
          };
          div.appendChild(img);
        }

        let label;
        if (item.type === "Concessionnaire"){
          const brand = (item.brand || String(item.name||"").replace(/^Concessionnaire\s+/i,"")).trim();
          label = item.city ? `${brand} — ${item.city}` : brand;
        } else if (["Atelier","Agence","Garage"].includes(item.type)){
          label = item.city || (item.type === "Agence" ? "Agence de recrutement" : item.type);
        } else if (item.type === "Monument"){
          label = item.city ? `${item.name} — ${item.city}` : item.name; 
        } else {
          label = item.city ? `${item.name} — ${item.city}` : item.name;
        }

        const span = document.createElement("div");
        span.className = "result-text";
        span.textContent = label;
        div.appendChild(span);

        div.addEventListener("click", () => {
          $search.value = "";
          $search.blur();
          $results.hidden = true;
          map.setView(item.center, Math.max(map.getZoom(), minNativeZoom + 4));
          if (item.open) setTimeout(()=> item.open(), 150);
        });

        container.appendChild(div);
      }

      let shown = 0;
      for (const [typeKey,label] of ORDER){
        const arr = buckets[typeKey];
        if (!arr.length) continue;
        const body = addSectionBlock(typeKey,label);
        for (const it of arr){
          if (shown >= 250) break;
          addItem(body,it);
          shown++;
        }
        if (shown >= 250) break;
      }

      $results.hidden = false;
    }
    function doSearch(q){
      const raw = String(q||"");
      const nQ  = norm(raw);

      const ALLOWED = new Set(ALL_TYPES.filter(t => SELECTED_TYPES.has(t)));

      if (nQ === ""){
        const all = searchIndex.filter(it => ALLOWED.has(it.type));
        renderResults(all);
        $results.hidden = false;
        return;
      }

      let filtered = searchIndex.filter(it => ALLOWED.has(it.type));
      const typeInfo = detectTypeFilter(nQ);

      if (typeInfo){
        filtered = filtered.filter(it => typeInfo.types.includes(it.type));
        let rest = norm(raw.replace(new RegExp(typeInfo.hit,'i'), '').trim())
                    .replace(/^[\s,;:>-]+|[\s,;:>-]+$/g,'');
        if (rest){
          filtered = filtered.filter(it => {
            const hay = [it.name, it.city, it.brand].filter(Boolean).join(" ");
            return includesNorm(hay, rest);
          });
        }
      } else {
        filtered = filtered.filter(it => {
          const hay = [it.type, it.name, it.city, it.brand].filter(Boolean).join(" ");
          return includesNorm(hay, raw);
        });
      }

      filtered.sort((a,b)=>{
        const pa = (a.type==="Ville")?0:1, pb=(b.type==="Ville")?0:1;
        if(pa!==pb) return pa-pb;
        return String(a.name).localeCompare(String(b.name),'fr',{numeric:true});
      });

      renderResults(filtered);
      $results.hidden = false;
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
    const doSearchDebounced = debounce(q => {
      doSearch(String(q||''));
      openSearchUI();
      _resIdx = -1;
    }, 120);

    $search.addEventListener('focus', () => {
      closeDbusPanel();
      doSearch($search.value);
    });
    $search.addEventListener('input', e => doSearchDebounced(e.target.value));
    $search.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const first = $results.querySelector('.result-item');
        if (first) first.click();
      }
    });

    document.addEventListener('click', (e) => {
      const searchPanel = document.querySelector('.search-panel');
      const clickInSearch = !!searchPanel && searchPanel.contains(e.target);
      const clickInDbus   = !!$panelDbus && ($panelDbus.contains(e.target) || e.target === $btnDbus);

      if (!clickInSearch) closeSearchUI({ reset: true });
      if (!clickInDbus)   closeDbusPanel();
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('lpClose')?.click();
        closeSearchUI({ reset: true });
        closeDbusPanel();
        try { map.closePopup(); } catch {}
      }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        $search?.focus();
      }
    });
  </script>

  <script>
    const CLOSED = false 
      || (new URLSearchParams(location.search).get('closed') === '1');

    if (CLOSED) {
      const html = `
        <div style="
          position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
          background:#0b1118;color:#e8eefb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
          text-align:center;padding:24px
        ">
          <div>
            <div style="font-size:64px;line-height:1">🛠️</div>
            <div style="font-size:28px;font-weight:800;margin-bottom:10px">En maintenance</div>
            <div style="color:#9fb1cc;margin-bottom:18px">La carte sera de nouveau disponible lors de la prochaine version de la map.</div>
          </div>
        </div>
      `;
      document.body.innerHTML = html;
      throw new Error('Maintenance');
    }
  </script>

</body>
</html>
