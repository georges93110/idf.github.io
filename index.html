<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Map</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --panel:#0b1118;--panel2:#0f1722;--border:#2b2f3a;--text:#e8eefb;--muted:#8892a6;--shadow:0 10px 30px rgba(0,0,0,.40);
      --logoW:110px; --logoH:44px;
      --busA:#2b2f3a; --busB:#2b2f3a; --busC:#2b2f3a; --busD:#2b2f3a; --busE:#2b2f3a;
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    #map{position:fixed;inset:0}
    .leaflet-container,html,body,#map{background:#000}

    .city-label{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      color:#fff;font-weight:600;white-space:nowrap;text-align:center;
      text-shadow:0 2px 4px rgba(0,0,0,.8);
      pointer-events:auto; cursor:pointer;
    }
    .city-selected{color:#ffda3a !important;text-shadow:0 0 0 rgba(0,0,0,0),0 2px 6px rgba(0,0,0,.9)}

    .search-panel{position:fixed;top:12px;right:12px;z-index:1000;min-width:950px;max-width:min(92vw,920px)}
    .search-row{display:flex;gap:8px;align-items:center}
    .search-input{flex:1;min-width:300px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-size:15px;box-shadow:var(--shadow);outline:none}
    .search-input::placeholder{color:var(--muted)}
    .btn{padding:11px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    .btn:hover{background:#101926}
    .results{margin-top:6px;max-height:42vh;overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--panel);box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .result-item{display:flex;align-items:center;gap:12px;padding:10px 12px;cursor:pointer;border-bottom:1px solid #1f2732;color:var(--text);font-size:14px}
    .result-item:last-child{border-bottom:none}
    .result-item:hover{background:#101926}
    .result-item img.ico{width:var(--logoW);height:var(--logoH);flex:0 0 auto;border-radius:6px;object-fit:contain}
    .result-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;line-height:1.2}
    .result-empty{
      padding:10px 12px;
      color:var(--muted);
      font-size:14px;
      border-bottom:1px solid #1f2732;
    }
    .result-item img.ico { width: var(--logoW); height: var(--logoH); }
    .result-item img.ico.ico-service { width: calc(var(--logoW) / 2); height: calc(var(--logoH) / 2); }

    .result-sechead{
      padding:8px 10px;
      color:#a7b2c9;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      border-bottom:1px solid #1f2732;
      background:var(--panel2);
    }

    .dbus-panel{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:1240px;
      height:760px;
      padding:12px 18px 0;
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 25px 90px rgba(0,0,0,.7);
      display:none;
      overflow:hidden;
      z-index:1200;
    }
    .dbus-panel .dbus-content{
      overflow:auto;
    }
    .dbus-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1f2732;color:var(--muted);font-size:16px}
    .dbus-header .dbus-title{font-size:20px;font-weight:700;color:#f8fbff;}
    .dbus-header .dbus-close{
      background:transparent;
      border:none;
      color:#ef4444;
      font-size:24px;
      cursor:pointer;
      line-height:1;
    }
    .dbus-list{padding:6px}
    .dbus-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 90px);
      gap: 4px; 
      padding: 6px;
      justify-content: start; 
      align-items: start;
    }
    .dbus-double {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 10px;
      padding-bottom: 10px;
      grid-auto-rows: minmax(0, auto);
    }
    .dbus-double .dbus-item {
      width: 100%;
      box-sizing: border-box;
    }
    .dbus-double .dbus-item .rname {
      max-width: 100%;
      word-break: break-word;
    }
    .line-block{display:flex;flex-direction:column;align-items:flex-start}
    .dbus-logo{width:88px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid #1f2732;background:#223047;color:#fff;font-weight:800;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,0.04)}
    .dbus-logo--titus{border:none;background:transparent;box-shadow:none}
    .dbus-logo.dim{opacity:.25; filter:grayscale(100%);}
    .dbus-logo.sel{position:relative}
    .dbus-logo.sel::after{content:"";position:absolute;left:14px;right:14px;bottom:-4px;height:2px;border-radius:6px;background:var(--selColor,#3aa0ff);pointer-events:none;z-index:2}
    
    .dbus-logo img{display:block;width:100%;height:100%;object-fit:contain;border-radius:10px}
    .routes-host .dbus-item{margin:2px 6px;padding:8px 10px}
    .line-routes{margin-top:8px;width:100%}
    .dbus-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #1f2732;border-radius:10px;background:var(--panel2);cursor:pointer;margin:6px}
    .dbus-item:hover{background:#101926}
    .dbus-item .badge{display:flex;align-items:center;justify-content:center;width:72px;height:32px;border-radius:8px;font-weight:800;font-size:16px}
    .dbus-item .rname{
      color:var(--text);
      font-size:14px;
      white-space:normal;
      overflow:hidden;
      text-overflow:clip;
      word-break:break-word;
      line-height:1.3;
    }
    .dbus-none{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed #223047;border-radius:10px;background:#0c1421;color:#9fb1cc;cursor:pointer;margin:6px}
    .dbus-item.active{ outline:2px solid #ffffff55; background:#101926; }
    .dbus-sec{margin:8px 6px 4px}
    .dbus-sec h4{
      margin:10px 6px 6px;
      color:#a7b2c9;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .dbus-sechead {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      color:#a7b2c9;
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      border-bottom:1px solid #1f2732;
      background:var(--panel2);
      cursor:pointer;
      user-select:none;
    }
    .dbus-sechead .chev {
      transition: transform .18s ease;
    }
    .dbus-sechead[aria-expanded="false"] .chev {
      transform: rotate(-90deg);
    }
    .dbus-secbody[hidden] { display:none; }


    .watermark{position:fixed;right:14px;bottom:14px;z-index:400;pointer-events:none;opacity:.125;filter:grayscale(10%);mix-blend-mode:screen}
    .watermark img{display:block;width:220px;max-width:32vw;height:auto}

    .inline-ico{ height:1.5em; width:auto; vertical-align:-.35em; margin:0 .12em }
    .rer-invert { filter: invert(1); }
    .leaflet-popup-content{white-space:normal;overflow:visible}
    .dbus-stop-name{font-size:15px;line-height:1.35;word-break:break-word}
    .stop-popup{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:260px;
      max-width:420px;
      font-size:13px;
      color:#d4dcf0;
    }
    .stop-popup .sp-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      border-radius:10px;
      background:color-mix(in oklab,var(--panel2) 85%, #000 15%);
      border:1px solid rgba(255,255,255,0.08);
    }
    .stop-popup .sp-title{
      font-weight:700;
      font-size:14px;
      color:#f8fbff;
    }
    .stop-popup .sp-index{
      padding:2px 10px;
      border-radius:999px;
      background:#19304a;
      color:#8dd0ff;
      font-weight:700;
      font-size:12px;
    }
    .stop-popup .sp-body{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .stop-popup .sp-coords{
      font-size:12px;
      line-height:1.5;
      color:#9fb1cc;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(15,23,34,0.85);
    }
    .stop-popup .sp-coords span{
      display:block;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:11px;
      margin-bottom:3px;
      color:#6da8ff;
    }
    .stop-popup .sp-coords-code{
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size:12px;
      color:#e8eefb;
    }
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip{
      background:color-mix(in oklab,var(--panel) 92%, #000 8%);
      color:var(--text);
      border:1px solid #1c2533;
      box-shadow:0 12px 32px rgba(0,0,0,.55);
    }

    @media (max-width:800px){
      .search-panel{min-width:300px;max-width:92vw}
      .search-input{min-width:180px}
      .watermark img{width:180px}
    }
    .selected-chip{margin-top:6px;display:none;width:100%}
    .line-chip{display:flex;align-items:center;padding:6px 6.5px;border:1px solid var(--border);border-radius:12px;background:color-mix(in oklab, var(--panel) 92%, #000 8%);box-shadow:var(--shadow);width:fit-content}
    .line-chip .close{margin-left:10px;border:none;background:transparent;color:#ef4444;font-weight:900;font-size:22px;cursor:pointer;line-height:1}
    .line-chip .close:hover{color:#ff6666}

    .line-preview-wrap{ position:fixed;left:0;right:0;bottom:0;z-index:1100; pointer-events:none; }
    .line-preview{
      margin:10px auto 12px; max-width:min(1100px,94vw);
      background:color-mix(in oklab, var(--panel) 92%, #000 8%);
      border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
      padding:10px 12px; pointer-events:auto;
    }
    .line-preview-header{ display:flex;align-items:center;gap:10px;justify-content:space-between; margin-bottom:8px; }
    .line-preview-title{ display:flex;align-items:center;gap:10px;min-width:0; }
    .line-preview .dbus-badge {
      font-size:25px;
      min-width:56px;
      height:28px;
      padding:4px 10px;
    }
    .line-preview-route{ color:var(--text);font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
    .line-preview-close{ border:none;background:transparent;color:#ef4444;font-weight:900; font-size:22px;cursor:pointer;line-height:1;padding:2px 6px;border-radius:8px; }
    .line-preview-close:hover{ color:#ff6666; background:#0f1722; }

    .transit-scroll{ overflow-x:auto;overflow-y:hidden;white-space:nowrap; padding-bottom:4px; }
    .transit{
      --lineColor:#3aa0ff;
      --rail-h:26px;
      --dot:16px;
      --ringW:12px;
      --gap:18px;
      --nameH:18px;
      display:flex;align-items:flex-start;gap:0;
      min-height:calc(var(--rail-h) + var(--nameH) + 14px);
      padding:2px 2px 6px;
    }

    .stop{ position:relative; display:flex; flex-direction:column; align-items:center; flex:0 0 auto;
      box-sizing:border-box; padding-top:calc(var(--rail-h) - var(--dot)/2); margin:0 calc(var(--gap)/2); }
    .segment{
      position:relative;
      height:4px;
      flex:1 0 60px;
      min-width:120px;
      background:var(--lineColor);
      margin-top:calc(var(--rail-h)/2 - 2px);
      margin-left:calc(var(--gap)*-0.5);
      margin-right:calc(var(--gap)*-0.5);
      border-radius:2px;
    }
    .stop .dot{ position:absolute; left:50%; top:calc(var(--rail-h)/2 - var(--dot)/2);
      transform:translateX(-50%); width:var(--dot); height:var(--dot); border-radius:50%; background:var(--lineColor);
      border:none; box-shadow:0 1px 2px rgba(0,0,0,.5); }
    .stop .name{
      color:var(--text);
      font-size:12px;
      line-height:1.3;
      text-align:center;
      margin-top:8px;
      font-weight:700;
      max-width:110px;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
    }
    .stop-flag{
      font-size:10px;
      color:#fbbf24;
      background:rgba(251,191,36,0.15);
      border:1px solid rgba(251,191,36,0.4);
      border-radius:999px;
      padding:2px 6px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }
    .stop .name .inline-ico{ height:1em; vertical-align:-.2em; }
    .stop.active .name{ color:#ffda3a; }

    @media (max-width:800px){
      .stop{min-width:64px}
      .segment{min-width:36px}
    }

    .rer-ico{
      display:inline-block;
      width:1.1em; height:1.1em;
      vertical-align:-.2em;
      background-color: currentColor;
      -webkit-mask: url("./Overlays/o_rer.png") no-repeat center / contain;
              mask: url("./Overlays/o_rer.png") no-repeat center / contain;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner{
      display:inline-block; width:16px; height:16px;
      border:2px solid #8892a6; border-top-color:#e8eefb;
      border-radius:50%; animation:spin .8s linear infinite;
      vertical-align:-.2em;
    }

    .results::-webkit-scrollbar,
    .dbus-panel::-webkit-scrollbar,
    .dbus-content::-webkit-scrollbar,
    .transit-scroll::-webkit-scrollbar { width: 10px; height: 10px; }
    .results::-webkit-scrollbar-track,
    .dbus-panel::-webkit-scrollbar-track,
    .dbus-content::-webkit-scrollbar-track,
    .transit-scroll::-webkit-scrollbar-track { background: var(--panel2); border-radius: 8px; }
    .results::-webkit-scrollbar-thumb,
    .dbus-panel::-webkit-scrollbar-thumb,
    .dbus-content::-webkit-scrollbar-thumb,
    .transit-scroll::-webkit-scrollbar-thumb {
      background: var(--muted); border-radius: 8px; border: 2px solid var(--panel2);
    }
    .results::-webkit-scrollbar-thumb:hover,
    .dbus-panel::-webkit-scrollbar-thumb:hover,
    .dbus-content::-webkit-scrollbar-thumb:hover,
    .transit-scroll::-webkit-scrollbar-thumb:hover { background: var(--text); }
    .results, .dbus-panel, .dbus-content, .transit-scroll { scrollbar-width: thin; scrollbar-color: var(--muted) var(--panel2); }

    .result-sechead{ display:flex;align-items:center;justify-content:space-between; cursor:pointer; user-select:none; }
    .result-sechead .chev{ font-size:14px; opacity:.9; transition:transform .18s ease; }
    .result-sechead[aria-expanded="false"] .chev{ transform:rotate(-90deg); }
    .result-secbody[hidden]{ display:none !important; }
    
    .results-filters{
      position: sticky; top: 0; z-index: 2;
      display:flex; flex-wrap:wrap; align-items:center; gap:6px;
      padding:8px 10px; border-bottom:1px solid #1f2732;
      background:var(--panel2); backdrop-filter:blur(6px);
    }
    .rf-chip{ display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      background:var(--panel); color:var(--text); font-size:12px; cursor:pointer; user-select:none; }
    .rf-chip input{ appearance:none; width:16px; height:16px; border:2px solid #5b6b85; border-radius:4px; display:inline-block; }
    .rf-chip input:checked{ background:#3aa0ff; border-color:#3aa0ff; }
    .rf-chip .dot{ width:10px; height:10px; border-radius:50%; opacity:.95; }
    .rf-chip[data-type="Ville"]              .dot{ background:#9ca3af; }
    .rf-chip[data-type="Monument"]           .dot{ background:#f59e0b; }
    .rf-chip[data-type="Atelier"]            .dot{ background:#22c55e; }
    .rf-chip[data-type="Agence"]             .dot{ background:#8b5cf6; }
    .rf-chip[data-type="Concessionnaire"]    .dot{ background:#3aa0ff; }
    .rf-chip[data-type="Entreprise"]         .dot{ background:#ef4444; }
    .rf-chip[data-type="Centre commercial"]  .dot{ background:#10b981; }

    .rf-actions{ margin-left:auto; display:flex; gap:6px; }
    .rf-btn{ padding:6px 10px; font-size:12px; border-radius:10px; border:1px solid var(--border);
      background:color-mix(in oklab, var(--panel) 92%, #000 8%); color:var(--text); cursor:pointer; }
    .rf-btn:hover{ background:#101926; }

    .rf-chip .dot{ display:none !important; }

    .result-sechead{ display:block; cursor:default; user-select:text; }
    .result-sechead .chev{ display:none !important; }

    .dbus-badge {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      background:#444;
      color:#fff;
      padding:6px 14px;
      border-radius:8px;
      min-width:48px;
      text-align:center;
      position:relative; 
    }
    
    .titus-chip{
      height:30px;
      padding:0 12px;
      font-size:16px;
      min-width:0;
      width:40px;
      display:inline-flex;
      align-items:center;
    }
    .network-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .network-badge img{
      height:36px;
      width:auto;
      object-fit:contain;
    }
    .network-logo-invert{
      filter: invert(1);
    }
    .network-chip{
      min-width:48px;
      height:30px;
      padding:0 12px;
      font-size:16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    #lpBadge.lp-badge-wrapper{
      display:flex;
      align-items:center;
      background:transparent;
      padding:0;
    }
    
    .dbus-badge .noctilien-stripe {
      position:absolute;
      left:0; right:0; bottom:0;
      height:4px;
      border-bottom-left-radius:8px;
      border-bottom-right-radius:8px;
    }

    .route-flag {
      font-size:10px;
      color:#fbbf24;
      background:rgba(255, 255, 255, 0.15);
      border:1px solid rgba(251,191,36,0.4);
      border-radius:999px;
      padding:1px 5px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }

    .badge.fictive {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-top: 10px;
      box-sizing: border-box;
    }

    .badge .fictive-stripe {
      position: absolute;
      top: 2px;
      left: 6px;
      right: 6px;
      height: 10px;
      border-radius: 4px;
      background: #000000;
      color: #fff;
      font-size: 8px;
      font-weight: 600;
      text-align: center;
      line-height: 10px;
      text-transform: uppercase;
      pointer-events: none;
      overflow: hidden;
      white-space: nowrap;
    }

    .badge-label {
      display: inline-block;
      white-space: nowrap;
      line-height: 1;
      position: relative;
      z-index: 1;
    }

    .dbus-sechead .chev {
      transition: transform .18s ease;
    }
    .dbus-sechead[aria-expanded="false"] .chev {
      transform: rotate(-90deg);
    }

    .dbus-panel, 
    .results {
      overflow-y: auto;
      scrollbar-gutter: stable;
    }

    .custom-scale {
      position: relative;
      height: 8px;
      margin: 10px;
      background: transparent;
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,.8);
      width: fit-content;
    }

    .custom-scale .bar {
      height: 3px;
      background: var(--text);
      border-radius: 2px;
    }

    .custom-scale span {
      position: absolute;
      top: -18px;
      left: 0;
    }

    .analysis-hud{
      position:fixed; right:8px; bottom:6px; z-index:1500;
      color:#ffffff; font-size:5px; font-weight:600; letter-spacing:.02em;
      background:rgba(11,17,24,0.6); border:1px solid rgba(255,255,255,0.05);
      border-radius:6px; padding:2px 4px; user-select:none; pointer-events:none;
    }

  </style>
  
</head>
<body>
  <div id="map"></div>

  <div class="search-panel">
    <div class="search-row">
      <input id="search" class="search-input" type="search" placeholder="Rechercher..." autocomplete="off"/>
      <button id="btnDbus" class="btn" type="button">Lignes DBus</button>
      <!-- <button id="langToggle" class="btn" type="button" aria-label="Langue">FR</button> -->
    </div>
    
    <div id="selectedChip" class="selected-chip"></div>
    <div id="results" class="results" hidden></div>

  <div id="dbusPanel" class="dbus-panel">
      <div class="dbus-header">
        <div class="dbus-title" id="dbusPanelTitle">Lignes DBus</div>
        <button type="button" class="line-preview-close dbus-close" id="dbusPanelClose" aria-label="Fermer">&times;</button>
      </div>
      <div class="dbus-content">
        <div id="dbusList" class="dbus-list"></div>
      </div>
    </div>
  </div>

  <div id="linePreviewWrap" class="line-preview-wrap" style="display:none">
    <div class="line-preview" id="linePreview">
      <div class="line-preview-header">
        <div class="line-preview-title">
          <div class="dbus-badge" id="lpBadge">?</div>
          <div class="line-preview-route" id="lpRouteTitle">-</div>
        </div>
        <button type="button" class="line-preview-close" id="lpClose" aria-label="Fermer">X</button>
      </div>
      <div class="transit-scroll">
        <div class="transit" id="lpTransit"></div>
      </div>
    </div>
  </div>

  <div class="watermark">
    <img src="./Overlays/idf_logo.png" alt="IDF Logo">
  </div>

  <!-- <div id="analysisHUD" class="analysis-hud"></div>*/ -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>

  const LINE_STYLES = {
    "24":         ["#ab5798", "#FFFFFF"],
    "63":         ["#cdc74f", "#221f20"],
    "109":        ["#cdc74f", "#221f20"],
    "112":        ["#e69459", "#221f20"],
    "114":        ["#8cc299", "#221f20"],
    "121":        ["#d63e34", "#FFFFFF"],
    "124":        ["#e6a4b2", "#221f20"],
    "221":        ["#e7a5b3", "#221f20"],
    "303":        ["#99974a", "#FFFFFF"],
    "325":        ["#9ad1dc", "#221f20"],
    "351":        ["#d7b152", "#221f20"],
    "FLIXBUS":    ["#a7d245", "#FFFFFF"],
    "N11":        ["#e9682a", "#221f20"],
    "N23":        ["#d09835", "#221f20"],
    "Titus 1":    ["#e63b20", "#FFFFFF"],
    "Titus 2":    ["#49713e", "#FFFFFF"],
    "Scolaire":   ["#31387e", "#FFFFFF"],
    "Express 75": ["#6fb2e1", "#FFFFFF"],
    "Express 77": ["#6fb2e1", "#FFFFFF"],
    "Express 93": ["#6fb2e1", "#FFFFFF"],
    "Express 94": ["#6fb2e1", "#FFFFFF"],
  };

  const I18N = {
    fr: {
      search_placeholder: "Rechercher...",
      dbus_button: "Lignes DBus",
      lang_btn: "FR",
      results_empty: "Aucun résultat",
      none: "Aucune",
      villes: "Villes",
      emblematic: "Lieux Emblématiques",
      repair_shops: "Ateliers de réparation",
      agencies: "Agences de recrutement",
      dealers: "Concessionnaires",
      companies: "Entreprises",
      malls: "Centres commerciaux",
      see_wiki: "Voir sur Wikipédia",
      loading: "Chargement...",
      depart: "Départ",
      terminus: "Terminus",
      stop: "Arrêt",
      home_tooltip: "Revenir à la vue initiale",
      maintenance_title: "En maintenance",
      close: "Fermer",
      analyze_mode: "Mode Analyse",
    },
    en: {
      search_placeholder: "Search...",
      dbus_button: "DBus Lines",
      lang_btn: "EN",
      results_empty: "No results",
      none: "None",
      villes: "Cities",
      emblematic: "Landmarks",
      repair_shops: "Repair shops",
      agencies: "Recruitment agencies",
      dealers: "Dealers",
      companies: "Companies",
      malls: "Shopping centers",
      see_wiki: "See on Wikipedia",
      loading: "Loading...",
      depart: "Departure",
      terminus: "Terminus",
      stop: "Stop",
      home_tooltip: "Return to initial view",
      maintenance_title: "Under maintenance",
      close: "Close",
      analyze_mode: "Analyze Mode",
    }
  };
  const SUPPORTED = new Set(["fr","en"]);
  function detectInitialLang(){
    const qs = new URLSearchParams(location.search);
    const fromURL = (qs.get("lang")||"").toLowerCase();
    if (SUPPORTED.has(fromURL)) return fromURL;
    const stored = localStorage.getItem("idf_lang");
    if (SUPPORTED.has(stored)) return stored;
    const nav = (navigator.language||"fr").slice(0,2).toLowerCase();
    return SUPPORTED.has(nav) ? nav : "fr";
  }
  let LANG = detectInitialLang();
  function t(key){ return (I18N[LANG] && I18N[LANG][key]) || (I18N.fr[key]||key); }
  function wikiBase(){ return LANG === "en" ? "https://en.wikipedia.org/wiki/" : "https://fr.wikipedia.org/wiki/"; }
  function setLang(lang, {persist=true, apply=true} = {}){
    if (!SUPPORTED.has(lang)) lang = "fr";
    LANG = lang;
    if (persist) localStorage.setItem("idf_lang", lang);
    document.documentElement.setAttribute("lang", lang);
    const btn = document.getElementById("langToggle");
    if (btn) btn.textContent = I18N[lang].lang_btn;
    if (apply) applyI18N();
  }
  function applyI18N(){
    const $search = document.getElementById("search");
    if ($search) $search.placeholder = t("search_placeholder");
    const $btnDbus = document.getElementById("btnDbus");
    if ($btnDbus) $btnDbus.textContent = t("dbus_button");
    const panelTitle = document.getElementById("dbusPanelTitle");
    if (panelTitle) panelTitle.textContent = t("dbus_button");
    const $lpClose = document.getElementById("lpClose");
    if ($lpClose){ $lpClose.setAttribute("aria-label", t("close")); $lpClose.title = t("close"); }
    const home = document.querySelector(".leaflet-custom-home a.home-btn");
    if (home) home.title = t("home_tooltip");

    const results = document.getElementById("results");
    if (results && !results.hidden) {
      const empty = results.querySelector(".result-empty");
      if (empty) empty.textContent = t("results_empty");
      results.querySelectorAll(".result-sechead").forEach(h => {
        const raw = h.textContent.trim().toLowerCase();
        const map = {
          "villes": t("villes"),
          "lieux emblématiques": t("emblematic"),
          "ateliers de réparation": t("repair_shops"),
          "agences de recrutement": t("agencies"),
          "concessionnaires": t("dealers"),
          "entreprises": t("companies"),
          "centres commerciaux": t("malls"),
        };
        if (map[raw]) h.textContent = map[raw];
      });
    }
    const none = document.querySelector(".dbus-none");
    if (none) none.textContent = t("none");
  }
  document.getElementById("langToggle")?.addEventListener("click", ()=> setLang(LANG === "fr" ? "en" : "fr"));
  setLang(LANG, {persist:false, apply:true});
  </script>

  <script>
    const minNativeZoom=0,maxNativeZoom=8,tileSize=256,TILE_BASE="./Tiles";
    const widthPx=tileSize*Math.pow(2,maxNativeZoom),heightPx=tileSize*Math.pow(2,maxNativeZoom);

    const map=L.map('map',{crs:L.CRS.Simple,attributionControl:false,minZoom:minNativeZoom+3,maxZoom:maxNativeZoom+2,maxBoundsViscosity:1.0,inertia:true});
    const fullBounds=L.latLngBounds(map.unproject(L.point(0,heightPx),maxNativeZoom),map.unproject(L.point(widthPx,0),maxNativeZoom));
    const MARGIN=64;
    function innerBounds(m){const sw=L.point(0+m,heightPx-m),ne=L.point(widthPx-m,0+m);return L.latLngBounds(map.unproject(sw,maxNativeZoom),map.unproject(ne,maxNativeZoom));}

    const SCALE_RATIO = 0.95;

    function updateCustomScale() {
      const zoom = map.getZoom();
      const scaleFactor = Math.pow(2, zoom - maxNativeZoom);
      const metersPerPixel = SCALE_RATIO / scaleFactor;

      const zoomScales = {
        [maxNativeZoom - 5]: 16000,
        [maxNativeZoom - 4]: 8000,
        [maxNativeZoom - 3]: 4000,
        [maxNativeZoom - 2]: 2000,
        [maxNativeZoom - 1]: 1000,
        [maxNativeZoom]: 500,
        [maxNativeZoom + 1]: 200,
        [maxNativeZoom + 2]: 100,
      };

      let targetMeters = zoomScales[zoom];
      if (targetMeters === undefined) {
        const keys = Object.keys(zoomScales).map(k => parseInt(k));
        const closest = keys.reduce((a, b) =>
          Math.abs(b - zoom) < Math.abs(a - zoom) ? b : a
        );
        targetMeters = zoomScales[closest];
      }

      const pxLength = targetMeters / metersPerPixel;

      const scaleEl = document.getElementById("custom-scale");
      if (scaleEl) {
        scaleEl.style.width = `${pxLength}px`;
        scaleEl.querySelector("span").textContent =
          targetMeters >= 1000 ? `${(targetMeters / 1000).toFixed(0)} km` : `${targetMeters} m`;
      }
    }

    const scaleDiv = L.control({ position: 'bottomleft' });
    scaleDiv.onAdd = () => {
      const div = L.DomUtil.create('div', 'custom-scale');
      div.id = 'custom-scale';
      div.innerHTML = '<div class="bar"></div><span></span>';
      return div;
    };
    scaleDiv.addTo(map);

    map.on('zoom', updateCustomScale);
    updateCustomScale();


    L.tileLayer(`${TILE_BASE}/{z}/{x}/{y}.png`,{tileSize,minNativeZoom,maxNativeZoom,maxZoom:maxNativeZoom+2,noWrap:true,bounds:fullBounds,crossOrigin:true,referrerPolicy:"no-referrer"}).addTo(map);
    function applyBounds(){const ib=innerBounds(MARGIN);map.setMaxBounds(ib);map.panInsideBounds(ib,{animate:false});}
    map.fitBounds(innerBounds(MARGIN),{animate:false});applyBounds();map.on('zoomend resize',applyBounds);

    let TileMapInfo;
    const tileInfoReady = fetch('./TileMapInfo.json').then(r=>{ if(!r.ok) throw new Error('TileMapInfo'); return r.json(); }).then(info => (TileMapInfo = info));
    const QS = new URLSearchParams(location.search);
    const OX = parseFloat(QS.get('ox') ?? '0');
    const OY = parseFloat(QS.get('oy') ?? '0');
    const SX = parseFloat(QS.get('sx') ?? '1');
    const SY = parseFloat(QS.get('sy') ?? '1');
    
    const $search = document.getElementById("search");
    const $results = document.getElementById("results");
    const $analysisHUD = document.getElementById("analysisHUD");

    const BRAND_DISPLAY = { renault: 'Renault Trucks', daf: 'DAF', mercedes: 'Mercedes-Benz', volvo : 'Volvo Trucks' };
    function brandLabel(key){
      const k = String(key||'').trim().toLowerCase();
      if (!k) return '';
      if (BRAND_DISPLAY[k]) return BRAND_DISPLAY[k];
      return k.charAt(0).toUpperCase() + k.slice(1);
    }
    function brandsText(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      return arr.map(brandLabel).join(', ');
    }

    let _resIdx = -1;
    function highlightResult(i){
      const items=[...$results.querySelectorAll('.result-item')];
      items.forEach((el,idx)=> el.style.background = idx===i ? "#101926" : "");
    }
    $search.addEventListener('keydown', e=>{
      const items=[...$results.querySelectorAll('.result-item')];
      if(!items.length) return;
      if(e.key==="ArrowDown"){ e.preventDefault(); _resIdx=Math.min(_resIdx+1, items.length-1); highlightResult(_resIdx); }
      if(e.key==="ArrowUp"){ e.preventDefault(); _resIdx=Math.max(_resIdx-1, 0); highlightResult(_resIdx); }
      if(e.key==="Enter" && _resIdx>=0){ items[_resIdx].click(); }
    });

    function dealerBrandKeyFrom(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      const raw = String(arr[0] || "").toLowerCase().trim();
      if (!raw) return "";
      const MAP = { "renault trucks": "renault", "DAF": "daf", "mercedes-benz": "mercedes", "volvo trucks": "volvo" };
      const canonical = MAP[raw] || raw;
      return canonical.replace(/trucks?|camions?/g, "").replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
    }

    function addSectionBlock(typeKey, label){
      const head = document.createElement("div");
      head.className = "result-sechead";
      const labelMap = {
        "Ville": t("villes"),
        "Monument": t("emblematic"),
        "Atelier": t("repair_shops"),
        "Agence": t("agencies"),
        "Concessionnaire": t("dealers"),
        "Entreprise": t("companies"),
        "Centre commercial": t("malls")
      };
      head.textContent = labelMap[typeKey] || label;
      $results.appendChild(head);

      const body = document.createElement("div");
      body.className = "result-secbody";
      $results.appendChild(body);
      return body;
    }

    window.addEventListener('keydown', e=>{
      if(document.getElementById("linePreviewWrap")?.style.display!=="block") return;
      if(!currentSelectedKey) return;
      const route = (()=> {
        const [lu,ru]=currentSelectedKey.split(":");
        const line=DBUS_LINES.find(l=>l.uid===lu); if(!line) return null;
        return line.routes.find(r=>r.uid===ru);
      })();
      if(!route) return;

      const ids=(route.stops||[]).map(s=>s.uid);
      const idx = ids.indexOf(currentActiveStopId);
      if(e.key==="ArrowRight" && idx>=0 && idx<ids.length-1){
        const nextId = ids[idx+1];
        const st=DBUS_STOPS.get(nextId);
        if(st?.latlng) centerWithPreview(st.latlng);
        setTimeout(()=> dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx+1]?.openPopup?.(), 120);
        setActiveStopById(nextId);
      }
      if(e.key==="ArrowLeft" && idx>0){
        const prevId = ids[idx-1];
        const st=DBUS_STOPS.get(prevId);
        if(st?.latlng) centerWithPreview(st.latlng);
        setTimeout(()=> dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx-1]?.openPopup?.(), 120);
        setActiveStopById(prevId);
      }
    });


    function applyXY(x, y){ return { x: x * SX + OX, y: y * SY + OY }; }
    function toLatLng(X,Y){
      const px=(X-TileMapInfo.x1)/(TileMapInfo.x2-TileMapInfo.x1)*widthPx;
      const py=(Y-TileMapInfo.y1)/(TileMapInfo.y2-TileMapInfo.y1)*heightPx;
      return map.unproject([px,py],maxNativeZoom);
    }
    function fromLatLngToXY(latlng){
      const pt = map.project(latlng, maxNativeZoom);
      const X = (pt.x/widthPx) * (TileMapInfo.x2 - TileMapInfo.x1) + TileMapInfo.x1;
      const Y = (pt.y/heightPx) * (TileMapInfo.y2 - TileMapInfo.y1) + TileMapInfo.y1;
      return { X, Y };
    }

    const transitScroll = document.querySelector(".transit-scroll");
    if (transitScroll) {
      transitScroll.addEventListener("wheel", function (e) {
        if (e.shiftKey) return;
        e.preventDefault();
        transitScroll.scrollLeft += e.deltaY;
      }, { passive: false });
    }

    const cityLayer=L.layerGroup().addTo(map);
    const cityMarkers=[],searchIndex=[];
    let selectedCityMarker = null;

    const $btnDbus = document.getElementById("btnDbus");
    const $panelDbus = document.getElementById("dbusPanel");
    const $dbusList = document.getElementById("dbusList");
    const $selectedChip = document.getElementById("selectedChip");
    
    map.on('mousemove', (e) => {
      if (!$analysisHUD) return;
      try{
        const { X, Y } = fromLatLngToXY(e.latlng);
        $analysisHUD.textContent = `X: ${X.toFixed(2)}  Y: ${Y.toFixed(2)}`;
      }catch{}
    });

    function wikiTitleForCity(name){
      const m = /^Paris\s+(\d{1,2})(?:er|e|eme|Ã¨me|th|st|nd|rd)?$/i.exec(String(name||"").trim());
      if (m){
        const n = parseInt(m[1], 10);
        if (LANG === "en"){
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }
      return String(name||"").replaceAll(" ", "_");
    }
    function normalizeParisArrondissement(title){
      const s0 = String(title || "");

      if (/\barrondissement_(de|of)_Paris\b/i.test(s0)) return s0;

      const s = s0
        .replace(/ /g, "_")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");

      let m = /^(\d{1,2})(?:er|e|eme)?_arrondissement_(?:de|of)_paris$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      m = /^paris_(\d{1,2})(?:er|e|eme)?$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      m = /^paris_(\d{1,2})(?:er|e|eme)?_arrondissement$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      return s0;
    }
    async function fetchWikiSummary(title){
      const url = (LANG==="en" ? "https://en.wikipedia.org/api/rest_v1/page/summary/" : "https://fr.wikipedia.org/api/rest_v1/page/summary/") + encodeURIComponent(title);
      const r = await fetch(url); if (!r.ok) throw new Error("wiki fetch"); return r.json();
    }

    function escapeHTML(s){
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function trimAroundRER(s, mode ){
      const txt = String(s || "").trim();
      if (!/\bRER\b/i.test(txt)) return txt;
      if (mode === 'start'){
        const m = txt.match(/^(.*?)\s*[â€“â€”-]\s*RER\b/i);
        return (m && m[1]) ? m[1].trim() : txt;
      } else {
        const m = txt.match(/\bRER\b\s*[â€“â€”-]\s*(.+)$/i);
        return (m && m[1]) ? m[1].trim() : txt;
      }
    }

    function decodeHTML(s){
      const t = document.createElement('textarea');
      t.innerHTML = String(s ?? "");
      return t.value;
    }

    function withRERIcon(text, opts = {}){ const caseInsensitive = !!opts.caseInsensitive;
      const esc = escapeHTML(text ?? "");
      const flags = caseInsensitive ? "gi" : "g";
      return esc
        .replace(new RegExp("(?:\\s*[---]\\s*)?\\bRER\\b(?:\\s*[---]\\s*)?", flags),
                ' <span class="rer-ico" aria-label="RER"></span> ')
        .replace(/\s{2,}/g, " ")
        .trim();
    }

    async function openCityPopup(cityObj, marker) {
      const latlng = marker.getLatLng();
      let rawTitle = normalizeParisArrondissement(wikiTitleForCity(cityObj.Name));
      const p = L.popup({ maxWidth: 380, autoPan: true })
        .setLatLng(latlng)
        .setContent(`<b>${cityObj.Name}</b><br><span class="spinner" aria-label="${t('loading')}"></span>`).openOn(map);
      try {
        const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
          try {
            const d0 = await fetchWikiSummary(baseTitle);
            if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
          } catch {}
          const sufList = (LANG === "en")
            ? [",_Val-de-Marne", ",_Essonne", ",_Hauts-de-Seine", ",_Seine-Saint-Denis",
              ",_Val-d'Oise", ",_Seine-et-Marne", ",_Yvelines"]
            : ["_(Commune_franÃ Â§aise)", "_(Val-de-Marne)", "_(Essonne)", "_(Hauts-de-Seine)",
              "_(Seine-Saint-Denis)", "_(Val-d'Oise)", "_(Seine-et-Marne)", "_(Yvelines)"];

          for (const suf of sufList) {
            try {
              const d = await fetchWikiSummary(baseTitle + suf);
              if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
            } catch {}
          }
          return { title: baseTitle, data: null };
        })(rawTitle);

        const pageUrl = wikiBase() + finalTitle;
        const desc = data?.description || "";
        const img = data?.thumbnail?.source || "";
        const html = data ? `
          <div style="display:flex;gap:10px;align-items:flex-start">
            ${img ? `<img src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
            <div style="min-width:0">
              <div style="font-weight:700;margin-bottom:4px">${cityObj.Name}</div>
              <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${desc}</div>
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
            </div>
          </div>` :
          `<div style="min-width:0">
            <div style="font-weight:700;margin-bottom:6px">${cityObj.Name}</div>
            <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
          </div>`;
        p.setContent(html);
      } catch {}
    }

    tileInfoReady.then(()=> fetch("Cities.json")).then(r=>r.json()).then(cities=>{
      cities.forEach(city=>{
        const icon=L.divIcon({className:"",html:`<span class="city-label">${city.Name}</span>`,iconSize:[0,0]});
        const m=L.marker(toLatLng(city.X,city.Y),{icon,interactive:true,bubblingMouseEvents:true}).addTo(cityLayer);
        m.on("click", ()=> openCityPopup(city, m));
        cityMarkers.push(m);
        searchIndex.push({type:"Ville",name:city.Name||"Ville",city:"",center:m.getLatLng(),open:()=>openCityPopup(city, m)});
      });
      updateCityLabels();
    }).catch(err=>console.error("Erreur chargement Cities.json",err));

    function updateCityLabels(){
      const zMin=map.getMinZoom(),zMax=map.getMaxZoom(),z=map.getZoom(),SMALL=8,LARGE=20,t=(z-zMin)/Math.max(1,(zMax-zMin)),px=Math.round(SMALL+t*(LARGE-SMALL));
      cityMarkers.forEach(m=>{const el=m.getElement();if(!el)return;const span=el.querySelector(".city-label");if(!span)return;span.style.fontSize=px+"px";span.style.opacity=(t<0.05)?0.8:1;});
    }
    map.on("zoomend",updateCityLabels);

    const DEDUPE_MIN_PX_BASE = 100;
    const _placedByIcon = new Map();
    function _isTooClose(iconId, latlng, minPx){
      const pt = map.project(latlng, maxNativeZoom);
      const list = _placedByIcon.get(iconId) || [];
      for(const p of list){ const dx = pt.x - p.x, dy = pt.y - p.y; if (Math.hypot(dx, dy) < minPx) return true; }
      list.push({x: pt.x, y: pt.y}); _placedByIcon.set(iconId, list); return false;
    }

    function bindPopupWithImage(layer, html){
      layer.bindPopup(html);
      layer.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => {
            try { e.popup.update(); } catch {}
          }, { once: true });
        }
      });
    }

    const homeBtn = L.control({ position: 'topleft' });

    homeBtn.onAdd = function(map) {
      const container = L.DomUtil.create('div', 'leaflet-bar leaflet-custom-home');
      const link = L.DomUtil.create('a', 'home-btn', container);
      link.innerHTML = '⟳'; 
      link.href = '#';
      link.title = t('home_tooltip');

      L.DomEvent.on(link, 'click', (e) => {
        L.DomEvent.stop(e);
        map.fitBounds(innerBounds(MARGIN), { animate: true });
        history.replaceState(null, "", location.pathname);
      });

      return container;
    };

    homeBtn.addTo(map);

    const ICON_NAMES = {
      "gas_ico": "Station service",
      "bus_ico": "Gare routiÃ¨re",
      "service_ico": "Atelier de réparation",
      "garage_large_ico": "Garage",
      "recruitment_ico": "Agence de recrutement",
      "dealer_ico": "Concessionnaire",
      "border_ico": "ContrÃ´le d'identité",
      "toll_ico": "Péage",
      "parking_ico": "Parking"
    };

    tileInfoReady
      .then(() => fetch("CentreCommerciaux.json"))
      .then(r => r.ok ? r.json() : Promise.reject("CentreCommerciaux.json"))
      .then(malls => {
        malls.forEach(ov => {
          const width = 32, height = 32;

          const centerLL = toLatLng(ov.X, ov.Y);
          const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
          const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
          const bounds = L.latLngBounds(topLeft, bottomRight);

          const key = "overlay_centrecom";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;

          const overlay = L.imageOverlay(`./Overlays/overlay_centrecom.png`, bounds, { interactive: true }).addTo(map);
          const popup = L.popup({ maxWidth: 420, autoPan: true });
          overlay.bindPopup(popup);

          overlay.on('popupopen', (e) => {
            const el = e.popup.getElement();
            const img = el && el.querySelector('img[data-autosize]');
            if (img && !img.complete) {
              img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
            }
          });

          const name = "Centre Commercial " + String(ov.Name || "").trim();
          const city = String(ov.City || "").trim();
          const wikiKey = String(ov.wiki || "").trim();

          overlay.on("click", async () => {
            const p = overlay.getPopup();
            p.setLatLng(bounds.getCenter());

            if (!wikiKey) {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
              overlay.openPopup();
              return;
            }

            p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b><br><span class="spinner" aria-label="${t('loading')}"></span></div>`);
            overlay.openPopup();

            try {
              const baseTitle = wikiTitleFrom(wikiKey);
              const { title: finalTitle, data } = await (async function resolveWikiSummary(title){
                try {
                  const d0 = await fetchWikiSummary(title);
                  if (d0?.type !== "disambiguation") return { title, data: d0 };
                } catch {}
                for (const suf of [
                  "_(Paris)", "_(ÃƒÆ’Ã…Â½le-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
                  "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
                  "_(Centre_commercial)", "_(Centre_commercial_en_France)"
                ]) {
                  try {
                    const d = await fetchWikiSummary(title + suf);
                    if (d?.type !== "disambiguation") return { title: title + suf, data: d };
                  } catch {}
                }
                return { title, data: null };
              })(baseTitle);

              const pageUrlFromAPI = data?.content_urls?.desktop?.page || null;
              const hasPage = !!pageUrlFromAPI;
              const desc = data?.description || "";
              const img = data?.thumbnail?.source || "";

              const linkHTML = hasPage
                ? `<a href="${pageUrlFromAPI}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>`
                : "";

              const html = data ? `
                <div style="display:flex;gap:10px;align-items:flex-start">
                  ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
                  <div style="min-width:0">
                    <div style="font-weight:700;margin-bottom:4px">${escapeHTML(name)}</div>
                    ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                    <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                    ${linkHTML}
                  </div>
                </div>` :
                `<div style="min-width:0">
                  <div style="font-weight:700;margin-bottom:6px">${escapeHTML(name)}</div>
                  ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
                </div>`;


              p.setContent(html);
            } catch {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
            }
          });

          searchIndex.push({
            type: "Centre commercial",
            name,
            city,
            center: bounds.getCenter(),
            open: () => { overlay.fire('click'); },
            logo: `./Overlays/overlay_centrecom.png`,
            fallbackLogo: `./Overlays/overlay_centrecom.png`
          });
        });
      })
      .catch(err => console.error("CentreCommerciaux.json error:", err));

    tileInfoReady.then(()=> fetch("Overlays.json")).then(r=>r.json()).then(overlays=>{
      overlays.forEach(ov=>{
        let width=ov.Width, height=ov.Height;
        if(ov.IconId==="bus_ico"){ width=32; height=32; }
        const centerLL = toLatLng(ov.X, ov.Y);

        if(!ov.IconId) return;
        if(
          ov.IconId.startsWith("bus_") && ov.IconId !== "bus_ico" ||
          ov.IconId.startsWith("uk_")  ||
          ov.IconId.startsWith("fr_")  ||
          ov.IconId.startsWith("b_")   ||
          ov.IconId.startsWith("bg_")  ||
          ov.IconId.startsWith("train_ico")  ||
          ov.IconId.startsWith("port_overlay")  ||
          ov.IconId.startsWith("d334p")  ||
          ov.IconId.startsWith("viewpoint")
        ){ return; }

        const isCompany = (ov.Type === "Company");

        if (!isCompany) {
          const key = ov.IconId || ov.Type || "__misc";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width||0, height||0) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;
        }

        const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
        const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
        const bounds = L.latLngBounds(topLeft, bottomRight);

       if (ov.Type==="Company"){
        const compTopLeft=toLatLng(ov.X,ov.Y), compBottomRight=toLatLng(ov.X+20,ov.Y-20);
        const compBounds=L.latLngBounds(compTopLeft,compBottomRight);
        const overlay=L.imageOverlay(`./Overlays/button.png`,compBounds,{interactive:true}).addTo(map);

        const logoPath = `./Overlays/${ov.IconId}.png`;

        bindPopupWithImage(overlay, `
          <div style="text-align:center">
            <img data-autosize src="${logoPath}"
                style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
            <b>${escapeHTML(ov.Name)}</b><br/><i>${escapeHTML(ov.City||"")}</i>
          </div>
        `);

        searchIndex.push({
          type:"Entreprise",
          name:ov.Name||"Entreprise",
          city:ov.City||"",
          center:compBounds.getCenter(),
          open:()=>{ overlay.openPopup(compBounds.getCenter()); },
          logo:logoPath
        });
      } else if (ov.Type === "TruckDealer" || ov.IconId === "dealer_ico") {
            const overlay = L.imageOverlay(`./Overlays/${ov.IconId}.png`, bounds, { interactive: true }).addTo(map);
            const btxt = brandsText(ov) || 'ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â';
            const titleLine = `Concessionnaire ${escapeHTML(btxt)}`;

            const brandKey = dealerBrandKeyFrom(ov);
            const brandLogo = brandKey ? `./Overlays/dealer_${brandKey}.png` : `./Overlays/dealer_ico.png`;

            bindPopupWithImage(overlay, `
              <div style="text-align:center">
                <img data-autosize src="${brandLogo}"
                    style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
                <b>${escapeHTML(titleLine)}</b><br/><i>${escapeHTML(ov.City || "")}</i>
              </div>
            `);

            overlay.on("click", () => { overlay.openPopup(bounds.getCenter()); });

            searchIndex.push({
              type: "Concessionnaire",
              name: `${btxt}`.trim(),         
              brand: btxt,                   
              city: ov.City || "",
              center: bounds.getCenter(),
              open: () => { overlay.openPopup(bounds.getCenter()); },
              logo: brandLogo,
              fallbackLogo: `./Overlays/dealer_ico.png`
            });
          
        } else {
           const label = ICON_NAMES[ov.IconId] || ov.Name || ov.Type || "Lieu";
          const overlay = L.imageOverlay(`./Overlays/${ov.IconId}.png`, bounds, { interactive: true })
            .addTo(map)
            .bindPopup(`<b>${escapeHTML(label)}</b>`);

          const typeTag =
            ov.IconId === "service_ico"       ? "Atelier" :
            ov.IconId === "recruitment_ico"   ? "Agence"  :
            ov.IconId === "garage_large_ico"  ? "Garage"  :
            null;

          if (typeTag) {
            const logoPath =
              ov.IconId === "service_ico"      ? `./Overlays/service_ico.png` :
              ov.IconId === "recruitment_ico"  ? `./Overlays/recruitment_ico.png` :
              ov.IconId === "garage_large_ico" ? `./Overlays/garage_large_ico.png` :
              `./Overlays/${ov.IconId}.png`;

            const keywordName =
              typeTag === "Atelier" ? `Atelier de réparation ${ov.City || ""}` :
              typeTag === "Agence"  ? `Agence de recrutement ${ov.City || ""}` :
                          `Garage ${ov.City || ""}`;

            searchIndex.push({
              type: typeTag,               
              name: keywordName.trim(),    
              city: ov.City || "",
              center: bounds.getCenter(),
              open: () => { overlay.openPopup(bounds.getCenter()); },
              logo: logoPath,
              fallbackLogo: logoPath
            });
          }
        }
      });
    });

    function wikiTitleFrom(urlOrTitle){
      const s = String(urlOrTitle||"").trim();
      try{
        const u = new URL(s);
        const m = /\/wiki\/(.+)$/.exec(u.pathname);
        return m ? decodeURIComponent(m[1]) : s.replaceAll(" ", "_");
      }catch{
        return s.replaceAll(" ", "_");
      }
    }


  tileInfoReady
  .then(() => fetch("Monuments.json"))
  .then(r => r.ok ? r.json() : Promise.reject("Monuments.json"))
  .then(monuments => {
    monuments.forEach(ov => {
      const width = 32, height = 32;

      const centerLL = toLatLng(ov.X, ov.Y);
      const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
      const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
      const bounds = L.latLngBounds(topLeft, bottomRight);

      const key = "overlay_monument";
      const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
      if (_isTooClose(key, centerLL, minPx)) return;

      const overlay = L.imageOverlay(`./Overlays/overlay_monument.png`, bounds, { interactive: true }).addTo(map);
      const popup = L.popup({ maxWidth: 420, autoPan: true });
      overlay.bindPopup(popup);

      overlay.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
        }
      });

      const name = String(ov.Name || "").trim();
      const city = String(ov.City || "").trim();
      const wikiTitle = wikiTitleFrom(ov.wiki || ov.IconId || name);

      overlay.on("click", async () => {
        const p = overlay.getPopup();
        p.setLatLng(bounds.getCenter());
        p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b><br><span class="spinner" aria-label="${t('loading')}"></span></div>`);
        overlay.openPopup();

        try {
          const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
            try {
              const d0 = await fetchWikiSummary(baseTitle);
              if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
            } catch {}
            for (const suf of [
              "_(Paris)", "_(ÃƒÆ’Ã…Â½le-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
              "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
              "_(Monument)"
            ]) {
              try {
                const d = await fetchWikiSummary(baseTitle + suf);
                if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
              } catch {}
            }
            return { title: baseTitle, data: null };
          })(wikiTitle);

          const pageUrl = wikiBase() + finalTitle;
          const desc = data?.description || "";
          const img = data?.thumbnail?.source || "";

          const html = data ? `
            <div style="display:flex;gap:10px;align-items:flex-start">
              ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
              <div style="min-width:0">
                <div style="font-weight:700;margin-bottom:4px">${escapeHTML(name)}</div>
                ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
              </div>
            </div>` :
            `<div style="min-width:0">
              <div style="font-weight:700;margin-bottom:6px">${escapeHTML(name)}</div>
              ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
            </div>`;

          p.setContent(html);
        } catch {
          p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
        }
      });

      searchIndex.push({
        type: "Monument",
        name,
        city,
        center: bounds.getCenter(),
        open: () => { 
          const p = overlay.getPopup();
          if (p) { p.setLatLng(bounds.getCenter()); }
          overlay.fire('click');
        },
        logo: `./Overlays/overlay_monument.png`,
        fallbackLogo: `./Overlays/overlay_monument.png`
      });
    });
  })
  .catch(err => console.error("Monuments.json error:", err));


      
    function applyInitialView() {
      const qs = new URLSearchParams(location.search);
      const x = parseFloat(qs.get("x"));
      const y = parseFloat(qs.get("y"));
      const z = parseFloat(qs.get("z"));

      if (Number.isFinite(x) && Number.isFinite(y)) {
        const ll = toLatLng(x, y);

        const ib = innerBounds(MARGIN);
        const clamped = L.latLng(
          Math.max(Math.min(ll.lat, ib.getNorth()), ib.getSouth()),
          Math.max(Math.min(ll.lng, ib.getEast()),  ib.getWest())
        );

        const targetZoom = Number.isFinite(z)
          ? Math.max(map.getMinZoom(), Math.min(map.getMaxZoom(), z))
          : map.getZoom();

        map.setView(clamped, targetZoom, { animate: false });
      }
    }

    tileInfoReady.then(() => { applyInitialView(); });

    const routeAnimHandles = new Map();
    function animatePolyline(poly, { speed = 1.2, dash = "14 10", reverse = false } = {}) {
      const apply = (path) => {
        path.style.strokeDasharray = dash;
        let offset = 0, raf = 0;
        const tick = () => { offset = (offset + speed) % 10000; path.style.strokeDashoffset = reverse ? String(-offset) : String(offset); raf = requestAnimationFrame(tick); };
        tick();
        return () => { cancelAnimationFrame(raf); path.style.strokeDasharray = ""; path.style.strokeDashoffset = ""; };
      };
      let stopFn = null;
      if (poly._path) { stopFn = apply(poly._path); }
      else { poly.once("add", () => { if (poly._path) stopFn = apply(poly._path); }); }
      return { stop: () => { try { stopFn && stopFn(); } catch {} } };
    }
    function startLineAnim(key, poly) { stopLineAnim(key); const h = animatePolyline(poly, { speed: 0.1, dash: "30 10", reverse: true }); routeAnimHandles.set(key, h); }
    function stopLineAnim(key) { const h = routeAnimHandles.get(key); if (h) { h.stop(); routeAnimHandles.delete(key); } }

    const dbusRoot = "DBus/IDF MAP";
    const dbusLayers = L.layerGroup().addTo(map);
    const dbusRouteLayers = new Map();
    let currentSelectedKey = "";

    async function fetchXml(path){
      const res = await fetch(path);
      if(!res.ok) throw new Error("XML load failed: "+path);
      const txt = await res.text();
      const parser = new DOMParser();
      return parser.parseFromString(txt, "text/xml");
    }

    let DBUS_STOPS = new Map();
    async function loadStops(){
      await tileInfoReady;
      const xml = await fetchXml(`${dbusRoot}/stops.xml`);
      const nodes = [...xml.querySelectorAll("busstops > busstop")];
      DBUS_STOPS = new Map(nodes.map(node=>{
        const id = parseInt(node.querySelector("id")?.textContent.trim()||"0",10);
        const name = (node.querySelector("name")?.textContent||"").trim();
        const locRaw = (node.querySelector("location")?.textContent||"").trim();
        const parts = locRaw.split(";").map(x=>parseFloat(x));

        const X = parts[0] ?? 0;
        const Y = parts[1] ?? 0;
        const Z = parts[2] ?? 0;
        const rotX = parts[3] ?? 0;
        const rotY = parts[4] ?? 0;

        const latlng = toLatLng(X, Z);
        return [id, {id, name, X, Y, Z, rotX, rotY, latlng}];
      }));
    }

    let DBUS_LINES = [];
    async function loadLines(){
      const xml = await fetchXml(`${dbusRoot}/lines.xml`);
      DBUS_LINES = [...xml.querySelectorAll("lines > line")].map(line=>{
        const lineUid = line.getAttribute("uid");
        const number  = line.getAttribute("number") || "?";

        const routes = [...line.querySelectorAll(":scope > route")].map(rt=>{
          const rUid  = rt.getAttribute("uid");
          const rName = rt.getAttribute("name") || "";
          const stops = [...rt.querySelectorAll(":scope > busstop")].map(b => {
            return {
              uid: parseInt(b.getAttribute("uid"), 10),
              nextStopTime: parseInt(b.getAttribute("nextStopTime") || "0", 10)
            };
          });

          const totalMinutes = stops.reduce((sum, s) => sum + (s.nextStopTime || 0), 0);

          return { uid: rUid, name: rName, stops, totalMinutes };
        });

        return { uid: lineUid, number, routes };
      });
    }


    const BUS_COLORS = [getComputedStyle(document.documentElement).getPropertyValue('--busA').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busB').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busC').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busD').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busE').trim()];
    function colorFor(index){ return BUS_COLORS[index % BUS_COLORS.length] || "#3aa0ff"; }

    async function getTwoDominantColors(src){
      return new Promise(resolve => {
        const img = new Image(); img.crossOrigin = "anonymous"; img.src = src;
        img.onload = () => {
          const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d");
          canvas.width  = img.naturalWidth; canvas.height = img.naturalHeight;
          ctx.drawImage(img, 0, 0);
          const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
          const counts = {}; let whiteCount = 0; let blackCount = 0;
          const STEP = 16, WHITE_LUM = 0.92, BLACK_LUM = 0.08;
          for (let i = 0; i < data.length; i += 4*STEP) {
            const a = data[i+3]; if (a < 128) continue;
            const r = data[i], g = data[i+1], b = data[i+2];
            const lum = (0.299*r + 0.587*g + 0.114*b) / 255;
            if (lum > WHITE_LUM) { whiteCount++; continue; }
            if (lum < BLACK_LUM) { blackCount++; continue; }
            const rq = r >> 4, gq = g >> 4, bq = b >> 4;
            const key = `${rq},${gq},${bq}`; counts[key] = (counts[key] || 0) + 1;
          }
          const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
          let bg = "#444"; if (entries.length) { const [rq,gq,bq] = entries[0][0].split(",").map(v => (parseInt(v,10) << 4) + 8); bg = `rgb(${rq},${gq},${bq})`; }
          const text = (whiteCount >= blackCount) ? "#fff" : "#000";
          resolve([bg, text]);
        };
        img.onerror = () => resolve(["#444","#fff"]);
      });
    }

    function isNoctilien2(input){
      const num = typeof input === 'string' ? input : input?.number;
      return /^N\d+$/.test(String(num || "").trim().toUpperCase());
    }

    const LINE_COLOR_CACHE = new Map();
    function getLineColors(number){
      const n = String(number || "").trim();
      if (isNoctilien2(n)) return Promise.resolve(["#080080", "#FFFFFF"]);

      const STYLE_LC = getLineColors.STYLE_LC || (
        getLineColors.STYLE_LC = Object.fromEntries(
          Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
        )
      );
      const hit = STYLE_LC[n.toLowerCase()];
      if (hit) return Promise.resolve(hit);

      const key = n.toLowerCase();
      const hash = Math.abs([...key].reduce((h,c)=>((h<<5)-h + c.charCodeAt(0))|0,0));
      const i = (/^\d+$/.test(n) ? (parseInt(n,10) % BUS_COLORS.length) : (hash % BUS_COLORS.length));
      const bg = BUS_COLORS[i] || "#3aa0ff";
      const text = (() => {
        const m = /^#?([0-9a-f]{6})$/i.exec(bg); if(!m) return "#fff";
        const x = parseInt(m[1],16);
        const r=(x>>16)&255, g=(x>>8)&255, b=x&255;
        const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
        return L > 0.6 ? "#000" : "#fff";
      })();
      return Promise.resolve([bg, text]);
    }


    function noctilienStripeColor(number){
      const DEFAULT = "#080080";
      const n = String(number||"").trim();
      if (LINE_STYLES[n] && LINE_STYLES[n][0]) return LINE_STYLES[n][0];
      return DEFAULT;
    }

    function ensureStripe(badgeEl, color){
      badgeEl.style.position = "relative";
      const old = badgeEl.querySelector(".noctilien-stripe");
      if (old) old.remove();
      const stripe = document.createElement("div");
      stripe.className = "noctilien-stripe";
      stripe.style.position = "absolute";
      stripe.style.left = "0";
      stripe.style.right = "0";
      stripe.style.bottom = "0";
      stripe.style.height = "6px";
      stripe.style.borderBottomLeftRadius = "8px";
      stripe.style.borderBottomRightRadius = "8px";
      stripe.style.background = color;
      badgeEl.appendChild(stripe);
    }

    function parseRouteName(name){
      const raw = String(name || "").trim();

      const hasColon = raw.includes(":");
      const parts = hasColon ? raw.split(":") : [raw];

      let flag = null;
      const flagMatch = parts[0].match(/\(([^)]+)\)/);
      if (flagMatch) flag = flagMatch[1].trim();

      let lineNumber = parts[0]
        .replace(/\s*\([^)]*\)/g, "")
        .trim();

      let routeTitle;
      if (hasColon) {
        routeTitle = raw.substring(raw.indexOf(":") + 1).trim();
      } else {
        routeTitle = raw;
      }

      return { lineNumber, routeTitle, flag };
    }

    function ensureFictiveStripe(badgeEl) {
      badgeEl.classList.add("fictive");
      const old = badgeEl.querySelector(".fictive-stripe");
      if (old) old.remove();

      const stripe = document.createElement("div");
      stripe.className = "fictive-stripe";
      stripe.textContent = "FICTIF";
      badgeEl.appendChild(stripe);
    }

    function ensureBadgeLabel(badgeEl, text){
      if (!badgeEl) return null;
      let label = badgeEl.querySelector(".badge-label");
      if (!label){
        label = document.createElement("span");
        label.className = "badge-label";
        badgeEl.appendChild(label);
      }
      if (typeof text === "string") {
        label.textContent = text;
      }
      return label;
    }

    function makeLineBadge(number, bg="#444", text="#fff", size="72x32", stripeColor=null, isFictive=false) {
      const [w,h] = size.split("x").map(v=>parseInt(v,10));
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.style.width = w+"px"; 
      badge.style.height = h+"px";
      badge.style.borderRadius = "8px";
      badge.style.display = "flex";
      badge.style.alignItems = "center";
      badge.style.justifyContent = "center";
      badge.style.fontWeight = "800";
      badge.style.background = bg; 
      badge.style.color = text;
      badge.style.textShadow = "0 1px 2px rgba(0,0,0,.35)";
      badge.style.position = "relative";
      const labelText = String(number||"").trim();
      const labelSpan = ensureBadgeLabel(badge, labelText);

      let fontSize = h * 0.6;
      labelSpan.style.fontSize = fontSize + "px";

      document.body.appendChild(badge);
      while (labelSpan.scrollWidth > badge.clientWidth && fontSize > 6) {
        fontSize -= 7;
        labelSpan.style.fontSize = fontSize + "px";
      }
      document.body.removeChild(badge);

      if (stripeColor) ensureStripe(badge, stripeColor);
      if (isFictive) ensureFictiveStripe(badge);
      return badge;
    }

    function createNetworkBadgeElement({ label, imgSrc, alt, colorKey, chipClass = "dbus-badge network-chip", stripeColor = null, invertLogo = false }) {
      const wrap = document.createElement("div");
      wrap.className = "network-badge";

      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = alt;
      if (invertLogo) img.classList.add("network-logo-invert");
      wrap.appendChild(img);

      const [bg, text] = getLineColorsSync(colorKey || label);
      const chip = document.createElement("div");
      chip.className = chipClass;
      chip.dataset.chipRole = "line";
      chip.dataset.networkBadge = "true";
      chip.textContent = label;
      chip.style.background = bg;
      chip.style.color = text;
      wrap.appendChild(chip);

      if (stripeColor) ensureStripe(chip, stripeColor);

      return { wrap, chip };
    }

    function networkBadgeHTML({ label, imgSrc, alt, colorKey, chipClass = "dbus-badge network-chip", stripeColor = null, invertLogo = false }) {
      const [bg, text] = getLineColorsSync(colorKey || label);
      const stripe = stripeColor ? `<div class="noctilien-stripe" style="background:${stripeColor}"></div>` : "";
      return `
        <div class="network-badge">
          <img src="${imgSrc}" alt="${escapeHTML(alt)}" ${invertLogo ? 'class="network-logo-invert"' : ''}/>
          <div class="${chipClass}" data-chip-role="line" data-network-badge="true" style="background:${bg};color:${text};">
            ${escapeHTML(label)}
            ${stripe}
          </div>
        </div>
      `;
    }

    function trimByDash(s, mode){
      const txt = String(s || "").trim();
      const parts = txt.split(/\s*[---]\s*/).filter(Boolean);
      if (parts.length < 2) return txt;
      return (mode === 'start') ? parts[0].trim() : parts[parts.length - 1].trim();
    }

    function cleanRERLabel(label){
      return String(label ?? "").replace(/\s*[---]\s*RER\b/gi, " RER");
    }

    function withRERIconInStop(text){
      const esc = escapeHTML(text ?? "");
      return esc.replace(/\s*[---]?\s*RER\s*[---]?\s*/gi,
        ' <span class="rer-ico" aria-label="RER"></span> ');
    }

    function splitRouteEndpoints(routeTitle){
      const s = decodeHTML(String(routeTitle || "").trim());
      const parts = s.split(/\s*(?:>|ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬â„¢|ÃƒÂ¢Ã¢â‚¬Â Ã¢â‚¬Â|ÃƒÂ¢Ã¢â‚¬Â¡Ã¢â‚¬Å¾|<->|->|\bvers\b|\bto\b)\s*/i).filter(Boolean);
      if (parts.length >= 2){ return [parts[0].trim(), parts[parts.length-1].trim()]; }
      return [s, s];
    }

    function getLineColorsSync(number){
      const n = String(number || "").trim();

      if (isNoctilien2(n)) return ["#080080", "#FFFFFF"];

      const STYLE_LC = Object.fromEntries(
        Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
      );
      const hit = STYLE_LC[n.toLowerCase()];
      if (hit) return hit;

      const key = n.toLowerCase();
      const hash = Math.abs([...key].reduce((h,c)=>((h<<5)-h + c.charCodeAt(0))|0,0));
      const i = (/^\d+$/.test(n) ? (parseInt(n,10) % BUS_COLORS.length) : (hash % BUS_COLORS.length));
      const bg = BUS_COLORS[i] || "#3aa0ff";

      const m = /^#?([0-9a-f]{6})$/i.exec(bg);
      if (!m) return [bg, "#fff"];
      const x = parseInt(m[1],16);
      const r=(x>>16)&255, g=(x>>8)&255, b=x&255;
      const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
      const text = L > 0.6 ? "#000" : "#fff";

      return [bg, text];
    }


    function drawRoute(lineIdx, line, route){
      const key = `${line.uid}:${route.uid}`;
      if(dbusRouteLayers.has(key)) return dbusRouteLayers.get(key);

      const group = L.layerGroup().addTo(dbusLayers);
      const poly  = L.polyline([], {color: colorFor(lineIdx), weight:8, opacity:1}).addTo(group);

      const latlngs = route.stops.map(s => DBUS_STOPS.get(s.uid)?.latlng).filter(Boolean);

      if (latlngs.length >= 2){
        poly.setLatLngs(latlngs);
        startLineAnim(key, poly);
      }

      const effNum = getLineNumber(line, route);
      getLineColors(effNum).then(([bg])=>{ if(bg) poly.setStyle({color:bg}); });

      const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
      const routeTitleRaw = routeTitle;
      const [titleStart0, titleEnd0] = splitRouteEndpoints(routeTitleRaw);
      const titleStart = trimAroundRER(titleStart0, 'start');
      const titleEnd   = trimAroundRER(titleEnd0,   'end');

      const lineCategory = getCategory(line);
      const stops = route.stops.map((s, idx, arr)=> {
        const id = s.uid;
        const st = DBUS_STOPS.get(id);
        const isFirst = (idx===0), isLast=(idx===arr.length-1);
        const n = String(line.number||"").trim();

        if (!st) return null;
        let displayName = st.name || "";

        if (isFirst) displayName = titleStart;
        if (isLast)  displayName = titleEnd;

        const isProvisoireStop = /\(provisoire\)/i.test(displayName);
        const cleanDisplayName = displayName.replace(/\s*\(provisoire\)\s*/i, "");
        const stopNameHTML = withRERIconInStop(cleanDisplayName);
        const coordParts = [st.X, st.Y, st.Z].map(v => Number(v).toFixed(2));
        const coordsDisplay = escapeHTML(coordParts.join(", "));
        const gotoCmd = `goto ${st.X.toFixed(2)};${st.Y.toFixed(2)};${st.Z.toFixed(2)};${st.rotX.toFixed(6)};${st.rotY.toFixed(6)}`;

        const { lineNumber } = parseRouteName(route.name || "");
        let cleanNum = String(lineNumber || "").trim();
        cleanNum = cleanNum.replace(/\s*\([^)]*\)/, "").trim();

        const [bg, text] = getLineColorsSync(cleanNum);
        getLineColors(cleanNum).then(([bg])=>{
          if(bg) poly.setStyle({color:bg});
        });
        
        const stopOrderLabel = `${idx+1} / ${arr.length}`;
        const html = `
          <div class="stop-popup">
            <div class="sp-header">
              <div class="sp-title">${stopNameHTML}${isProvisoireStop ? ' <span class="stop-flag" aria-label="Arrêt provisoire">Arrêt provisoire</span>' : ''}</div>
              <span>‎  ‎  ‎  ‎  </span>
              <div class="sp-index">${stopOrderLabel}</div>
            </div>
            <div class="sp-body">
              <div class="sp-coords">
                <span>Coordonnées</span>
                <div class="sp-coords-code">${coordsDisplay}</div>
              </div>
            </div>
          </div>`;

        const marker = L.marker(st.latlng, {
          icon: L.divIcon({
            className: "stop-number",
            html: `<div style="
              width:${isFirst || isLast ? 26 : 22}px;
              height:${isFirst || isLast ? 26 : 22}px;
              border-radius:50%;
              background:#fff;
              border:2px solid #000;
              display:flex;
              align-items:center;
              justify-content:center;
              font-size:12px;
              font-weight:700;
              color:#000;
            ">${idx+1}</div>`,
            iconSize: [isFirst || isLast ? 26 : 22, isFirst || isLast ? 26 : 22],
            iconAnchor: [(isFirst || isLast ? 26 : 22)/2, (isFirst || isLast ? 26 : 22)/2]
          })
        }).addTo(group).bindPopup(
          L.popup({ maxWidth: 420, autoPan: true }).setContent(html)
        );

        marker._routeKey = key;

        marker.on('click', ()=> {
          const stObj = DBUS_STOPS.get(id);
          if (stObj?.latlng) centerWithPreview(stObj.latlng, { zoom: map.getZoom() });
        });

        marker.on('popupopen', (e) => {
          setActiveStopById(id);
          if (marker._routeKey !== currentSelectedKey) {
            e.popup.remove();
            return;
          }
          const el = e.popup.getElement();
          if (!el) return;
          const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
          if (!chip) return;
          const isNetworkChip = chip.dataset?.networkBadge === "true";
          if (isNetworkChip) return;

          const { cleanNum } = parseRouteName(route.name || "")
           getLineColors(cleanNum).then(([bg, text]) => {
              const pop = marker.getPopup();
              if (!pop) return;
              const el = pop.getElement();
              if (!el) return;
              const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
              if (!chip) return;
              const isNetworkChip = chip.dataset?.networkBadge === "true";

              if (isNetworkChip) return;

              if (isNoctilien2(n)) {
                chip.style.background = "#080080";
                chip.style.color = text;
                if (!el.querySelector('.noctilien-stripe')) {
                  ensureStripe(chip, noctilienStripeColor(n));
                }
              } else {
                chip.style.background = bg;
                chip.style.color = text;
              }
            });

        });

        marker.on('popupclose', ()=>{
          if (currentActiveStopId === id) clearActiveStop();
        });

        getLineColors(cleanNum).then(([bg, text]) => {
          const pop = marker.getPopup();
          if (!pop) return;
          const el = pop.getElement();
          if (!el) return;
          const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
          if (!chip) return;
          const isNetworkChip = chip.dataset?.networkBadge === "true";
          if (isNetworkChip) return;

          if (isNoctilien2(n)) {
            chip.style.background = "#080080";
            chip.style.color = text;
            ensureStripe(chip, noctilienStripeColor(n));
          } else {
            chip.style.background = bg;
            chip.style.color = text;
          }
        });


        return marker;
      }).filter(Boolean);

      const bundle = { group, poly, stops };
      dbusRouteLayers.set(key, bundle);
      return bundle;
    }

    function hideAllRoutes(){
      dbusLayers.clearLayers();
      routeAnimHandles.forEach(h => h.stop());
      routeAnimHandles.clear();
      hideLinePreview();
      clearActiveStop()
    }

    function showOnlyRoute(lineIdx, line, route){
      hideAllRoutes();
      const key = `${line.uid}:${route.uid}`;
      const existing = dbusRouteLayers.get(key);
      let bundle;

      if (existing) {
        dbusLayers.addLayer(existing.group);
        bundle = existing;
        if (existing.poly?._path) startLineAnim(key, existing.poly);
        else existing.poly.once('add', () => startLineAnim(key, existing.poly));
      } else {
        bundle = drawRoute(lineIdx, line, route);
      }

      if (route.stops && route.stops.length){
        const first = DBUS_STOPS.get(route.stops[0].uid);
        if(first?.latlng){
          centerWithPreview(first.latlng, { zoom: map.getZoom() });
          const marker = bundle.stops[0];
          if(marker?.openPopup) setTimeout(()=> marker.openPopup(), 300);
        }
      }

      if (route.stops.length){
        const first = DBUS_STOPS.get(route.stops[0].uid);
        if(first?.latlng){
          centerWithPreview(first.latlng, { zoom: map.getZoom() });
          const marker = bundle.stops[0];
          if(marker?.openPopup) setTimeout(()=> marker.openPopup(), 300);
        }
      }

      renderLinePreview(line, route);

      return bundle;
    }

    function getRouteEndpoints(route){
      const routeTitleRaw = route.name.includes(":") ? route.name.split(":")[1].trim() : route.name;
      const [titleStart0, titleEnd0] = splitRouteEndpoints(routeTitleRaw);
      const titleStart = trimAroundRER(titleStart0, 'start');
      const titleEnd   = trimAroundRER(titleEnd0,   'end');
      return { routeTitleRaw, titleStart, titleEnd };
    }

    let PREVIEW_STOP_ELEMS = new Map();

    function setActiveStopById(stopId){
      PREVIEW_STOP_ELEMS.forEach(({el, routeKey}) => {
        if (routeKey === currentSelectedKey) el.classList.remove('active');
      });
      const rec = PREVIEW_STOP_ELEMS.get(stopId);
      if (rec && rec.routeKey === currentSelectedKey) {
        rec.el.classList.add('active');
        currentActiveStopId = stopId;
      }
    }

    function centerWithPreview(latlng, { zoom = null } = {}) {
      const targetZoom = zoom ?? map.getZoom();
      const paneH = document.getElementById('linePreview')?.offsetHeight || 0;
      const offsetY = Math.round(paneH / 2);
      const p = map.project(latlng, targetZoom);
      const targetPt = L.point(p.x, p.y + offsetY);
      const targetLL = map.unproject(targetPt, targetZoom);
      map.setView(targetLL, targetZoom, { animate: true });
    }

    function getLineNumber(line, route) {
      if (line.number && line.number !== "?") {
        return line.number;
      }
      const { lineNumber } = parseRouteName(route.name || "");
      return lineNumber || "?";
    }

    function renderLinePreview(line, route){
      PREVIEW_STOP_ELEMS = new Map();

      const wrap = document.getElementById("linePreviewWrap");
      const badge = document.getElementById("lpBadge");
      const title = document.getElementById("lpRouteTitle");
      const transit = document.getElementById("lpTransit");
      if(!wrap || !badge || !title || !transit) return;

      const { titleStart, titleEnd } = getRouteEndpoints(route);
      const cleanedStart = withRERIcon(titleStart);
      const cleanedEnd   = withRERIcon(titleEnd);

      const stopCount = route.stops.length;

      let durationText;
      if (route.totalMinutes >= 60) {
        const h = Math.floor(route.totalMinutes / 60);
        const m = route.totalMinutes % 60;
        if (m > 0) {
          durationText = `${h} h ${m} min`;
        } else {
          durationText = `${h} h`;
        }
      } else {
        durationText = `${route.totalMinutes} min`;
      }
      
      title.innerHTML = `
        <div>${cleanedStart} &gt; ${cleanedEnd}</div>
        <div style="font-weight:400; font-size:12px; color:#9fb1cc; margin-top:2px">
          ${stopCount} arrêts - ${durationText}
        </div>
      `;

      const { lineNumber } = parseRouteName(route.name || "");
      const lineCategory = getCategory(line);
      const mTitusLP = /^titus\s*(\d+)/i.exec(String(lineNumber||""));
      const isNoctLinePreview = isNoctilien2(lineNumber);
      let previewBadgeChip = null;

      function applyNetworkBadgeToPreview(opts){
        badge.innerHTML = "";
        badge.className = "lp-badge-wrapper";
        badge.style.background = "transparent";
        badge.style.color = "#fff";
        const { wrap, chip } = createNetworkBadgeElement(opts);
        badge.appendChild(wrap);
        previewBadgeChip = chip;
      }

      function applyDefaultBadgeToPreview(){
        badge.className = "dbus-badge";
        badge.innerHTML = "";
        ensureBadgeLabel(badge, lineNumber);
        badge.style.background = "#444";
        badge.style.color = "#fff";
        previewBadgeChip = badge;
      }

      if (mTitusLP) {
        applyNetworkBadgeToPreview({
          label: mTitusLP[1],
          imgSrc: "./Overlays/reseau_titus.png",
          alt: "Réseau Titus",
          colorKey: lineNumber,
          chipClass: "dbus-badge titus-chip"
        });
      } else if (isNoctLinePreview) {
        applyNetworkBadgeToPreview({
          label: lineNumber,
          imgSrc: "./Overlays/noctilien_logo_idfm.png",
          alt: "Noctilien",
          stripeColor: noctilienStripeColor(lineNumber)
        });
      } else if (lineCategory === "Urbain") {
        applyNetworkBadgeToPreview({
          label: lineNumber,
          imgSrc: "./Overlays/bus_logo_idfm.png",
          alt: "Réseau urbain ÃŽle-de-France Mobilités"
        });
      } else {
        applyDefaultBadgeToPreview();
      }

      if (transit) transit.style.setProperty('--lineColor', '#3aa0ff');

      const previewBadgeTarget = previewBadgeChip || badge;
      const isPreviewNetwork = previewBadgeTarget?.dataset?.networkBadge === "true";
      if (!isPreviewNetwork && isNoctilien2(line.number)) {
        ensureStripe(previewBadgeTarget, noctilienStripeColor(line.number));
      }

      const colorKeyLP = lineNumber || getLineNumber(line, route);
      getLineColors(colorKeyLP).then(([bg, text])=>{
        if (previewBadgeTarget && !isPreviewNetwork){
          previewBadgeTarget.style.background = bg;
          previewBadgeTarget.style.color = text;
        }
        if (transit) transit.style.setProperty('--lineColor', bg);
        if (!isPreviewNetwork && isNoctilien2(colorKeyLP)) {
          ensureStripe(previewBadgeTarget, noctilienStripeColor(colorKeyLP));
        }
      });

      transit.innerHTML = "";
      const ids = route.stops.map(s => s.uid);
      ids.forEach((id, idx) => {
        const st = DBUS_STOPS.get(id); if(!st) return;
        let label = st.name;
        if (idx === 0) label = titleStart;
        else if (idx === ids.length-1) label = titleEnd;

        const stopEl = document.createElement("div");
        stopEl.className = "stop" + (idx===0 ? " first" : (idx===ids.length-1 ? " last" : ""));
        stopEl.dataset.stopId = String(id);
        const isProvisoire = /\(provisoire\)/i.test(label);
        const cleanLabel = label.replace(/\s*\(provisoire\)\s*/i, "");
        stopEl.innerHTML = `
          <div class="dot"></div>
          <div class="name">${withRERIcon(cleanLabel)}${isProvisoire ? '<span class="stop-flag" aria-label="Arrêt provisoire">Arrêt provisoire</span>' : ''}</div>
        `;
        
        stopEl.addEventListener('click', ()=>{
          const bundle = dbusRouteLayers.get(currentSelectedKey);
          const mk  = bundle?.stops?.[idx];
          const pop = mk?.getPopup?.();

          if (pop) pop.options.autoPan = false;

          const stObj = DBUS_STOPS.get(id);
          if (stObj?.latlng) centerWithPreview(stObj.latlng);

          setTimeout(()=> { if (mk?.openPopup) mk.openPopup(); }, 120);

          if (pop) pop.options.autoPan = true;

          setActiveStopById(id);
        });
        PREVIEW_STOP_ELEMS.set(id, { el: stopEl, idx, routeKey: currentSelectedKey });

        transit.appendChild(stopEl);

        if (idx < ids.length-1){
          const seg = document.createElement("div");
          seg.className = "segment";
          getLineColors(lineNumber).then(([bg]) => { if (bg) seg.style.background = bg; }).catch(()=>{});
          transit.appendChild(seg);
        }
      });

      const firstId = route.stops[0]?.uid;
      if (typeof firstId !== 'undefined') setActiveStopById(firstId);

      wrap.style.display = "block";
      applyI18N();
    }

    function hideLinePreview(){
      const wrap = document.getElementById("linePreviewWrap");
      if (wrap) wrap.style.display = "none";
      clearActiveStop()
    }

    document.getElementById("lpClose")?.addEventListener("click", () => {
      currentSelectedKey = "";
      hideAllRoutes();
      hideLinePreview();
      document.getElementById("dbusList")?.querySelectorAll(".dbus-item")?.forEach(it => it.style.outline="none");
      renderSelectedChip();
    });

    function openDbusPanel() {
      closeSearchUI({ reset: true });
      clearDbusSelection();
      hideLinePreview();
      $panelDbus.style.display = 'block';
      $btnDbus?.setAttribute('aria-expanded','true');
    }
    function closeDbusPanel() {
      $panelDbus.style.display = 'none';
      $btnDbus?.setAttribute('aria-expanded','false');
    }
    document.getElementById("dbusPanelClose")?.addEventListener("click", closeDbusPanel);
    function isDbusOpen() { return $panelDbus.style.display === 'block'; }
    function openSearchUI() { closeDbusPanel(); $results.hidden = false; }
    function closeSearchUI({ reset = false } = {}) {
      if (reset) $search.value = '';
      renderResults([]); 
      $results.hidden = true;
      $search.blur();
    }
    function isSearchOpen(){ return !$results.hidden; }

    $btnDbus.addEventListener('click', () => {
      if (isDbusOpen()) closeDbusPanel();
      else openDbusPanel();
      renderSelectedChip();
    });

    function renderSelectedChip(){
      const host = $selectedChip;
      if (!currentSelectedKey) { host.style.display="none"; host.innerHTML=""; return; }
      host.style.display = "none";
      host.innerHTML = "";
    }

    function clearDbusSelection(scope = $dbusList){
      if (!scope) return;
      const activeItems = scope.querySelectorAll(".dbus-item.active");
      if (!activeItems.length) return;
      activeItems.forEach(item => {
        item.classList.remove("active");
        item.style.outline = "none";
      });
      currentSelectedKey = "";
      hideAllRoutes();
      renderSelectedChip();
    }

    function isNumericOnly(s){ return /^\d+$/.test(String(s||"").trim()); }
    function isFlix(line){
      const num = String(line.number||"").toLowerCase();
      if (num.includes("flix")) return true;
      return (line.routes||[]).some(r => String(r.name||"").toLowerCase().includes("flix"));
    }
    function isNoctilien(line){
      const num = String(line.number||"").trim().toUpperCase();
      return /^N\d+$/.test(num);
    }
    function isTitusLine(line){
      const num = String(line.number||"").trim().toLowerCase();
      return /titus/i.test(num);
    }
    function getCategory(line){
      if (isNoctilien(line))          return "Noctilien";
      if (isFlix(line))               return "FlixBus";
      if (isNumericOnly(line.number)) return "Urbain";
      if (isTitusLine(line))          return "Urbain";
      if (/^scolaire/i.test(line.number)) return "Scolaire";
      return "Autres";
    }

    async function initDbusUI(){
      try{
        await loadStops();
        await loadLines();
      }catch(err){
        console.error("DBus: chargement échoué", err);
        return;
      }

      $dbusList.innerHTML = "";

      const buckets = { "Urbain": [], "FlixBus": [], "Noctilien": [], "Autres": [], "Scolaire": [] };

      const URBAIN_CUSTOM_ORDER = ["24","63","109","112","114","121","124","221","303","351","reseau titus"]; 
      function normLineId(x){
        return String(x||"").trim().toLowerCase()
          .replace(/[éÃ¨êÃ Â«]/g,'e')
          .replace(/\.(png|jpg|jpeg|webp)$/,'');
      }

      function compareUrbainLines(a,b){
        const ai = URBAIN_CUSTOM_ORDER.indexOf(normLineId(a.number));
        const bi = URBAIN_CUSTOM_ORDER.indexOf(normLineId(b.number));
        if (ai !== -1 || bi !== -1) {
          return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
        }

        const aNum = isNumericOnly(a.number);
        const bNum = isNumericOnly(b.number);
        if (aNum && !bNum) return -1;
        if (!aNum && bNum) return 1;
        if (aNum && bNum) return (parseInt(a.number,10)||0) - (parseInt(b.number,10)||0);

        return String(a.number).localeCompare(String(b.number), 'fr', {numeric:true});
      }

      DBUS_LINES.forEach(line => {
        const cat = getCategory(line);
        buckets[cat].push(line);
      });

      if (buckets["Noctilien"] && buckets["Noctilien"].length) {
        buckets["Urbain"].push(...buckets["Noctilien"]);
        buckets["Noctilien"] = [];
      }

      buckets["Urbain"].sort(compareUrbainLines);
      buckets["Noctilien"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
      buckets["FlixBus"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
      buckets["Autres"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
      buckets["Scolaire"].sort((a, b) => {
        return String(a.number).localeCompare(String(b.number), 'fr', {numeric:true});
      });

      function renderSection(title, lines) {
        if (!lines.length) return;

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        let totalRoutes = 0;
        lines.forEach(line => {
          totalRoutes += (line.routes ? line.routes.length : 0);
        });

        const isOpenByDefault = (title === "IDFM" || title === "Noctiliens");

        const head = document.createElement("div");
        head.className = "dbus-sechead";
        head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
        head.innerHTML = `
          <span>${title} (${totalRoutes})</span>
          <span class="chev" style="margin-left:auto">▼</span>
        `;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = !isOpenByDefault; 
        sec.appendChild(body);

        head.addEventListener("click", () => {
          const expanded = head.getAttribute("aria-expanded") === "true";
          const willOpen = !expanded;
          head.setAttribute("aria-expanded", expanded ? "false" : "true");
          body.hidden = expanded;
          if (expanded) {
            clearDbusSelection(body);
            return;
          }
          if (willOpen) {
            try {
              $dbusList.querySelectorAll('.dbus-sechead').forEach(h => {
                if (h !== head) {
                  h.setAttribute('aria-expanded','false');
                  const b = h.nextElementSibling;
                  if (b && b.classList.contains('dbus-secbody')) {
                    b.hidden = true;
                    clearDbusSelection(b);
                  }
                }
              });
              if (window.__DBUS_GRID_OPEN && typeof window.__DBUS_GRID_OPEN.clear === 'function') {
                window.__DBUS_GRID_OPEN.clear();
                window.__DBUS_GRID_OPEN = null;
              }
            } catch {}
          }
        });

        if (title === "Scolaire") {
          const allRoutes = [];
          lines.forEach(line => {
            line.routes.forEach(route => allRoutes.push({ line, route }));
          });

          allRoutes.sort((a, b) => {
            const depA = String(a.route.name).split(">")[0].trim();
            const depB = String(b.route.name).split(">")[0].trim();
            return depA.localeCompare(depB, 'fr', { numeric: true, sensitivity: "base" });
          });

          allRoutes.forEach(({ line, route }) => renderLineItem(line, route, body));
        } else {
          lines.forEach(line => {
            line.routes.forEach(route => renderLineItem(line, route, body));
          });
        }
      }

      function renderSectionGrid(title, lines) {
        if (!lines.length) return;

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        let totalRoutes = 0;
        lines.forEach(line => { totalRoutes += (line.routes ? line.routes.length : 0); });

        const isOpenByDefault = (title === "IDFM" || title === "Noctiliens");

        const head = document.createElement("div");
        head.className = "dbus-sechead";
        head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
        head.innerHTML = `<span>${title} (${totalRoutes})</span><span class=\"chev\" style=\"margin-left:auto\">▼</span>`;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = !isOpenByDefault; 
        sec.appendChild(body);

        function clearLocal(){
          selectedLineUid = null;
          routesHost.innerHTML = "";
          routesHost.style.margin = "8px 6px 0";
          body.querySelectorAll('.dbus-logo').forEach(el=>{
            el.style.outline='none';
            el.classList.remove('dim','sel');
            el.style.removeProperty('--selColor');
          });
          try { currentSelectedKey = ""; } catch {}
          try { if (typeof hideAllRoutes === 'function') hideAllRoutes(); } catch {}
          try { if (typeof hideLinePreview === 'function') hideLinePreview(); } catch {}
        }

        head.addEventListener("click", () => {
          const expanded = head.getAttribute("aria-expanded") === "true";
          const willOpen = !expanded;
          head.setAttribute("aria-expanded", expanded ? "false" : "true");
          body.hidden = expanded;
          if (expanded) {
            clearLocal();
            if (window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section === title) {
              window.__DBUS_GRID_OPEN = null;
            }
          }
          if (willOpen) {
            try {
              $dbusList.querySelectorAll('.dbus-sechead').forEach(h => {
                if (h !== head) {
                  h.setAttribute('aria-expanded','false');
                  const b = h.nextElementSibling;
                  if (b && b.classList.contains('dbus-secbody')) b.hidden = true;
                }
              });
            } catch {}
          }
        });

        const grid = document.createElement("div");
        grid.className = "dbus-grid";
        body.appendChild(grid);

        const routesHost = document.createElement("div");
        routesHost.className = "routes-host";
        routesHost.style.margin = "8px 6px 0";

        let selectedLineUid = null;

        function selectionColorForLine(line) {
          const rawNum = String(line.number || "").trim();
          if (isTitusLine(line)) return "#ffffff";
          if (/^N\d+$/i.test(rawNum)) return noctilienStripeColor(rawNum);
          return null;
        }

        function createLogoForLine(line) {
          const raw = String(line.number || "").trim();
          const norm = raw.toLowerCase().replace('é','e');
          const isTitus = /reseau\s*titus/.test(norm);

          const wrap = document.createElement('div');
          wrap.className = 'dbus-logo';

          if (isTitusLine(line)) {
           
            wrap.classList.add('dbus-logo--titus');
            wrap.style.background = 'transparent';
            const img = document.createElement('img');
            img.alt = 'Réseau Titus';
            img.src = './Overlays/reseau_titus.png';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            img.onerror = () => {
              wrap.textContent = 'Réseau Titus';
              wrap.style.color = '#522a8a';
              wrap.style.background = 'transparent';
            };
            wrap.appendChild(img);
            return wrap;
          }

          const num = raw;
          const badge = makeLineBadge(num, "#444", "#fff", "88x36");
          badge.classList.add("dbus-logo");
          getLineColors(num).then(([bg,text])=>{
            badge.style.background = bg; badge.style.color = text;
            if (isNoctilien2(num)) { ensureStripe(badge, noctilienStripeColor(num)); }
            if (getCategory(line) === "Autres") { ensureFictiveStripe(badge); }
          });
          return badge;
        }

        function renderRoutesForLine(line, container){
          container.innerHTML = "";
          line.routes.forEach(route => renderLineItem(line, route, container));
        }

        if (title === "IDFM") {
          const normals = lines.filter(l => isNumericOnly(l.number));
          normals.sort(compareUrbainLines);
          const nocti = lines.filter(l => isNoctilien(l));
          const autresReseaux = lines.filter(l => !isNumericOnly(l.number) && !isNoctilien(l));

          function renderSub(label, items){
            if (!items.length) return;
          const h = document.createElement('h4'); h.textContent = label; body.appendChild(h);
            const subGrid = document.createElement('div'); subGrid.className = 'dbus-grid'; body.appendChild(subGrid);

            items.sort((a, b) => {
                const an = parseInt(a.number.replace(/\D/g,'')) || 0;
                const bn = parseInt(b.number.replace(/\D/g,'')) || 0;
                return an - bn;
            });

            items.forEach(line => {
              const block = document.createElement('div'); block.className = 'line-block';
              const logo = createLogoForLine(line); block.appendChild(logo);

              function closeNonGridSections() {
                try {
                  const heads = $dbusList.querySelectorAll('.dbus-sechead');
                  heads.forEach(h => {
                    const txt = (h.textContent || '').trim().toLowerCase();
                if (!/^idfm\b/.test(txt) && !/^noctiliens\b/.test(txt)) {
                      h.setAttribute('aria-expanded','false');
                      const b = h.nextElementSibling;
                      if (b && b.classList.contains('dbus-secbody')) b.hidden = true;
                    }
                  });
                } catch {}
              }

              logo.addEventListener('click', () => {
                const isSame = (selectedLineUid === line.uid);
                if (!isSame && window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section !== title) {
                  try { window.__DBUS_GRID_OPEN.clear && window.__DBUS_GRID_OPEN.clear(); } catch {}
                  window.__DBUS_GRID_OPEN = null;
                }
                if (isSame) { clearLocal(); if (window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section === title) { window.__DBUS_GRID_OPEN = null; } return; }
                clearLocal(); selectedLineUid = line.uid;
                const raw = String(line.number||''); const norm = raw.toLowerCase().replace('é','e');
                const selColor = selectionColorForLine(line);
                if (selColor) { logo.style.setProperty('--selColor', selColor); }
                else { getLineColors(raw).then(([bg])=>{ logo.style.setProperty('--selColor', bg); }); }
                routesHost.style.margin = '8px 6px 25px';
                renderRoutesForLine(line, routesHost);
                body.querySelectorAll('.dbus-logo').forEach(el=>{ if (el!==logo) el.classList.add('dim'); else el.classList.remove('dim'); });
                body.querySelectorAll('.dbus-logo.sel').forEach(el=> el.classList.remove('sel'));
                logo.classList.add('sel');
                closeNonGridSections();
                window.__DBUS_GRID_OPEN = { section: title, clear: clearLocal };
              });

              subGrid.appendChild(block);
            });
          }

          renderSub('URBAINES', normals);
          renderSub('NOCTILIEN', nocti);
          renderSub('AUTRES RÉSEAUX', autresReseaux);
          body.appendChild(routesHost);
        } else {
          lines.forEach(line => {
            const block = document.createElement('div');
            block.className = 'line-block';
            const logo = createLogoForLine(line);
            block.appendChild(logo);

            function closeNonGridSections() {
              try {
                const heads = $dbusList.querySelectorAll('.dbus-sechead');
                heads.forEach(h => {
                  const txt = (h.textContent || '').trim().toLowerCase();
              if (!/^idfm\b/.test(txt) && !/^noctiliens\b/.test(txt)) {
                    h.setAttribute('aria-expanded','false');
                    const b = h.nextElementSibling;
                    if (b && b.classList.contains('dbus-secbody')) b.hidden = true;
                  }
                });
              } catch {}
            }

            logo.addEventListener('click', () => {
              const isSame = (selectedLineUid === line.uid);
              if (!isSame && window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section !== title) {
                try { window.__DBUS_GRID_OPEN.clear && window.__DBUS_GRID_OPEN.clear(); } catch {}
                window.__DBUS_GRID_OPEN = null;
              }
              if (isSame) { clearLocal(); if (window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section === title) { window.__DBUS_GRID_OPEN = null; } return; }
              clearLocal(); selectedLineUid = line.uid;
              const raw = String(line.number||''); const norm = raw.toLowerCase().replace('é','e');
              const selColor = selectionColorForLine(line);
              if (selColor) { logo.style.setProperty('--selColor', selColor); }
              else { getLineColors(raw).then(([bg])=>{ logo.style.setProperty('--selColor', bg); }); }
              routesHost.style.margin = '8px 6px 25px';
              renderRoutesForLine(line, routesHost);
              grid.querySelectorAll('.dbus-logo').forEach(el=>{ if (el!==logo) el.classList.add('dim'); else el.classList.remove('dim'); });
              body.querySelectorAll('.dbus-logo.sel').forEach(el=> el.classList.remove('sel'));
              logo.classList.add('sel');
              closeNonGridSections();
              window.__DBUS_GRID_OPEN = { section: title, clear: clearLocal };
            });

            grid.appendChild(block);
          });
          body.appendChild(routesHost);
        }
      }

      function getLineId(line, route) {
        if (line.number && line.number !== "?") {
          return line.number;
        }
        const { lineNumber } = parseRouteName(route.name || "");
        return lineNumber || "?";
      }

      function renderLineItem(line, route, container) {
        const item = document.createElement("div");
        item.className = "dbus-item";

        const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
        const mTitus = /^titus\s*(\d+)/i.exec(String(lineNumber||""));
        const displayNumber = mTitus ? mTitus[1] : lineNumber;
        const badge = makeLineBadge(displayNumber, "#444", "#fff", "72x32");
        
        const titleEl = document.createElement("div");
        titleEl.className = "rname";
        titleEl.style.flex = "1 1 auto";
        let titleHtml = withRERIcon(routeTitle);
        if (flag) {
          titleHtml = `<span class="route-flag">${flag}</span> ` + titleHtml;
        }
        titleEl.innerHTML = titleHtml;

        const duration = document.createElement("div");
        duration.style.marginLeft = "8px";
        duration.style.color = "#9fb1cc";
        duration.style.fontSize = "13px";

        const stopCount = route.stops.length;

        let durationText;
        if (route.totalMinutes >= 60) {
          const h = Math.floor(route.totalMinutes / 60);
          const m = route.totalMinutes % 60;
          if (m > 0) {
            durationText = `${h} h ${m} min`;
          } else {
            durationText = `${h} h`;
          }
        } else {
          durationText = `${route.totalMinutes} min`;
        }

        duration.textContent = `${stopCount} arrêts (${durationText})`;

        item.appendChild(badge);
        item.appendChild(titleEl);
        item.appendChild(duration);

        function effectiveLineNumber(line, route) {
          if (line.number && line.number !== "?") return line.number;
          const { lineNumber } = parseRouteName(route.name || "");
          return lineNumber || "?";
        }

        const effNum = effectiveLineNumber(line, route);

        const colorKey = mTitus ? lineNumber : getLineNumber(line, route);
        getLineColors(colorKey).then(([bg,text])=>{
          badge.style.background = bg;
          badge.style.color = text;
          if (isNoctilien2(getLineNumber(line, route))) {
            ensureStripe(badge, noctilienStripeColor(getLineNumber(line, route)));
          }
          if (getCategory(line) === "Autres") {
            ensureFictiveStripe(badge);
          }
        });


        item.addEventListener("click", ()=> {
          $dbusList.querySelectorAll(".dbus-item").forEach(it=>{
            it.classList.remove("active");
            it.style.outline = "none";
          });
          item.classList.add("active");
          getLineColors(lineNumber).then(([bg])=>{
            item.style.outline = `2px solid ${bg}`;
          });

          currentSelectedKey = `${line.uid}:${route.uid}`;
          showOnlyRoute(0, line, route);
          renderSelectedChip();
          $panelDbus.style.display = "none";
        });

        container.appendChild(item);
      }

      renderSectionGrid("IDFM",  buckets["Urbain"]);
      renderSectionGrid("Noctiliens",  buckets["Noctilien"]);
      renderSection("FlixBus", buckets["FlixBus"]);
      renderSection("Scolaires",  buckets["Scolaire"]);
      renderSection("Autres",  buckets["Autres"]);
      applyI18N();

      function formatLineName(line, route) {
        const { titleStart, titleEnd } = getRouteEndpoints(route);
        const num = line.number && line.number !== "?" ? line.number : (parseRouteName(route.name).lineNumber || "?");
        return `Ligne ${num}: ${titleStart} > ${titleEnd}`;
      }

      DBUS_LINES.forEach((line, lineIdx) => {
      line.routes.forEach(route => {
        const { titleStart, titleEnd } = getRouteEndpoints(route);

        const firstStop = DBUS_STOPS.get(route.stops[0]?.uid);
        const center = firstStop?.latlng || map.getCenter();

        function extractNum(val) {
          const m = String(val||"").match(/\d+/);
          return m ? parseInt(m[0], 10) : Infinity;
        }

        const mTitus = /^titus\s*(\d+)/i.exec(String(route.name||""));
        searchIndex.push({
          type: "Lignes DBus",
          name: formatLineName(line, route),
          city: "",
          center,
          logo: "./Overlays/bus_ico.png",
          fallbackLogo: "./Overlays/bus_ico.png",
          open: () => {
            currentSelectedKey = `${line.uid}:${route.uid}`;
            showOnlyRoute(lineIdx, line, route);
            renderSelectedChip();
          },
          num: extractNum(line.number),
          titusNum: mTitus ? mTitus[1] : null
        });



      });
    });


    }
    initDbusUI().then(()=>renderSelectedChip()).catch(()=>{});

    let currentActiveStopId = null;
    function clearActiveStop(){
      PREVIEW_STOP_ELEMS.forEach(({el}) => el.classList.remove('active'));
      currentActiveStopId = null;
    }

    function norm(s){
      return String(s||"")
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ')
        .trim();
    }
    function includesNorm(hay, needle){ return norm(hay).includes(norm(needle)); }

    function detectTypeFilter(q){
      const n = norm(q);

      const MAP = [
        {types:["Atelier"],      keys:["atelier","atelier de reparation","reparation","atelier reparation"]},
        {types:["Agence"],       keys:["agence","agence de recrutement","recrutement"]},
        {types:["Garage"],       keys:["garage"]},
        {types:["Concessionnaire"], keys:["concessionnaire","dealer","concess"]},
        {types:["Entreprise"],   keys:["entreprise","societe","company"]},
        {types:["Ville"],        keys:["ville","commune","city"]},
        {types:["Monument"],     keys:["monument","monuments","monu","lieu","lieu emblématique","lieux emblématiques","lieux","emblématique","emblématiques"]},
        {types:["Centre commercial"], keys:["centre commercial","centrecom","centre commerciaux","mall","shopping"]},
        {types:["Lignes DBus"],          keys:["ligne","bus","dbus"]},
      ];

      for(const row of MAP){
        for(const k of row.keys){
          if(n === k || n.startsWith(k+" ") || n.endsWith(" "+k) || n.includes(" "+k+" ")){
            return { types: row.types, hit: k };
          }
        }
      }
      return null;
    }
      
    let sectionState = {};
    function getExpanded(key){ return sectionState[key] !== false; }
    function setExpanded(key, val){ sectionState[key] = !!val; }
    
    const ALL_TYPES = [ "Ville","Monument","Atelier","Agence","Concessionnaire","Entreprise","Centre commercial","Lignes DBus" ];
    const ORDER = [
      ["Ville","Villes"],
      ["Monument","Lieux Emblématiques"],
      ["Atelier","Ateliers de réparation"],
      ["Agence","Agences de recrutement"],
      ["Concessionnaire","Concessionnaires"],
      ["Entreprise","Entreprises"],
      ["Centre commercial","Centres commerciaux"],
      ["Lignes DBus","Lignes DBus"] 
    ];
    const PLURIEL = Object.fromEntries(ORDER);

    const DEFAULT_OFF = new Set(["Atelier","Agence","Centre commercial","Lignes DBus"]);
    let SELECTED_TYPES = new Set(ALL_TYPES.filter(t => !DEFAULT_OFF.has(t)));

    const saveSelectedTypes = () => {};

    function buildResultsFilterBar(host){
      host.querySelector(".results-filters")?.remove();

      const bar = document.createElement("div");
      bar.className = "results-filters";

      ALL_TYPES.forEach(type=>{
        const id = "rf_" + type.replace(/\s+/g,'_');
        const labelText = ({
          "Ville": t("villes"),
          "Monument": t("emblematic"),
          "Atelier": t("repair_shops"),
          "Agence": t("agencies"),
          "Concessionnaire": t("dealers"),
          "Entreprise": t("companies"),
          "Centre commercial": t("malls")
        })[type] || type;

        const chip = document.createElement("label");
        chip.className = "rf-chip";
        chip.dataset.type = type;
        chip.innerHTML = `
          <span>${labelText}</span>
          <input type="checkbox" id="${id}" ${SELECTED_TYPES.has(type)?'checked':''} aria-label="${labelText}">
        `;
        const input = chip.querySelector("input");
        input.addEventListener("change", () => {
          if (input.checked) SELECTED_TYPES.add(type);
          else SELECTED_TYPES.delete(type);
          saveSelectedTypes(SELECTED_TYPES);
          doSearch($search.value);
        });
        bar.appendChild(chip);
      });

      host.prepend(bar);
    }

    function renderResults(list){
      $results.innerHTML = "";
      buildResultsFilterBar($results);
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "result-empty";
        empty.textContent = t("results_empty");
        $results.appendChild(empty);
        $results.hidden = false;
        return;
      }

      const buckets = {
        "Ville": [],
        "Atelier": [],
        "Agence": [],
        "Garage": [],
        "Concessionnaire": [],
        "Entreprise": [],
        "Monument": [],
        "Centre commercial": [],
        "Lignes DBus": []
      };
      for (const it of list){ if (buckets[it.type]) buckets[it.type].push(it); }

      function addSectionBlockLocal(typeKey, label){
        const head = document.createElement("div");
        head.className = "result-sechead";
        const mapLbl = {
          "Ville": t("villes"),
          "Monument": t("emblematic"),
          "Atelier": t("repair_shops"),
          "Agence": t("agencies"),
          "Concessionnaire": t("dealers"),
          "Entreprise": t("companies"),
          "Centre commercial": t("malls")
        };
        head.textContent = mapLbl[typeKey] || label;
        $results.appendChild(head);

        const body = document.createElement("div");
        body.className = "result-secbody";
        $results.appendChild(body);

        return body;
      }

      function addItem(container, item){
        const div = document.createElement("div");
        div.className = "result-item";

          if (item.type === "Lignes DBus") {
          const img = document.createElement("img");
          img.className = "ico ico-service";
          img.src = "./Overlays/bus_ico.png";
          img.alt = "Bus";
          div.appendChild(img);

          let lineNumber = "";
          let routeName  = "";
          if (item.name.includes(":")) {
            const [left, right] = item.name.split(":");
            lineNumber = left.replace("Ligne","").trim();
            routeName  = right.trim();
          } else {
            lineNumber = item.name.trim();
            routeName  = "";
          }

          const category = getCategory({ number: lineNumber });

          if (category !== "Autres") {
            const tnum = item.titusNum || (/^titus\s*(\d+)/i.exec(String(lineNumber||""))?.[1] ?? null);
            if (tnum) {
              const wrap = document.createElement('div');
              wrap.style.display = 'inline-flex';
              wrap.style.alignItems = 'center';
              wrap.style.gap = '6px';
              const img = document.createElement('img');
              img.src = './Overlays/reseau_titus.png';
              img.alt = 'Réseau Titus';
              img.style.height = '22px';
              img.style.width = 'auto';
              const [bg, text] = getLineColorsSync('Titus ' + tnum);
              const chip = makeLineBadge(tnum, bg, text, '48x24');
              wrap.appendChild(img);
              wrap.appendChild(chip);
              div.appendChild(wrap);
            } else {
              const [bg, text] = getLineColorsSync(lineNumber);
              const badge = makeLineBadge(
                lineNumber,
                bg,
                text,
                "72x32",
                isNoctilien2(lineNumber) ? noctilienStripeColor(lineNumber) : null,
                false
              );
              div.appendChild(badge);
            }
          }

          const span = document.createElement("div");
          span.className = "result-text";
          span.textContent = routeName.replace(/^\s*Titus\s*\d+\s*[:-]?\s*/i, '');
          div.appendChild(span);
        } else {
          if (item.logo) {
            const img = document.createElement("img");
            img.className = "ico";
            if (["Atelier","Agence","Garage","Ville","Monument","Centre commercial"].includes(item.type)) {
              img.classList.add("ico-service");
            }
            img.src = item.logo;
            img.alt = "";
            img.onerror = () => {
              if (item.fallbackLogo && img.src !== item.fallbackLogo) img.src = item.fallbackLogo;
            };
            div.appendChild(img);
          }

          let label;
          if (item.type === "Concessionnaire"){
            const brand = (item.brand || String(item.name||"").replace(/^Concessionnaire\s+/i,"")).trim();
            label = item.city ? `${brand} - ${item.city}` : brand;
          } else if (["Atelier","Agence","Garage"].includes(item.type)){
            label = item.city || (item.type === "Agence" ? "Agence de recrutement" : item.type);
          } else if (item.type === "Monument"){
            label = item.city ? `${item.name} - ${item.city}` : item.name; 
          } else {
            label = item.city ? `${item.name} - ${item.city}` : item.name;
          }

          const span = document.createElement("div");
          span.className = "result-text";
          span.textContent = label;
          div.appendChild(span);
        }

        div.addEventListener("click", () => {
          $search.value = "";
          $search.blur();
          $results.hidden = true;
          map.setView(item.center, Math.max(map.getZoom(), minNativeZoom + 4));
          if (item.open) setTimeout(()=> item.open(), 150);
        });

        container.appendChild(div);
      }



      let shown = 0;
      for (const [typeKey,label] of ORDER){
        const arr = buckets[typeKey];
        if (!arr.length) continue;
        const body = addSectionBlockLocal(typeKey,label);
        for (const it of arr){
          if (shown >= 250) break;
          addItem(body,it);
          shown++;
        }
        if (shown >= 250) break;
      }

      $results.hidden = false;
      applyI18N();
    }

    function doSearch(q){
      const raw = String(q||"");
      const nQ  = norm(raw);

      const ALLOWED = new Set(ALL_TYPES.filter(t => SELECTED_TYPES.has(t)));

      if (nQ === ""){
        const all = searchIndex.filter(it => ALLOWED.has(it.type));
        renderResults(all);
        $results.hidden = false;
        return;
      }

      let filtered = searchIndex.filter(it => ALLOWED.has(it.type));
      const typeInfo = detectTypeFilter(nQ);

      if (typeInfo){
        filtered = filtered.filter(it => typeInfo.types.includes(it.type));
        let rest = norm(raw.replace(new RegExp(typeInfo.hit,'i'), '').trim())
                    .replace(/^[\s,;:>-]+|[\s,;:>-]+$/g,'');
        if (rest){
          filtered = filtered.filter(it => {
            const hay = [it.name, it.city, it.brand].filter(Boolean).join(" ");
            return includesNorm(hay, rest);
          });
        }
      } else {
        const words = norm(raw).split(/\s+/).filter(Boolean);
        filtered = filtered.filter(it => {
          const hay = [it.type, it.name, it.city, it.brand].filter(Boolean).join(" ");
          const normHay = norm(hay);
          return words.every(w => normHay.includes(w));
        });
      }

      filtered.sort((a,b)=>{
        const pa = (a.type==="Ville")?0:1, pb=(b.type==="Ville")?0:1;
        if(pa!==pb) return pa-pb;
        return String(a.name).localeCompare(String(b.name), LANG==='en'?'en':'fr', {numeric:true});
      });

      filtered.sort((a,b)=>{
        if (a.type === "Lignes DBus" && b.type === "Lignes DBus") {
          return (a.num ?? Infinity) - (b.num ?? Infinity);
        }
        return 0;
      });



      renderResults(filtered);
      $results.hidden = false;
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
    const doSearchDebounced = debounce(q => {
      doSearch(String(q||''));
      openSearchUI();
      _resIdx = -1;
    }, 120);

    $search.addEventListener('focus', () => { closeDbusPanel(); doSearch($search.value); });
    $search.addEventListener('input', e => doSearchDebounced(e.target.value));
    $search.addEventListener('keydown', e => { if (e.key === 'Enter') { const first = $results.querySelector('.result-item'); if (first) first.click(); } });

    document.addEventListener('click', (e) => {
      const searchPanel = document.querySelector('.search-panel');
      const clickInSearch = !!searchPanel && searchPanel.contains(e.target);
      const clickInDbus   = !!$panelDbus && ($panelDbus.contains(e.target) || e.target === $btnDbus);

      if (!clickInSearch) closeSearchUI({ reset: true });
      if (!clickInDbus)   closeDbusPanel();
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('lpClose')?.click();
        closeSearchUI({ reset: true });
        closeDbusPanel();
        try { map.closePopup(); } catch {}
      }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        $search?.focus();
      }
    });
  </script>

  <script>
    const CLOSED = false 
      || (new URLSearchParams(location.search).get('closed') === '1');

    if (CLOSED) {
      const html = `
        <div style="
          position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
          background:#0b1118;color:#e8eefb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
          text-align:center;padding:24px
        ">
          <div>
            <div style="font-size:28px;font-weight:800;margin-bottom:10px">${t("maintenance_title")}</div>
          </div>
        </div>
      `;
      document.body.innerHTML = html;
      throw new Error('Maintenance');
    }
  </script>

</body>
</html>








