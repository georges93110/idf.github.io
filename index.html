<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Map</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --panel:#0b1118;--panel2:#0f1722;--border:#2b2f3a;--text:#e8eefb;--muted:#8892a6;--shadow:0 10px 30px rgba(0,0,0,.40);
      --logoW:110px; --logoH:44px;
      --busA:#2b2f3a; --busB:#2b2f3a; --busC:#2b2f3a; --busD:#2b2f3a; --busE:#2b2f3a;
      --rer-mask-url: url("./Overlays/o_rer.png");
      --metro-icon-url: url("./Overlays/o_metro.png");
      --metro-mask-url: url("./Overlays/o_metro.png");
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    #map{position:fixed;inset:0}
    .leaflet-container,html,body,#map{background:#000}

    .city-label{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      color:#fff;font-weight:600;white-space:nowrap;text-align:center;
      text-shadow:0 2px 4px rgba(0,0,0,.8);
      pointer-events:auto; cursor:pointer;
    }
    .city-selected{color:#ffda3a !important;text-shadow:0 0 0 rgba(0,0,0,0),0 2px 6px rgba(0,0,0,.9)}

    .search-panel{position:fixed;top:12px;right:12px;z-index:1000;width:max-content;max-width:92vw}
    .search-row{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .lang-switch{position:relative}
    .lang-btn{display:inline-flex;align-items:center;gap:8px;padding:11px 12px}
    .lang-btn .lang-flag{
      width:20px;height:15px;display:block;object-fit:cover;border-radius:3px;
      box-shadow:0 0 0 1px rgba(0,0,0,.35)
    }
    .lang-btn .lang-caret{width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid var(--muted)}
    .lang-menu{
      position:absolute;top:calc(100% + 8px);left:0;
      min-width:min(220px, 90vw);
      padding:6px;border-radius:12px;border:1px solid var(--border);
      background:var(--panel);box-shadow:var(--shadow);display:none;z-index:1300
    }
    .lang-menu[aria-hidden="false"]{display:block}
    .lang-option{
      width:100%;display:flex;align-items:center;gap:10px;padding:8px 10px;
      border-radius:10px;border:1px solid transparent;background:transparent;
      color:var(--text);cursor:pointer;font-weight:700;text-align:left
    }
    .lang-option:hover{background:#101926;border-color:#1f2732}
    .lang-option[aria-selected="true"]{
      background:#1b2a3f;border-color:#2a3a52;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04)
    }
    .lang-option .lang-name{text-transform:uppercase;letter-spacing:.05em;font-size:12px}
    .lang-option .lang-flag{
      width:20px;height:15px;display:block;object-fit:cover;border-radius:3px;
      box-shadow:0 0 0 1px rgba(0,0,0,.35)
    }
    .lang-menu-sep{height:1px;background:#1f2732;margin:6px 8px}
    .lang-toggle-row{
      display:flex;align-items:center;gap:10px;padding:8px 10px;
      border-radius:10px;border:1px solid transparent;color:var(--text);
      cursor:pointer;font-weight:600;font-size:12px;letter-spacing:.02em
    }
    .lang-toggle-row:hover{background:#101926;border-color:#1f2732}
    .lang-toggle-row input{
      width:16px;height:16px;accent-color:#f59e0b;cursor:pointer
    }
    .lang-toggle-label{display:block;flex:1 1 auto}
    .lang-toggle-row.is-disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .lang-toggle-row.is-disabled input{cursor:not-allowed}
    .lang-toggle-badge{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(245,158,11,0.15);
      border:1px solid rgba(245,158,11,0.45);
      color:#fbbf24;
      font-weight:800;
    }
    .search-input{flex:1;min-width:300px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-size:15px;box-shadow:var(--shadow);outline:none}
    .search-input:disabled{opacity:.5;cursor:not-allowed;background:color-mix(in oklab, var(--panel) 85%, #000 15%)}
    .search-input::placeholder{color:var(--muted)}
    .btn{padding:11px 14px;border-radius:12px;border:1px solid var(--border);background:color-mix(in oklab, var(--panel) 92%, #000 8%);color:var(--text);font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    .btn:hover{background:#101926}
    .btn:disabled,
    .btn.is-disabled{opacity:.5;cursor:not-allowed;box-shadow:none}
    .btn.is-open{
      outline:2px solid #f59e0b;
      outline-offset:2px;
    }
    .results{margin-top:6px;max-height:42vh;overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--panel);box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .result-item{display:flex;align-items:center;gap:12px;padding:10px 12px;cursor:pointer;border-bottom:1px solid #1f2732;color:var(--text);font-size:14px}
    .result-item:last-child{border-bottom:none}
    .result-item:hover{background:#101926}
    .result-item img.ico{width:var(--logoW);height:var(--logoH);flex:0 0 auto;border-radius:6px;object-fit:contain}
    .result-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;line-height:1.2}
    .result-empty{
      padding:10px 12px;
      color:var(--muted);
      font-size:14px;
      border-bottom:1px solid #1f2732;
    }
    .result-item img.ico { width: var(--logoW); height: var(--logoH); }
    .result-item img.ico.ico-service { width: calc(var(--logoW) / 2); height: calc(var(--logoH) / 2); }

    .search-panel-modal .search-toolbar{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px 12px;
      border-bottom:1px solid #1f2732;
      background:var(--panel2);
    }
    .search-panel-modal .search-input{width:100%;min-width:0;box-shadow:none}
    .search-panel-modal .results{
      margin:0;
      padding:6px;
      max-height:none;
      border:0;
      background:transparent;
      box-shadow:none;
      overflow:visible;
    }
    #searchFilters{flex:1;min-width:0}
    .search-panel-modal .dbus-header .dbus-close{margin-left:auto}
    .result-sechead{
      padding:8px 10px;
      color:#a7b2c9;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      border-bottom:1px solid #1f2732;
      background:var(--panel2);
    }

    .dbus-panel{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:min(1240px,94vw);
      height:min(760px,92vh);
      max-width:94vw;
      max-height:92vh;
      box-sizing:border-box;
      padding:12px 18px;
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 25px 90px rgba(0,0,0,.7);
      display:none;
      overflow:hidden;
      z-index:1200;
      flex-direction:column;
    }
    .dbus-panel.is-open,
    .dbus-stop-panel.is-open{
      outline:2px solid #ffffff33;
      outline-offset:-2px;
    }
    .dbus-panel .dbus-content{
      flex:1 1 auto;
      overflow:auto;
      scrollbar-gutter: stable;
      min-height:0;
    }
    .dbus-stop-panel{
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:min(1240px,92vw);
      max-width:92vw;
      height:min(760px,92vh);
      max-height:92vh;
      box-sizing:border-box;
      padding:12px 18px 0;
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:0 25px 90px rgba(0,0,0,.7);
      display:none;
      overflow:hidden;
      z-index:1250;
      flex-direction:column;
    }
    .dbus-stop-panel .dbus-title{white-space:normal;line-height:1.25}
    .dbus-stop-content{flex:1 1 auto;overflow:auto;scrollbar-gutter: stable;min-height:0}
    .dbus-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #1f2732;color:var(--muted);font-size:16px}
    .dbus-header .dbus-title{font-size:20px;font-weight:700;color:#f8fbff;}
    .dbus-header .dbus-close{
      background:transparent;
      border:none;
      color:#ef4444;
      font-size:24px;
      cursor:pointer;
      line-height:1;
    }
    .dbus-mode-group{display:flex;gap:8px;align-items:center;margin-left:auto}
    .dbus-group-label{
      font-size:11px;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:#7c879d;
      font-weight:700;
    }
    .dbus-modes{display:flex;gap:6px;align-items:center}
    .dbus-mode-btn{border:1px solid #1f2732;background:#0f1722;color:#a7b2c9;padding:6px 10px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer}
    .dbus-mode-btn:hover{background:#111c2a;color:#d0d6e6}
    .dbus-mode-btn.active{background:#1b2a3f;color:#f8fbff;border-color:#2a3a52;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04)}
    .dbus-footer{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-top:1px solid #1f2732;
      background:var(--panel2);
      border-radius:12px;
      margin-top:10px;
      flex:0 0 auto;
    }
    .dbus-filters{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .dbus-switch{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border:1px solid #1f2732;border-radius:999px;background:#0f1722;color:#a7b2c9;font-size:12px;font-weight:700}
    .dbus-switch-label{white-space:nowrap}
    .dbus-switch input{
      appearance:none;
      width:34px;height:20px;
      background:#1a2434;
      border-radius:999px;
      border:1px solid #2a3a52;
      position:relative;
      cursor:pointer;
      transition:background .2s ease,border-color .2s ease;
    }
    .dbus-switch input::after{
      content:"";
      position:absolute;
      width:16px;height:16px;
      border-radius:50%;
      background:#e8eefb;
      top:1px;left:1px;
      transition:transform .2s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.4);
    }
    .dbus-switch input:checked{
      background:#1b6dff;
      border-color:#1b6dff;
    }
    .dbus-switch input:checked::after{transform:translateX(14px)}
    .dbus-depart-indicator-wrap{display:flex;justify-content:flex-end;margin-top:6px}
    .dbus-depart-indicator-wrap[hidden]{display:none !important}
    .dbus-depart-indicator{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #2a3a52;
      background:color-mix(in oklab, var(--panel) 92%, #000 8%);
      color:#d7e2f7;
      font-size:12px;
      font-weight:700;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
    }
    .dbus-depart-close{
      background:transparent;
      border:none;
      color:#ef4444;
      font-size:25px;
      line-height:1;
      cursor:pointer;
      padding:0 2px;
    }
    .dbus-depart-close:hover{color:#ff6666}
    .dbus-stop-panel .dbus-close{margin-left:auto}
    .dbus-list{padding:6px}
    .dbus-depart-actions{padding:6px 12px 0}
    .dbus-depart-map-btn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #1f2732;
      background:#0f1722;
      color:#d7e2f7;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
    }
    .dbus-depart-map-btn:hover{background:#111c2a;color:#f8fbff}
    .dbus-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 90px);
      gap: 4px; 
      padding: 6px;
      justify-content: start; 
      align-items: start;
    }
    .dbus-double {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 10px;
      padding-bottom: 10px;
      grid-auto-rows: minmax(0, auto);
    }
    .dbus-double .dbus-item {
      width: 100%;
      box-sizing: border-box;
    }
    .dbus-double .dbus-item .rname {
      max-width: 100%;
      word-break: break-word;
    }
    .line-block{display:flex;flex-direction:column;align-items:flex-start}
    .dbus-logo{width:88px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid #1f2732;background:#223047;color:#fff;font-weight:800;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,0.04)}
    .dbus-logo--titus{border:none;background:transparent;box-shadow:none}
    .dbus-logo.dim{opacity:.25; filter:grayscale(100%);}
    .dbus-logo.sel{position:relative}
    .dbus-logo.sel::after{content:"";position:absolute;left:14px;right:14px;bottom:-4px;height:2px;border-radius:6px;background:var(--selColor,#3aa0ff);pointer-events:none;z-index:2}
    
    .dbus-logo img{display:block;width:100%;height:100%;object-fit:contain;border-radius:10px}
    .routes-host .dbus-item{margin:2px 6px;padding:8px 10px}
    .line-routes{margin-top:8px;width:100%}
    .dbus-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #1f2732;border-radius:10px;background:var(--panel2);cursor:pointer;margin:6px}
    .dbus-item:hover{background:#101926}
    .dbus-item .badge{display:flex;align-items:center;justify-content:center;width:72px;height:32px;border-radius:8px;font-weight:800;font-size:16px}
    .dbus-route-logo{width:46px;height:26px;object-fit:contain;flex:0 0 auto}
    .dbus-route-logo + .dbus-route-logo{margin-left:6px}
    .dbus-item .rname{
      color:var(--text);
      font-size:14px;
      white-space:normal;
      overflow:hidden;
      text-overflow:clip;
      word-break:break-word;
      line-height:1.3;
    }
    .dbus-duration{margin-left:auto;min-width:90px;text-align:right;color:#9fb1cc;font-size:13px;align-self:flex-start}
    .dbus-stop-count{
      min-width:44px;
      height:32px;
      border-radius:8px;
      background:#1b2a3f;
      color:#f8fbff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:14px;
    }
    .dbus-none{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed #223047;border-radius:10px;background:#0c1421;color:#9fb1cc;cursor:pointer;margin:6px}
    .dbus-item.active{ outline:2px solid #ffffff55; background:#101926; }
    .dbus-sec{margin:8px 6px 4px}
    .dbus-sec h4{
      margin:10px 6px 6px;
      color:#a7b2c9;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .dbus-sechead {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      color:#a7b2c9;
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      border-bottom:1px solid #1f2732;
      background:var(--panel2);
      cursor:pointer;
      user-select:none;
    }
    .dbus-sechead .chev {
      transition: transform .18s ease;
    }
    .dbus-sechead[aria-expanded="false"] .chev {
      transform: rotate(-90deg);
    }
    .dbus-secbody[hidden] { display:none; }
    .dbus-stop-panel .dbus-sec{margin:6px 6px 4px}
    .dbus-stop-panel .dbus-sec h4{margin:8px 6px 4px}
    .dbus-stop-panel .dbus-sec .dbus-sec{margin:6px 4px 4px}

    .dbus-depart-icon{background:transparent;border:none}
    .dbus-depart-dot{
      width:24px;height:24px;border-radius:50%;
      background:#f8fbff;border:2px solid #0b1118;color:#0b1118;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:800;box-shadow:0 4px 10px rgba(0,0,0,.35);
    }
    .dbus-depart-dot.is-hover{background:#dbeafe}
    .dbus-depart-dot.is-selected{background:#60a5fa}
    .leaflet-tooltip.dbus-depart-tooltip{
      background:color-mix(in oklab, var(--panel2) 90%, #000 10%);
      border:1px solid #1f2732;
      color:var(--text);
      padding:4px 8px;
      border-radius:8px;
      box-shadow:var(--shadow);
      font-size:12px;
      font-weight:700;
    }
    .leaflet-tooltip.dbus-depart-tooltip:before{border-top-color:#1f2732}


    .watermark{position:fixed;right:14px;bottom:14px;z-index:400;pointer-events:none;opacity:.125;filter:grayscale(10%);mix-blend-mode:screen}
    .watermark img{display:block;width:220px;max-width:32vw;height:auto}

    .inline-ico{ height:1.5em; width:auto; vertical-align:-.35em; margin:0 .12em }
    .rer-invert { filter: invert(1); }
    .leaflet-popup-content{white-space:normal;overflow:visible}
    .dbus-stop-name{font-size:15px;line-height:1.35;word-break:break-word}
    .stop-popup{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:260px;
      max-width:420px;
      font-size:13px;
      color:#d4dcf0;
    }
    .stop-popup .sp-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      border-radius:10px;
      background:color-mix(in oklab,var(--panel2) 85%, #000 15%);
      border:1px solid rgba(255,255,255,0.08);
    }
    .stop-popup .sp-title{
      font-weight:700;
      font-size:14px;
      color:#f8fbff;
    }
    .stop-popup .sp-index{
      padding:2px 10px;
      border-radius:999px;
      background:#19304a;
      color:#8dd0ff;
      font-weight:700;
      font-size:12px;
    }
    .stop-popup .sp-body{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .stop-popup .sp-coords{
      font-size:12px;
      line-height:1.5;
      color:#9fb1cc;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(15,23,34,0.85);
    }
    .stop-popup .sp-coords span{
      display:block;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:11px;
      margin-bottom:3px;
      color:#6da8ff;
    }
    .stop-popup .sp-coords-code{
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size:12px;
      color:#e8eefb;
    }
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip{
      background:color-mix(in oklab,var(--panel) 92%, #000 8%);
      color:var(--text);
      border:1px solid #1c2533;
      box-shadow:0 12px 32px rgba(0,0,0,.55);
    }

    @media (max-width:800px){
      .search-panel{min-width:0;max-width:92vw}
      .search-input{min-width:180px}
      .watermark img{width:180px}
    }
    .selected-chip{margin-top:6px;display:none;width:100%}
    .line-chip{display:flex;align-items:center;padding:6px 6.5px;border:1px solid var(--border);border-radius:12px;background:color-mix(in oklab, var(--panel) 92%, #000 8%);box-shadow:var(--shadow);width:fit-content}
    .line-chip .close{margin-left:10px;border:none;background:transparent;color:#ef4444;font-weight:900;font-size:22px;cursor:pointer;line-height:1}
    .line-chip .close:hover{color:#ff6666}

    .line-preview-wrap{ position:fixed;left:0;right:0;bottom:0;z-index:1100; pointer-events:none; padding-bottom:env(safe-area-inset-bottom, 0); }
    .line-preview{
      margin:10px auto 12px; max-width:min(1100px,94vw);
      background:color-mix(in oklab, var(--panel) 92%, #000 8%);
      border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
      padding:10px 12px; pointer-events:auto;
    }
    .line-preview-header{ display:flex;align-items:center;gap:10px;justify-content:space-between; margin-bottom:8px; }
    .line-preview-title{ display:flex;align-items:center;gap:10px;min-width:0; }
    .line-preview .dbus-badge {
      font-size:25px;
      min-width:56px;
      height:28px;
      padding:4px 10px;
    }
    .line-preview-route{ color:var(--text);font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
    .line-preview-close{ border:none;background:transparent;color:#ef4444;font-weight:900; font-size:22px;cursor:pointer;line-height:1;padding:2px 6px;border-radius:8px; }
    .line-preview-close:hover{ color:#ff6666; background:#0f1722; }
    .line-preview-actions{ display:flex; align-items:center; gap:6px; flex:0 0 auto; }
    .line-preview-link{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px; border-radius:8px;
      border:1px solid #1f2732; background:transparent; color:#9fb1cc;
      text-decoration:none; cursor:pointer;
    }
    .line-preview-link:hover{ background:#0f1722; color:#f8fbff; }
    .line-preview-link svg{ width:16px; height:16px; display:block; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

    .transit-scroll{ overflow-x:auto;overflow-y:hidden;white-space:nowrap; padding-bottom:4px; }
    .transit{
      --lineColor:#3aa0ff;
      --rail-h:26px;
      --dot:16px;
      --ringW:12px;
      --gap:18px;
      --nameH:18px;
      display:flex;align-items:flex-start;gap:0;
      min-height:calc(var(--rail-h) + var(--nameH) + 14px);
      padding:2px 2px 6px;
    }

    .stop{ position:relative; display:flex; flex-direction:column; align-items:center; flex:0 0 auto;
      box-sizing:border-box; padding-top:calc(var(--rail-h) - var(--dot)/2); margin:0 calc(var(--gap)/2); }
    .segment{
      position:relative;
      height:4px;
      flex:1 0 60px;
      min-width:120px;
      background:var(--lineColor);
      margin-top:calc(var(--rail-h)/2 - 2px);
      margin-left:calc(var(--gap)*-0.5);
      margin-right:calc(var(--gap)*-0.5);
      border-radius:2px;
    }
    .stop .dot{ position:absolute; left:50%; top:calc(var(--rail-h)/2 - var(--dot)/2);
      transform:translateX(-50%); width:var(--dot); height:var(--dot); border-radius:50%; background:var(--lineColor);
      border:none; box-shadow:0 1px 2px rgba(0,0,0,.5); }
    .stop .name{
      color:var(--text);
      font-size:12px;
      line-height:1.3;
      text-align:center;
      margin-top:8px;
      font-weight:700;
      max-width:110px;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
    }
    .stop-flag{
      font-size:10px;
      color:#fbbf24;
      background:rgba(251,191,36,0.15);
      border:1px solid rgba(251,191,36,0.4);
      border-radius:999px;
      padding:2px 6px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }
    .stop .name .inline-ico{ height:1em; vertical-align:-.2em; }
    .stop.active .name{ color:#ffda3a; }

    @media (max-width:800px){
      .stop{min-width:64px}
      .segment{min-width:36px}
    }

    .rer-ico{
      display:inline-block;
      width:1.1em; height:1.1em;
      vertical-align:-.2em;
      background-color: currentColor;
      -webkit-mask: var(--rer-mask-url) no-repeat center / contain;
              mask: var(--rer-mask-url) no-repeat center / contain;
    }
    .metro-ico{
      display:inline-block;
      width:1.1em; height:1.1em;
      vertical-align:-.2em;
      background: var(--metro-icon-url) no-repeat center / contain;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner{
      display:inline-block; width:16px; height:16px;
      border:2px solid #8892a6; border-top-color:#e8eefb;
      border-radius:50%; animation:spin .8s linear infinite;
      vertical-align:-.2em;
    }

    .results::-webkit-scrollbar,
    .dbus-content::-webkit-scrollbar,
    .dbus-stop-content::-webkit-scrollbar,
    .transit-scroll::-webkit-scrollbar { width: 10px; height: 10px; }
    .results::-webkit-scrollbar-track,
    .dbus-content::-webkit-scrollbar-track,
    .dbus-stop-content::-webkit-scrollbar-track,
    .transit-scroll::-webkit-scrollbar-track { background: var(--panel2); border-radius: 8px; }
    .results::-webkit-scrollbar-thumb,
    .dbus-content::-webkit-scrollbar-thumb,
    .dbus-stop-content::-webkit-scrollbar-thumb,
    .transit-scroll::-webkit-scrollbar-thumb {
      background: var(--muted); border-radius: 8px; border: 2px solid var(--panel2);
    }
    .results::-webkit-scrollbar-thumb:hover,
    .dbus-content::-webkit-scrollbar-thumb:hover,
    .dbus-stop-content::-webkit-scrollbar-thumb:hover,
    .transit-scroll::-webkit-scrollbar-thumb:hover { background: var(--text); }
    .results, .dbus-content, .dbus-stop-content, .transit-scroll { scrollbar-width: thin; scrollbar-color: var(--muted) var(--panel2); }

    .result-sechead{ display:flex;align-items:center;justify-content:space-between; cursor:pointer; user-select:none; }
    .result-sechead .chev{ font-size:14px; opacity:.9; transition:transform .18s ease; }
    .result-sechead[aria-expanded="false"] .chev{ transform:rotate(-90deg); }
    .result-secbody[hidden]{ display:none !important; }
    
    .results-filters,
    .search-categories{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      width:100%;
    }
    .search-categories .dbus-mode-btn{
      padding:6px 10px;
      font-size:12px;
    }

    .result-sechead{ display:block; cursor:default; user-select:text; }
    .result-sechead .chev{ display:none !important; }

    .dbus-badge {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      background:#444;
      color:#fff;
      padding:6px 14px;
      border-radius:8px;
      min-width:48px;
      text-align:center;
      position:relative; 
    }
    
    .titus-chip{
      height:30px;
      padding:0 12px;
      font-size:16px;
      min-width:0;
      width:40px;
      display:inline-flex;
      align-items:center;
    }
    .network-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .network-badge img{
      height:36px;
      width:auto;
      object-fit:contain;
    }
    .network-logo-invert{
      filter: invert(1);
    }
    .network-chip{
      min-width:48px;
      height:30px;
      padding:0 12px;
      font-size:16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    #lpBadge.lp-badge-wrapper{
      display:flex;
      align-items:center;
      background:transparent;
      padding:0;
    }
    
    .dbus-badge .noctilien-stripe {
      position:absolute;
      left:0; right:0; bottom:0;
      height:4px;
      border-bottom-left-radius:8px;
      border-bottom-right-radius:8px;
    }

    .route-flag {
      font-size:10px;
      color:#fbbf24;
      background:rgba(255, 255, 255, 0.15);
      border:1px solid rgba(251,191,36,0.4);
      border-radius:999px;
      padding:1px 5px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }

    .badge.fictive {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-top: 10px;
      box-sizing: border-box;
    }

    .badge .fictive-stripe {
      position: absolute;
      top: 2px;
      left: 6px;
      right: 6px;
      height: 10px;
      border-radius: 4px;
      background: #000000;
      color: #fff;
      font-size: 8px;
      font-weight: 600;
      text-align: center;
      line-height: 10px;
      text-transform: uppercase;
      pointer-events: none;
      overflow: hidden;
      white-space: nowrap;
    }

    .badge-label {
      display: inline-block;
      white-space: nowrap;
      line-height: 1;
      position: relative;
      z-index: 1;
    }

    .dbus-sechead .chev {
      transition: transform .18s ease;
    }
    .dbus-sechead[aria-expanded="false"] .chev {
      transform: rotate(-90deg);
    }

    .results {
      overflow-y: auto;
      scrollbar-gutter: stable;
    }

    .custom-scale {
      position: relative;
      height: 8px;
      margin: 10px;
      background: transparent;
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,.8);
      width: fit-content;
    }

    .custom-scale .bar {
      height: 3px;
      background: var(--text);
      border-radius: 2px;
    }

    .custom-scale span {
      position: absolute;
      top: -18px;
      left: 0;
    }

    @media (max-width:1200px){
      .search-panel{width:max-content}
    }
    @media (max-width:980px){
      .search-panel{left:12px;right:12px;width:auto;max-width:none}
      .search-row{flex-wrap:wrap}
      .search-input{flex:1 1 100%;min-width:0}
      .search-row .btn{flex:1 1 48%}
      .lang-switch{flex:1 1 48%}
      .lang-btn{width:100%;justify-content:center}
      .results{max-height:50vh}
      .dbus-header{flex-wrap:wrap;align-items:flex-start}
      .dbus-mode-group{width:100%;flex-wrap:wrap;justify-content:flex-start}
      .dbus-modes{flex-wrap:wrap}
      .dbus-mode-btn{padding:6px 8px;font-size:12px}
      .dbus-footer{flex-wrap:wrap}
    }
    @media (max-width:700px){
      .dbus-panel,.dbus-stop-panel{border-radius:16px}
      .dbus-header{gap:8px;font-size:14px}
      .dbus-header .dbus-title{font-size:18px}
      .dbus-grid{grid-template-columns:repeat(auto-fill,72px)}
      .dbus-double{grid-template-columns:1fr}
      .dbus-item{flex-wrap:wrap;gap:8px}
      .dbus-item .badge{width:64px;height:28px;font-size:14px}
      .dbus-route-logo{width:38px;height:22px}
      .line-preview{padding:8px 10px;margin:8px auto 10px}
      .line-preview .dbus-badge{font-size:20px;min-width:44px;height:24px}
      .line-preview-route{font-size:13px}
      .stop .name{font-size:11px;max-width:90px}
      .watermark img{width:150px}
    }
    @media (max-width:520px){
      .search-panel{top:8px;left:8px;right:8px}
      .search-row{gap:6px}
      .btn{padding:10px 12px;font-size:13px}
      .search-input{padding:10px 12px;font-size:14px}
      .dbus-panel{padding:10px 12px}
      .dbus-footer{padding:8px 10px}
      .dbus-group-label{font-size:10px}
      .dbus-switch{padding:3px 6px}
      .dbus-switch-label{font-size:11px}
      .dbus-route-logo{width:34px;height:20px}
      .results{max-height:55vh}
    }
    @media (max-height:700px){
      .dbus-panel,.dbus-stop-panel{height:92vh}
    }

    .analysis-hud{
      position:fixed; right:8px; bottom:6px; z-index:1500;
      color:#ffffff; font-size:5px; font-weight:600; letter-spacing:.02em;
      background:rgba(11,17,24,0.6); border:1px solid rgba(255,255,255,0.05);
      border-radius:6px; padding:2px 4px; user-select:none; pointer-events:none;
    }

  </style>
  
</head>
<body>
  <div id="map"></div>

  <div class="search-panel">
    <div class="search-row">
      <div class="lang-switch" id="langSwitch">
        <button id="langToggle" class="btn lang-btn" type="button" aria-haspopup="listbox" aria-expanded="false">
          <img class="lang-flag" src="https://flagcdn.com/w40/fr.png" alt="" aria-hidden="true">
          <span class="lang-caret" aria-hidden="true"></span>
        </button>
        <div id="langMenu" class="lang-menu" role="listbox" aria-label="Langue" aria-hidden="true"></div>
      </div>
      <button id="btnSearch" class="btn" type="button" aria-expanded="false">Recherche</button>
      <button id="btnDbus" class="btn" type="button" aria-expanded="false">Lignes DBus</button>
    </div>

    <div id="dbusDepartIndicatorWrap" class="dbus-depart-indicator-wrap" hidden>
      <div class="dbus-depart-indicator" role="status" aria-live="polite">
        <span id="dbusDepartIndicatorLabel"></span>
        <button type="button" class="dbus-depart-close" id="dbusDepartIndicatorClose" aria-label="D√©sactiver">&times;</button>
      </div>
    </div>
    
    <div id="selectedChip" class="selected-chip"></div>

    <div id="searchPanel" class="dbus-panel search-panel-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="searchPanelTitle">
      <div class="dbus-header">
        <div class="dbus-title" id="searchPanelTitle">Recherche</div>
        <button type="button" class="line-preview-close dbus-close" id="searchPanelClose" aria-label="Fermer">&times;</button>
      </div>
      <div class="search-toolbar">
        <input id="search" class="search-input" type="search" placeholder="Rechercher..." autocomplete="off"/>
      </div>
      <div class="dbus-content">
        <div id="results" class="results results-panel" hidden></div>
      </div>
      <div class="dbus-footer">
        <span class="dbus-group-label" id="searchFilterLabel">Filtres</span>
        <div id="searchFilters"></div>
      </div>
    </div>

    <div id="dbusPanel" class="dbus-panel">
      <div class="dbus-header">
        <div class="dbus-title" id="dbusPanelTitle">Lignes DBus</div>
        <div class="dbus-mode-group">
          <span class="dbus-group-label" id="dbusModeLabel">Trier par</span>
          <div class="dbus-modes" role="tablist" aria-label="Mode">
            <button type="button" class="dbus-mode-btn active" data-mode="lines" aria-pressed="true">Cat√©gorie</button>
            <button type="button" class="dbus-mode-btn" data-mode="length" aria-pressed="false">Longueur</button>
            <button type="button" class="dbus-mode-btn" data-mode="departures" aria-pressed="false">D√©parts de lignes</button>
          </div>
        </div>
        <button type="button" class="line-preview-close dbus-close" id="dbusPanelClose" aria-label="Fermer">&times;</button>
      </div>
      <div class="dbus-content">
        <div id="dbusList" class="dbus-list"></div>
        <div id="dbusDepartActions" class="dbus-depart-actions" hidden>
          <button type="button" id="dbusDepartMapBtn" class="dbus-depart-map-btn"></button>
        </div>
        <div id="dbusDepartList" class="dbus-list"></div>
      </div>
      <div class="dbus-footer">
        <span class="dbus-group-label" id="dbusFilterLabel">Filtres</span>
        <div class="dbus-filters">
          <label class="dbus-switch">
            <span class="dbus-switch-label" id="dbusSchoolLabel">Scolaires</span>
            <input type="checkbox" id="dbusSchoolToggle">
          </label>
          <label class="dbus-switch">
            <span class="dbus-switch-label" id="dbusFictiveLabel">Fictif</span>
            <input type="checkbox" id="dbusFictiveToggle">
          </label>
        </div>
      </div>
    </div>
  </div>

  <div id="dbusStopPanel" class="dbus-stop-panel">
    <div class="dbus-header">
      <div class="dbus-title" id="dbusStopTitle">Arr√™t</div>
      <button type="button" class="line-preview-close dbus-close" id="dbusStopClose" aria-label="Fermer">&times;</button>
    </div>
    <div class="dbus-stop-content">
      <div id="dbusStopList" class="dbus-list"></div>
    </div>
  </div>

  <div id="linePreviewWrap" class="line-preview-wrap" style="display:none">
    <div class="line-preview" id="linePreview">
      <div class="line-preview-header">
        <div class="line-preview-title">
          <div class="dbus-badge" id="lpBadge">?</div>
          <div class="line-preview-route" id="lpRouteTitle">-</div>
        </div>
        <div class="line-preview-actions">
          <a class="line-preview-link" id="lpLink" href="" target="_blank" rel="noopener" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
          </a>
          <button type="button" class="line-preview-close" id="lpClose" aria-label="Fermer">X</button>
        </div>
      </div>
      <div class="transit-scroll">
        <div class="transit" id="lpTransit"></div>
      </div>
    </div>
  </div>

  <div class="watermark">
    <img id="watermarkLogo" src="./Overlays/idf_logo.png" alt="IDF Logo">
  </div>

  <!-- <div id="analysisHUD" class="analysis-hud"></div>*/ -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>

  const LINE_STYLES = {
    "24":         ["#ab5798", "#FFFFFF","https://www.bonjour-ratp.fr/lignes-bus/ligne-24/"],
    "63":         ["#cdc74f", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-63/"],
    "109":        ["#cdc74f", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-109/"],
    "112":        ["#e69459", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-112/"],
    "114":        ["#8cc299", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-114/"],
    "121":        ["#d63e34", "#FFFFFF","https://www.bonjour-ratp.fr/lignes-bus/ligne-121/"],
    "124":        ["#e6a4b2", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-124/"],
    "210":        ["#fecd08", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-210/"],
    "221":        ["#e7a5b3", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-221/"],
    "303":        ["#99974a", "#FFFFFF","https://www.bonjour-ratp.fr/lignes-bus/ligne-303/"],
    "325":        ["#9ad1dc", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-325/"],
    "351":        ["#d7b152", "#221f20","https://www.bonjour-ratp.fr/lignes-bus/ligne-351/"],
    "FLIXBUS":    ["#a7d245", "#FFFFFF","https://www.flixbus.fr/"],
    "N11":        ["#e9682a", "#221f20","https://www.ratp.fr/plans-lignes/noctilien/n11"],
    "N23":        ["#d09835", "#221f20","https://www.ratp.fr/plans-lignes/noctilien/n23"],
    "N33":        ["#e9682a", "#221f20","https://www.ratp.fr/plans-lignes/noctilien/n33"],
    "Titus 1":    ["#e63b20", "#FFFFFF","https://www.rosnysousbois.fr/mobilites/le-titus/"],
    "Titus 2":    ["#49713e", "#FFFFFF","https://www.rosnysousbois.fr/mobilites/le-titus/"],
    "Scolaire":   ["#31387e", "#FFFFFF",""],
    "Express 75": ["#6fb2e1", "#FFFFFF",""],
    "Express 77": ["#6fb2e1", "#FFFFFF",""],
    "Express 93": ["#6fb2e1", "#FFFFFF",""],
    "Express 94": ["#6fb2e1", "#FFFFFF",""],
  };

  const I18N = {
    fr: {
      search_placeholder: "Rechercher...",
      search_button: "Rechercher",
      search_category_label: "Cat√©gories",
      search_category_all: "Tout",
      dbus_button: "Lignes DBus",
      dbus_mode_label: "Trier par",
      dbus_filter_label: "Filtres",
      dbus_mode_lines: "Cat√©gorie",
      dbus_mode_length: "Longueur",
      dbus_mode_stops: "D√©parts de lignes",
      dbus_depart_map_btn: "üó∫Ô∏è Voir les d√©parts de lignes sur le plan",
      dbus_school_toggle: "Scolaires",
      dbus_fictive_toggle: "Fictives",
      dbus_sub_urban: "Urbaines",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Autres r√©seaux",
      lang_btn: "FR",
      language_label: "Langue",
      translate_stop_types: "Traduire les arr√™ts",
      experimental: "Exp√©rimental",
      lang_fr: "Fran√ßais",
      lang_en: "Anglais",
      lang_es: "Espagnol",
      lang_de: "Allemand",
      lang_pl: "Polonais",
      lang_pt: "Portugais",
      lang_nl: "N√©erlandais",
      lang_it: "Italien",
      lang_ru: "Russe",
      lang_zh: "Chinois",
      lang_ko: "Cor√©en",
      lang_ja: "Japonais",
      coordinates: "Coordonn√©es",
      temporary_stop: "Arr√™t provisoire",
      stop_count_singular: "{count} arr√™t",
      stop_count_plural: "{count} arr√™ts",
      recruitment_agency: "Agence de recrutement",
      repair_shop: "Atelier de r√©paration",
      garage: "Garage",
      mall: "Centre commercial",
      place: "Lieu",
      dealer: "Concessionnaire",
      city: "Ville",
      company: "Entreprise",
      stop_centre_aquatique: "Centre aquatique",
      stop_centre_aquanautique: "Centre aquanautique",
      stop_centre_commercial: "Centre commercial",
      stop_centre_municipal: "Centre municipal",
      stop_centre_pmi: "Centre de protection maternelle et infantile",
      stop_centre: "Centre",
      stop_parc_floral: "Parc Floral",
      stop_parc: "Parc",
      stop_gare: "Gare",
      stop_chateau: "Ch√¢teau",
      stop_cimetiere: "Cimeti√®re",
      stop_ecole_elementaire: "√âcole √©l√©mentaire",
      stop_ecole_primaire: "√âcole primaire",
      stop_ecole: "√âcole",
      stop_piscine: "Piscine",
      stop_stade: "Stade",
      stop_mairie: "Mairie",
      stop_hotel_de_ville: "H√¥tel de Ville",
      stop_pont: "Pont",
      stop_porte: "Porte",
      stop_place: "Place",
      stop_avenue: "Avenue",
      stop_rue: "Rue",
      stop_maison: "Maison",
      stop_plateau: "Plateau",
      stop_marche_international: "March√© international",
      dir_north: "Nord",
      dir_south: "Sud",
      dir_east: "Est",
      dir_west: "Ouest",
      stop_ecole_maternelle: "√âcole maternelle",
      stop_ecole_maternelle_publique: "√âcole maternelle publique",

      stop_college: "Coll√®ge",
      stop_lycee: "Lyc√©e",
      stop_lycee_polyvalent: "Lyc√©e polyvalent",

      stop_cite_scolaire: "Cit√© scolaire",

      stop_hopital: "H√¥pital",
      stop_eglise: "√âglise",
      stop_square: "Square",
      stop_allee: "All√©e",
      stop_chemin: "Chemin",
      stop_tour: "Tour",
      stop_ferme: "Ferme",
      stop_ferme_pedagogique: "Ferme p√©dagogique",

      stop_ministere: "Minist√®re",
      stop_ministere_economie_finances: "Minist√®re de l'√âconomie et des Finances",
      stop_echangeur: "√âchangeur",
      icon_gas: "Station service",
      icon_bus_station: "Gare routi√®re",
      icon_repair_shop: "Atelier de r√©paration",
      icon_garage: "Garage",
      icon_recruitment_agency: "Agence de recrutement",
      icon_dealer: "Concessionnaire",
      icon_border_control: "Contr√¥le d'identit√©",
      icon_toll: "P√©age",
      icon_parking: "Parking",
      results_empty: "Aucun r√©sultat",
      results_empty_category: "Aucun r√©sultat dans la cat√©gorie {category}",
      none: "Aucune",
      villes: "Villes",
      emblematic: "Lieux embl√©matiques",
      repair_shops: "Ateliers de r√©paration",
      agencies: "Agences de recrutement",
      dealers: "Concessionnaires",
      companies: "Entreprises",
      malls: "Centres commerciaux",
      see_wiki: "Voir sur Wikip√©dia",
      loading: "Chargement...",
      depart: "D√©part",
      terminus: "Terminus",
      departures_active: "Aper√ßu des emplacements de d√©parts des lignes actif",
      departures_disable: "D√©sactiver l'aper√ßu",
      destination: "Destination",
      stop: "Arr√™t",
      home_tooltip: "Revenir √† la vue initiale",
      maintenance_title: "En maintenance",
      close: "Fermer",
      open_link: "Ouvrir le lien",
      analyze_mode: "Mode Analyse",
      color_yellow: "Jaune",
      color_green: "Vert",
      color_red: "Rouge",
      color_blue: "Bleu",
      color_orange: "Orange",
      color_purple: "Violet",
      color_black: "Noir",
      color_white: "Blanc",
      color_grey: "Gris",
    },
    en: {
      search_placeholder: "Search...",
      search_button: "Search",
      search_category_label: "Categories",
      search_category_all: "All",
      dbus_button: "DBus Lines",
      dbus_mode_label: "Categories",
      dbus_filter_label: "Filters",
      dbus_mode_lines: "Default",
      dbus_mode_length: "Length",
      dbus_mode_stops: "Departure stops",
      dbus_depart_map_btn: "üó∫Ô∏è See line departures on the map",
      dbus_school_toggle: "School lines",
      dbus_fictive_toggle: "Fictive lines",
      dbus_sub_urban: "Urban",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Other networks",
      lang_btn: "EN",
      language_label: "Language",
      translate_stop_types: "Translate stops",
      experimental: "Experimental",
      lang_fr: "French",
      lang_en: "English",
      lang_es: "Spanish",
      lang_de: "German",
      lang_pl: "Polish",
      lang_pt: "Portuguese",
      lang_nl: "Dutch",
      lang_it: "Italian",
      lang_ru: "Russian",
      lang_zh: "Chinese",
      lang_ko: "Korean",
      lang_ja: "Japanese",
      coordinates: "Coordinates",
      temporary_stop: "Temporary stop",
      stop_count_singular: "{count} stop",
      stop_count_plural: "{count} stops",
      recruitment_agency: "Recruitment agency",
      repair_shop: "Repair shop",
      garage: "Garage",
      mall: "Shopping center",
      place: "Place",
      dealer: "Dealer",
      city: "City",
      company: "Company",
      stop_centre_aquatique: "Aquatic Center",
      stop_centre_aquanautique: "Aquatic Center",
      stop_centre_commercial: "Shopping Center",
      stop_centre_municipal: "Municipal Center",
      stop_centre_pmi: "Maternal and Child Protection Center",
      stop_centre: "Center",
      stop_parc_floral: "Floral Park",
      stop_parc: "Park",
      stop_gare: "Station",
      stop_chateau: "Castle",
      stop_cimetiere: "Cemetery",
      stop_ecole_elementaire: "Elementary School",
      stop_ecole_primaire: "Primary School",
      stop_ecole: "School",
      stop_piscine: "Swimming Pool",
      stop_stade: "Stadium",
      stop_mairie: "Town Hall",
      stop_hotel_de_ville: "City Hall",
      stop_pont: "Bridge",
      stop_porte: "Gate",
      stop_place: "Square",
      stop_avenue: "Avenue",
      stop_rue: "Street",
      stop_maison: "House",
      stop_plateau: "Plateau",
      stop_marche_international: "International Market",
      dir_north: "North",
      dir_south: "South",
      dir_east: "East",
      dir_west: "West",
      stop_ecole_maternelle: "Nursery school",
      stop_ecole_maternelle_publique: "Public kindergarten",

      stop_college: "Middle School",
      stop_lycee: "High School",
      stop_lycee_polyvalent: "Comprehensive High School",

      stop_cite_scolaire: "School campus",

      stop_hopital: "Hospital",
      stop_eglise: "Church",
      stop_square: "Square",
      stop_allee: "Lane",
      stop_chemin: "Path",
      stop_tour: "Tower",
      stop_ferme: "Farm",
      stop_ferme_pedagogique: "Educational farm",

      stop_ministere: "Ministry",
      stop_ministere_economie_finances: "Ministry of Economy and Finance",
      stop_echangeur: "Interchange",
      icon_gas: "Gas station",
      icon_bus_station: "Bus station",
      icon_repair_shop: "Repair shop",
      icon_garage: "Garage",
      icon_recruitment_agency: "Recruitment agency",
      icon_dealer: "Dealer",
      icon_border_control: "ID check",
      icon_toll: "Toll",
      icon_parking: "Parking",
      results_empty: "No results",
      results_empty_category: "No results in the {category} category",
      none: "None",
      villes: "Cities",
      emblematic: "Landmarks",
      repair_shops: "Repair shops",
      agencies: "Recruitment agencies",
      dealers: "Dealers",
      companies: "Companies",
      malls: "Shopping centers",
      see_wiki: "See on Wikipedia",
      loading: "Loading...",
      depart: "Departure",
      terminus: "Terminus",
      departures_active: "Departure previews active",
      departures_disable: "Disable previews",
      destination: "Destination",
      stop: "Stop",
      home_tooltip: "Return to initial view",
      maintenance_title: "Under maintenance",
      close: "Close",
      open_link: "Open link",
      analyze_mode: "Analyze Mode",
      color_yellow: "Yellow",
      color_green: "Green",
      color_red: "Red",
      color_blue: "Blue",
      color_orange: "Orange",
      color_purple: "Purple",
      color_black: "Black",
      color_white: "White",
      color_grey: "Grey",
    },
    es: {
      search_placeholder: "Buscar...",
      search_button: "Buscar",
      search_category_label: "Categor√≠as",
      search_category_all: "Todo",
      dbus_button: "L√≠neas DBus",
      dbus_mode_label: "Ordenar por",
      dbus_filter_label: "Filtros",
      dbus_mode_lines: "Categor√≠a",
      dbus_mode_length: "Longitud",
      dbus_mode_stops: "Paradas de salida",
      dbus_depart_map_btn: "üó∫Ô∏è Ver salidas de l√≠neas en el mapa",
      dbus_school_toggle: "Escolares",
      dbus_fictive_toggle: "Ficticias",
      dbus_sub_urban: "Urbanas",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Otras redes",
      lang_btn: "ES",
      language_label: "Idioma",
      translate_stop_types: "Traducir paradas",
      experimental: "Experimental",
      lang_fr: "Franc√©s",
      lang_en: "Ingl√©s",
      lang_es: "Espa√±ol",
      lang_de: "Alem√°n",
      lang_pl: "Polaco",
      lang_pt: "Portugu√©s",
      lang_nl: "Neerland√©s",
      lang_it: "Italiano",
      lang_ru: "Ruso",
      lang_zh: "Chino",
      lang_ko: "Coreano",
      lang_ja: "Japon√©s",
      coordinates: "Coordenadas",
      temporary_stop: "Parada temporal",
      stop_count_singular: "{count} parada",
      stop_count_plural: "{count} paradas",
      recruitment_agency: "Agencia de contrataci√≥n",
      repair_shop: "Taller de reparaci√≥n",
      garage: "Garaje",
      mall: "Centro comercial",
      place: "Lugar",
      dealer: "Concesionario",
      city: "Ciudad",
      company: "Empresa",
      stop_centre_aquatique: "Centro acu√°tico",
      stop_centre_aquanautique: "Centro acu√°tico",
      stop_centre_commercial: "Centro comercial",
      stop_centre_municipal: "Centro municipal",
      stop_centre_pmi: "Centro de protecci√≥n maternoinfantil",
      stop_centre: "Centro",
      stop_parc_floral: "Parque Floral",
      stop_parc: "Parque",
      stop_gare: "Estaci√≥n",
      stop_chateau: "Castillo",
      stop_cimetiere: "Cementerio",
      stop_ecole_elementaire: "Escuela primaria",
      stop_ecole_primaire: "Escuela primaria",
      stop_ecole: "Escuela",
      stop_piscine: "Piscina",
      stop_stade: "Estadio",
      stop_mairie: "Ayuntamiento",
      stop_hotel_de_ville: "Ayuntamiento",
      stop_pont: "Puente",
      stop_porte: "Puerta",
      stop_place: "Plaza",
      stop_avenue: "Avenida",
      stop_rue: "Calle",
      stop_maison: "Casa",
      stop_plateau: "Meseta",
      stop_marche_international: "Mercado internacional",
      dir_north: "Norte",
      dir_south: "Sur",
      dir_east: "Este",
      dir_west: "Oeste",
      stop_ecole_maternelle: "Jard√≠n de infancia",
      stop_ecole_maternelle_publique: "Escuela infantil p√∫blica",

      stop_college: "Escuela secundaria",
      stop_lycee: "Instituto",
      stop_lycee_polyvalent: "Instituto polivalente",

      stop_cite_scolaire: "Complejo escolar",

      stop_hopital: "Hospital",
      stop_eglise: "Iglesia",
      stop_square: "Plaza",
      stop_allee: "Alameda",
      stop_chemin: "Camino",
      stop_tour: "Torre",
      stop_ferme: "Granja",
      stop_ferme_pedagogique: "Granja educativa",

      stop_ministere: "Ministerio",
      stop_ministere_economie_finances: "Ministerio de Econom√≠a y Finanzas",
      stop_echangeur: "Intercambiador",
      icon_gas: "Gasolinera",
      icon_bus_station: "Estaci√≥n de autobuses",
      icon_repair_shop: "Taller de reparaci√≥n",
      icon_garage: "Garaje",
      icon_recruitment_agency: "Agencia de contrataci√≥n",
      icon_dealer: "Concesionario",
      icon_border_control: "Control de identidad",
      icon_toll: "Peaje",
      icon_parking: "Aparcamiento",
      results_empty: "Sin resultados",
      results_empty_category: "No hay resultados en la categor√≠a {category}",
      none: "Ninguna",
      villes: "Ciudades",
      emblematic: "Lugares emblem√°ticos",
      repair_shops: "Talleres de reparaci√≥n",
      agencies: "Agencias de contrataci√≥n",
      dealers: "Concesionarios",
      companies: "Empresas",
      malls: "Centros comerciales",
      see_wiki: "Ver en Wikipedia",
      loading: "Cargando...",
      depart: "Salida",
      terminus: "Terminal",
      departures_active: "Vista previa de ubicaciones de salida de l√≠neas activada",
      departures_disable: "Desactivar vista previa",
      destination: "Destino",
      stop: "Parada",
      home_tooltip: "Volver a la vista inicial",
      maintenance_title: "En mantenimiento",
      close: "Cerrar",
      open_link: "Abrir enlace",
      analyze_mode: "Modo de an√°lisis",
      color_yellow: "Amarillo",
      color_green: "Verde",
      color_red: "Rojo",
      color_blue: "Azul",
      color_orange: "Naranja",
      color_purple: "Morado",
      color_black: "Negro",
      color_white: "Blanco",
      color_grey: "Gris",
    },
    de: {
      search_placeholder: "Suchen...",
      search_button: "Suche",
      search_category_label: "Kategorien",
      search_category_all: "Alle",
      dbus_button: "DBus-Linien",
      dbus_mode_label: "Sortieren nach",
      dbus_filter_label: "Filter",
      dbus_mode_lines: "Kategorie",
      dbus_mode_length: "L√§nge",
      dbus_mode_stops: "Abfahrthaltestellen",
      dbus_depart_map_btn: "üó∫Ô∏è Abfahrten der Linien auf der Karte ansehen",
      dbus_school_toggle: "Schulverkehr",
      dbus_fictive_toggle: "Fiktiv",
      dbus_sub_urban: "St√§dtisch",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Andere Netze",
      lang_btn: "DE",
      language_label: "Sprache",
      translate_stop_types: "Haltestellen √ºbersetzen",
      experimental: "Experimentell",
      lang_fr: "Franz√∂sisch",
      lang_en: "Englisch",
      lang_es: "Spanisch",
      lang_de: "Deutsch",
      lang_pl: "Polnisch",
      lang_pt: "Portugiesisch",
      lang_nl: "Niederl√§ndisch",
      lang_it: "Italienisch",
      lang_ru: "Russisch",
      lang_zh: "Chinesisch",
      lang_ko: "Koreanisch",
      lang_ja: "Japanisch",
      coordinates: "Koordinaten",
      temporary_stop: "Vor√ºbergehende Haltestelle",
      stop_count_singular: "{count} Halt",
      stop_count_plural: "{count} Haltestellen",
      recruitment_agency: "Personalvermittlungsagentur",
      repair_shop: "Reparaturwerkstatt",
      garage: "Garage",
      mall: "Einkaufszentrum",
      place: "Ort",
      dealer: "H√§ndler",
      city: "Stadt",
      company: "Unternehmen",
      stop_centre_aquatique: "Aquazentrum",
      stop_centre_aquanautique: "Aquazentrum",
      stop_centre_commercial: "Einkaufszentrum",
      stop_centre_municipal: "Kommunalzentrum",
      stop_centre_pmi: "Zentrum f√ºr Mutter-Kind-Schutz",
      stop_centre: "Zentrum",
      stop_parc_floral: "Blumenpark",
      stop_parc: "Park",
      stop_gare: "Bahnhof",
      stop_chateau: "Schloss",
      stop_cimetiere: "Friedhof",
      stop_ecole_elementaire: "Grundschule",
      stop_ecole_primaire: "Grundschule",
      stop_ecole: "Schule",
      stop_piscine: "Schwimmbad",
      stop_stade: "Stadion",
      stop_mairie: "Rathaus",
      stop_hotel_de_ville: "Rathaus",
      stop_pont: "Br√ºcke",
      stop_porte: "Tor",
      stop_place: "Platz",
      stop_avenue: "Allee",
      stop_rue: "Stra√üe",
      stop_maison: "Haus",
      stop_plateau: "Hochplateau",
      stop_marche_international: "Internationaler Markt",
      dir_north: "Nord",
      dir_south: "S√ºd",
      dir_east: "Ost",
      dir_west: "West",
      stop_ecole_maternelle: "Kindergarten",
      stop_ecole_maternelle_publique: "√ñffentlicher Kindergarten",

      stop_college: "Mittelschule",
      stop_lycee: "Gymnasium",
      stop_lycee_polyvalent: "Gesamtschule",

      stop_cite_scolaire: "Schulzentrum",

      stop_hopital: "Krankenhaus",
      stop_eglise: "Kirche",
      stop_square: "Platz",
      stop_allee: "Allee",
      stop_chemin: "Weg",
      stop_tour: "Turm",
      stop_ferme: "Bauernhof",
      stop_ferme_pedagogique: "P√§dagogischer Bauernhof",

      stop_ministere: "Ministerium",
      stop_ministere_economie_finances: "Ministerium f√ºr Wirtschaft und Finanzen",
      stop_echangeur: "Autobahnkreuz",
      icon_gas: "Tankstelle",
      icon_bus_station: "Busbahnhof",
      icon_repair_shop: "Reparaturwerkstatt",
      icon_garage: "Garage",
      icon_recruitment_agency: "Personalvermittlungsagentur",
      icon_dealer: "H√§ndler",
      icon_border_control: "Ausweiskontrolle",
      icon_toll: "Maut",
      icon_parking: "Parkplatz",
      results_empty: "Keine Ergebnisse",
      results_empty_category: "Keine Ergebnisse in der Kategorie {category}",
      none: "Keine",
      villes: "St√§dte",
      emblematic: "Wahrzeichen",
      repair_shops: "Reparaturwerkst√§tten",
      agencies: "Personalvermittlungen",
      dealers: "H√§ndler",
      companies: "Unternehmen",
      malls: "Einkaufszentren",
      see_wiki: "Auf Wikipedia ansehen",
      loading: "Laden...",
      depart: "Abfahrt",
      terminus: "Endstation",
      departures_active: "Vorschau der Abfahrtsstandorte der Linien aktiviert",
      departures_disable: "Vorschau deaktivieren",
      destination: "Ziel",
      stop: "Haltestelle",
      home_tooltip: "Zur Ausgangsansicht zur√ºckkehren",
      maintenance_title: "Wartung",
      close: "Schlie√üen",
      open_link: "Link √∂ffnen",
      analyze_mode: "Analysemodus",
      color_yellow: "Gelb",
      color_green: "Gr√ºn",
      color_red: "Rot",
      color_blue: "Blau",
      color_orange: "Orange",
      color_purple: "Lila",
      color_black: "Schwarz",
      color_white: "Wei√ü",
      color_grey: "Grau",
    },
    pl: {
      search_placeholder: "Szukaj...",
      search_button: "Szukaj",
      search_category_label: "Kategorie",
      search_category_all: "Wszystkie",
      dbus_button: "Linie DBus",
      dbus_mode_label: "Sortuj wed≈Çug",
      dbus_filter_label: "Filtry",
      dbus_mode_lines: "Kategoria",
      dbus_mode_length: "D≈Çugo≈õƒá",
      dbus_mode_stops: "Przystanki poczƒÖtkowe",
      dbus_depart_map_btn: "üó∫Ô∏è Zobacz odjazdy linii na mapie",
      dbus_school_toggle: "Szkolne",
      dbus_fictive_toggle: "Fikcyjne",
      dbus_sub_urban: "Miejskie",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Inne sieci",
      lang_btn: "PL",
      language_label: "Jƒôzyk",
      translate_stop_types: "T≈Çumacz przystanki",
      experimental: "Eksperymentalne",
      lang_fr: "Francuski",
      lang_en: "Angielski",
      lang_es: "Hiszpa≈Ñski",
      lang_de: "Niemiecki",
      lang_pl: "Polski",
      lang_pt: "Portugalski",
      lang_nl: "Niderlandzki",
      lang_it: "W≈Çoski",
      lang_ru: "Rosyjski",
      lang_zh: "Chi≈Ñski",
      lang_ko: "Korea≈Ñski",
      lang_ja: "Japo≈Ñski",
      coordinates: "Wsp√≥≈Çrzƒôdne",
      temporary_stop: "Tymczasowy przystanek",
      stop_count_singular: "{count} przystanek",
      stop_count_plural: "{count} przystank√≥w",
      recruitment_agency: "Agencja rekrutacyjna",
      repair_shop: "Warsztat naprawczy",
      garage: "Gara≈º",
      mall: "Centrum handlowe",
      place: "Miejsce",
      dealer: "Dealer",
      city: "Miasto",
      company: "Firma",
      stop_centre_aquatique: "Centrum wodne",
      stop_centre_aquanautique: "Centrum wodne",
      stop_centre_commercial: "Centrum handlowe",
      stop_centre_municipal: "Centrum miejskie",
      stop_centre_pmi: "Centrum ochrony matki i dziecka",
      stop_centre: "Centrum",
      stop_parc_floral: "Park kwiatowy",
      stop_parc: "Park",
      stop_gare: "Stacja",
      stop_chateau: "Zamek",
      stop_cimetiere: "Cmentarz",
      stop_ecole_elementaire: "Szko≈Ça podstawowa",
      stop_ecole_primaire: "Szko≈Ça podstawowa",
      stop_ecole: "Szko≈Ça",
      stop_piscine: "Basen",
      stop_stade: "Stadion",
      stop_mairie: "Ratusz",
      stop_hotel_de_ville: "Ratusz",
      stop_pont: "Most",
      stop_porte: "Brama",
      stop_place: "Plac",
      stop_avenue: "Aleja",
      stop_rue: "Ulica",
      stop_maison: "Dom",
      stop_plateau: "P≈Çaskowy≈º",
      stop_marche_international: "Miƒôdzynarodowy targ",
      dir_north: "P√≥≈Çnoc",
      dir_south: "Po≈Çudnie",
      dir_east: "Wsch√≥d",
      dir_west: "Zach√≥d",
      stop_ecole_maternelle: "Przedszkole",
      stop_ecole_maternelle_publique: "Publiczne przedszkole",

      stop_college: "Gimnazjum",
      stop_lycee: "Liceum",
      stop_lycee_polyvalent: "Liceum wieloprofilowe",

      stop_cite_scolaire: "Zesp√≥≈Ç szk√≥≈Ç",

      stop_hopital: "Szpital",
      stop_eglise: "Ko≈õci√≥≈Ç",
      stop_square: "Skwer",
      stop_allee: "Aleja",
      stop_chemin: "Droga",
      stop_tour: "Wie≈ºa",
      stop_ferme: "Farma",
      stop_ferme_pedagogique: "Gospodarstwo edukacyjne",

      stop_ministere: "Ministerstwo",
      stop_ministere_economie_finances: "Ministerstwo Gospodarki i Finans√≥w",
      stop_echangeur: "Wƒôze≈Ç",
      icon_gas: "Stacja paliw",
      icon_bus_station: "Dworzec autobusowy",
      icon_repair_shop: "Warsztat naprawczy",
      icon_garage: "Gara≈º",
      icon_recruitment_agency: "Agencja rekrutacyjna",
      icon_dealer: "Dealer",
      icon_border_control: "Kontrola to≈ºsamo≈õci",
      icon_toll: "Op≈Çata drogowa",
      icon_parking: "Parking",
      results_empty: "Brak wynik√≥w",
      results_empty_category: "Brak wynik√≥w w kategorii {category}",
      none: "Brak",
      villes: "Miasta",
      emblematic: "Miejsca symboliczne",
      repair_shops: "Warsztaty naprawcze",
      agencies: "Agencje rekrutacyjne",
      dealers: "Dealerzy",
      companies: "Firmy",
      malls: "Centra handlowe",
      see_wiki: "Zobacz w Wikipedii",
      loading: "≈Åadowanie...",
      depart: "Odjazd",
      terminus: "Ko≈Ñcowy",
      departures_active: "PodglƒÖd lokalizacji odjazd√≥w linii w≈ÇƒÖczony",
      departures_disable: "Wy≈ÇƒÖcz podglƒÖd",
      destination: "Cel",
      stop: "Przystanek",
      home_tooltip: "Wr√≥ƒá do widoku poczƒÖtkowego",
      maintenance_title: "W trakcie konserwacji",
      close: "Zamknij",
      open_link: "Otw√≥rz link",
      analyze_mode: "Tryb analizy",
      color_yellow: "≈ª√≥≈Çty",
      color_green: "Zielony",
      color_red: "Czerwony",
      color_blue: "Niebieski",
      color_orange: "Pomara≈Ñczowy",
      color_purple: "Fioletowy",
      color_black: "Czarny",
      color_white: "Bia≈Çy",
      color_grey: "Szary",
    },
    pt: {
      search_placeholder: "Pesquisar...",
      search_button: "Pesquisar",
      search_category_label: "Categorias",
      search_category_all: "Tudo",
      dbus_button: "Linhas DBus",
      dbus_mode_label: "Ordenar por",
      dbus_filter_label: "Filtros",
      dbus_mode_lines: "Categoria",
      dbus_mode_length: "Comprimento",
      dbus_mode_stops: "Paradas de partida",
      dbus_depart_map_btn: "üó∫Ô∏è Ver partidas das linhas no mapa",
      dbus_school_toggle: "Escolares",
      dbus_fictive_toggle: "Fict√≠cias",
      dbus_sub_urban: "Urbanas",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Outras redes",
      lang_btn: "PT",
      language_label: "Idioma",
      translate_stop_types: "Traduzir paradas",
      experimental: "Experimental",
      lang_fr: "Franc√™s",
      lang_en: "Ingl√™s",
      lang_es: "Espanhol",
      lang_de: "Alem√£o",
      lang_pl: "Polon√™s",
      lang_pt: "Portugu√™s",
      lang_nl: "Neerland√™s",
      lang_it: "Italiano",
      lang_ru: "Russo",
      lang_zh: "Chin√™s",
      lang_ko: "Coreano",
      lang_ja: "Japon√™s",
      coordinates: "Coordenadas",
      temporary_stop: "Parada tempor√°ria",
      stop_count_singular: "{count} parada",
      stop_count_plural: "{count} paradas",
      recruitment_agency: "Ag√™ncia de recrutamento",
      repair_shop: "Oficina de reparo",
      garage: "Garagem",
      mall: "Centro comercial",
      place: "Local",
      dealer: "Concession√°ria",
      city: "Cidade",
      company: "Empresa",
      stop_centre_aquatique: "Centro aqu√°tico",
      stop_centre_aquanautique: "Centro aqu√°tico",
      stop_centre_commercial: "Centro comercial",
      stop_centre_municipal: "Centro municipal",
      stop_centre_pmi: "Centro de prote√ß√£o materno-infantil",
      stop_centre: "Centro",
      stop_parc_floral: "Parque Floral",
      stop_parc: "Parque",
      stop_gare: "Esta√ß√£o",
      stop_chateau: "Castelo",
      stop_cimetiere: "Cemit√©rio",
      stop_ecole_elementaire: "Escola prim√°ria",
      stop_ecole_primaire: "Escola prim√°ria",
      stop_ecole: "Escola",
      stop_piscine: "Piscina",
      stop_stade: "Est√°dio",
      stop_mairie: "Prefeitura",
      stop_hotel_de_ville: "Prefeitura",
      stop_pont: "Ponte",
      stop_porte: "Porta",
      stop_place: "Pra√ßa",
      stop_avenue: "Avenida",
      stop_rue: "Rua",
      stop_maison: "Casa",
      stop_plateau: "Planalto",
      stop_marche_international: "Mercado internacional",
      dir_north: "Norte",
      dir_south: "Sul",
      dir_east: "Este",
      dir_west: "Oeste",
      stop_ecole_maternelle: "Jardim de inf√¢ncia",
      stop_ecole_maternelle_publique: "Jardim de inf√¢ncia p√∫blico",

      stop_college: "Col√©gio",
      stop_lycee: "Liceu",
      stop_lycee_polyvalent: "Escola secund√°ria polivalente",

      stop_cite_scolaire: "Complexo escolar",

      stop_hopital: "Hospital",
      stop_eglise: "Igreja",
      stop_square: "Pra√ßa",
      stop_allee: "Alameda",
      stop_chemin: "Caminho",
      stop_tour: "Torre",
      stop_ferme: "Fazenda",
      stop_ferme_pedagogique: "Quinta pedag√≥gica",

      stop_ministere: "Minist√©rio",
      stop_ministere_economie_finances: "Minist√©rio da Economia e Finan√ßas",
      stop_echangeur: "Entrocamento",
      icon_gas: "Posto de gasolina",
      icon_bus_station: "Esta√ß√£o rodovi√°ria",
      icon_repair_shop: "Oficina de reparo",
      icon_garage: "Garagem",
      icon_recruitment_agency: "Ag√™ncia de recrutamento",
      icon_dealer: "Concession√°ria",
      icon_border_control: "Controle de identidade",
      icon_toll: "Ped√°gio",
      icon_parking: "Estacionamento",
      results_empty: "Sem resultados",
      results_empty_category: "Sem resultados na categoria {category}",
      none: "Nenhuma",
      villes: "Cidades",
      emblematic: "Locais emblem√°ticos",
      repair_shops: "Oficinas de reparo",
      agencies: "Ag√™ncias de recrutamento",
      dealers: "Concession√°rias",
      companies: "Empresas",
      malls: "Centros comerciais",
      see_wiki: "Ver na Wikip√©dia",
      loading: "Carregando...",
      depart: "Partida",
      terminus: "Terminal",
      departures_active: "Pr√©-visualiza√ß√£o das localiza√ß√µes de partida das linhas ativa",
      departures_disable: "Desativar pr√©-visualiza√ß√£o",
      destination: "Destino",
      stop: "Parada",
      home_tooltip: "Voltar √† vista inicial",
      maintenance_title: "Em manuten√ß√£o",
      close: "Fechar",
      open_link: "Abrir link",
      analyze_mode: "Modo de an√°lise",
      color_yellow: "Amarelo",
      color_green: "Verde",
      color_red: "Vermelho",
      color_blue: "Azul",
      color_orange: "Laranja",
      color_purple: "Roxo",
      color_black: "Preto",
      color_white: "Branco",
      color_grey: "Cinza",
    },
    nl: {
      search_placeholder: "Zoeken...",
      search_button: "Zoeken",
      search_category_label: "Categorie√´n",
      search_category_all: "Alles",
      dbus_button: "DBus-lijnen",
      dbus_mode_label: "Sorteren op",
      dbus_filter_label: "Filters",
      dbus_mode_lines: "Categorie",
      dbus_mode_length: "Lengte",
      dbus_mode_stops: "Vertrekhaltes",
      dbus_depart_map_btn: "üó∫Ô∏è Vertrekken van lijnen op de kaart bekijken",
      dbus_school_toggle: "Schoollijnen",
      dbus_fictive_toggle: "Fictief",
      dbus_sub_urban: "Stedelijk",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Andere netwerken",
      lang_btn: "NL",
      language_label: "Taal",
      translate_stop_types: "Haltes vertalen",
      experimental: "Experimenteel",
      lang_fr: "Frans",
      lang_en: "Engels",
      lang_es: "Spaans",
      lang_de: "Duits",
      lang_pl: "Pools",
      lang_pt: "Portugees",
      lang_nl: "Nederlands",
      lang_it: "Italiaans",
      lang_ru: "Russisch",
      lang_zh: "Chinees",
      lang_ko: "Koreaans",
      lang_ja: "Japans",
      coordinates: "Co√∂rdinaten",
      temporary_stop: "Tijdelijke halte",
      stop_count_singular: "{count} halte",
      stop_count_plural: "{count} haltes",
      recruitment_agency: "Wervingsbureau",
      repair_shop: "Reparatiewerkplaats",
      garage: "Garage",
      mall: "Winkelcentrum",
      place: "Plaats",
      dealer: "Dealer",
      city: "Stad",
      company: "Bedrijf",
      stop_centre_aquatique: "Aquacentrum",
      stop_centre_aquanautique: "Aquacentrum",
      stop_centre_commercial: "Winkelcentrum",
      stop_centre_municipal: "Gemeentelijk centrum",
      stop_centre_pmi: "Centrum voor moeder- en kindbescherming",
      stop_centre: "Centrum",
      stop_parc_floral: "Bloemenpark",
      stop_parc: "Park",
      stop_gare: "Station",
      stop_chateau: "Kasteel",
      stop_cimetiere: "Begraafplaats",
      stop_ecole_elementaire: "Basisschool",
      stop_ecole_primaire: "Basisschool",
      stop_ecole: "School",
      stop_piscine: "Zwembad",
      stop_stade: "Stadion",
      stop_mairie: "Gemeentehuis",
      stop_hotel_de_ville: "Stadhuis",
      stop_pont: "Brug",
      stop_porte: "Poort",
      stop_place: "Plein",
      stop_avenue: "Laan",
      stop_rue: "Straat",
      stop_maison: "Huis",
      stop_plateau: "Plateau",
      stop_marche_international: "Internationale markt",
      dir_north: "Noord",
      dir_south: "Zuid",
      dir_east: "Oost",
      dir_west: "West",
      stop_ecole_maternelle: "Kleuterschool",
      stop_ecole_maternelle_publique: "Openbare kleuterschool",

      stop_college: "Middelbare school",
      stop_lycee: "Lyceum",
      stop_lycee_polyvalent: "Brede scholengemeenschap",

      stop_cite_scolaire: "Scholencampus",

      stop_hopital: "Ziekenhuis",
      stop_eglise: "Kerk",
      stop_square: "Plein",
      stop_allee: "Laan",
      stop_chemin: "Pad",
      stop_tour: "Toren",
      stop_ferme: "Boerderij",
      stop_ferme_pedagogique: "Educatieve boerderij",

      stop_ministere: "Ministerie",
      stop_ministere_economie_finances: "Ministerie van Economie en Financi√´n",
      stop_echangeur: "Knooppunt",
      icon_gas: "Tankstation",
      icon_bus_station: "Busstation",
      icon_repair_shop: "Reparatiewerkplaats",
      icon_garage: "Garage",
      icon_recruitment_agency: "Wervingsbureau",
      icon_dealer: "Dealer",
      icon_border_control: "Identiteitscontrole",
      icon_toll: "Tol",
      icon_parking: "Parkeerplaats",
      results_empty: "Geen resultaten",
      results_empty_category: "Geen resultaten in de categorie {category}",
      none: "Geen",
      villes: "Steden",
      emblematic: "Bezienswaardigheden",
      repair_shops: "Reparatiewerkplaatsen",
      agencies: "Wervingsbureaus",
      dealers: "Dealers",
      companies: "Bedrijven",
      malls: "Winkelcentra",
      see_wiki: "Bekijk op Wikipedia",
      loading: "Laden...",
      depart: "Vertrek",
      terminus: "Eindpunt",
      departures_active: "Voorvertoning van vertreklocaties van lijnen actief",
      departures_disable: "Voorvertoning uitschakelen",
      destination: "Bestemming",
      stop: "Halte",
      home_tooltip: "Terug naar de beginweergave",
      maintenance_title: "In onderhoud",
      close: "Sluiten",
      open_link: "Link openen",
      analyze_mode: "Analysemodus",
      color_yellow: "Geel",
      color_green: "Groen",
      color_red: "Rood",
      color_blue: "Blauw",
      color_orange: "Oranje",
      color_purple: "Paars",
      color_black: "Zwart",
      color_white: "Wit",
      color_grey: "Grijs",
    },
    it: {
      search_placeholder: "Cerca...",
      search_button: "Cerca",
      search_category_label: "Categorie",
      search_category_all: "Tutto",
      dbus_button: "Linee DBus",
      dbus_mode_label: "Ordina per",
      dbus_filter_label: "Filtri",
      dbus_mode_lines: "Categoria",
      dbus_mode_length: "Lunghezza",
      dbus_mode_stops: "Fermate di partenza",
      dbus_depart_map_btn: "üó∫Ô∏è Vedi le partenze delle linee sulla mappa",
      dbus_school_toggle: "Scolastiche",
      dbus_fictive_toggle: "Fittizie",
      dbus_sub_urban: "Urbane",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Altre reti",
      lang_btn: "IT",
      language_label: "Lingua",
      translate_stop_types: "Traduci fermate",
      experimental: "Sperimentale",
      lang_fr: "Francese",
      lang_en: "Inglese",
      lang_es: "Spagnolo",
      lang_de: "Tedesco",
      lang_pl: "Polacco",
      lang_pt: "Portoghese",
      lang_nl: "Olandese",
      lang_it: "Italiano",
      lang_ru: "Russo",
      lang_zh: "Cinese",
      lang_ko: "Coreano",
      lang_ja: "Giapponese",
      coordinates: "Coordinate",
      temporary_stop: "Fermata temporanea",
      stop_count_singular: "{count} fermata",
      stop_count_plural: "{count} fermate",
      recruitment_agency: "Agenzia di reclutamento",
      repair_shop: "Officina di riparazione",
      garage: "Garage",
      mall: "Centro commerciale",
      place: "Luogo",
      dealer: "Concessionario",
      city: "Citt√†",
      company: "Azienda",
      stop_centre_aquatique: "Centro acquatico",
      stop_centre_aquanautique: "Centro acquatico",
      stop_centre_commercial: "Centro commerciale",
      stop_centre_municipal: "Centro comunale",
      stop_centre_pmi: "Centro di protezione materno-infantile",
      stop_centre: "Centro",
      stop_parc_floral: "Parco floreale",
      stop_parc: "Parco",
      stop_gare: "Stazione",
      stop_chateau: "Castello",
      stop_cimetiere: "Cimitero",
      stop_ecole_elementaire: "Scuola primaria",
      stop_ecole_primaire: "Scuola primaria",
      stop_ecole: "Scuola",
      stop_piscine: "Piscina",
      stop_stade: "Stadio",
      stop_mairie: "Municipio",
      stop_hotel_de_ville: "Municipio",
      stop_pont: "Ponte",
      stop_porte: "Porta",
      stop_place: "Piazza",
      stop_avenue: "Viale",
      stop_rue: "Via",
      stop_maison: "Casa",
      stop_plateau: "Altopiano",
      stop_marche_international: "Mercato internazionale",
      dir_north: "Nord",
      dir_south: "Sud",
      dir_east: "Est",
      dir_west: "Ovest",
      stop_ecole_maternelle: "Scuola materna",
      stop_ecole_maternelle_publique: "Scuola materna pubblica",

      stop_college: "Scuola media",
      stop_lycee: "Liceo",
      stop_lycee_polyvalent: "Liceo polivalente",

      stop_cite_scolaire: "Complesso scolastico",

      stop_hopital: "Ospedale",
      stop_eglise: "Chiesa",
      stop_square: "Piazza",
      stop_allee: "Viale",
      stop_chemin: "Sentiero",
      stop_tour: "Torre",
      stop_ferme: "Fattoria",
      stop_ferme_pedagogique: "Fattoria didattica",

      stop_ministere: "Ministero",
      stop_ministere_economie_finances: "Ministero dell'Economia e delle Finanze",
      stop_echangeur: "Svincolo",
      icon_gas: "Stazione di servizio",
      icon_bus_station: "Stazione autobus",
      icon_repair_shop: "Officina di riparazione",
      icon_garage: "Garage",
      icon_recruitment_agency: "Agenzia di reclutamento",
      icon_dealer: "Concessionario",
      icon_border_control: "Controllo identit√†",
      icon_toll: "Pedaggio",
      icon_parking: "Parcheggio",
      results_empty: "Nessun risultato",
      results_empty_category: "Nessun risultato nella categoria {category}",
      none: "Nessuna",
      villes: "Citt√†",
      emblematic: "Luoghi emblematici",
      repair_shops: "Officine di riparazione",
      agencies: "Agenzie di reclutamento",
      dealers: "Concessionari",
      companies: "Aziende",
      malls: "Centri commerciali",
      see_wiki: "Vedi su Wikipedia",
      loading: "Caricamento...",
      depart: "Partenza",
      terminus: "Capolinea",
      departures_active: "Anteprima delle posizioni di partenza delle linee attiva",
      departures_disable: "Disattiva anteprima",
      destination: "Destinazione",
      stop: "Fermata",
      home_tooltip: "Torna alla vista iniziale",
      maintenance_title: "In manutenzione",
      close: "Chiudi",
      open_link: "Apri link",
      analyze_mode: "Modalit√† analisi",
      color_yellow: "Giallo",
      color_green: "Verde",
      color_red: "Rosso",
      color_blue: "Blu",
      color_orange: "Arancione",
      color_purple: "Viola",
      color_black: "Nero",
      color_white: "Bianco",
      color_grey: "Grigio",
    },
    ru: {
      search_placeholder: "–ü–æ–∏—Å–∫...",
      search_button: "–ü–æ–∏—Å–∫",
      search_category_label: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏",
      search_category_all: "–í—Å–µ",
      dbus_button: "–õ–∏–Ω–∏–∏ DBus",
      dbus_mode_label: "–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ",
      dbus_filter_label: "–§–∏–ª—å—Ç—Ä—ã",
      dbus_mode_lines: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
      dbus_mode_length: "–î–ª–∏–Ω–∞",
      dbus_mode_stops: "–û—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
      dbus_depart_map_btn: "üó∫Ô∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ",
      dbus_school_toggle: "–®–∫–æ–ª—å–Ω—ã–µ",
      dbus_fictive_toggle: "–í—ã–º—ã—à–ª–µ–Ω–Ω—ã–µ",
      dbus_sub_urban: "–ì–æ—Ä–æ–¥—Å–∫–∏–µ",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "–î—Ä—É–≥–∏–µ —Å–µ—Ç–∏",
      lang_btn: "RU",
      language_label: "–Ø–∑—ã–∫",
      translate_stop_types: "–ü–µ—Ä–µ–≤–æ–¥–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏",
      experimental: "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ",
      lang_fr: "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π",
      lang_en: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π",
      lang_es: "–ò—Å–ø–∞–Ω—Å–∫–∏–π",
      lang_de: "–ù–µ–º–µ—Ü–∫–∏–π",
      lang_pl: "–ü–æ–ª—å—Å–∫–∏–π",
      lang_pt: "–ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π",
      lang_nl: "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—Å–∫–∏–π",
      lang_it: "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π",
      lang_ru: "–†—É—Å—Å–∫–∏–π",
      lang_zh: "–ö–∏—Ç–∞–π—Å–∫–∏–π",
      lang_ko: "–ö–æ—Ä–µ–π—Å–∫–∏–π",
      lang_ja: "–Ø–ø–æ–Ω—Å–∫–∏–π",
      coordinates: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã",
      temporary_stop: "–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞",
      stop_count_singular: "{count} –æ—Å—Ç–∞–Ω–æ–≤–∫–∞",
      stop_count_plural: "{count} –æ—Å—Ç–∞–Ω–æ–≤–æ–∫",
      recruitment_agency: "–ö–∞–¥—Ä–æ–≤–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ",
      repair_shop: "–†–µ–º–æ–Ω—Ç–Ω–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è",
      garage: "–ì–∞—Ä–∞–∂",
      mall: "–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä",
      place: "–ú–µ—Å—Ç–æ",
      dealer: "–î–∏–ª–µ—Ä",
      city: "–ì–æ—Ä–æ–¥",
      company: "–ö–æ–º–ø–∞–Ω–∏—è",
      stop_centre_aquatique: "–ê–∫–≤–∞—Ü–µ–Ω—Ç—Ä",
      stop_centre_aquanautique: "–ê–∫–≤–∞—Ü–µ–Ω—Ç—Ä",
      stop_centre_commercial: "–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä",
      stop_centre_municipal: "–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä",
      stop_centre_pmi: "–¶–µ–Ω—Ç—Ä –æ—Ö—Ä–∞–Ω—ã –º–∞—Ç–µ—Ä–∏–Ω—Å—Ç–≤–∞ –∏ –¥–µ—Ç—Å—Ç–≤–∞",
      stop_centre: "–¶–µ–Ω—Ç—Ä",
      stop_parc_floral: "–¶–≤–µ—Ç–æ—á–Ω—ã–π –ø–∞—Ä–∫",
      stop_parc: "–ü–∞—Ä–∫",
      stop_gare: "–°—Ç–∞–Ω—Ü–∏—è",
      stop_chateau: "–ó–∞–º–æ–∫",
      stop_cimetiere: "–ö–ª–∞–¥–±–∏—â–µ",
      stop_ecole_elementaire: "–ù–∞—á–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞",
      stop_ecole_primaire: "–ù–∞—á–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞",
      stop_ecole: "–®–∫–æ–ª–∞",
      stop_piscine: "–ë–∞—Å—Å–µ–π–Ω",
      stop_stade: "–°—Ç–∞–¥–∏–æ–Ω",
      stop_mairie: "–ú—ç—Ä–∏—è",
      stop_hotel_de_ville: "–ú—ç—Ä–∏—è",
      stop_pont: "–ú–æ—Å—Ç",
      stop_porte: "–í–æ—Ä–æ—Ç–∞",
      stop_place: "–ü–ª–æ—â–∞–¥—å",
      stop_avenue: "–ü—Ä–æ—Å–ø–µ–∫—Ç",
      stop_rue: "–£–ª–∏—Ü–∞",
      stop_maison: "–î–æ–º",
      stop_plateau: "–ü–ª–∞—Ç–æ",
      stop_marche_international: "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ä—ã–Ω–æ–∫",
      dir_north: "–°–µ–≤–µ—Ä",
      dir_south: "–Æ–≥",
      dir_east: "–í–æ—Å—Ç–æ–∫",
      dir_west: "–ó–∞–ø–∞–¥",
      stop_ecole_maternelle: "–î–µ—Ç—Å–∫–∏–π —Å–∞–¥",
      stop_ecole_maternelle_publique: "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—Ç—Å–∫–∏–π —Å–∞–¥",

      stop_college: "–°—Ä–µ–¥–Ω—è—è —à–∫–æ–ª–∞",
      stop_lycee: "–õ–∏—Ü–µ–π",
      stop_lycee_polyvalent: "–ú–Ω–æ–≥–æ–ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–π –ª–∏—Ü–µ–π",

      stop_cite_scolaire: "–®–∫–æ–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å",

      stop_hopital: "–ë–æ–ª—å–Ω–∏—Ü–∞",
      stop_eglise: "–¶–µ—Ä–∫–æ–≤—å",
      stop_square: "–°–∫–≤–µ—Ä",
      stop_allee: "–ê–ª–ª–µ—è",
      stop_chemin: "–î–æ—Ä–æ–≥–∞",
      stop_tour: "–ë–∞—à–Ω—è",
      stop_ferme: "–§–µ—Ä–º–∞",
      stop_ferme_pedagogique: "–£—á–µ–±–Ω–∞—è —Ñ–µ—Ä–º–∞",

      stop_ministere: "–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ",
      stop_ministere_economie_finances: "–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤",
      stop_echangeur: "–†–∞–∑–≤—è–∑–∫–∞",
      icon_gas: "–ó–∞–ø—Ä–∞–≤–∫–∞",
      icon_bus_station: "–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª",
      icon_repair_shop: "–†–µ–º–æ–Ω—Ç–Ω–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è",
      icon_garage: "–ì–∞—Ä–∞–∂",
      icon_recruitment_agency: "–ö–∞–¥—Ä–æ–≤–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ",
      icon_dealer: "–î–∏–ª–µ—Ä",
      icon_border_control: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–∏",
      icon_toll: "–ü–ª–∞—Ç–Ω–∞—è –¥–æ—Ä–æ–≥–∞",
      icon_parking: "–ü–∞—Ä–∫–æ–≤–∫–∞",
      results_empty: "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
      results_empty_category: "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {category}",
      none: "–ù–µ—Ç",
      villes: "–ì–æ—Ä–æ–¥–∞",
      emblematic: "–ó–Ω–∞–∫–æ–≤—ã–µ –º–µ—Å—Ç–∞",
      repair_shops: "–†–µ–º–æ–Ω—Ç–Ω—ã–µ –º–∞—Å—Ç–µ—Ä—Å–∫–∏–µ",
      agencies: "–ê–≥–µ–Ω—Ç—Å—Ç–≤–∞ –ø–æ –ø–æ–¥–±–æ—Ä—É –ø–µ—Ä—Å–æ–Ω–∞–ª–∞",
      dealers: "–î–∏–ª–µ—Ä—ã",
      companies: "–ö–æ–º–ø–∞–Ω–∏–∏",
      malls: "–¢–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã",
      see_wiki: "–°–º–æ—Ç—Ä–µ—Ç—å –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏",
      loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
      depart: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
      terminus: "–ö–æ–Ω–µ—á–Ω–∞—è",
      departures_active: "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–Ω–∏–π –∞–∫—Ç–∏–≤–µ–Ω",
      departures_disable: "–û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä",
      destination: "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ",
      stop: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞",
      home_tooltip: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º—É –≤–∏–¥—É",
      maintenance_title: "–ù–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏",
      close: "–ó–∞–∫—Ä—ã—Ç—å",
      open_link: "–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É",
      analyze_mode: "–†–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞",
      color_yellow: "–ñ–µ–ª—Ç—ã–π",
      color_green: "–ó–µ–ª–µ–Ω—ã–π",
      color_red: "–ö—Ä–∞—Å–Ω—ã–π",
      color_blue: "–°–∏–Ω–∏–π",
      color_orange: "–û—Ä–∞–Ω–∂–µ–≤—ã–π",
      color_purple: "–§–∏–æ–ª–µ—Ç–æ–≤—ã–π",
      color_black: "–ß–µ—Ä–Ω—ã–π",
      color_white: "–ë–µ–ª—ã–π",
      color_grey: "–°–µ—Ä—ã–π",
    },
    zh: {
      search_placeholder: "ÊêúÁ¥¢...",
      search_button: "ÊêúÁ¥¢",
      search_category_label: "Á±ªÂà´",
      search_category_all: "ÂÖ®ÈÉ®",
      dbus_button: "DBusÁ∫øË∑Ø",
      dbus_mode_label: "ÊéíÂ∫è‰æùÊçÆ",
      dbus_filter_label: "Á≠õÈÄâ",
      dbus_mode_lines: "Á±ªÂà´",
      dbus_mode_length: "ÈïøÂ∫¶",
      dbus_mode_stops: "Âá∫ÂèëÁ´ôÁÇπ",
      dbus_depart_map_btn: "üó∫Ô∏è Âú®Âú∞Âõæ‰∏äÊü•ÁúãÁ∫øË∑ØÂá∫ÂèëÁÇπ",
      dbus_school_toggle: "Ê†°ËΩ¶",
      dbus_fictive_toggle: "ËôöÊûÑ",
      dbus_sub_urban: "ÂüéÂ∏Ç",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "ÂÖ∂‰ªñÁΩëÁªú",
      lang_btn: "ZH",
      language_label: "ËØ≠Ë®Ä",
      translate_stop_types: "ÁøªËØëÁ´ôÁÇπ",
      experimental: "ÂÆûÈ™åÊÄß",
      lang_fr: "Ê≥ïËØ≠",
      lang_en: "Ëã±ËØ≠",
      lang_es: "Ë•øÁè≠ÁâôËØ≠",
      lang_de: "Âæ∑ËØ≠",
      lang_pl: "Ê≥¢ÂÖ∞ËØ≠",
      lang_pt: "Ëë°ËêÑÁâôËØ≠",
      lang_nl: "Ëç∑ÂÖ∞ËØ≠",
      lang_it: "ÊÑèÂ§ßÂà©ËØ≠",
      lang_ru: "‰øÑËØ≠",
      lang_zh: "‰∏≠Êñá",
      lang_ko: "Èü©ËØ≠",
      lang_ja: "Êó•ËØ≠",
      coordinates: "ÂùêÊ†á",
      temporary_stop: "‰∏¥Êó∂Á´ôÁÇπ",
      stop_count_singular: "{count} Á´ô",
      stop_count_plural: "{count} Á´ô",
      recruitment_agency: "ÊãõËÅòÊú∫ÊûÑ",
      repair_shop: "Áª¥‰øÆËΩ¶Èó¥",
      garage: "ËΩ¶Â∫ì",
      mall: "Ë¥≠Áâ©‰∏≠ÂøÉ",
      place: "Âú∞ÁÇπ",
      dealer: "ÁªèÈîÄÂïÜ",
      city: "ÂüéÂ∏Ç",
      company: "ÂÖ¨Âè∏",
      stop_centre_aquatique: "Ê∞¥‰∏ä‰∏≠ÂøÉ",
      stop_centre_aquanautique: "Ê∞¥‰∏ä‰∏≠ÂøÉ",
      stop_centre_commercial: "Ë¥≠Áâ©‰∏≠ÂøÉ",
      stop_centre_municipal: "Â∏ÇÊîø‰∏≠ÂøÉ",
      stop_centre_pmi: "ÊØçÂ©¥‰øùÂÅ•‰∏≠ÂøÉ",
      stop_centre: "‰∏≠ÂøÉ",
      stop_parc_floral: "Ëä±ÂçâÂÖ¨Âõ≠",
      stop_parc: "ÂÖ¨Âõ≠",
      stop_gare: "ËΩ¶Á´ô",
      stop_chateau: "ÂüéÂ†°",
      stop_cimetiere: "ÂÖ¨Â¢ì",
      stop_ecole_elementaire: "Â∞èÂ≠¶",
      stop_ecole_primaire: "Â∞èÂ≠¶",
      stop_ecole: "Â≠¶Ê†°",
      stop_piscine: "Ê∏∏Ê≥≥È¶Ü",
      stop_stade: "‰ΩìËÇ≤Âú∫",
      stop_mairie: "Â∏ÇÊîøÂéÖ",
      stop_hotel_de_ville: "Â∏ÇÊîøÂéÖ",
      stop_pont: "Ê°•",
      stop_porte: "Èó®",
      stop_place: "ÂπøÂú∫",
      stop_avenue: "Â§ßÈÅì",
      stop_rue: "Ë°ó",
      stop_maison: "‰πãÂÆ∂",
      stop_plateau: "È´òÂéü",
      stop_marche_international: "ÂõΩÈôÖÂ∏ÇÂú∫",
      dir_north: "Âåó",
      dir_south: "Âçó",
      dir_east: "‰∏ú",
      dir_west: "Ë•ø",
      stop_ecole_maternelle: "ÂπºÂÑøÂõ≠",
      stop_ecole_maternelle_publique: "ÂÖ¨Á´ãÂπºÂÑøÂõ≠",

      stop_college: "Âàù‰∏≠",
      stop_lycee: "È´ò‰∏≠",
      stop_lycee_polyvalent: "ÁªºÂêàÈ´ò‰∏≠",

      stop_cite_scolaire: "Ê†°Âõ≠",

      stop_hopital: "ÂåªÈô¢",
      stop_eglise: "ÊïôÂ†Ç",
      stop_square: "ÂπøÂú∫",
      stop_allee: "ÊûóËç´ÈÅì",
      stop_chemin: "Â∞èË∑Ø",
      stop_tour: "Â°î",
      stop_ferme: "ÂÜúÂú∫",
      stop_ferme_pedagogique: "ÊïôËÇ≤ÂÜúÂú∫",

      stop_ministere: "ÈÉ®",
      stop_ministere_economie_finances: "ÁªèÊµéÂíåË¥¢ÊîøÈÉ®",
      stop_echangeur: "Á´ã‰∫§",
      icon_gas: "Âä†Ê≤πÁ´ô",
      icon_bus_station: "Ê±ΩËΩ¶Á´ô",
      icon_repair_shop: "Áª¥‰øÆËΩ¶Èó¥",
      icon_garage: "ËΩ¶Â∫ì",
      icon_recruitment_agency: "ÊãõËÅòÊú∫ÊûÑ",
      icon_dealer: "ÁªèÈîÄÂïÜ",
      icon_border_control: "Ë∫´‰ªΩÊ£ÄÊü•",
      icon_toll: "Êî∂Ë¥πÁ´ô",
      icon_parking: "ÂÅúËΩ¶Âú∫",
      results_empty: "Ê≤°ÊúâÁªìÊûú",
      results_empty_category: "Á±ªÂà´ {category} ‰∏≠Ê≤°ÊúâÁªìÊûú",
      none: "Êó†",
      villes: "ÂüéÂ∏Ç",
      emblematic: "Ê†áÂøóÊÄßÂú∞ÁÇπ",
      repair_shops: "Áª¥‰øÆËΩ¶Èó¥",
      agencies: "ÊãõËÅòÊú∫ÊûÑ",
      dealers: "ÁªèÈîÄÂïÜ",
      companies: "‰ºÅ‰∏ö",
      malls: "Ë¥≠Áâ©‰∏≠ÂøÉ",
      see_wiki: "Âú®Áª¥Âü∫ÁôæÁßëÊü•Áúã",
      loading: "Âä†ËΩΩ‰∏≠...",
      depart: "Âá∫Âèë",
      terminus: "ÁªàÁÇπ",
      departures_active: "Á∫øË∑ØÂá∫Âèë‰ΩçÁΩÆÈ¢ÑËßàÂ∑≤ÂêØÁî®",
      departures_disable: "Á¶ÅÁî®È¢ÑËßà",
      destination: "ÁõÆÁöÑÂú∞",
      stop: "Á´ôÁÇπ",
      home_tooltip: "ËøîÂõûÂàùÂßãËßÜÂõæ",
      maintenance_title: "Áª¥Êä§‰∏≠",
      close: "ÂÖ≥Èó≠",
      open_link: "ÊâìÂºÄÈìæÊé•",
      analyze_mode: "ÂàÜÊûêÊ®°Âºè",
      color_yellow: "ÈªÑËâ≤",
      color_green: "ÁªøËâ≤",
      color_red: "Á∫¢Ëâ≤",
      color_blue: "ËìùËâ≤",
      color_orange: "Ê©ôËâ≤",
      color_purple: "Á¥´Ëâ≤",
      color_black: "ÈªëËâ≤",
      color_white: "ÁôΩËâ≤",
      color_grey: "ÁÅ∞Ëâ≤",
    },
    ko: {
      search_placeholder: "Í≤ÄÏÉâ...",
      search_button: "Í≤ÄÏÉâ",
      search_category_label: "Ïπ¥ÌÖåÍ≥†Î¶¨",
      search_category_all: "Ï†ÑÏ≤¥",
      dbus_button: "DBus ÎÖ∏ÏÑ†",
      dbus_mode_label: "Ï†ïÎ†¨ Í∏∞Ï§Ä",
      dbus_filter_label: "ÌïÑÌÑ∞",
      dbus_mode_lines: "Ïπ¥ÌÖåÍ≥†Î¶¨",
      dbus_mode_length: "Í∏∏Ïù¥",
      dbus_mode_stops: "Ï∂úÎ∞ú Ï†ïÎ•òÏû•",
      dbus_depart_map_btn: "üó∫Ô∏è ÏßÄÎèÑÏóêÏÑú ÎÖ∏ÏÑ† Ï∂úÎ∞ú ÏßÄÏ†ê Î≥¥Í∏∞",
      dbus_school_toggle: "ÌïôÍµê ÎÖ∏ÏÑ†",
      dbus_fictive_toggle: "Í∞ÄÏÉÅ",
      dbus_sub_urban: "ÎèÑÏãú",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "Í∏∞ÌÉÄ ÎÑ§Ìä∏ÏõåÌÅ¨",
      lang_btn: "KO",
      language_label: "Ïñ∏Ïñ¥",
      translate_stop_types: "Ï†ïÎ•òÏû• Î≤àÏó≠",
      experimental: "Ïã§ÌóòÏ†Å",
      lang_fr: "ÌîÑÎûëÏä§Ïñ¥",
      lang_en: "ÏòÅÏñ¥",
      lang_es: "Ïä§ÌéòÏù∏Ïñ¥",
      lang_de: "ÎèÖÏùºÏñ¥",
      lang_pl: "Ìè¥ÎûÄÎìúÏñ¥",
      lang_pt: "Ìè¨Î•¥Ìà¨Í∞àÏñ¥",
      lang_nl: "ÎÑ§ÎçúÎûÄÎìúÏñ¥",
      lang_it: "Ïù¥ÌÉàÎ¶¨ÏïÑÏñ¥",
      lang_ru: "Îü¨ÏãúÏïÑÏñ¥",
      lang_zh: "Ï§ëÍµ≠Ïñ¥",
      lang_ko: "ÌïúÍµ≠Ïñ¥",
      lang_ja: "ÏùºÎ≥∏Ïñ¥",
      coordinates: "Ï¢åÌëú",
      temporary_stop: "ÏûÑÏãú Ï†ïÎ•òÏû•",
      stop_count_singular: "{count} Ï†ïÎ•òÏû•",
      stop_count_plural: "{count} Ï†ïÎ•òÏû•",
      recruitment_agency: "Ï±ÑÏö© ÎåÄÌñâÏÇ¨",
      repair_shop: "ÏàòÎ¶¨Ï†ê",
      garage: "Ï∞®Í≥†",
      mall: "ÏáºÌïëÏÑºÌÑ∞",
      place: "Ïû•ÏÜå",
      dealer: "ÎåÄÎ¶¨Ï†ê",
      city: "ÎèÑÏãú",
      company: "ÌöåÏÇ¨",
      stop_centre_aquatique: "ÏïÑÏø†ÏïÑÏÑºÌÑ∞",
      stop_centre_aquanautique: "ÏïÑÏø†ÏïÑÏÑºÌÑ∞",
      stop_centre_commercial: "ÏáºÌïëÏÑºÌÑ∞",
      stop_centre_municipal: "ÏãúÎ¶Ω ÏÑºÌÑ∞",
      stop_centre_pmi: "Î™®ÏûêÎ≥¥Í±¥ÏÑºÌÑ∞",
      stop_centre: "ÏÑºÌÑ∞",
      stop_parc_floral: "ÍΩÉÍ≥µÏõê",
      stop_parc: "Í≥µÏõê",
      stop_gare: "Ïó≠",
      stop_chateau: "ÏÑ±",
      stop_cimetiere: "Î¨òÏßÄ",
      stop_ecole_elementaire: "Ï¥àÎì±ÌïôÍµê",
      stop_ecole_primaire: "Ï¥àÎì±ÌïôÍµê",
      stop_ecole: "ÌïôÍµê",
      stop_piscine: "ÏàòÏòÅÏû•",
      stop_stade: "Í≤ΩÍ∏∞Ïû•",
      stop_mairie: "ÏãúÏ≤≠",
      stop_hotel_de_ville: "ÏãúÏ≤≠",
      stop_pont: "Îã§Î¶¨",
      stop_porte: "Î¨∏",
      stop_place: "Í¥ëÏû•",
      stop_avenue: "ÎåÄÎ°ú",
      stop_rue: "Í±∞Î¶¨",
      stop_maison: "Ïßë",
      stop_plateau: "Í≥†Ïõê",
      stop_marche_international: "Íµ≠Ï†ú ÏãúÏû•",
      dir_north: "Î∂Å",
      dir_south: "ÎÇ®",
      dir_east: "Îèô",
      dir_west: "ÏÑú",
      stop_ecole_maternelle: "Ïú†ÏπòÏõê",
      stop_ecole_maternelle_publique: "Í≥µÎ¶Ω Ïú†ÏπòÏõê",

      stop_college: "Ï§ëÌïôÍµê",
      stop_lycee: "Í≥†Îì±ÌïôÍµê",
      stop_lycee_polyvalent: "Ï¢ÖÌï©Í≥†Îì±ÌïôÍµê",

      stop_cite_scolaire: "ÌïôÍµê Ï∫†ÌçºÏä§",

      stop_hopital: "Î≥ëÏõê",
      stop_eglise: "ÍµêÌöå",
      stop_square: "Í¥ëÏû•",
      stop_allee: "Í∞ÄÎ°úÏàòÍ∏∏",
      stop_chemin: "Í∏∏",
      stop_tour: "ÌÉë",
      stop_ferme: "ÎÜçÏû•",
      stop_ferme_pedagogique: "ÍµêÏú° ÎÜçÏû•",

      stop_ministere: "Î∂Ä",
      stop_ministere_economie_finances: "Í≤ΩÏ†úÏû¨Ï†ïÎ∂Ä",
      stop_echangeur: "ÏûÖÏ≤¥ÍµêÏ∞®Î°ú",
      icon_gas: "Ï£ºÏú†ÏÜå",
      icon_bus_station: "Î≤ÑÏä§ÌÑ∞ÎØ∏ÎÑê",
      icon_repair_shop: "ÏàòÎ¶¨Ï†ê",
      icon_garage: "Ï∞®Í≥†",
      icon_recruitment_agency: "Ï±ÑÏö© ÎåÄÌñâÏÇ¨",
      icon_dealer: "ÎåÄÎ¶¨Ï†ê",
      icon_border_control: "Ïã†Ïõê ÌôïÏù∏",
      icon_toll: "ÌÜµÌñâÎ£å",
      icon_parking: "Ï£ºÏ∞®Ïû•",
      results_empty: "Í≤∞Í≥º ÏóÜÏùå",
      results_empty_category: "Ïπ¥ÌÖåÍ≥†Î¶¨ {category}Ïóê Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§",
      none: "ÏóÜÏùå",
      villes: "ÎèÑÏãú",
      emblematic: "ÏÉÅÏßïÏ†Å Ïû•ÏÜå",
      repair_shops: "ÏàòÎ¶¨Ï†ê",
      agencies: "Ï±ÑÏö© ÎåÄÌñâÏÇ¨",
      dealers: "ÎåÄÎ¶¨Ï†ê",
      companies: "Í∏∞ÏóÖ",
      malls: "ÏáºÌïëÎ™∞",
      see_wiki: "ÏúÑÌÇ§Î∞±Í≥ºÏóêÏÑú Î≥¥Í∏∞",
      loading: "Î°úÎî© Ï§ë...",
      depart: "Ï∂úÎ∞ú",
      terminus: "Ï¢ÖÏ†ê",
      departures_active: "ÎÖ∏ÏÑ† Ï∂úÎ∞ú ÏúÑÏπò ÎØ∏Î¶¨Î≥¥Í∏∞ ÌôúÏÑ±ÌôîÎê®",
      departures_disable: "ÎØ∏Î¶¨Î≥¥Í∏∞ ÎπÑÌôúÏÑ±Ìôî",
      destination: "Î™©Ï†ÅÏßÄ",
      stop: "Ï†ïÎ•òÏû•",
      home_tooltip: "Ï¥àÍ∏∞ Î≥¥Í∏∞Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞",
      maintenance_title: "Ï†êÍ≤Ä Ï§ë",
      close: "Îã´Í∏∞",
      open_link: "ÎßÅÌÅ¨ Ïó¥Í∏∞",
      analyze_mode: "Î∂ÑÏÑù Î™®Îìú",
      color_yellow: "ÎÖ∏Îûë",
      color_green: "Ï¥àÎ°ù",
      color_red: "Îπ®Í∞ï",
      color_blue: "ÌååÎûë",
      color_orange: "Ï£ºÌô©",
      color_purple: "Î≥¥Îùº",
      color_black: "Í≤ÄÏ†ï",
      color_white: "Ìù∞ÏÉâ",
      color_grey: "ÌöåÏÉâ",
    },
    ja: {
      search_placeholder: "Ê§úÁ¥¢...",
      search_button: "Ê§úÁ¥¢",
      search_category_label: "„Ç´„ÉÜ„Ç¥„É™",
      search_category_all: "„Åô„Åπ„Å¶",
      dbus_button: "DBusË∑ØÁ∑ö",
      dbus_mode_label: "‰∏¶„Å≥Êõø„Åà",
      dbus_filter_label: "„Éï„Ç£„É´„Çø„Éº",
      dbus_mode_lines: "„Ç´„ÉÜ„Ç¥„É™",
      dbus_mode_length: "Èï∑„Åï",
      dbus_mode_stops: "Âá∫Áô∫ÂÅúÁïôÊâÄ",
      dbus_depart_map_btn: "üó∫Ô∏è Âú∞Âõ≥„ÅßË∑ØÁ∑ö„ÅÆÂá∫Áô∫ÁÇπ„ÇíË¶ã„Çã",
      dbus_school_toggle: "„Çπ„ÇØ„Éº„É´Ë∑ØÁ∑ö",
      dbus_fictive_toggle: "Êû∂Á©∫",
      dbus_sub_urban: "ÈÉΩÂ∏Ç",
      dbus_sub_noctilien: "Noctilien",
      dbus_sub_other_networks: "„Åù„ÅÆ‰ªñ„ÅÆ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ",
      lang_btn: "JA",
      language_label: "Ë®ÄË™û",
      translate_stop_types: "ÂÅúÁïôÊâÄ„ÇíÁøªË®≥",
      experimental: "ÂÆüÈ®ìÁöÑ",
      lang_fr: "„Éï„É©„É≥„ÇπË™û",
      lang_en: "Ëã±Ë™û",
      lang_es: "„Çπ„Éö„Ç§„É≥Ë™û",
      lang_de: "„Éâ„Ç§„ÉÑË™û",
      lang_pl: "„Éù„Éº„É©„É≥„ÉâË™û",
      lang_pt: "„Éù„É´„Éà„Ç¨„É´Ë™û",
      lang_nl: "„Ç™„É©„É≥„ÉÄË™û",
      lang_it: "„Ç§„Çø„É™„Ç¢Ë™û",
      lang_ru: "„É≠„Ç∑„Ç¢Ë™û",
      lang_zh: "‰∏≠ÂõΩË™û",
      lang_ko: "ÈüìÂõΩË™û",
      lang_ja: "Êó•Êú¨Ë™û",
      coordinates: "Â∫ßÊ®ô",
      temporary_stop: "Ëá®ÊôÇÂÅúÁïôÊâÄ",
      stop_count_singular: "{count} ÂÅúÁïôÊâÄ",
      stop_count_plural: "{count} ÂÅúÁïôÊâÄ",
      recruitment_agency: "‰∫∫ÊùêÁ¥π‰ªã‰ºöÁ§æ",
      repair_shop: "‰øÆÁêÜÂ∑•Êàø",
      garage: "„Ç¨„É¨„Éº„Ç∏",
      mall: "„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„Çª„É≥„Çø„Éº",
      place: "Â†¥ÊâÄ",
      dealer: "„Éá„Ç£„Éº„É©„Éº",
      city: "ÈÉΩÂ∏Ç",
      company: "‰ºÅÊ•≠",
      stop_centre_aquatique: "„Ç¢„ÇØ„Ç¢„Çª„É≥„Çø„Éº",
      stop_centre_aquanautique: "„Ç¢„ÇØ„Ç¢„Çª„É≥„Çø„Éº",
      stop_centre_commercial: "„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„Çª„É≥„Çø„Éº",
      stop_centre_municipal: "Â∏ÇÊ∞ë„Çª„É≥„Çø„Éº",
      stop_centre_pmi: "ÊØçÂ≠ê‰øùÂÅ•„Çª„É≥„Çø„Éº",
      stop_centre: "„Çª„É≥„Çø„Éº",
      stop_parc_floral: "„Éï„É≠„Éº„É©„É´„Éë„Éº„ÇØ",
      stop_parc: "ÂÖ¨Âúí",
      stop_gare: "ÈßÖ",
      stop_chateau: "Âüé",
      stop_cimetiere: "Â¢ìÂú∞",
      stop_ecole_elementaire: "Â∞èÂ≠¶Ê†°",
      stop_ecole_primaire: "Â∞èÂ≠¶Ê†°",
      stop_ecole: "Â≠¶Ê†°",
      stop_piscine: "„Éó„Éº„É´",
      stop_stade: "„Çπ„Çø„Ç∏„Ç¢„É†",
      stop_mairie: "Â∏ÇÂΩπÊâÄ",
      stop_hotel_de_ville: "Â∏ÇÂΩπÊâÄ",
      stop_pont: "Ê©ã",
      stop_porte: "ÈñÄ",
      stop_place: "Â∫ÉÂ†¥",
      stop_avenue: "Â§ßÈÄö„Çä",
      stop_rue: "ÈÄö„Çä",
      stop_maison: "„Éè„Ç¶„Çπ",
      stop_plateau: "È´òÂéü",
      stop_marche_international: "ÂõΩÈöõÂ∏ÇÂ†¥",
      dir_north: "Âåó",
      dir_south: "Âçó",
      dir_east: "Êù±",
      dir_west: "Ë•ø",
      stop_ecole_maternelle: "ÂπºÁ®öÂúí",
      stop_ecole_maternelle_publique: "ÂÖ¨Á´ãÂπºÁ®öÂúí",

      stop_college: "‰∏≠Â≠¶Ê†°",
      stop_lycee: "È´òÊ†°",
      stop_lycee_polyvalent: "Á∑èÂêàÈ´òÊ†°",

      stop_cite_scolaire: "Â≠¶Ê†°„Ç≠„É£„É≥„Éë„Çπ",

      stop_hopital: "ÁóÖÈô¢",
      stop_eglise: "Êïô‰ºö",
      stop_square: "Â∫ÉÂ†¥",
      stop_allee: "‰∏¶Êú®ÈÅì",
      stop_chemin: "ÈÅì",
      stop_tour: "Â°î",
      stop_ferme: "Ëæ≤Â†¥",
      stop_ferme_pedagogique: "ÊïôËÇ≤Ëæ≤Â†¥",

      stop_ministere: "ÁúÅ",
      stop_ministere_economie_finances: "ÁµåÊ∏àË≤°ÊîøÁúÅ",
      stop_echangeur: "„Ç∏„É£„É≥„ÇØ„Ç∑„Éß„É≥",
      icon_gas: "„Ç¨„ÇΩ„É™„É≥„Çπ„Çø„É≥„Éâ",
      icon_bus_station: "„Éê„Çπ„Çø„Éº„Éü„Éä„É´",
      icon_repair_shop: "‰øÆÁêÜÂ∑•Êàø",
      icon_garage: "„Ç¨„É¨„Éº„Ç∏",
      icon_recruitment_agency: "‰∫∫ÊùêÁ¥π‰ªã‰ºöÁ§æ",
      icon_dealer: "„Éá„Ç£„Éº„É©„Éº",
      icon_border_control: "Ë∫´ÂàÜÁ¢∫Ë™ç",
      icon_toll: "ÊñôÈáëÊâÄ",
      icon_parking: "ÈßêËªäÂ†¥",
      results_empty: "ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
      results_empty_category: "„Ç´„ÉÜ„Ç¥„É™ {category} „Å´ÁµêÊûú„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì",
      none: "„Å™„Åó",
      villes: "ÈÉΩÂ∏Ç",
      emblematic: "Ë±°Âæ¥ÁöÑ„Å™Â†¥ÊâÄ",
      repair_shops: "‰øÆÁêÜÂ∑•Êàø",
      agencies: "‰∫∫ÊùêÁ¥π‰ªã‰ºöÁ§æ",
      dealers: "„Éá„Ç£„Éº„É©„Éº",
      companies: "‰ºÅÊ•≠",
      malls: "„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„Çª„É≥„Çø„Éº",
      see_wiki: "Wikipedia„ÅßË¶ã„Çã",
      loading: "Ë™≠„ÅøËæº„Åø‰∏≠...",
      depart: "Âá∫Áô∫",
      terminus: "ÁµÇÁÇπ",
      departures_active: "Ë∑ØÁ∑ö„ÅÆÂá∫Áô∫‰ΩçÁΩÆ„ÅÆ„Éó„É¨„Éì„É•„Éº„ÅåÊúâÂäπ„Åß„Åô",
      departures_disable: "„Éó„É¨„Éì„É•„Éº„ÇíÁÑ°ÂäπÂåñ",
      destination: "ÁõÆÁöÑÂú∞",
      stop: "ÂÅúÁïôÊâÄ",
      home_tooltip: "ÂàùÊúüË°®Á§∫„Å´Êàª„Çã",
      maintenance_title: "„É°„É≥„ÉÜ„Éä„É≥„Çπ‰∏≠",
      close: "Èñâ„Åò„Çã",
      open_link: "„É™„É≥„ÇØ„ÇíÈñã„Åè",
      analyze_mode: "ÂàÜÊûê„É¢„Éº„Éâ",
      color_yellow: "ÈªÑËâ≤",
      color_green: "Á∑ë",
      color_red: "Ëµ§",
      color_blue: "Èùí",
      color_orange: "„Ç™„É¨„É≥„Ç∏",
      color_purple: "Á¥´",
      color_black: "Èªí",
      color_white: "ÁôΩ",
      color_grey: "ÁÅ∞Ëâ≤",
    }
  };
  const LANG_OPTIONS = [
    { code: "fr", label: "Fran√ßais", flagSrc: "https://flagcdn.com/w40/fr.png" },
    { code: "en", label: "English", flagSrc: "https://flagcdn.com/w40/gb.png" },
    { code: "es", label: "Espa√±ol", flagSrc: "https://flagcdn.com/w40/es.png" },
    { code: "de", label: "Deutsch", flagSrc: "https://flagcdn.com/w40/de.png" },
    { code: "pl", label: "Polski", flagSrc: "https://flagcdn.com/w40/pl.png" },
    { code: "pt", label: "Portugu√™s", flagSrc: "https://flagcdn.com/w40/pt.png" },
    { code: "nl", label: "Nederlands", flagSrc: "https://flagcdn.com/w40/nl.png" },
    { code: "it", label: "Italiano", flagSrc: "https://flagcdn.com/w40/it.png" },
    { code: "ru", label: "–†—É—Å—Å–∫–∏–π", flagSrc: "https://flagcdn.com/w40/ru.png" },
    { code: "zh", label: "‰∏≠Êñá", flagSrc: "https://flagcdn.com/w40/cn.png" },
    { code: "ko", label: "ÌïúÍµ≠Ïñ¥", flagSrc: "https://flagcdn.com/w40/kr.png" },
    { code: "ja", label: "Êó•Êú¨Ë™û", flagSrc: "https://flagcdn.com/w40/jp.png" }
  ];
  const LANG_META = Object.fromEntries(LANG_OPTIONS.map(entry => [entry.code, entry]));
  const SUPPORTED = new Set(LANG_OPTIONS.map(entry => entry.code));
  function detectInitialLang(){
    const qs = new URLSearchParams(location.search);
    const fromURL = (qs.get("lang")||"").toLowerCase();
    if (SUPPORTED.has(fromURL)) return fromURL;
    const stored = localStorage.getItem("idf_lang");
    if (SUPPORTED.has(stored)) return stored;
    const nav = (navigator.language||"fr").slice(0,2).toLowerCase();
    return SUPPORTED.has(nav) ? nav : "fr";
  }
  let LANG = detectInitialLang();
  const STOP_TYPE_TRANSLATION_KEY = "idf_translate_stop_types";
  let TRANSLATE_STOP_TYPES = (() => {
    const stored = localStorage.getItem(STOP_TYPE_TRANSLATION_KEY);
    return stored === "1" || stored === "true";
  })();
  function t(key){ return (I18N[LANG] && I18N[LANG][key]) || (I18N.fr[key]||key); }
  const STOP_PREFIXES = [
    { re: /^centre\s+de\s+protection\s+maternelle\s+et\s+infantile\b/i, key: "stop_centre_pmi" },
    { re: /^centre\s+aquanautique\b/i, key: "stop_centre_aquanautique" },
    { re: /^centre\s+aquatique\b/i, key: "stop_centre_aquatique" },
    { re: /^centre\s+commercial\b/i, key: "stop_centre_commercial" },
    { re: /^centre\s+municipal\b/i, key: "stop_centre_municipal" },
    { re: /^march[e√©]\s+international\b/i, key: "stop_marche_international" },
    { re: /^parc\s+floral\b/i, key: "stop_parc_floral" },
    { re: /^plateau\b/i, key: "stop_plateau" },
    { re: /^h(?:√¥|o)tel\s+de\s+ville\b/i, key: "stop_hotel_de_ville" },
    { re: /^(?:√©|e)cole\s+(?:√©l√©mentaire|elementaire)\b/i, key: "stop_ecole_elementaire" },
    { re: /^(?:√©|e)l[√©e]mentaire\b/i, key: "stop_ecole" },
    { re: /^(?:√©|e)cole\s+primaire\b/i, key: "stop_ecole_primaire" },
    { re: /^(?:√©|e)cole\s+maternelle\s+publique\b/i, key: "stop_ecole_maternelle_publique" },
    { re: /^(?:√©|e)cole\s+maternelle\b/i, key: "stop_ecole_maternelle" },
    { re: /^cit[√©e]\s+scolaire\b/i, key: "stop_cite_scolaire" },
    { re: /^(?:√©|e)cole\b/i, key: "stop_ecole" },
    { re: /^coll[√®e]ge\b/i, key: "stop_college" },
    { re: /^lyc[√©e]e\s+polyvalent\b/i, key: "stop_lycee_polyvalent" },
    { re: /^lyc[√©e]e\b/i, key: "stop_lycee" },
    { re: /^h[√¥o]pital\b/i, key: "stop_hopital" },
    { re: /^(?:√©|e)glise\b/i, key: "stop_eglise" },
    { re: /^square\b/i, key: "stop_square" },
    { re: /^all[√©e]e\b/i, key: "stop_allee" },
    { re: /^chemin\b/i, key: "stop_chemin" },
    { re: /^tour\b/i, key: "stop_tour" },
    { re: /^ferme\s+p[√©e]dagogique\b/i, key: "stop_ferme_pedagogique" },
    { re: /^ferme\b/i, key: "stop_ferme" },
    { re: /^minist[√®e]re\s+de\s+l['‚Äô]?(?:√©|e)conomie\s+et\s+des\s+finances\b/i, key: "stop_ministere_economie_finances" },
    { re: /^minist[√®e]re\b/i, key: "stop_ministere" },
    { re: /^(?:√©|e)changeur\b/i, key: "stop_echangeur" },
    { re: /^(?:cimeti√®re|cimetiere)\b/i, key: "stop_cimetiere" },
    { re: /^(?:ch√¢teau|chateau)\b/i, key: "stop_chateau" },
    { re: /^gare\b/i, key: "stop_gare" },
    { re: /^piscine\b/i, key: "stop_piscine" },
    { re: /^stade\b/i, key: "stop_stade" },
    { re: /^mairie\b/i, key: "stop_mairie" },
    { re: /^pont\b/i, key: "stop_pont" },
    { re: /^porte\b/i, key: "stop_porte" },
    { re: /^place\b/i, key: "stop_place" },
    { re: /^avenue\b/i, key: "stop_avenue" },
    { re: /^rue\b/i, key: "stop_rue" },
    { re: /^parc\b/i, key: "stop_parc" },
    { re: /^centre\b/i, key: "stop_centre" },
    { re: /^maison\b/i, key: "stop_maison" },
    { re: /^jaune\b/i, key: "color_yellow" },
    { re: /^vert\b/i, key: "color_green" },
    { re: /^verte\b/i, key: "color_green" },
    { re: /^rouge\b/i, key: "color_red" },
    { re: /^bleu/i, key: "color_blue" },
    { re: /^bleue/i, key: "color_blue" },
    { re: /^orange\b/i, key: "color_orange" },
    { re: /^violet\b/i, key: "color_purple" },
    { re: /^violete\b/i, key: "color_purple" },
    { re: /^blanc\b/i, key: "color_white" },
    { re: /^blanche\b/i, key: "color_white" },
    { re: /^noir\b/i, key: "color_black" },
    { re: /^noire\b/i, key: "color_black" },
    { re: /^gris\b/i, key: "color_grey" },
    { re: /^grise\b/i, key: "color_grey" },
  ];
  const POSTFIX_LANGS = new Set(["en"]);
  function stripFrenchJoiners(text){
    let s = String(text || "").trim();
    let prev;
    do {
      prev = s;
      s = s.replace(/^(?:d['‚Äô]|de l['‚Äô]|de la|du|des|de|l['‚Äô]|la|le|les)\s*/i, "").trim();
    } while (s && s !== prev);
    return s;
  }
  function appendPostfix(base, postfix){
    const trimmed = String(base || "").trim();
    if (!trimmed) return postfix;
    const m = trimmed.match(/^(.*?)(\s*\([^)]*\))$/);
    if (m) {
      const main = (m[1] || "").trim();
      if (main) return `${main} ${postfix}${m[2]}`.replace(/\s+/g, " ").trim();
      return `${postfix}${m[2]}`.replace(/\s+/g, " ").trim();
    }
    return `${trimmed} ${postfix}`.replace(/\s+/g, " ").trim();
  }
  function endsWithWord(text, word){
    const t = String(text || "").trim();
    const w = String(word || "").trim();
    if (!t || !w) return false;
    const m = t.match(/^(.*?)(\s*\([^)]*\))$/);
    const core = (m ? m[1] : t).trim();
    const escaped = w.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return new RegExp(`\\b${escaped}$`, "i").test(core);
  }
  function startsWithWord(text, word){
    const t = String(text || "").trim();
    const w = String(word || "").trim();
    if (!t || !w) return false;
    const m = t.match(/^(.*?)(\s*\([^)]*\))$/);
    const core = (m ? m[1] : t).trim();
    const escaped = w.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return new RegExp(`^${escaped}\\b`, "i").test(core);
  }
  function translateDirectionTokens(text){
    if (!TRANSLATE_STOP_TYPES || LANG === "fr") return text;
    let s = String(text || "");
    const tokens = [
      { re: /\bnord\b/gi, key: "dir_north" },
      { re: /\bsud\b/gi, key: "dir_south" },
      { re: /\best\b/gi, key: "dir_east" },
      { re: /\bouest\b/gi, key: "dir_west" },
    ];
    tokens.forEach(({ re, key }) => { s = s.replace(re, t(key)); });
    return s;
  }
  function translateStopNameSegment(name, depth = 0){
    const raw = String(name || "").trim();
    if (!raw || !TRANSLATE_STOP_TYPES || LANG === "fr") return raw;
    if (depth > 2) return raw;
    for (const { re, key } of STOP_PREFIXES){
      if (re.test(raw)) {
        const translatedPrefix = t(key);
        const remainderRaw = raw.replace(re, "").trim();
        const remainderNoJoin = stripFrenchJoiners(remainderRaw);
        let remainderTranslated = remainderNoJoin ? translateStopNameSegment(remainderNoJoin, depth + 1) : "";
        remainderTranslated = translateDirectionTokens(remainderTranslated);
        if (POSTFIX_LANGS.has(LANG) && remainderTranslated) {
          if (endsWithWord(remainderTranslated, translatedPrefix)) return remainderTranslated;
          return appendPostfix(remainderTranslated, translatedPrefix);
        }
        if (remainderTranslated) {
          if (startsWithWord(remainderTranslated, translatedPrefix)) return remainderTranslated;
          return `${translatedPrefix} ${remainderTranslated}`.replace(/\s+/g, " ").trim();
        }
        return translatedPrefix;
      }
    }
    return raw;
  }
  function translateStopName(raw){
    const name = String(raw || "").trim();
    if (!name || !TRANSLATE_STOP_TYPES || LANG === "fr") return name;
    const parts = name.split(/(\s+[‚Äì‚Äî/]\s+|\s+-\s+)/);
    if (parts.length > 1) {
      const translated = parts.map(part => {
        if (/^\s*[-‚Äì‚Äî/]\s*$/.test(part)) return part;
        return translateStopNameSegment(part, 0);
      }).join("");
      return translateDirectionTokens(translated).replace(/\s+/g, " ").trim();
    }
    return translateDirectionTokens(translateStopNameSegment(name, 0)).replace(/\s+/g, " ").trim();
  }
  const I18N_LAYERS = [];
  function registerI18nLayer(layer, updater){
    if (!layer || typeof updater !== "function") return;
    I18N_LAYERS.push({ layer, updater });
  }
  function refreshI18nLayers(){
    I18N_LAYERS.forEach(entry => {
      const layer = entry.layer;
      if (!layer || typeof layer.getPopup !== "function") return;
      if (!layer.getPopup()) return;
      try { entry.updater(); } catch {}
    });
  }
  const SEARCH_CATEGORY_ALL = "ALL";
  const ALL_TYPES = [ "Ville","Monument","Atelier","Agence","Concessionnaire","Entreprise" ];
  let ACTIVE_SEARCH_CATEGORY = SEARCH_CATEGORY_ALL;
  let SEARCH_CATEGORY_COUNTS = Object.fromEntries(ALL_TYPES.map(t => [t, 0]));
  let SEARCH_CATEGORY_TOTAL = 0;
  function searchCategoryLabel(typeKey){
    const map = {
      "Ville": t("villes"),
      "Monument": t("emblematic"),
      "Atelier": t("repair_shops"),
      "Agence": t("agencies"),
      "Concessionnaire": t("dealers"),
      "Entreprise": t("companies")
    };
    return map[typeKey] || typeKey;
  }
  function searchCategoryDisplay(typeKey){
    if (typeKey === SEARCH_CATEGORY_ALL) return t("search_category_all");
    return searchCategoryLabel(typeKey);
  }
  function searchCategoryButtonLabel(typeKey){
    const label = searchCategoryDisplay(typeKey);
    const count = typeKey === SEARCH_CATEGORY_ALL
      ? SEARCH_CATEGORY_TOTAL
      : (SEARCH_CATEGORY_COUNTS[typeKey] ?? 0);
    return `${label} (${count})`;
  }
  function resultsEmptyText(){
    const label = searchCategoryDisplay(ACTIVE_SEARCH_CATEGORY);
    return t("results_empty_category").replace("{category}", label);
  }
  function langLabel(code){
    const meta = LANG_META[code];
    if (meta && meta.label) return meta.label;
    return String(code || "").toUpperCase();
  }
  function formatStopCount(count){
    const key = count === 1 ? "stop_count_singular" : "stop_count_plural";
    return t(key).replace("{count}", count);
  }
  function formatStopDuration(count, durationText, format = "paren"){
    const base = formatStopCount(count);
    if (!durationText) return base;
    if (format === "dash") return `${base} - ${durationText}`;
    return `${base} (${durationText})`;
  }
  function dbusCategoryTitle(key){
    if (key === "Scolaire") return t("dbus_school_toggle");
    if (key === "Autres") return t("dbus_fictive_toggle");
    if (key === "Urbain") return "IDFM";
    if (key === "Noctilien") return "Noctiliens";
    if (key === "FlixBus") return "FlixBus";
    return key;
  }
  function setStopDurationText(el, stopCount, durationText, format){
    if (!el) return;
    el.dataset.stopCount = String(stopCount);
    el.dataset.durationText = String(durationText || "");
    el.dataset.durationFormat = format || "paren";
    el.textContent = formatStopDuration(stopCount, durationText, format);
  }
  function typeFallbackLabel(type){
    if (type === "Agence") return t("recruitment_agency");
    if (type === "Atelier") return t("repair_shop");
    if (type === "Garage") return t("garage");
    return type;
  }
  function setStopTypeTranslation(enabled, { persist = true, apply = true } = {}) {
    TRANSLATE_STOP_TYPES = !!enabled;
    if (persist) {
      localStorage.setItem(STOP_TYPE_TRANSLATION_KEY, TRANSLATE_STOP_TYPES ? "1" : "0");
    }
    if (apply) applyI18N();
  }
  function wikiBase(){ return LANG === "en" ? "https://en.wikipedia.org/wiki/" : "https://fr.wikipedia.org/wiki/"; }
  function buildLangMenu(){
    const menu = document.getElementById("langMenu");
    if (!menu) return;
    menu.innerHTML = "";
    LANG_OPTIONS.forEach(option => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "lang-option";
      btn.setAttribute("role", "option");
      btn.dataset.lang = option.code;
      btn.setAttribute("aria-selected", option.code === LANG ? "true" : "false");
      const img = document.createElement("img");
      img.className = "lang-flag";
      img.src = option.flagSrc;
      img.alt = "";
      img.loading = "lazy";
      img.setAttribute("aria-hidden", "true");
      const name = document.createElement("span");
      name.className = "lang-name";
      name.textContent = langLabel(option.code);
      btn.appendChild(img);
      btn.appendChild(name);
      btn.addEventListener("click", () => {
        setLang(option.code);
      });
      menu.appendChild(btn);
    });

    const sep = document.createElement("div");
    sep.className = "lang-menu-sep";
    menu.appendChild(sep);

    const toggleRow = document.createElement("label");
    toggleRow.className = "lang-toggle-row";
    const toggle = document.createElement("input");
    toggle.type = "checkbox";
    toggle.id = "langStopTypeToggle";
    toggle.checked = !!TRANSLATE_STOP_TYPES;
    toggle.setAttribute("aria-label", t("translate_stop_types"));
    toggle.addEventListener("change", (event) => {
      if (LANG === "fr") {
        event.target.checked = false;
        return;
      }
      setStopTypeTranslation(event.target.checked);
    });
    const toggleLabel = document.createElement("span");
    toggleLabel.className = "lang-toggle-label";
    toggleLabel.textContent = t("translate_stop_types");
    const badge = document.createElement("span");
    badge.className = "lang-toggle-badge";
    badge.textContent = t("experimental");
    toggleRow.appendChild(toggle);
    toggleRow.appendChild(toggleLabel);
    toggleRow.appendChild(badge);
    menu.appendChild(toggleRow);
  }
  function setLangMenuOpen(open){
    const menu = document.getElementById("langMenu");
    const btn = document.getElementById("langToggle");
    if (!menu || !btn) return;
    menu.setAttribute("aria-hidden", open ? "false" : "true");
    btn.setAttribute("aria-expanded", open ? "true" : "false");
  }
  function isLangMenuOpen(){
    const menu = document.getElementById("langMenu");
    return !!menu && menu.getAttribute("aria-hidden") === "false";
  }
  function openLangMenu(){ setLangMenuOpen(true); }
  function closeLangMenu(){ setLangMenuOpen(false); }
  function toggleLangMenu(){ isLangMenuOpen() ? closeLangMenu() : openLangMenu(); }
  function updateLangUI(){
    const meta = LANG_META[LANG] || LANG_META.fr;
    const btn = document.getElementById("langToggle");
    if (btn) {
      const flag = btn.querySelector(".lang-flag");
      if (flag) flag.src = meta.flagSrc;
      const label = `${t("language_label")}: ${langLabel(LANG)}`;
      btn.setAttribute("aria-label", label);
      btn.title = label;
    }
    const menu = document.getElementById("langMenu");
    if (menu) {
      menu.setAttribute("aria-label", t("language_label"));
      menu.querySelectorAll(".lang-option").forEach(option => {
        const isActive = option.dataset.lang === LANG;
        option.setAttribute("aria-selected", isActive ? "true" : "false");
        const name = option.querySelector(".lang-name");
        if (name) name.textContent = langLabel(option.dataset.lang);
      });
      const toggle = menu.querySelector("#langStopTypeToggle");
      const toggleRow = menu.querySelector(".lang-toggle-row");
      if (toggle) {
        toggle.checked = !!TRANSLATE_STOP_TYPES;
        toggle.setAttribute("aria-label", t("translate_stop_types"));
        toggle.disabled = LANG === "fr";
      }
      if (toggleRow) toggleRow.classList.toggle("is-disabled", LANG === "fr");
      const toggleLabel = menu.querySelector(".lang-toggle-label");
      if (toggleLabel) toggleLabel.textContent = t("translate_stop_types");
      const badge = menu.querySelector(".lang-toggle-badge");
      if (badge) badge.textContent = t("experimental");
    }
  }
  function setLang(lang, {persist=true, apply=true} = {}){
    if (!SUPPORTED.has(lang)) lang = "fr";
    LANG = lang;
    if (persist) localStorage.setItem("idf_lang", lang);
    document.documentElement.setAttribute("lang", lang);
    if (LANG === "fr" && TRANSLATE_STOP_TYPES) {
      setStopTypeTranslation(false, { persist: true, apply: false });
    }
    if (typeof isLinePreviewOpen === "function" && isLinePreviewOpen()) {
      try { currentSelectedKey = ""; } catch {}
      if (typeof hideAllRoutes === "function") {
        try { hideAllRoutes(); } catch {}
      }
      if (typeof hideLinePreview === "function") {
        try { hideLinePreview(); } catch {}
      }
      document.getElementById("dbusList")?.querySelectorAll(".dbus-item").forEach(it => {
        it.classList.remove("active");
        it.style.outline = "none";
      });
      if (typeof renderSelectedChip === "function") {
        try { renderSelectedChip(); } catch {}
      }
    }
    if (apply) applyI18N();
  }
  function applyI18N(){
    const routeTitleFn = (typeof translateRouteTitle === "function")
      ? translateRouteTitle
      : (title) => translateStopName(title);
    const $search = document.getElementById("search");
    if ($search) $search.placeholder = t("search_placeholder");
    const $btnSearch = document.getElementById("btnSearch");
    if ($btnSearch) $btnSearch.textContent = t("search_button");
    const $searchPanelTitle = document.getElementById("searchPanelTitle");
    if ($searchPanelTitle) $searchPanelTitle.textContent = t("search_button");
    const $searchPanelClose = document.getElementById("searchPanelClose");
    if ($searchPanelClose){ $searchPanelClose.setAttribute("aria-label", t("close")); $searchPanelClose.title = t("close"); }
    const $searchFilterLabel = document.getElementById("searchFilterLabel");
    if ($searchFilterLabel) $searchFilterLabel.textContent = t("search_category_label");
    document.querySelectorAll(".search-categories .dbus-mode-btn").forEach(btn => {
      const key = btn.dataset.category;
      if (key) btn.textContent = searchCategoryButtonLabel(key);
    });
    const $btnDbus = document.getElementById("btnDbus");
    if ($btnDbus) $btnDbus.textContent = t("dbus_button");
    const panelTitle = document.getElementById("dbusPanelTitle");
    if (panelTitle) panelTitle.textContent = t("dbus_button");
    const $dbusModeLabel = document.getElementById("dbusModeLabel");
    if ($dbusModeLabel) $dbusModeLabel.textContent = t("dbus_mode_label");
    document.querySelectorAll(".dbus-mode-btn").forEach(btn => {
      const mode = btn.dataset.mode;
      if (mode === "lines") btn.textContent = t("dbus_mode_lines");
      if (mode === "length") btn.textContent = t("dbus_mode_length");
      if (mode === "departures") btn.textContent = t("dbus_mode_stops");
    });
    const $dbusDepartMapBtn = document.getElementById("dbusDepartMapBtn");
    if ($dbusDepartMapBtn) {
      const label = t("dbus_depart_map_btn");
      $dbusDepartMapBtn.textContent = label;
      $dbusDepartMapBtn.setAttribute("aria-label", label);
      $dbusDepartMapBtn.title = label;
    }
    const $dbusFilterLabel = document.getElementById("dbusFilterLabel");
    if ($dbusFilterLabel) $dbusFilterLabel.textContent = t("dbus_filter_label");
    const $dbusSchoolLabel = document.getElementById("dbusSchoolLabel");
    const $dbusSchoolToggle = document.getElementById("dbusSchoolToggle");
    if ($dbusSchoolLabel) $dbusSchoolLabel.textContent = t("dbus_school_toggle");
    if ($dbusSchoolToggle) {
      const label = t("dbus_school_toggle");
      $dbusSchoolToggle.setAttribute("aria-label", label);
      $dbusSchoolToggle.title = label;
    }
    const $dbusFictiveLabel = document.getElementById("dbusFictiveLabel");
    const $dbusFictiveToggle = document.getElementById("dbusFictiveToggle");
    if ($dbusFictiveLabel) $dbusFictiveLabel.textContent = t("dbus_fictive_toggle");
    if ($dbusFictiveToggle) {
      const label = t("dbus_fictive_toggle");
      $dbusFictiveToggle.setAttribute("aria-label", label);
      $dbusFictiveToggle.title = label;
    }
    const $lpClose = document.getElementById("lpClose");
    if ($lpClose){ $lpClose.setAttribute("aria-label", t("close")); $lpClose.title = t("close"); }
    const $lpLink = document.getElementById("lpLink");
    if ($lpLink){
      const label = t("open_link");
      $lpLink.setAttribute("aria-label", label);
      $lpLink.title = label;
    }
    const $dbusStopClose = document.getElementById("dbusStopClose");
    if ($dbusStopClose){ $dbusStopClose.setAttribute("aria-label", t("close")); $dbusStopClose.title = t("close"); }
    const $dbusDepartIndicatorLabel = document.getElementById("dbusDepartIndicatorLabel");
    if ($dbusDepartIndicatorLabel) $dbusDepartIndicatorLabel.textContent = t("departures_active");
    const $dbusDepartIndicatorClose = document.getElementById("dbusDepartIndicatorClose");
    if ($dbusDepartIndicatorClose){
      $dbusDepartIndicatorClose.setAttribute("aria-label", t("departures_disable"));
      $dbusDepartIndicatorClose.title = t("departures_disable");
    }
    const home = document.querySelector(".leaflet-custom-home a.home-btn");
    if (home) home.title = t("home_tooltip");

    const results = document.getElementById("results");
    if (results && !results.hidden) {
      const empty = results.querySelector(".result-empty");
      if (empty) empty.textContent = resultsEmptyText();
      results.querySelectorAll(".result-sechead").forEach(h => {
        const raw = h.textContent.trim().toLowerCase();
        const map = {
          "villes": t("villes"),
          "lieux embl√©matiques": t("emblematic"),
          "ateliers de r√©paration": t("repair_shops"),
          "agences de recrutement": t("agencies"),
          "concessionnaires": t("dealers"),
          "entreprises": t("companies"),
          "centres commerciaux": t("malls"),
        };
        if (map[raw]) h.textContent = map[raw];
      });
    }
    if (results && !results.hidden) {
      results.querySelectorAll(".result-sechead").forEach(h => {
        const typeKey = h.dataset.type;
        const count = h.dataset.count;
        if (typeKey && count !== undefined) {
          h.textContent = `${searchCategoryLabel(typeKey)} (${count})`;
        }
      });
    }
    const $dbusStopTitle = document.getElementById("dbusStopTitle");
    if ($dbusStopTitle) {
      const mode = $dbusStopTitle.dataset.stopMode || "";
      const name = $dbusStopTitle.dataset.stopName || "";
      if (mode === "single" && name) {
        $dbusStopTitle.innerHTML = `${t("stop")} : ${withRERIcon(translateStopName(name))}`;
      } else if (mode === "group") {
        const raw = $dbusStopTitle.dataset.stopNames || "[]";
        let list = [];
        try { list = JSON.parse(raw); } catch { list = []; }
        const translated = list.map(n => translateStopName(n));
        $dbusStopTitle.innerHTML = translated.map(n => withRERIcon(n)).join(" / ");
      } else if (!mode) {
        $dbusStopTitle.textContent = t("stop");
      }
    }
    document.querySelectorAll(".stop-flag").forEach(flag => {
      const label = t("temporary_stop");
      flag.textContent = label;
      flag.setAttribute("aria-label", label);
    });
    document.querySelectorAll(".stop[data-raw-label]").forEach(stop => {
      const raw = stop.dataset.rawLabel || "";
      const isProv = stop.dataset.provisoire === "1";
      const label = translateStopName(raw);
      const nameEl = stop.querySelector(".name");
      if (nameEl) {
        const flag = isProv ? ` <span class="stop-flag" aria-label="${t("temporary_stop")}">${t("temporary_stop")}</span>` : "";
        nameEl.innerHTML = `${withRERIcon(label)}${flag}`;
      }
    });
    document.querySelectorAll(".sp-coords span").forEach(span => {
      span.textContent = t("coordinates");
    });
    document.querySelectorAll(".dbus-sec h4[data-stop-name]").forEach(h => {
      const raw = h.dataset.stopName || "";
      const count = h.dataset.stopCount || "";
      const label = withRERIcon(translateStopName(raw));
      h.innerHTML = `${label}${count ? ` (${count})` : ""}`;
    });
    document.querySelectorAll(".rname[data-raw-name]").forEach(el => {
      const raw = el.dataset.rawName || "";
      el.innerHTML = withRERIcon(translateStopName(raw));
    });
    document.querySelectorAll(".rname[data-route-kind]").forEach(el => {
      const kind = el.dataset.routeKind;
      const routeTitle = el.dataset.routeTitle || "";
      const flag = el.dataset.routeFlag || "";
      if (kind === "line") {
        const displayTitle = routeTitleFn(routeTitle);
        let html = withRERIcon(displayTitle || routeTitle);
        if (flag) html += ` <span class="route-flag">${flag}</span>`;
        el.innerHTML = html;
      } else if (kind === "depart") {
        const titleEnd = el.dataset.routeEnd || "";
        const dirName = getRouteTerminusLabel({ stops: [] }, titleEnd) || String(titleEnd || routeTitle || "").trim();
        const dirLabel = t("destination");
        const dirText = dirName || routeTitle || "?";
        let html = `${dirLabel} : ${withRERIcon(dirText)}`;
        if (flag) html += ` <span class="route-flag">${flag}</span>`;
        el.innerHTML = html;
      }
    });
    document.querySelectorAll(".result-text[data-route-title]").forEach(el => {
      const raw = el.dataset.routeTitle || "";
      el.textContent = routeTitleFn(raw);
    });
    document.querySelectorAll("[data-stop-count]").forEach(el => {
      const count = parseInt(el.dataset.stopCount || "0", 10);
      const durationText = el.dataset.durationText || "";
      const format = el.dataset.durationFormat || "paren";
      if (Number.isFinite(count)) {
        el.textContent = formatStopDuration(count, durationText, format);
      }
    });
    const $lpRouteTitle = document.getElementById("lpRouteTitle");
    if ($lpRouteTitle && ($lpRouteTitle.dataset.rawStart || $lpRouteTitle.dataset.rawEnd)) {
      const durationEl = $lpRouteTitle.querySelector(".stop-duration");
      const count = parseInt(durationEl?.dataset.stopCount || "0", 10);
      const durationText = durationEl?.dataset.durationText || "";
      const format = durationEl?.dataset.durationFormat || "dash";
      const start = translateStopName($lpRouteTitle.dataset.rawStart || "");
      const end = translateStopName($lpRouteTitle.dataset.rawEnd || "");
      $lpRouteTitle.innerHTML = `
        <div>${withRERIcon(start)} &gt; ${withRERIcon(end)}</div>
        <div style="font-weight:400; font-size:12px; color:#9fb1cc; margin-top:2px">
          <span class="stop-duration"></span>
        </div>
      `;
      if (Number.isFinite(count)) {
        setStopDurationText($lpRouteTitle.querySelector(".stop-duration"), count, durationText, format);
      }
    }
    document.querySelectorAll(".dbus-sechead").forEach(head => {
      const key = head.dataset.cat;
      const count = head.dataset.count;
      if (!key || !count) return;
      const label = dbusCategoryTitle(key);
      head.innerHTML = `<span>${label} (${count})</span><span class="chev" style="margin-left:auto">‚ñº</span>`;
    });
    document.querySelectorAll("h4[data-sub-key]").forEach(head => {
      const key = head.dataset.subKey || "";
      if (key) head.textContent = t(key);
    });
    const none = document.querySelector(".dbus-none");
    if (none) none.textContent = t("none");
    refreshI18nLayers();
    updateLangUI();
  }
  buildLangMenu();
  document.getElementById("langToggle")?.addEventListener("click", (event) => {
    event.stopPropagation();
    toggleLangMenu();
  });
  document.addEventListener("click", (event) => {
    const host = document.getElementById("langSwitch");
    if (host && !host.contains(event.target)) closeLangMenu();
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") closeLangMenu();
  });
  setLang(LANG, {persist:false, apply:true});
  </script>

  <script>
    const QS = new URLSearchParams(location.search);
    const IS_DEV = QS.has("dev");
    const DATA_BASE = IS_DEV ? "./new" : ".";
    const OVERLAY_BASE = `${DATA_BASE}/Overlays`;
    const TILE_BASE = `${DATA_BASE}/Tiles`;
    const DBUS_BASE = `${DATA_BASE}/DBus`;
    const dataPath = (file) => `${DATA_BASE}/${file}`;
    const overlayPath = (file) => `${OVERLAY_BASE}/${file}`;

    const watermarkLogo = document.getElementById("watermarkLogo");
    if (watermarkLogo) watermarkLogo.src = overlayPath("idf_logo.png");
    document.documentElement.style.setProperty(
      "--rer-mask-url",
      `url("${overlayPath("o_rer.png")}")`
    );
    document.documentElement.style.setProperty(
      "--metro-icon-url",
      `url("${overlayPath("o_metro.png")}")`
    );

    const minNativeZoom=0,maxNativeZoom=8,tileSize=256;
    const widthPx=tileSize*Math.pow(2,maxNativeZoom),heightPx=tileSize*Math.pow(2,maxNativeZoom);

    const map=L.map('map',{crs:L.CRS.Simple,attributionControl:false,minZoom:minNativeZoom+3,maxZoom:maxNativeZoom+2,maxBoundsViscosity:1.0,inertia:true});
    const fullBounds=L.latLngBounds(map.unproject(L.point(0,heightPx),maxNativeZoom),map.unproject(L.point(widthPx,0),maxNativeZoom));
    const MARGIN=64;
    function innerBounds(m){const sw=L.point(0+m,heightPx-m),ne=L.point(widthPx-m,0+m);return L.latLngBounds(map.unproject(sw,maxNativeZoom),map.unproject(ne,maxNativeZoom));}

    const SCALE_RATIO = 0.95;

    function updateCustomScale() {
      const zoom = map.getZoom();
      const scaleFactor = Math.pow(2, zoom - maxNativeZoom);
      const metersPerPixel = SCALE_RATIO / scaleFactor;

      const zoomScales = {
        [maxNativeZoom - 5]: 16000,
        [maxNativeZoom - 4]: 8000,
        [maxNativeZoom - 3]: 4000,
        [maxNativeZoom - 2]: 2000,
        [maxNativeZoom - 1]: 1000,
        [maxNativeZoom]: 500,
        [maxNativeZoom + 1]: 200,
        [maxNativeZoom + 2]: 100,
      };

      let targetMeters = zoomScales[zoom];
      if (targetMeters === undefined) {
        const keys = Object.keys(zoomScales).map(k => parseInt(k));
        const closest = keys.reduce((a, b) =>
          Math.abs(b - zoom) < Math.abs(a - zoom) ? b : a
        );
        targetMeters = zoomScales[closest];
      }

      const pxLength = targetMeters / metersPerPixel;

      const scaleEl = document.getElementById("custom-scale");
      if (scaleEl) {
        scaleEl.style.width = `${pxLength}px`;
        scaleEl.querySelector("span").textContent =
          targetMeters >= 1000 ? `${(targetMeters / 1000).toFixed(0)} km` : `${targetMeters} m`;
      }
    }

    const scaleDiv = L.control({ position: 'bottomleft' });
    scaleDiv.onAdd = () => {
      const div = L.DomUtil.create('div', 'custom-scale');
      div.id = 'custom-scale';
      div.innerHTML = '<div class="bar"></div><span></span>';
      return div;
    };
    scaleDiv.addTo(map);

    map.on('zoom', updateCustomScale);
    updateCustomScale();


    L.tileLayer(`${TILE_BASE}/{z}/{x}/{y}.png`,{tileSize,minNativeZoom,maxNativeZoom,maxZoom:maxNativeZoom+2,noWrap:true,bounds:fullBounds,crossOrigin:true,referrerPolicy:"no-referrer"}).addTo(map);
    function applyBounds(){const ib=innerBounds(MARGIN);map.setMaxBounds(ib);map.panInsideBounds(ib,{animate:false});}
    map.fitBounds(innerBounds(MARGIN),{animate:false});applyBounds();map.on('zoomend resize',applyBounds);

    let TileMapInfo;
    const tileInfoReady = fetch(dataPath("TileMapInfo.json")).then(r=>{ if(!r.ok) throw new Error('TileMapInfo'); return r.json(); }).then(info => (TileMapInfo = info));
    const OX = parseFloat(QS.get('ox') ?? '0');
    const OY = parseFloat(QS.get('oy') ?? '0');
    const SX = parseFloat(QS.get('sx') ?? '1');
    const SY = parseFloat(QS.get('sy') ?? '1');
    
    const $search = document.getElementById("search");
    const $results = document.getElementById("results");
    const $searchPanel = document.getElementById("searchPanel");
    const $searchFilters = document.getElementById("searchFilters");
    const $btnSearch = document.getElementById("btnSearch");
    const $searchPanelClose = document.getElementById("searchPanelClose");
    const $analysisHUD = document.getElementById("analysisHUD");

    const BRAND_DISPLAY = { renault: 'Renault Trucks', daf: 'DAF', mercedes: 'Mercedes-Benz', volvo : 'Volvo Trucks' };
    function brandLabel(key){
      const k = String(key||'').trim().toLowerCase();
      if (!k) return '';
      if (BRAND_DISPLAY[k]) return BRAND_DISPLAY[k];
      return k.charAt(0).toUpperCase() + k.slice(1);
    }
    function brandsText(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      return arr.map(brandLabel).join(', ');
    }

    let _resIdx = -1;
    function highlightResult(i){
      const items=[...$results.querySelectorAll('.result-item')];
      items.forEach((el,idx)=> el.style.background = idx===i ? "#101926" : "");
    }
    $search.addEventListener('keydown', e=>{
      const items=[...$results.querySelectorAll('.result-item')];
      if(!items.length) return;
      if(e.key==="ArrowDown"){ e.preventDefault(); _resIdx=Math.min(_resIdx+1, items.length-1); highlightResult(_resIdx); }
      if(e.key==="ArrowUp"){ e.preventDefault(); _resIdx=Math.max(_resIdx-1, 0); highlightResult(_resIdx); }
      if(e.key==="Enter" && _resIdx>=0){ items[_resIdx].click(); }
    });

    function dealerBrandKeyFrom(ov){
      const arr = Array.isArray(ov.Brands) ? ov.Brands : (ov.Brands ? [ov.Brands] : []);
      const raw = String(arr[0] || "").toLowerCase().trim();
      if (!raw) return "";
      const MAP = { "renault trucks": "renault", "DAF": "daf", "mercedes-benz": "mercedes", "volvo trucks": "volvo" };
      const canonical = MAP[raw] || raw;
      return canonical.replace(/trucks?|camions?/g, "").replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
    }

    function addSectionBlock(typeKey, label){
      const head = document.createElement("div");
      head.className = "result-sechead";
        const labelMap = {
          "Ville": t("villes"),
          "Monument": t("emblematic"),
          "Atelier": t("repair_shops"),
          "Agence": t("agencies"),
          "Concessionnaire": t("dealers"),
          "Entreprise": t("companies")
        };
      head.textContent = labelMap[typeKey] || label;
      $results.appendChild(head);

      const body = document.createElement("div");
      body.className = "result-secbody";
      $results.appendChild(body);
      return body;
    }

    window.addEventListener('keydown', e=>{
      if(document.getElementById("linePreviewWrap")?.style.display!=="block") return;
      if(!currentSelectedKey) return;
      const route = (()=> {
        const [lu,ru]=currentSelectedKey.split(":");
        const line=DBUS_LINES.find(l=>l.uid===lu); if(!line) return null;
        return line.routes.find(r=>r.uid===ru);
      })();
      if(!route) return;

      const ids=(route.stops||[]).map(s=>s.uid);
      const idx = ids.indexOf(currentActiveStopId);
      if(e.key==="ArrowRight" && idx>=0 && idx<ids.length-1){
        const nextId = ids[idx+1];
        const st=DBUS_STOPS.get(nextId);
        if(st?.latlng) centerWithPreview(st.latlng);
        setTimeout(()=> dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx+1]?.openPopup?.(), 120);
        setActiveStopById(nextId);
      }
      if(e.key==="ArrowLeft" && idx>0){
        const prevId = ids[idx-1];
        const st=DBUS_STOPS.get(prevId);
        if(st?.latlng) centerWithPreview(st.latlng);
        setTimeout(()=> dbusRouteLayers.get(currentSelectedKey)?.stops?.[idx-1]?.openPopup?.(), 120);
        setActiveStopById(prevId);
      }
    });


    function applyXY(x, y){ return { x: x * SX + OX, y: y * SY + OY }; }
    function toLatLng(X,Y){
      const px=(X-TileMapInfo.x1)/(TileMapInfo.x2-TileMapInfo.x1)*widthPx;
      const py=(Y-TileMapInfo.y1)/(TileMapInfo.y2-TileMapInfo.y1)*heightPx;
      return map.unproject([px,py],maxNativeZoom);
    }
    function fromLatLngToXY(latlng){
      const pt = map.project(latlng, maxNativeZoom);
      const X = (pt.x/widthPx) * (TileMapInfo.x2 - TileMapInfo.x1) + TileMapInfo.x1;
      const Y = (pt.y/heightPx) * (TileMapInfo.y2 - TileMapInfo.y1) + TileMapInfo.y1;
      return { X, Y };
    }

    const transitScroll = document.querySelector(".transit-scroll");
    if (transitScroll) {
      transitScroll.addEventListener("wheel", function (e) {
        if (e.shiftKey) return;
        e.preventDefault();
        transitScroll.scrollLeft += e.deltaY;
      }, { passive: false });
    }

    const cityLayer=L.layerGroup().addTo(map);
    const cityMarkers=[],searchIndex=[];
    let selectedCityMarker = null;

    const $btnDbus = document.getElementById("btnDbus");
    const $panelDbus = document.getElementById("dbusPanel");
    const $dbusList = document.getElementById("dbusList");
    const $dbusDepartList = document.getElementById("dbusDepartList");
    const $dbusDepartActions = document.getElementById("dbusDepartActions");
    const $dbusDepartMapBtn = document.getElementById("dbusDepartMapBtn");
    const $selectedChip = document.getElementById("selectedChip");
    const $dbusStopPanel = document.getElementById("dbusStopPanel");
    const $dbusStopTitle = document.getElementById("dbusStopTitle");
    const $dbusStopList = document.getElementById("dbusStopList");
    const $dbusModeButtons = document.querySelectorAll(".dbus-mode-btn");
    const $dbusSchoolToggle = document.getElementById("dbusSchoolToggle");
    const $dbusFictiveToggle = document.getElementById("dbusFictiveToggle");
    const $dbusDepartIndicatorWrap = document.getElementById("dbusDepartIndicatorWrap");
    const $dbusDepartIndicatorLabel = document.getElementById("dbusDepartIndicatorLabel");
    const $dbusDepartIndicatorClose = document.getElementById("dbusDepartIndicatorClose");
    
    map.on('mousemove', (e) => {
      if (!$analysisHUD) return;
      try{
        const { X, Y } = fromLatLngToXY(e.latlng);
        $analysisHUD.textContent = `X: ${X.toFixed(2)}  Y: ${Y.toFixed(2)}`;
      }catch{}
    });

    function wikiTitleForCity(name){
      const m = /^Paris\s+(\d{1,2})(?:er|e|eme|√®me|th|st|nd|rd)?$/i.exec(String(name||"").trim());
      if (m){
        const n = parseInt(m[1], 10);
        if (LANG === "en"){
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }
      return String(name||"").replaceAll(" ", "_");
    }
    function normalizeParisArrondissement(title){
      const s0 = String(title || "");

      if (/\barrondissement_(de|of)_Paris\b/i.test(s0)) return s0;

      const s = s0
        .replace(/ /g, "_")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");

      let m = /^(\d{1,2})(?:er|e|eme)?_arrondissement_(?:de|of)_paris$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      m = /^paris_(\d{1,2})(?:er|e|eme)?$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      m = /^paris_(\d{1,2})(?:er|e|eme)?_arrondissement$/.exec(s);
      if (m) {
        const n = parseInt(m[1], 10);
        if (LANG === "en") {
          const suf = (n%10===1 && n%100!==11) ? "st" : (n%10===2 && n%100!==12) ? "nd" : (n%10===3 && n%100!==13) ? "rd" : "th";
          return `${n}${suf}_arrondissement_of_Paris`;
        } else {
          const suf = (n === 1) ? "er" : "e";
          return `${n}${suf}_arrondissement_de_Paris`;
        }
      }

      return s0;
    }
    async function fetchWikiSummary(title){
      const url = (LANG==="en" ? "https://en.wikipedia.org/api/rest_v1/page/summary/" : "https://fr.wikipedia.org/api/rest_v1/page/summary/") + encodeURIComponent(title);
      const r = await fetch(url); if (!r.ok) throw new Error("wiki fetch"); return r.json();
    }

    function escapeHTML(s){
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function trimAroundRER(s, mode ){
      const txt = String(s || "").trim();
      if (!/\bRER\b/i.test(txt)) return txt;
      if (mode === 'start'){
        const m = txt.match(/^(.*?)\s*[‚Äì‚Äî-]\s*RER\b/i);
        return (m && m[1]) ? m[1].trim() : txt;
      } else {
        const m = txt.match(/\bRER\b\s*[‚Äì‚Äî-]\s*(.+)$/i);
        return (m && m[1]) ? m[1].trim() : txt;
      }
    }

    function decodeHTML(s){
      const t = document.createElement('textarea');
      t.innerHTML = String(s ?? "");
      return t.value;
    }

    function withRERIcon(text, opts = {}){ const caseInsensitive = !!opts.caseInsensitive;
      const esc = escapeHTML(text ?? "");
      const flags = caseInsensitive ? "gi" : "g";
      return esc
        .replace(new RegExp("(?:\\s*[---]\\s*)?\\bRER\\b(?:\\s*[---]\\s*)?", flags),
                ' <span class="rer-ico" aria-label="RER"></span> ')
        .replace(new RegExp("(?:\\s*[---]\\s*)?\\bM[√©e]tro\\b(?:\\s*[---]\\s*)?", flags),
                ' <span class="metro-ico" aria-label="M√©tro"></span> ')
        .replace(/\s{2,}/g, " ")
        .trim();
    }

    async function openCityPopup(cityObj, marker) {
      const latlng = marker.getLatLng();
      let rawTitle = normalizeParisArrondissement(wikiTitleForCity(cityObj.Name));
      const p = L.popup({ maxWidth: 380, autoPan: true })
        .setLatLng(latlng)
        .setContent(`<b>${cityObj.Name}</b><br><span class="spinner" aria-label="${t('loading')}"></span>`).openOn(map);
      try {
        const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
          try {
            const d0 = await fetchWikiSummary(baseTitle);
            if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
          } catch {}
          const sufList = (LANG === "en")
            ? [",_Val-de-Marne", ",_Essonne", ",_Hauts-de-Seine", ",_Seine-Saint-Denis",
              ",_Val-d'Oise", ",_Seine-et-Marne", ",_Yvelines"]
            : ["_(Commune_fran√†¬ßaise)", "_(Val-de-Marne)", "_(Essonne)", "_(Hauts-de-Seine)",
              "_(Seine-Saint-Denis)", "_(Val-d'Oise)", "_(Seine-et-Marne)", "_(Yvelines)"];

          for (const suf of sufList) {
            try {
              const d = await fetchWikiSummary(baseTitle + suf);
              if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
            } catch {}
          }
          return { title: baseTitle, data: null };
        })(rawTitle);

        const pageUrl = wikiBase() + finalTitle;
        const desc = data?.description || "";
        const img = data?.thumbnail?.source || "";
        const html = data ? `
          <div style="display:flex;gap:10px;align-items:flex-start">
            ${img ? `<img src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
            <div style="min-width:0">
              <div style="font-weight:700;margin-bottom:4px">${cityObj.Name}</div>
              <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${desc}</div>
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
            </div>
          </div>` :
          `<div style="min-width:0">
            <div style="font-weight:700;margin-bottom:6px">${cityObj.Name}</div>
            <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
          </div>`;
        p.setContent(html);
      } catch {}
    }

    tileInfoReady.then(()=> fetch(dataPath("Cities.json"))).then(r=>r.json()).then(cities=>{
      cities.forEach(city=>{
        const icon=L.divIcon({className:"",html:`<span class="city-label">${city.Name}</span>`,iconSize:[0,0]});
        const m=L.marker(toLatLng(city.X,city.Y),{icon,interactive:true,bubblingMouseEvents:true}).addTo(cityLayer);
        m.on("click", ()=> openCityPopup(city, m));
        cityMarkers.push(m);
        searchIndex.push({type:"Ville",name:city.Name||t("city"),city:"",center:m.getLatLng(),open:()=>openCityPopup(city, m)});
      });
      updateCityLabels();
    }).catch(err=>console.error("Erreur chargement Cities.json",err));

    function updateCityLabels(){
      const zMin=map.getMinZoom(),zMax=map.getMaxZoom(),z=map.getZoom(),SMALL=8,LARGE=20,t=(z-zMin)/Math.max(1,(zMax-zMin)),px=Math.round(SMALL+t*(LARGE-SMALL));
      cityMarkers.forEach(m=>{const el=m.getElement();if(!el)return;const span=el.querySelector(".city-label");if(!span)return;span.style.fontSize=px+"px";span.style.opacity=(t<0.05)?0.8:1;});
    }
    map.on("zoomend",updateCityLabels);

    const DEDUPE_MIN_PX_BASE = 100;
    const _placedByIcon = new Map();
    function _isTooClose(iconId, latlng, minPx){
      const pt = map.project(latlng, maxNativeZoom);
      const list = _placedByIcon.get(iconId) || [];
      for(const p of list){ const dx = pt.x - p.x, dy = pt.y - p.y; if (Math.hypot(dx, dy) < minPx) return true; }
      list.push({x: pt.x, y: pt.y}); _placedByIcon.set(iconId, list); return false;
    }

    function bindPopupWithImage(layer, html){
      layer.bindPopup(html);
      layer.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => {
            try { e.popup.update(); } catch {}
          }, { once: true });
        }
      });
    }
    function setPopupContentWithImage(layer, html){
      if (layer.getPopup()) {
        layer.setPopupContent(html);
      } else {
        bindPopupWithImage(layer, html);
      }
    }

    const homeBtn = L.control({ position: 'topleft' });

    homeBtn.onAdd = function(map) {
      const container = L.DomUtil.create('div', 'leaflet-bar leaflet-custom-home');
      const link = L.DomUtil.create('a', 'home-btn', container);
      link.innerHTML = '‚ü≥'; 
      link.href = '#';
      link.title = t('home_tooltip');

      L.DomEvent.on(link, 'click', (e) => {
        L.DomEvent.stop(e);
        map.fitBounds(innerBounds(MARGIN), { animate: true });
        history.replaceState(null, "", location.pathname);
      });

      return container;
    };

    homeBtn.addTo(map);

    function iconLabel(iconId){
      const map = {
        "gas_ico": t("icon_gas"),
        "bus_ico": t("icon_bus_station"),
        "service_ico": t("icon_repair_shop"),
        "garage_large_ico": t("icon_garage"),
        "recruitment_ico": t("icon_recruitment_agency"),
        "dealer_ico": t("icon_dealer"),
        "border_ico": t("icon_border_control"),
        "toll_ico": t("icon_toll"),
        "parking_ico": t("icon_parking")
      };
      return map[iconId];
    }

    tileInfoReady
      .then(() => fetch(dataPath("CentreCommerciaux.json")))
      .then(r => r.ok ? r.json() : Promise.reject("CentreCommerciaux.json"))
      .then(malls => {
        malls.forEach(ov => {
          const width = 32, height = 32;

          const centerLL = toLatLng(ov.X, ov.Y);
          const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
          const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
          const bounds = L.latLngBounds(topLeft, bottomRight);

          const key = "overlay_centrecom";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;

          const overlay = L.imageOverlay(overlayPath("overlay_centrecom.png"), bounds, { interactive: true }).addTo(map);
          const popup = L.popup({ maxWidth: 420, autoPan: true });
          overlay.bindPopup(popup);

          overlay.on('popupopen', (e) => {
            const el = e.popup.getElement();
            const img = el && el.querySelector('img[data-autosize]');
            if (img && !img.complete) {
              img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
            }
          });

          const rawName = String(ov.Name || "").trim();
          const city = String(ov.City || "").trim();
          const wikiKey = String(ov.wiki || "").trim();

          overlay.on("click", async () => {
            const displayName = `${t("mall")} ${rawName}`.trim();
            const p = overlay.getPopup();
            p.setLatLng(bounds.getCenter());

            if (!wikiKey) {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(displayName)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
              overlay.openPopup();
              return;
            }

            p.setContent(`<div style="min-width:0"><b>${escapeHTML(displayName)}</b><br><span class="spinner" aria-label="${t('loading')}"></span></div>`);
            overlay.openPopup();

            try {
              const baseTitle = wikiTitleFrom(wikiKey);
              const { title: finalTitle, data } = await (async function resolveWikiSummary(title){
                try {
                  const d0 = await fetchWikiSummary(title);
                  if (d0?.type !== "disambiguation") return { title, data: d0 };
                } catch {}
                for (const suf of [
                  "_(Paris)", "_(√É∆í√Ö¬Ωle-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
                  "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
                  "_(Centre_commercial)", "_(Centre_commercial_en_France)"
                ]) {
                  try {
                    const d = await fetchWikiSummary(title + suf);
                    if (d?.type !== "disambiguation") return { title: title + suf, data: d };
                  } catch {}
                }
                return { title, data: null };
              })(baseTitle);

              const pageUrlFromAPI = data?.content_urls?.desktop?.page || null;
              const hasPage = !!pageUrlFromAPI;
              const desc = data?.description || "";
              const img = data?.thumbnail?.source || "";

              const linkHTML = hasPage
                ? `<a href="${pageUrlFromAPI}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>`
                : "";

              const html = data ? `
                <div style="display:flex;gap:10px;align-items:flex-start">
                  ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
                  <div style="min-width:0">
                    <div style="font-weight:700;margin-bottom:4px">${escapeHTML(displayName)}</div>
                    ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                    <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                    ${linkHTML}
                  </div>
                </div>` :
                `<div style="min-width:0">
                  <div style="font-weight:700;margin-bottom:6px">${escapeHTML(displayName)}</div>
                  ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
                </div>`;


              p.setContent(html);
            } catch {
              p.setContent(`<div style="min-width:0"><b>${escapeHTML(displayName)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
            }
          });

          searchIndex.push({
            type: "Centre commercial",
            name: rawName,
            city,
            center: bounds.getCenter(),
            open: () => { overlay.fire('click'); },
            logo: overlayPath("overlay_centrecom.png"),
            fallbackLogo: overlayPath("overlay_centrecom.png")
          });
        });
      })
      .catch(err => console.error("CentreCommerciaux.json error:", err));

    tileInfoReady.then(()=> fetch(dataPath("Overlays.json"))).then(r=>r.json()).then(overlays=>{
      overlays.forEach(ov=>{
        let width=ov.Width, height=ov.Height;
        if(ov.IconId==="bus_ico"){ width=32; height=32; }
        const centerLL = toLatLng(ov.X, ov.Y);

        if(!ov.IconId) return;
        if(
          ov.IconId.startsWith("bus_") && ov.IconId !== "bus_ico" ||
          ov.IconId.startsWith("uk_")  ||
          ov.IconId.startsWith("fr_")  ||
          ov.IconId.startsWith("b_")   ||
          ov.IconId.startsWith("bg_")  ||
          ov.IconId.startsWith("train_ico")  ||
          ov.IconId.startsWith("port_overlay")  ||
          ov.IconId.startsWith("d334p")  ||
          ov.IconId.startsWith("viewpoint")
        ){ return; }

        const isCompany = (ov.Type === "Company");

        if (!isCompany) {
          const key = ov.IconId || ov.Type || "__misc";
          const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width||0, height||0) * 0.75);
          if (_isTooClose(key, centerLL, minPx)) return;
        }

        const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
        const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
        const bounds = L.latLngBounds(topLeft, bottomRight);

       if (ov.Type==="Company"){
        const compTopLeft=toLatLng(ov.X,ov.Y), compBottomRight=toLatLng(ov.X+20,ov.Y-20);
        const compBounds=L.latLngBounds(compTopLeft,compBottomRight);
        const overlay=L.imageOverlay(overlayPath("button.png"),compBounds,{interactive:true}).addTo(map);

        const logoPath = overlayPath(`${ov.IconId}.png`);

        bindPopupWithImage(overlay, `
          <div style="text-align:center">
            <img data-autosize src="${logoPath}"
                style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
            <b>${escapeHTML(ov.Name)}</b><br/><i>${escapeHTML(ov.City||"")}</i>
          </div>
        `);

        searchIndex.push({
          type:"Entreprise",
          name:ov.Name||t("company"),
          city:ov.City||"",
          center:compBounds.getCenter(),
          open:()=>{ overlay.openPopup(compBounds.getCenter()); },
          logo:logoPath
        });
      } else if (ov.Type === "TruckDealer" || ov.IconId === "dealer_ico") {
            const overlay = L.imageOverlay(overlayPath(`${ov.IconId}.png`), bounds, { interactive: true }).addTo(map);
            const btxt = brandsText(ov) || '√É¬¢√¢‚Äö¬¨√¢‚Ç¨¬ù';

            const brandKey = dealerBrandKeyFrom(ov);
            const brandLogo = brandKey ? overlayPath(`dealer_${brandKey}.png`) : overlayPath("dealer_ico.png");

            const updateDealerPopup = () => {
              const html = `
                <div style="text-align:center">
                  <img data-autosize src="${brandLogo}"
                      style="width:168px;height:auto;display:block;margin:0 auto 10px;object-fit:contain"/>
                  <b>${escapeHTML(`${t("dealer")} ${btxt}`.trim())}</b><br/><i>${escapeHTML(ov.City || "")}</i>
                </div>
              `;
              setPopupContentWithImage(overlay, html);
            };

            const openDealerPopup = () => {
              updateDealerPopup();
              overlay.openPopup(bounds.getCenter());
            };
            overlay.on("click", openDealerPopup);
            registerI18nLayer(overlay, updateDealerPopup);

            searchIndex.push({
              type: "Concessionnaire",
              name: `${btxt}`.trim(),         
              brand: btxt,                   
              city: ov.City || "",
              center: bounds.getCenter(),
              open: openDealerPopup,
              logo: brandLogo,
              fallbackLogo: overlayPath("dealer_ico.png")
            });
          
        } else {
          const overlay = L.imageOverlay(overlayPath(`${ov.IconId}.png`), bounds, { interactive: true }).addTo(map);
          const updateIconPopup = () => {
            const label = iconLabel(ov.IconId) || ov.Name || ov.Type || t("place");
            if (overlay.getPopup()) {
              overlay.setPopupContent(`<b>${escapeHTML(label)}</b>`);
            } else {
              overlay.bindPopup(`<b>${escapeHTML(label)}</b>`);
            }
          };
          const openIconPopup = () => {
            updateIconPopup();
            overlay.openPopup(bounds.getCenter());
          };
          overlay.on("click", openIconPopup);
          registerI18nLayer(overlay, updateIconPopup);

          const typeTag =
            ov.IconId === "service_ico"       ? "Atelier" :
            ov.IconId === "recruitment_ico"   ? "Agence"  :
            ov.IconId === "garage_large_ico"  ? "Garage"  :
            null;

          if (typeTag) {
            const logoPath =
              ov.IconId === "service_ico"      ? overlayPath("service_ico.png") :
              ov.IconId === "recruitment_ico"  ? overlayPath("recruitment_ico.png") :
              ov.IconId === "garage_large_ico" ? overlayPath("garage_large_ico.png") :
              overlayPath(`${ov.IconId}.png`);

            const keywordName =
              typeTag === "Atelier" ? `Atelier de r√©paration ${ov.City || ""}` :
              typeTag === "Agence"  ? `Agence de recrutement ${ov.City || ""}` :
                          `Garage ${ov.City || ""}`;

            searchIndex.push({
              type: typeTag,               
              name: keywordName.trim(),    
              city: ov.City || "",
              center: bounds.getCenter(),
              open: openIconPopup,
              logo: logoPath,
              fallbackLogo: logoPath
            });
          }
        }
      });
    });

    function wikiTitleFrom(urlOrTitle){
      const s = String(urlOrTitle||"").trim();
      try{
        const u = new URL(s);
        const m = /\/wiki\/(.+)$/.exec(u.pathname);
        return m ? decodeURIComponent(m[1]) : s.replaceAll(" ", "_");
      }catch{
        return s.replaceAll(" ", "_");
      }
    }


  tileInfoReady
  .then(() => fetch(dataPath("Monuments.json")))
  .then(r => r.ok ? r.json() : Promise.reject("Monuments.json"))
  .then(monuments => {
    monuments.forEach(ov => {
      const width = 32, height = 32;

      const centerLL = toLatLng(ov.X, ov.Y);
      const topLeft = toLatLng(ov.X - (width/2), ov.Y + (height/2));
      const bottomRight = toLatLng(ov.X + (width/2), ov.Y - (height/2));
      const bounds = L.latLngBounds(topLeft, bottomRight);

      const key = "overlay_monument";
      const minPx = Math.max(DEDUPE_MIN_PX_BASE, Math.max(width, height) * 0.75);
      if (_isTooClose(key, centerLL, minPx)) return;

      const overlay = L.imageOverlay(overlayPath("overlay_monument.png"), bounds, { interactive: true }).addTo(map);
      const popup = L.popup({ maxWidth: 420, autoPan: true });
      overlay.bindPopup(popup);

      overlay.on('popupopen', (e) => {
        const el = e.popup.getElement();
        const img = el && el.querySelector('img[data-autosize]');
        if (img && !img.complete) {
          img.addEventListener('load', () => { try { e.popup.update(); } catch {} }, { once:true });
        }
      });

      const name = String(ov.Name || "").trim();
      const city = String(ov.City || "").trim();
      const wikiTitle = wikiTitleFrom(ov.wiki || ov.IconId || name);

      overlay.on("click", async () => {
        const p = overlay.getPopup();
        p.setLatLng(bounds.getCenter());
        p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b><br><span class="spinner" aria-label="${t('loading')}"></span></div>`);
        overlay.openPopup();

        try {
          const { title: finalTitle, data } = await (async function resolveWikiSummary(baseTitle){
            try {
              const d0 = await fetchWikiSummary(baseTitle);
              if (d0?.type !== "disambiguation") return { title: baseTitle, data: d0 };
            } catch {}
            for (const suf of [
              "_(Paris)", "_(√É∆í√Ö¬Ωle-de-France)", "_(Hauts-de-Seine)", "_(Seine-Saint-Denis)",
              "_(Val-de-Marne)", "_(Yvelines)", "_(Val-d'Oise)", "_(Essonne)", "_(Seine-et-Marne)",
              "_(Monument)"
            ]) {
              try {
                const d = await fetchWikiSummary(baseTitle + suf);
                if (d?.type !== "disambiguation") return { title: baseTitle + suf, data: d };
              } catch {}
            }
            return { title: baseTitle, data: null };
          })(wikiTitle);

          const pageUrl = wikiBase() + finalTitle;
          const desc = data?.description || "";
          const img = data?.thumbnail?.source || "";

          const html = data ? `
            <div style="display:flex;gap:10px;align-items:flex-start">
              ${img ? `<img data-autosize src="${img}" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;flex:0 0 auto">` : ``}
              <div style="min-width:0">
                <div style="font-weight:700;margin-bottom:4px">${escapeHTML(name)}</div>
                ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:6px">${escapeHTML(city)}</div>` : ``}
                <div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(desc)}</div>
                <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
              </div>
            </div>` :
            `<div style="min-width:0">
              <div style="font-weight:700;margin-bottom:6px">${escapeHTML(name)}</div>
              ${city ? `<div style="color:#8892a6;font-size:12px;margin-bottom:8px">${escapeHTML(city)}</div>` : ``}
              <a href="${pageUrl}" target="_blank" rel="noopener" style="color:#3aa0ff;text-decoration:underline">${t("see_wiki")}</a>
            </div>`;

          p.setContent(html);
        } catch {
          p.setContent(`<div style="min-width:0"><b>${escapeHTML(name)}</b>${city?`<br><i>${escapeHTML(city)}</i>`:""}</div>`);
        }
      });

      searchIndex.push({
        type: "Monument",
        name,
        city,
        center: bounds.getCenter(),
        open: () => { 
          const p = overlay.getPopup();
          if (p) { p.setLatLng(bounds.getCenter()); }
          overlay.fire('click');
        },
        logo: overlayPath("overlay_monument.png"),
        fallbackLogo: overlayPath("overlay_monument.png")
      });
    });
  })
  .catch(err => console.error("Monuments.json error:", err));


      
    function applyInitialView() {
      const qs = new URLSearchParams(location.search);
      const x = parseFloat(qs.get("x"));
      const y = parseFloat(qs.get("y"));
      const z = parseFloat(qs.get("z"));

      if (Number.isFinite(x) && Number.isFinite(y)) {
        const ll = toLatLng(x, y);

        const ib = innerBounds(MARGIN);
        const clamped = L.latLng(
          Math.max(Math.min(ll.lat, ib.getNorth()), ib.getSouth()),
          Math.max(Math.min(ll.lng, ib.getEast()),  ib.getWest())
        );

        const targetZoom = Number.isFinite(z)
          ? Math.max(map.getMinZoom(), Math.min(map.getMaxZoom(), z))
          : map.getZoom();

        map.setView(clamped, targetZoom, { animate: false });
      }
    }

    tileInfoReady.then(() => { applyInitialView(); });

    const routeAnimHandles = new Map();
    function animatePolyline(poly, { speed = 1.2, dash = "14 10", reverse = false } = {}) {
      const apply = (path) => {
        path.style.strokeDasharray = dash;
        let offset = 0, raf = 0;
        const tick = () => { offset = (offset + speed) % 10000; path.style.strokeDashoffset = reverse ? String(-offset) : String(offset); raf = requestAnimationFrame(tick); };
        tick();
        return () => { cancelAnimationFrame(raf); path.style.strokeDasharray = ""; path.style.strokeDashoffset = ""; };
      };
      let stopFn = null;
      if (poly._path) { stopFn = apply(poly._path); }
      else { poly.once("add", () => { if (poly._path) stopFn = apply(poly._path); }); }
      return { stop: () => { try { stopFn && stopFn(); } catch {} } };
    }
    function startLineAnim(key, poly) { stopLineAnim(key); const h = animatePolyline(poly, { speed: 0.1, dash: "30 10", reverse: true }); routeAnimHandles.set(key, h); }
    function stopLineAnim(key) { const h = routeAnimHandles.get(key); if (h) { h.stop(); routeAnimHandles.delete(key); } }

    const dbusRoot = `${DBUS_BASE}/IDF MAP`;
    const dbusLayers = L.layerGroup().addTo(map);
    const dbusDepartLayers = L.layerGroup();
    const dbusRouteLayers = new Map();
    let currentSelectedKey = "";
    const DBUS_MODES = { LINES: "lines", LENGTH: "length", DEPARTS: "departures" };
    let currentDbusMode = DBUS_MODES.LINES;
    let showSchoolLines = false;
    let showFictiveLines = false;
    let renderDbusLinesList = null;
    const DBUS_DEPART_MERGE_PX = 100;
    let dbusDepartGroups = [];
    let dbusDepartMarkers = new Map();
    let dbusDepartNameIndex = new Map();
    let selectedDepartMarker = null;
    let dbusDepartFilterKey = `${showSchoolLines}-${showFictiveLines}`;
    let dbusDepartPreviewActive = false;

    async function fetchXml(path){
      const res = await fetch(path);
      if(!res.ok) throw new Error("XML load failed: "+path);
      const txt = await res.text();
      const parser = new DOMParser();
      return parser.parseFromString(txt, "text/xml");
    }

    let DBUS_STOPS = new Map();
    async function loadStops(){
      await tileInfoReady;
      const xml = await fetchXml(`${dbusRoot}/stops.xml`);
      const nodes = [...xml.querySelectorAll("busstops > busstop")];
      DBUS_STOPS = new Map(nodes.map(node=>{
        const id = parseInt(node.querySelector("id")?.textContent.trim()||"0",10);
        const name = (node.querySelector("name")?.textContent||"").trim();
        const locRaw = (node.querySelector("location")?.textContent||"").trim();
        const parts = locRaw.split(";").map(x=>parseFloat(x));

        const X = parts[0] ?? 0;
        const Y = parts[1] ?? 0;
        const Z = parts[2] ?? 0;
        const rotX = parts[3] ?? 0;
        const rotY = parts[4] ?? 0;

        const latlng = toLatLng(X, Z);
        return [id, {id, name, X, Y, Z, rotX, rotY, latlng}];
      }));
    }

    let DBUS_LINES = [];
    async function loadLines(){
      const xml = await fetchXml(`${dbusRoot}/lines.xml`);
      DBUS_LINES = [...xml.querySelectorAll("lines > line")].map(line=>{
        const lineUid = line.getAttribute("uid");
        const number  = line.getAttribute("number") || "?";

        const routes = [...line.querySelectorAll(":scope > route")].map(rt=>{
          const rUid  = rt.getAttribute("uid");
          const rName = rt.getAttribute("name") || "";
          const stops = [...rt.querySelectorAll(":scope > busstop")].map(b => {
            return {
              uid: parseInt(b.getAttribute("uid"), 10),
              nextStopTime: parseInt(b.getAttribute("nextStopTime") || "0", 10)
            };
          });

          const totalMinutes = stops.reduce((sum, s) => sum + (s.nextStopTime || 0), 0);

          return { uid: rUid, name: rName, stops, totalMinutes };
        });

        return { uid: lineUid, number, routes };
      });
    }


    const BUS_COLORS = [getComputedStyle(document.documentElement).getPropertyValue('--busA').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busB').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busC').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busD').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--busE').trim()];
    function colorFor(index){ return BUS_COLORS[index % BUS_COLORS.length] || "#3aa0ff"; }

    async function getTwoDominantColors(src){
      return new Promise(resolve => {
        const img = new Image(); img.crossOrigin = "anonymous"; img.src = src;
        img.onload = () => {
          const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d");
          canvas.width  = img.naturalWidth; canvas.height = img.naturalHeight;
          ctx.drawImage(img, 0, 0);
          const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
          const counts = {}; let whiteCount = 0; let blackCount = 0;
          const STEP = 16, WHITE_LUM = 0.92, BLACK_LUM = 0.08;
          for (let i = 0; i < data.length; i += 4*STEP) {
            const a = data[i+3]; if (a < 128) continue;
            const r = data[i], g = data[i+1], b = data[i+2];
            const lum = (0.299*r + 0.587*g + 0.114*b) / 255;
            if (lum > WHITE_LUM) { whiteCount++; continue; }
            if (lum < BLACK_LUM) { blackCount++; continue; }
            const rq = r >> 4, gq = g >> 4, bq = b >> 4;
            const key = `${rq},${gq},${bq}`; counts[key] = (counts[key] || 0) + 1;
          }
          const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
          let bg = "#444"; if (entries.length) { const [rq,gq,bq] = entries[0][0].split(",").map(v => (parseInt(v,10) << 4) + 8); bg = `rgb(${rq},${gq},${bq})`; }
          const text = (whiteCount >= blackCount) ? "#fff" : "#000";
          resolve([bg, text]);
        };
        img.onerror = () => resolve(["#444","#fff"]);
      });
    }

    function isNoctilien2(input){
      const num = typeof input === 'string' ? input : input?.number;
      return /^N\d+$/.test(String(num || "").trim().toUpperCase());
    }

    function getLineStyleEntry(number){
      const n = String(number || "").trim();
      if (!n) return null;
      const STYLE_LC = getLineStyleEntry.STYLE_LC || (
        getLineStyleEntry.STYLE_LC = Object.fromEntries(
          Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
        )
      );
      return STYLE_LC[n.toLowerCase()] || null;
    }

    function getLineLink(line, route){
      const candidates = [];
      try {
        const { lineNumber } = parseRouteName(route?.name || "");
        if (lineNumber) candidates.push(lineNumber);
      } catch {}
      if (line?.number) candidates.push(line.number);
      try {
        const cat = getCategory(line);
        if (cat) candidates.push(cat);
        if (cat === "FlixBus") candidates.push("FLIXBUS");
      } catch {}

      const seen = new Set();
      for (const cand of candidates){
        const key = String(cand || "").trim();
        if (!key) continue;
        const lc = key.toLowerCase();
        if (seen.has(lc)) continue;
        seen.add(lc);
        const entry = getLineStyleEntry(key);
        if (entry) {
          const url = (typeof entry[2] === "string") ? entry[2].trim() : "";
          if (url) return url;
        }
      }
      return "";
    }

    const LINE_COLOR_CACHE = new Map();
    function getLineColors(number){
      const n = String(number || "").trim();
      if (isNoctilien2(n)) return Promise.resolve(["#080080", "#FFFFFF"]);

      const STYLE_LC = getLineColors.STYLE_LC || (
        getLineColors.STYLE_LC = Object.fromEntries(
          Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
        )
      );
      const hit = STYLE_LC[n.toLowerCase()];
      if (hit) return Promise.resolve(hit);

      const key = n.toLowerCase();
      const hash = Math.abs([...key].reduce((h,c)=>((h<<5)-h + c.charCodeAt(0))|0,0));
      const i = (/^\d+$/.test(n) ? (parseInt(n,10) % BUS_COLORS.length) : (hash % BUS_COLORS.length));
      const bg = BUS_COLORS[i] || "#3aa0ff";
      const text = (() => {
        const m = /^#?([0-9a-f]{6})$/i.exec(bg); if(!m) return "#fff";
        const x = parseInt(m[1],16);
        const r=(x>>16)&255, g=(x>>8)&255, b=x&255;
        const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
        return L > 0.6 ? "#000" : "#fff";
      })();
      return Promise.resolve([bg, text]);
    }


    function noctilienStripeColor(number){
      const DEFAULT = "#080080";
      const n = String(number||"").trim();
      if (LINE_STYLES[n] && LINE_STYLES[n][0]) return LINE_STYLES[n][0];
      return DEFAULT;
    }

    function ensureStripe(badgeEl, color){
      badgeEl.style.position = "relative";
      const old = badgeEl.querySelector(".noctilien-stripe");
      if (old) old.remove();
      const stripe = document.createElement("div");
      stripe.className = "noctilien-stripe";
      stripe.style.position = "absolute";
      stripe.style.left = "0";
      stripe.style.right = "0";
      stripe.style.bottom = "0";
      stripe.style.height = "6px";
      stripe.style.borderBottomLeftRadius = "8px";
      stripe.style.borderBottomRightRadius = "8px";
      stripe.style.background = color;
      badgeEl.appendChild(stripe);
    }

    function parseRouteName(name){
      const raw = String(name || "").trim();

      const hasColon = raw.includes(":");
      const parts = hasColon ? raw.split(":") : [raw];

      let flag = null;
      const flagMatch = parts[0].match(/\(([^)]+)\)/);
      if (flagMatch) flag = flagMatch[1].trim();

      let lineNumber = parts[0]
        .replace(/\s*\([^)]*\)/g, "")
        .trim();

      let routeTitle;
      if (hasColon) {
        routeTitle = raw.substring(raw.indexOf(":") + 1).trim();
      } else {
        routeTitle = raw;
      }

      return { lineNumber, routeTitle, flag };
    }

    function ensureFictiveStripe(badgeEl) {
      badgeEl.classList.add("fictive");
      const old = badgeEl.querySelector(".fictive-stripe");
      if (old) old.remove();

      const stripe = document.createElement("div");
      stripe.className = "fictive-stripe";
      stripe.textContent = "FICTIF";
      badgeEl.appendChild(stripe);
    }

    function ensureBadgeLabel(badgeEl, text){
      if (!badgeEl) return null;
      let label = badgeEl.querySelector(".badge-label");
      if (!label){
        label = document.createElement("span");
        label.className = "badge-label";
        badgeEl.appendChild(label);
      }
      if (typeof text === "string") {
        label.textContent = text;
      }
      return label;
    }

    function makeLineBadge(number, bg="#444", text="#fff", size="72x32", stripeColor=null, isFictive=false) {
      const [w,h] = size.split("x").map(v=>parseInt(v,10));
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.style.width = w+"px"; 
      badge.style.height = h+"px";
      badge.style.borderRadius = "8px";
      badge.style.display = "flex";
      badge.style.alignItems = "center";
      badge.style.justifyContent = "center";
      badge.style.fontWeight = "800";
      badge.style.background = bg; 
      badge.style.color = text;
      badge.style.textShadow = "0 1px 2px rgba(0,0,0,.35)";
      badge.style.position = "relative";
      const labelText = String(number||"").trim();
      const labelSpan = ensureBadgeLabel(badge, labelText);

      let fontSize = h * 0.6;
      labelSpan.style.fontSize = fontSize + "px";

      document.body.appendChild(badge);
      while (labelSpan.scrollWidth > badge.clientWidth && fontSize > 6) {
        fontSize -= 7;
        labelSpan.style.fontSize = fontSize + "px";
      }
      document.body.removeChild(badge);

      if (stripeColor) ensureStripe(badge, stripeColor);
      if (isFictive) ensureFictiveStripe(badge);
      return badge;
    }

    function createNetworkBadgeElement({ label, imgSrc, alt, colorKey, chipClass = "dbus-badge network-chip", stripeColor = null, invertLogo = false }) {
      const wrap = document.createElement("div");
      wrap.className = "network-badge";

      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = alt;
      if (invertLogo) img.classList.add("network-logo-invert");
      wrap.appendChild(img);

      const [bg, text] = getLineColorsSync(colorKey || label);
      const chip = document.createElement("div");
      chip.className = chipClass;
      chip.dataset.chipRole = "line";
      chip.dataset.networkBadge = "true";
      chip.textContent = label;
      chip.style.background = bg;
      chip.style.color = text;
      wrap.appendChild(chip);

      if (stripeColor) ensureStripe(chip, stripeColor);

      return { wrap, chip };
    }

    function networkBadgeHTML({ label, imgSrc, alt, colorKey, chipClass = "dbus-badge network-chip", stripeColor = null, invertLogo = false }) {
      const [bg, text] = getLineColorsSync(colorKey || label);
      const stripe = stripeColor ? `<div class="noctilien-stripe" style="background:${stripeColor}"></div>` : "";
      return `
        <div class="network-badge">
          <img src="${imgSrc}" alt="${escapeHTML(alt)}" ${invertLogo ? 'class="network-logo-invert"' : ''}/>
          <div class="${chipClass}" data-chip-role="line" data-network-badge="true" style="background:${bg};color:${text};">
            ${escapeHTML(label)}
            ${stripe}
          </div>
        </div>
      `;
    }

    function trimByDash(s, mode){
      const txt = String(s || "").trim();
      const parts = txt.split(/\s*[---]\s*/).filter(Boolean);
      if (parts.length < 2) return txt;
      return (mode === 'start') ? parts[0].trim() : parts[parts.length - 1].trim();
    }

    function cleanRERLabel(label){
      return String(label ?? "").replace(/\s*[---]\s*RER\b/gi, " RER");
    }

    function withRERIconInStop(text){
      const esc = escapeHTML(text ?? "");
      return esc.replace(/\s*[---]?\s*RER\s*[---]?\s*/gi,
        ' <span class="rer-ico" aria-label="RER"></span> ')
        .replace(/\s*[---]?\s*M[√©e]tro\s*[---]?\s*/gi,
        ' <span class="metro-ico" aria-label="M√©tro"></span> ');
    }

    const PROV_RE = /\bprovisoire\b/i;
    function hasProvisoire(text){
      return PROV_RE.test(String(text || ""));
    }
    function stripProvisoire(text){
      return String(text || "")
        .replace(/\s*\(\s*provisoire\s*\)\s*/i, " ")
        .replace(/\s*-\s*provisoire\b/i, " ")
        .replace(/\s+/g, " ")
        .trim();
    }
    function getRouteTerminusLabel(route, titleEndFallback = ""){
      const stops = route?.stops || [];
      const lastStopId = stops.length ? stops[stops.length - 1].uid : undefined;
      const lastStop = (typeof lastStopId !== "undefined") ? DBUS_STOPS.get(lastStopId) : null;
      const rawStopName = lastStop?.name || "";
      const rawFallback = String(titleEndFallback || "").trim();
      const raw = rawStopName || rawFallback;
      if (!raw) return "";
      const isProvisoire = hasProvisoire(rawStopName) || hasProvisoire(rawFallback);
      const clean = stripProvisoire(raw);
      const translated = translateStopName(clean);
      return isProvisoire ? `${translated} (${t("temporary_stop")})` : translated;
    }

    function splitRouteEndpoints(routeTitle){
      const s = decodeHTML(String(routeTitle || "").trim());
      const parts = s.split(/\s*(?:>|√É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢|√É¬¢√¢‚Ç¨¬†√¢‚Ç¨¬ù|√É¬¢√¢‚Ç¨¬°√¢‚Ç¨≈æ|<->|->|\bvers\b|\bto\b)\s*/i).filter(Boolean);
      if (parts.length >= 2){ return [parts[0].trim(), parts[parts.length-1].trim()]; }
      return [s, s];
    }

    function translateRouteTitle(routeTitle){
      const raw = String(routeTitle || "").trim();
      if (!raw || !TRANSLATE_STOP_TYPES || LANG === "fr") return raw;
      const [start0, end0] = splitRouteEndpoints(raw);
      if (!start0 || !end0 || start0 === end0) return translateStopName(raw);
      const start = translateStopName(start0);
      const end = translateStopName(end0);
      return `${start} > ${end}`;
    }

    function getLineColorsSync(number){
      const n = String(number || "").trim();

      if (isNoctilien2(n)) return ["#080080", "#FFFFFF"];

      const STYLE_LC = Object.fromEntries(
        Object.entries(LINE_STYLES).map(([k,v]) => [k.toLowerCase(), v])
      );
      const hit = STYLE_LC[n.toLowerCase()];
      if (hit) return hit;

      const key = n.toLowerCase();
      const hash = Math.abs([...key].reduce((h,c)=>((h<<5)-h + c.charCodeAt(0))|0,0));
      const i = (/^\d+$/.test(n) ? (parseInt(n,10) % BUS_COLORS.length) : (hash % BUS_COLORS.length));
      const bg = BUS_COLORS[i] || "#3aa0ff";

      const m = /^#?([0-9a-f]{6})$/i.exec(bg);
      if (!m) return [bg, "#fff"];
      const x = parseInt(m[1],16);
      const r=(x>>16)&255, g=(x>>8)&255, b=x&255;
      const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
      const text = L > 0.6 ? "#000" : "#fff";

      return [bg, text];
    }


    function drawRoute(lineIdx, line, route){
      const key = `${line.uid}:${route.uid}`;
      if(dbusRouteLayers.has(key)) return dbusRouteLayers.get(key);

      const group = L.layerGroup().addTo(dbusLayers);
      const poly  = L.polyline([], {color: colorFor(lineIdx), weight:8, opacity:1}).addTo(group);

      const latlngs = route.stops.map(s => DBUS_STOPS.get(s.uid)?.latlng).filter(Boolean);

      if (latlngs.length >= 2){
        poly.setLatLngs(latlngs);
        startLineAnim(key, poly);
      }

      const effNum = getLineNumber(line, route);
      getLineColors(effNum).then(([bg])=>{ if(bg) poly.setStyle({color:bg}); });

      const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
      const { titleStart, titleEnd } = getRouteEndpoints(route);

      const lineCategory = getCategory(line);
      const stops = route.stops.map((s, idx, arr)=> {
        const id = s.uid;
        const st = DBUS_STOPS.get(id);
        const isFirst = (idx===0), isLast=(idx===arr.length-1);
        const n = String(line.number||"").trim();

        if (!st) return null;
        const rawStopName = st.name || "";
        let displayName = rawStopName;

        if (isFirst) displayName = titleStart;
        if (isLast)  displayName = titleEnd;

        const isProvisoireStop = hasProvisoire(rawStopName) || hasProvisoire(displayName);
        const cleanDisplayName = stripProvisoire(displayName);
        const translatedDisplayName = translateStopName(cleanDisplayName);
        const stopNameHTML = withRERIconInStop(translatedDisplayName);
        const coordParts = [st.X, st.Y, st.Z].map(v => Number(v).toFixed(2));
        const coordsDisplay = escapeHTML(coordParts.join(", "));
        const gotoCmd = `goto ${st.X.toFixed(2)};${st.Y.toFixed(2)};${st.Z.toFixed(2)};${st.rotX.toFixed(6)};${st.rotY.toFixed(6)}`;

        const { lineNumber } = parseRouteName(route.name || "");
        let cleanNum = String(lineNumber || "").trim();
        cleanNum = cleanNum.replace(/\s*\([^)]*\)/, "").trim();

        const [bg, text] = getLineColorsSync(cleanNum);
        getLineColors(cleanNum).then(([bg])=>{
          if(bg) poly.setStyle({color:bg});
        });
        
        const stopOrderLabel = `${idx+1} / ${arr.length}`;
        const temporaryStopLabel = escapeHTML(t("temporary_stop"));
        const coordinatesLabel = escapeHTML(t("coordinates"));
        const html = `
          <div class="stop-popup">
            <div class="sp-header">
              <div class="sp-title">${stopNameHTML}${isProvisoireStop ? ` <span class="stop-flag" aria-label="${temporaryStopLabel}">${temporaryStopLabel}</span>` : ''}</div>
              <div class="sp-index">${stopOrderLabel}</div>
            </div>
            <div class="sp-body">
              <div class="sp-coords">
                <span>${coordinatesLabel}</span>
                <div class="sp-coords-code">${coordsDisplay}</div>
              </div>
            </div>
          </div>`;

        const marker = L.marker(st.latlng, {
          icon: L.divIcon({
            className: "stop-number",
            html: `<div style="
              width:${isFirst || isLast ? 26 : 22}px;
              height:${isFirst || isLast ? 26 : 22}px;
              border-radius:50%;
              background:#fff;
              border:2px solid #000;
              display:flex;
              align-items:center;
              justify-content:center;
              font-size:12px;
              font-weight:700;
              color:#000;
            ">${idx+1}</div>`,
            iconSize: [isFirst || isLast ? 26 : 22, isFirst || isLast ? 26 : 22],
            iconAnchor: [(isFirst || isLast ? 26 : 22)/2, (isFirst || isLast ? 26 : 22)/2]
          })
        }).addTo(group).bindPopup(
          L.popup({ maxWidth: 420, autoPan: true }).setContent(html)
        );

        marker._routeKey = key;

        marker.on('click', ()=> {
          const stObj = DBUS_STOPS.get(id);
          if (stObj?.latlng) centerWithPreview(stObj.latlng, { zoom: map.getZoom() });
        });

        marker.on('popupopen', (e) => {
          setActiveStopById(id);
          if (marker._routeKey !== currentSelectedKey) {
            e.popup.remove();
            return;
          }
          const el = e.popup.getElement();
          if (!el) return;
          const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
          if (!chip) return;
          const isNetworkChip = chip.dataset?.networkBadge === "true";
          if (isNetworkChip) return;

          const { cleanNum } = parseRouteName(route.name || "")
           getLineColors(cleanNum).then(([bg, text]) => {
              const pop = marker.getPopup();
              if (!pop) return;
              const el = pop.getElement();
              if (!el) return;
              const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
              if (!chip) return;
              const isNetworkChip = chip.dataset?.networkBadge === "true";

              if (isNetworkChip) return;

              if (isNoctilien2(n)) {
                chip.style.background = "#080080";
                chip.style.color = text;
                if (!el.querySelector('.noctilien-stripe')) {
                  ensureStripe(chip, noctilienStripeColor(n));
                }
              } else {
                chip.style.background = bg;
                chip.style.color = text;
              }
            });

        });

        marker.on('popupclose', ()=>{
          if (currentActiveStopId === id) clearActiveStop();
        });

        getLineColors(cleanNum).then(([bg, text]) => {
          const pop = marker.getPopup();
          if (!pop) return;
          const el = pop.getElement();
          if (!el) return;
          const chip = el.querySelector(".titus-chip") || el.querySelector(".dbus-badge");
          if (!chip) return;
          const isNetworkChip = chip.dataset?.networkBadge === "true";
          if (isNetworkChip) return;

          if (isNoctilien2(n)) {
            chip.style.background = "#080080";
            chip.style.color = text;
            ensureStripe(chip, noctilienStripeColor(n));
          } else {
            chip.style.background = bg;
            chip.style.color = text;
          }
        });


        return marker;
      }).filter(Boolean);

      const bundle = { group, poly, stops };
      dbusRouteLayers.set(key, bundle);
      return bundle;
    }

    function hideAllRoutes(){
      dbusLayers.clearLayers();
      routeAnimHandles.forEach(h => h.stop());
      routeAnimHandles.clear();
      hideLinePreview();
      clearActiveStop()
    }

    function showOnlyRoute(lineIdx, line, route){
      hideAllRoutes();
      const key = `${line.uid}:${route.uid}`;
      const existing = dbusRouteLayers.get(key);
      let bundle;

      if (existing) {
        dbusLayers.addLayer(existing.group);
        bundle = existing;
        if (existing.poly?._path) startLineAnim(key, existing.poly);
        else existing.poly.once('add', () => startLineAnim(key, existing.poly));
      } else {
        bundle = drawRoute(lineIdx, line, route);
      }

      if (route.stops && route.stops.length){
        const first = DBUS_STOPS.get(route.stops[0].uid);
        if(first?.latlng){
          centerWithPreview(first.latlng, { zoom: map.getZoom() });
          const marker = bundle.stops[0];
          if(marker?.openPopup) setTimeout(()=> marker.openPopup(), 300);
        }
      }

      if (route.stops.length){
        const first = DBUS_STOPS.get(route.stops[0].uid);
        if(first?.latlng){
          centerWithPreview(first.latlng, { zoom: map.getZoom() });
          const marker = bundle.stops[0];
          if(marker?.openPopup) setTimeout(()=> marker.openPopup(), 300);
        }
      }

      renderLinePreview(line, route);

      return bundle;
    }

    function getRouteEndpoints(route){
      const routeTitleRaw = route.name.includes(":") ? route.name.split(":")[1].trim() : route.name;
      const [titleStart0, titleEnd0] = splitRouteEndpoints(routeTitleRaw);
      const rawStart = trimAroundRER(titleStart0, 'start');
      const rawEnd   = trimAroundRER(titleEnd0,   'end');
      const titleStart = translateStopName(rawStart);
      const titleEnd   = translateStopName(rawEnd);
      return { routeTitleRaw, titleStart, titleEnd, rawStart, rawEnd };
    }

    let PREVIEW_STOP_ELEMS = new Map();

    function setActiveStopById(stopId){
      PREVIEW_STOP_ELEMS.forEach(({el, routeKey}) => {
        if (routeKey === currentSelectedKey) el.classList.remove('active');
      });
      const rec = PREVIEW_STOP_ELEMS.get(stopId);
      if (rec && rec.routeKey === currentSelectedKey) {
        rec.el.classList.add('active');
        currentActiveStopId = stopId;
      }
    }

    function centerWithPreview(latlng, { zoom = null } = {}) {
      const targetZoom = zoom ?? map.getZoom();
      const paneH = document.getElementById('linePreview')?.offsetHeight || 0;
      const offsetY = Math.round(paneH / 2);
      const p = map.project(latlng, targetZoom);
      const targetPt = L.point(p.x, p.y + offsetY);
      const targetLL = map.unproject(targetPt, targetZoom);
      map.setView(targetLL, targetZoom, { animate: true });
    }

    function getLineNumber(line, route) {
      if (line.number && line.number !== "?") {
        return line.number;
      }
      const { lineNumber } = parseRouteName(route.name || "");
      return lineNumber || "?";
    }

    function renderLinePreview(line, route){
      PREVIEW_STOP_ELEMS = new Map();

      const wrap = document.getElementById("linePreviewWrap");
      const badge = document.getElementById("lpBadge");
      const title = document.getElementById("lpRouteTitle");
      const transit = document.getElementById("lpTransit");
      if(!wrap || !badge || !title || !transit) return;

      const { titleStart, titleEnd, rawStart, rawEnd } = getRouteEndpoints(route);
      const cleanedStart = withRERIcon(titleStart);
      const cleanedEnd   = withRERIcon(titleEnd);

      const stopCount = route.stops.length;

      let durationText;
      if (route.totalMinutes >= 60) {
        const h = Math.floor(route.totalMinutes / 60);
        const m = route.totalMinutes % 60;
        if (m > 0) {
          durationText = `${h} h ${m} min`;
        } else {
          durationText = `${h} h`;
        }
      } else {
        durationText = `${route.totalMinutes} min`;
      }
      
      title.innerHTML = `
        <div>${cleanedStart} &gt; ${cleanedEnd}</div>
        <div style="font-weight:400; font-size:12px; color:#9fb1cc; margin-top:2px">
          <span class="stop-duration"></span>
        </div>
      `;
      title.dataset.rawStart = rawStart || "";
      title.dataset.rawEnd = rawEnd || "";
      setStopDurationText(title.querySelector(".stop-duration"), stopCount, durationText, "dash");

      const { lineNumber } = parseRouteName(route.name || "");
      const lineCategory = getCategory(line);
      const mTitusLP = /^titus\s*(\d+)/i.exec(String(lineNumber||""));
      const isNoctLinePreview = isNoctilien2(lineNumber);
      let previewBadgeChip = null;

      const lpLink = document.getElementById("lpLink");
      if (lpLink){
        const url = getLineLink(line, route);
        const hasUrl = !!url;
        if (hasUrl) {
          lpLink.href = url;
          lpLink.hidden = false;
          lpLink.style.display = "";
        } else {
          lpLink.removeAttribute("href");
          lpLink.hidden = true;
          lpLink.style.display = "none";
        }
      }

      function applyNetworkBadgeToPreview(opts){
        badge.innerHTML = "";
        badge.className = "lp-badge-wrapper";
        badge.style.background = "transparent";
        badge.style.color = "#fff";
        delete badge.dataset.networkBadge;
        const { wrap, chip } = createNetworkBadgeElement(opts);
        badge.appendChild(wrap);
        previewBadgeChip = chip;
      }

      function applyDefaultBadgeToPreview(){
        badge.className = "dbus-badge";
        badge.innerHTML = "";
        delete badge.dataset.networkBadge;
        ensureBadgeLabel(badge, lineNumber);
        badge.style.background = "#444";
        badge.style.color = "#fff";
        previewBadgeChip = badge;
      }

      function applySchoolBadgeToPreview(){
        badge.innerHTML = "";
        badge.className = "lp-badge-wrapper";
        badge.style.background = "transparent";
        badge.style.color = "#fff";
        badge.dataset.networkBadge = "true";
        const wrap = document.createElement("div");
        wrap.className = "network-badge";
        const school = document.createElement("img");
        school.src = overlayPath("bus_school.png");
        school.alt = t("dbus_school_toggle");
        wrap.appendChild(school);
        badge.appendChild(wrap);
        previewBadgeChip = badge;
      }

      if (mTitusLP) {
        applyNetworkBadgeToPreview({
          label: mTitusLP[1],
          imgSrc: overlayPath("reseau_titus.png"),
          alt: "Reseau Titus",
          colorKey: lineNumber,
          chipClass: "dbus-badge titus-chip"
        });
      } else if (isNoctLinePreview) {
        applyNetworkBadgeToPreview({
          label: lineNumber,
          imgSrc: overlayPath("noctilien_logo_idfm.png"),
          alt: "Noctilien",
          stripeColor: noctilienStripeColor(lineNumber)
        });
      } else if (lineCategory === "Scolaire") {
        applySchoolBadgeToPreview();
      } else if (lineCategory === "FlixBus") {
        applyNetworkBadgeToPreview({
          label: lineNumber,
          imgSrc: overlayPath("bus_ico.png"),
          alt: "FlixBus"
        });
      } else if (lineCategory === "Urbain" || lineCategory === "Autres") {
        applyNetworkBadgeToPreview({
          label: lineNumber,
          imgSrc: overlayPath("bus_logo_idfm.png"),
          alt: "Reseau urbain Ile-de-France Mobilites"
        });
      } else {
        applyDefaultBadgeToPreview();
      }

      if (transit) transit.style.setProperty('--lineColor', '#3aa0ff');

      const previewBadgeTarget = previewBadgeChip || badge;
      const isPreviewNetwork = previewBadgeTarget?.dataset?.networkBadge === "true";
      if (!isPreviewNetwork && isNoctilien2(line.number)) {
        ensureStripe(previewBadgeTarget, noctilienStripeColor(line.number));
      }

      const colorKeyLP = lineNumber || getLineNumber(line, route);
      getLineColors(colorKeyLP).then(([bg, text])=>{
        if (previewBadgeTarget && !isPreviewNetwork){
          previewBadgeTarget.style.background = bg;
          previewBadgeTarget.style.color = text;
        }
        if (transit) transit.style.setProperty('--lineColor', bg);
        if (!isPreviewNetwork && isNoctilien2(colorKeyLP)) {
          ensureStripe(previewBadgeTarget, noctilienStripeColor(colorKeyLP));
        }
      });

      transit.innerHTML = "";
      const temporaryStopLabel = escapeHTML(t("temporary_stop"));
      const ids = route.stops.map(s => s.uid);
      ids.forEach((id, idx) => {
        const st = DBUS_STOPS.get(id); if(!st) return;
        const rawStopName = st.name || "";
        let label = rawStopName;
        if (idx === 0) label = titleStart;
        else if (idx === ids.length-1) label = titleEnd;

        const stopEl = document.createElement("div");
        stopEl.className = "stop" + (idx===0 ? " first" : (idx===ids.length-1 ? " last" : ""));
        stopEl.dataset.stopId = String(id);
        const isProvisoire = hasProvisoire(rawStopName) || hasProvisoire(label);
        const cleanLabel = stripProvisoire(label);
        const translatedLabel = translateStopName(cleanLabel);
        stopEl.dataset.rawLabel = cleanLabel;
        stopEl.dataset.provisoire = isProvisoire ? "1" : "0";
        stopEl.innerHTML = `
          <div class="dot"></div>
          <div class="name">${withRERIcon(translatedLabel)}${isProvisoire ? ` <span class="stop-flag" aria-label="${temporaryStopLabel}">${temporaryStopLabel}</span>` : ''}</div>
        `;
        
        stopEl.addEventListener('click', ()=>{
          const bundle = dbusRouteLayers.get(currentSelectedKey);
          const mk  = bundle?.stops?.[idx];
          const pop = mk?.getPopup?.();

          if (pop) pop.options.autoPan = false;

          const stObj = DBUS_STOPS.get(id);
          if (stObj?.latlng) centerWithPreview(stObj.latlng);

          setTimeout(()=> { if (mk?.openPopup) mk.openPopup(); }, 120);

          if (pop) pop.options.autoPan = true;

          setActiveStopById(id);
        });
        PREVIEW_STOP_ELEMS.set(id, { el: stopEl, idx, routeKey: currentSelectedKey });

        transit.appendChild(stopEl);

        if (idx < ids.length-1){
          const seg = document.createElement("div");
          seg.className = "segment";
          getLineColors(lineNumber).then(([bg]) => { if (bg) seg.style.background = bg; }).catch(()=>{});
          transit.appendChild(seg);
        }
      });

      const firstId = route.stops[0]?.uid;
      if (typeof firstId !== 'undefined') setActiveStopById(firstId);

      wrap.style.display = "block";
      updateUiOverlays();
      applyI18N();
    }

    function restoreLinePreview(key){
      const routeKey = key || currentSelectedKey;
      if (!routeKey) return;
      const [lineUid, routeUid] = routeKey.split(":");
      const line = (DBUS_LINES || []).find(l => String(l.uid) === String(lineUid));
      const route = line?.routes?.find(r => String(r.uid) === String(routeUid));
      if (line && route) renderLinePreview(line, route);
    }
    window.restoreLinePreview = restoreLinePreview;

    function hideLinePreview(){
      const wrap = document.getElementById("linePreviewWrap");
      if (wrap) wrap.style.display = "none";
      clearActiveStop()
      updateUiOverlays();
    }

    document.getElementById("lpClose")?.addEventListener("click", () => {
      currentSelectedKey = "";
      hideAllRoutes();
      hideLinePreview();
      document.getElementById("dbusList")?.querySelectorAll(".dbus-item")?.forEach(it => it.style.outline="none");
      renderSelectedChip();
    });

    function openDbusPanel() {
      if (dbusDepartPreviewActive) {
        dbusDepartPreviewActive = false;
        hideDbusDepartures();
      }
      closeSearchUI({ reset: true });
      clearDbusSelection();
      hideLinePreview();
      closeDbusStopPanel();
      if (currentDbusMode !== DBUS_MODES.LINES) setDbusMode(DBUS_MODES.LINES);
      else updateDbusModeUI();
      $panelDbus.style.display = 'flex';
      setMenuOpen($panelDbus, true);
      $btnDbus?.setAttribute('aria-expanded','true');
      updateDbusDepartIndicator();
      updateUiOverlays();
    }
    function closeDbusPanel() {
      $panelDbus.style.display = 'none';
      setMenuOpen($panelDbus, false);
      $btnDbus?.setAttribute('aria-expanded','false');
      closeDbusStopPanel();
      updateDbusDepartIndicator();
      updateUiOverlays();
    }
    document.getElementById("dbusPanelClose")?.addEventListener("click", closeDbusPanel);
    document.getElementById("dbusStopClose")?.addEventListener("click", closeDbusStopPanel);
    function isDbusOpen() { return getComputedStyle($panelDbus).display !== 'none'; }
    function isDbusStopOpen() { return $dbusStopPanel && getComputedStyle($dbusStopPanel).display !== 'none'; }
    function isLinePreviewOpen() {
      const wrap = document.getElementById("linePreviewWrap");
      return !!wrap && getComputedStyle(wrap).display !== "none";
    }
    function isButtonDisabled(btn){
      return !!btn && (btn.classList.contains("is-disabled") || btn.getAttribute("aria-disabled") === "true");
    }
    function setButtonDisabled(btn, disabled){
      if (!btn) return;
      btn.classList.toggle("is-disabled", disabled);
      if (disabled) btn.setAttribute("aria-disabled", "true");
      else btn.removeAttribute("aria-disabled");
    }
    function setMenuOpen(el, open){
      if (!el) return;
      el.classList.toggle("is-open", !!open);
    }
    function closeAllMenus({ resetSearch = true } = {}){
      closeSearchUI({ reset: resetSearch });
      closeDbusPanel();
      closeDbusStopPanel();
      hideLinePreview();
      try { resetDbusSelection(); } catch {}
      try { closeLangMenu(); } catch {}
    }
    function updateUiOverlays() {
      const isMenuOpen = isDbusOpen() || isDbusStopOpen();
      const isPreviewOpen = isLinePreviewOpen();
      const isDepartIndicatorOpen = !!$dbusDepartIndicatorWrap && !$dbusDepartIndicatorWrap.hidden;
      const isSearchPanelOpen = isSearchOpen();
      const disableSearch = isMenuOpen || isPreviewOpen || isDepartIndicatorOpen;
      if ($btnSearch) $btnSearch.classList.toggle("is-open", isSearchPanelOpen);
      if ($btnDbus) $btnDbus.classList.toggle("is-open", isMenuOpen || isPreviewOpen || isDepartIndicatorOpen);
      setButtonDisabled($btnSearch, disableSearch);
      setButtonDisabled($btnDbus, isSearchPanelOpen);
      if ($search) {
        if ($search.disabled !== disableSearch) $search.disabled = disableSearch;
        if (disableSearch) {
          $search.setAttribute("aria-disabled", "true");
          if (isSearchOpen()) closeSearchUI();
        } else {
          $search.removeAttribute("aria-disabled");
        }
      }
      const scaleEl = document.getElementById("custom-scale");
      if (scaleEl) scaleEl.hidden = isMenuOpen || isPreviewOpen || isDepartIndicatorOpen;
    }
    function updateDbusDepartIndicator(){
      if (!$dbusDepartIndicatorWrap) return;
      const show = dbusDepartPreviewActive && currentDbusMode === DBUS_MODES.DEPARTS && !isDbusOpen();
      $dbusDepartIndicatorWrap.hidden = !show;
      updateUiOverlays();
    }
    function refreshDbusDepartures(showOnMap){
      const needsBuild = !dbusDepartGroups.length || dbusDepartFilterKey !== `${showSchoolLines}-${showFictiveLines}`;
      if (needsBuild) buildDbusDepartures();
      else renderDbusDepartList();
      if (showOnMap) showDbusDepartures();
      else hideDbusDepartures();
    }
    function openSearchUI({ focus = false, refresh = false } = {}) {
      if (isButtonDisabled($btnSearch)) return;
      closeDbusPanel();
      if ($searchPanel) {
        $searchPanel.style.display = 'flex';
        $searchPanel.setAttribute("aria-hidden", "false");
        setMenuOpen($searchPanel, true);
      }
      $btnSearch?.setAttribute("aria-expanded", "true");
      if (refresh) doSearch($search.value);
      $results.hidden = false;
      if (focus) setTimeout(() => $search?.focus(), 0);
      updateUiOverlays();
    }
    function closeSearchUI({ reset = false } = {}) {
      if (reset) $search.value = '';
      renderResults([]); 
      $results.hidden = true;
      $search.blur();
      if ($searchPanel) {
        $searchPanel.style.display = 'none';
        $searchPanel.setAttribute("aria-hidden", "true");
        setMenuOpen($searchPanel, false);
      }
      $btnSearch?.setAttribute("aria-expanded", "false");
      updateUiOverlays();
    }
    function isSearchOpen(){
      return !!$searchPanel && getComputedStyle($searchPanel).display !== 'none';
    }

    if ($btnSearch) {
      $btnSearch.addEventListener("click", () => {
        if (isButtonDisabled($btnSearch)) {
          closeAllMenus({ resetSearch: true });
          return;
        }
        if (isSearchOpen()) closeSearchUI({ reset: true });
        else {
          setActiveSearchCategory(SEARCH_CATEGORY_ALL);
          $search.value = "";
          openSearchUI({ focus: true, refresh: true });
        }
      });
    }
    $searchPanelClose?.addEventListener("click", () => closeSearchUI({ reset: true }));

    $dbusModeButtons.forEach(btn => {
      btn.addEventListener("click", () => setDbusMode(btn.dataset.mode));
    });
    updateDbusModeUI();
    function onDbusFilterChange() {
      if ((!showSchoolLines || !showFictiveLines) && currentSelectedKey) {
        try {
          const [lu] = currentSelectedKey.split(":");
          const line = DBUS_LINES.find(l => l.uid === lu);
          const cat = line ? getCategory(line) : "";
          if (!showSchoolLines && cat === "Scolaire") clearDbusSelection();
          if (!showFictiveLines && cat === "Autres") clearDbusSelection();
        } catch {}
      }
      if (currentDbusMode === DBUS_MODES.DEPARTS) {
        closeDbusStopPanel();
        refreshDbusDepartures(dbusDepartPreviewActive);
        return;
      }
      if (typeof renderDbusLinesList === "function") renderDbusLinesList(currentDbusMode);
    }
    if ($dbusSchoolToggle) {
      showSchoolLines = $dbusSchoolToggle.checked;
      $dbusSchoolToggle.addEventListener("change", () => {
        showSchoolLines = $dbusSchoolToggle.checked;
        onDbusFilterChange();
      });
    }
    if ($dbusFictiveToggle) {
      showFictiveLines = $dbusFictiveToggle.checked;
      $dbusFictiveToggle.addEventListener("change", () => {
        showFictiveLines = $dbusFictiveToggle.checked;
        onDbusFilterChange();
      });
    }

    $btnDbus.addEventListener('click', () => {
      if (isButtonDisabled($btnDbus)) {
        closeAllMenus({ resetSearch: true });
        return;
      }
      if (isDbusOpen()) closeDbusPanel();
      else openDbusPanel();
      renderSelectedChip();
    });

    $dbusDepartIndicatorClose?.addEventListener("click", () => {
      dbusDepartPreviewActive = false;
      setDbusMode(DBUS_MODES.LINES);
      updateDbusDepartIndicator();
    });
    $dbusDepartMapBtn?.addEventListener("click", () => {
      dbusDepartPreviewActive = true;
      if (currentDbusMode !== DBUS_MODES.DEPARTS) setDbusMode(DBUS_MODES.DEPARTS);
      else refreshDbusDepartures(true);
      closeDbusPanel();
    });


    function renderSelectedChip(){
      const host = $selectedChip;
      if (!currentSelectedKey) { host.style.display="none"; host.innerHTML=""; return; }
      host.style.display = "none";
      host.innerHTML = "";
    }

    function resetDbusSelection(){
      document.getElementById("dbusList")?.querySelectorAll(".dbus-item.active")?.forEach(item => {
        item.classList.remove("active");
        item.style.outline = "none";
      });
      currentSelectedKey = "";
      hideAllRoutes();
      renderSelectedChip();
      if (window.__DBUS_GRID_OPEN && typeof window.__DBUS_GRID_OPEN.clear === "function") {
        try { window.__DBUS_GRID_OPEN.clear(); } catch {}
        window.__DBUS_GRID_OPEN = null;
      }
    }

    function updateDbusModeUI(){
      $dbusModeButtons.forEach(btn => {
        const active = btn.dataset.mode === currentDbusMode;
        btn.classList.toggle("active", active);
        btn.setAttribute("aria-pressed", active ? "true" : "false");
      });
      const isDepartMode = currentDbusMode === DBUS_MODES.DEPARTS;
      const isListMode = (currentDbusMode === DBUS_MODES.LINES || currentDbusMode === DBUS_MODES.LENGTH);
      if ($dbusList) $dbusList.style.display = isListMode ? "" : "none";
      if ($dbusDepartActions) $dbusDepartActions.hidden = !isDepartMode;
      if ($dbusDepartList) $dbusDepartList.style.display = isDepartMode ? "" : "none";
      updateUiOverlays();
    }

    function setDbusMode(mode){
      if (!mode || currentDbusMode === mode) return;
      currentDbusMode = mode;
      updateDbusModeUI();
      if (mode === DBUS_MODES.DEPARTS) {
        resetDbusSelection();
        refreshDbusDepartures(dbusDepartPreviewActive);
      } else {
        dbusDepartPreviewActive = false;
        resetDbusSelection();
        hideDbusDepartures();
        closeDbusStopPanel();
        if (typeof renderDbusLinesList === "function") renderDbusLinesList(mode);
      }
      updateDbusDepartIndicator();
    }

    function clearDbusSelection(scope = $dbusList){
      if (!scope) return;
      const activeItems = scope.querySelectorAll(".dbus-item.active");
      if (!activeItems.length) return;
      activeItems.forEach(item => {
        item.classList.remove("active");
        item.style.outline = "none";
      });
      currentSelectedKey = "";
      hideAllRoutes();
      renderSelectedChip();
    }

    function isNumericOnly(s){ return /^\d+$/.test(String(s||"").trim()); }
    function isFlix(line){
      const num = String(line.number||"").toLowerCase();
      if (num.includes("flix")) return true;
      return (line.routes||[]).some(r => String(r.name||"").toLowerCase().includes("flix"));
    }
    function isNoctilien(line){
      const num = String(line.number||"").trim().toUpperCase();
      return /^N\d+$/.test(num);
    }
    function isTitusLine(line){
      const num = String(line.number||"").trim().toLowerCase();
      return /titus/i.test(num);
    }
    function getCategory(line){
      if (isNoctilien(line))          return "Noctilien";
      if (isFlix(line))               return "FlixBus";
      if (isNumericOnly(line.number)) return "Urbain";
      if (isTitusLine(line))          return "Urbain";
      if (/^scolaire/i.test(line.number)) return "Scolaire";
      return "Autres";
    }

    function compareDepartRoutes(a, b) {
      const numA = String(getLineNumber(a.line, a.route) || "").trim();
      const numB = String(getLineNumber(b.line, b.route) || "").trim();
      const aNum = isNumericOnly(numA);
      const bNum = isNumericOnly(numB);
      if (aNum !== bNum) return aNum ? -1 : 1;
      const cmp = numA.localeCompare(numB, 'fr', { numeric: true, sensitivity: "base" });
      if (cmp !== 0) return cmp;
      const uidCmp = String(a.line?.uid || "").localeCompare(String(b.line?.uid || ""), 'fr', { numeric: true, sensitivity: "base" });
      if (uidCmp !== 0) return uidCmp;
      const durDiff = (b.route?.totalMinutes || 0) - (a.route?.totalMinutes || 0);
      if (durDiff !== 0) return durDiff;
      return String(a.route?.name || "").localeCompare(String(b.route?.name || ""), 'fr', { numeric: true, sensitivity: "base" });
    }

    function countDepartEntries(entries) {
      let total = 0;
      const scolaireLines = new Set();
      entries.forEach(entry => {
        if (getCategory(entry.line) === "Scolaire") {
          scolaireLines.add(entry.line.uid);
        } else {
          total += 1;
        }
      });
      return total + scolaireLines.size;
    }

    const DEPART_CATEGORY_ORDER = ["Urbain", "Noctilien", "FlixBus", "Scolaire", "Autres"];

    function buildDepartBuckets(entries) {
      const buckets = {
        "Urbain": [],
        "Noctilien": [],
        "FlixBus": [],
        "Scolaire": [],
        "Autres": []
      };
      entries.forEach(entry => {
        const cat = getCategory(entry.line);
        if (buckets[cat]) buckets[cat].push(entry);
      });
      return buckets;
    }

    function renderDepartCategorySection(key, entries, container, isOpenByDefault = false) {
      if (!entries.length) return;
      const title = dbusCategoryTitle(key);
      const sec = document.createElement("div");
      sec.className = "dbus-sec";
      container.appendChild(sec);

      const head = document.createElement("div");
      head.className = "dbus-sechead";
      head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
      head.dataset.cat = key;
      head.dataset.count = String(entries.length);
      head.innerHTML = `<span>${title} (${entries.length})</span><span class="chev" style="margin-left:auto">‚ñº</span>`;
      sec.appendChild(head);

      const body = document.createElement("div");
      body.className = "dbus-secbody";
      body.hidden = !isOpenByDefault;
      sec.appendChild(body);

      const sorted = [...entries].sort(compareDepartRoutes);
      sorted.forEach(({ line, route }) => renderDepartLineItem(line, route, body));

      head.addEventListener("click", () => {
        const expanded = head.getAttribute("aria-expanded") === "true";
        head.setAttribute("aria-expanded", expanded ? "false" : "true");
        body.hidden = expanded;
      });
    }

    function renderDepartCategories(entries, container) {
      if (!entries.length) {
        const empty = document.createElement("div");
        empty.className = "dbus-none";
        empty.textContent = t("none");
        container.appendChild(empty);
        return;
      }

      const buckets = buildDepartBuckets(entries);
      DEPART_CATEGORY_ORDER.forEach((key) => {
        const list = buckets[key] || [];
        if (!list.length) return;
        renderDepartCategorySection(key, list, container, true);
      });
    }

    function appendRouteLogo(item, line, lineNumber, showLogo) {
      if (!showLogo) return;
      const rawLineNumber = String(lineNumber || line.number || "").trim();
      const isNoct = isNoctilien2(rawLineNumber);
      const isTitusLogo = /^titus\s*(\d+)/i.test(rawLineNumber) || isTitusLine(line);
      const cat = getCategory(line);
      const logos = [];
      if (isTitusLogo) {
        logos.push({ src: overlayPath("reseau_titus.png"), alt: "Reseau Titus" });
      } else if (isNoct) {
        logos.push({ src: overlayPath("noctilien_logo_idfm.png"), alt: "Noctilien" });
      } else if (cat === "FlixBus") {
        logos.push({ src: overlayPath("bus_ico.png"), alt: "FlixBus" });
      } else if (cat === "Scolaire") {
        logos.push({ src: overlayPath("bus_school.png"), alt: "Scolaire" });
      } else if (cat === "Urbain" || cat === "Autres") {
        logos.push({ src: overlayPath("bus_logo_idfm.png"), alt: "IDFM" });
      }
      if (!logos.length) return;
      logos.forEach(({ src, alt }) => {
        const logo = document.createElement("img");
        logo.className = "dbus-route-logo";
        logo.src = src;
        logo.alt = alt;
        item.appendChild(logo);
      });
    }

    function renderDepartLineItem(line, route, container) {
      const item = document.createElement("div");
      item.className = "dbus-item";

      const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
      const { titleEnd } = getRouteEndpoints(route);
      const mTitus = /^titus\s*(\d+)/i.exec(String(lineNumber||""));
      const displayNumber = mTitus ? mTitus[1] : lineNumber;
      const isScolaire = getCategory(line) === "Scolaire";
      const badge = isScolaire ? null : makeLineBadge(displayNumber, "#444", "#fff", "72x32");
      appendRouteLogo(item, line, lineNumber, true);

      const titleEl = document.createElement("div");
      titleEl.className = "rname";
      titleEl.style.flex = "1 1 auto";
      const dirName = getRouteTerminusLabel(route, titleEnd) || String(titleEnd || routeTitle || "").trim();
      const dirLabel = t("destination");
      const dirText = dirName || routeTitle || "?";
      titleEl.dataset.routeKind = "depart";
      titleEl.dataset.routeTitle = routeTitle || "";
      titleEl.dataset.routeEnd = titleEnd || "";
      if (flag) titleEl.dataset.routeFlag = flag;
      let titleHtml = `${dirLabel} : ${withRERIcon(dirText)}`;
      if (flag) titleHtml = titleHtml + ` <span class="route-flag">${flag}</span>`;
      titleEl.innerHTML = titleHtml; 

      const duration = document.createElement("div");
      duration.className = "dbus-duration";

      const stopCount = route.stops.length;
      let durationText;
      if (route.totalMinutes >= 60) {
        const h = Math.floor(route.totalMinutes / 60);
        const m = route.totalMinutes % 60;
        if (m > 0) {
          durationText = `${h} h ${m} min`;
        } else {
          durationText = `${h} h`;
        }
      } else {
        durationText = `${route.totalMinutes} min`;
      }
      setStopDurationText(duration, stopCount, durationText, "paren");

      if (badge) item.appendChild(badge);
      item.appendChild(titleEl);
      item.appendChild(duration);

      const colorKey = mTitus ? lineNumber : getLineNumber(line, route);
      if (badge) {
        getLineColors(colorKey).then(([bg,text])=>{
          badge.style.background = bg;
          badge.style.color = text;
          if (isNoctilien2(getLineNumber(line, route))) {
            ensureStripe(badge, noctilienStripeColor(getLineNumber(line, route)));
          }
          if (getCategory(line) === "Autres") {
            ensureFictiveStripe(badge);
          }
        });
      }

      item.addEventListener("click", () => {
        const lineIdx = DBUS_LINES.indexOf(line);
        setDbusMode(DBUS_MODES.LINES);
        currentSelectedKey = `${line.uid}:${route.uid}`;
        showOnlyRoute(lineIdx >= 0 ? lineIdx : 0, line, route);
        renderSelectedChip();
        closeDbusStopPanel();
        closeDbusPanel();
      });

      container.appendChild(item);
    }

    function updateDepartMarkerClasses(marker, { hover = false, selected = false } = {}) {
      const el = marker?.getElement?.();
      if (!el) return;
      const dot = el.querySelector(".dbus-depart-dot");
      if (!dot) return;
      dot.classList.toggle("is-hover", hover);
      dot.classList.toggle("is-selected", selected);
    }

    function setDepartMarkerHover(marker, isHover) {
      if (!marker) return;
      marker._departHover = !!isHover;
      updateDepartMarkerClasses(marker, {
        hover: marker._departHover,
        selected: marker === selectedDepartMarker
      });
    }

    function clearDepartMarkerSelection() {
      if (!selectedDepartMarker) return;
      updateDepartMarkerClasses(selectedDepartMarker, { hover: !!selectedDepartMarker._departHover, selected: false });
      selectedDepartMarker = null;
    }

    function setSelectedDepartMarker(marker) {
      if (!marker) return;
      if (selectedDepartMarker && selectedDepartMarker !== marker) {
        updateDepartMarkerClasses(selectedDepartMarker, { hover: !!selectedDepartMarker._departHover, selected: false });
      }
      selectedDepartMarker = marker;
      updateDepartMarkerClasses(marker, { hover: !!marker._departHover, selected: true });
    }

    function closeDbusStopPanel() {
      if ($dbusStopPanel) $dbusStopPanel.style.display = "none";
      setMenuOpen($dbusStopPanel, false);
      clearDepartMarkerSelection();
      updateUiOverlays();
    }

    function normalizeDepartName(name) {
      const txt = String(name || "").trim();
      return txt || t("stop");
    }

    function getDepartGroupNames(group) {
      const names = [...group.nameMap.keys()].map(n => String(n || "").trim()).filter(Boolean);
      const translated = names.map(n => translateStopName(n));
      translated.sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: "base" }));
      if (!translated.length) return [t("stop")];
      return translated;
    }

    function renderDepartStopSection(nameRec, container) {
      const sec = document.createElement("div");
      sec.className = "dbus-sec";
      const h = document.createElement("h4");
      const displayName = translateStopName(nameRec.name);
      h.dataset.stopName = nameRec.name;
      const stopCount = countDepartEntries(nameRec.routes);
      h.dataset.stopCount = String(stopCount);
      h.innerHTML = `${withRERIcon(displayName)} (${stopCount})`;
      sec.appendChild(h);

      const body = document.createElement("div");
      sec.appendChild(body);
      renderDepartCategories(nameRec.routes, body);

      container.appendChild(sec);
    }

    function openDbusStopPanelForGroup(group) {
      if (!$dbusStopPanel || !$dbusStopTitle || !$dbusStopList) return;
      const rawNames = [...group.nameMap.keys()].map(n => String(n || "").trim()).filter(Boolean);
      const nameList = rawNames.map(n => translateStopName(n));
      $dbusStopTitle.innerHTML = nameList.map(n => withRERIcon(n)).join(" / ");
      $dbusStopTitle.dataset.stopMode = "group";
      $dbusStopTitle.dataset.stopNames = JSON.stringify(rawNames);
      delete $dbusStopTitle.dataset.stopName;
      $dbusStopList.innerHTML = "";

      const sections = [...group.nameMap.values()].sort((a, b) => {
        const countA = countDepartEntries(a.routes);
        const countB = countDepartEntries(b.routes);
        if (countB !== countA) return countB - countA;
        return a.name.localeCompare(b.name, 'fr', { sensitivity: "base" });
      });
      if (sections.length <= 1) {
        const routes = sections[0]?.routes ? [...sections[0].routes] : [];
        renderDepartCategories(routes, $dbusStopList);
      } else {
        sections.forEach(section => renderDepartStopSection(section, $dbusStopList));
      }
      $dbusStopPanel.style.display = "flex";
      setMenuOpen($dbusStopPanel, true);
      updateUiOverlays();
    }

    function openDbusStopPanelForName(nameRec) {
      if (!$dbusStopPanel || !$dbusStopTitle || !$dbusStopList) return;
      $dbusStopTitle.dataset.stopMode = "single";
      $dbusStopTitle.dataset.stopName = nameRec.name;
      $dbusStopTitle.innerHTML = `${t("stop")} : ${withRERIcon(translateStopName(nameRec.name))}`;
      $dbusStopList.innerHTML = "";

      renderDepartCategories(nameRec.routes, $dbusStopList);

      $dbusStopPanel.style.display = "flex";
      setMenuOpen($dbusStopPanel, true);
      updateUiOverlays();
    }

    function renderDbusDepartList() {
      if (!$dbusDepartList) return;
      $dbusDepartList.innerHTML = "";
      const items = [...dbusDepartNameIndex.values()];
      items.sort((a, b) => {
        const countA = countDepartEntries(a.routes);
        const countB = countDepartEntries(b.routes);
        if (countB !== countA) return countB - countA;
        return a.name.localeCompare(b.name, 'fr', { sensitivity: "base" });
      });

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "dbus-none";
        empty.textContent = t("none");
        $dbusDepartList.appendChild(empty);
        return;
      }

      items.forEach(rec => {
        const item = document.createElement("div");
        item.className = "dbus-item";

        const count = document.createElement("div");
        count.className = "dbus-stop-count";
        count.textContent = String(countDepartEntries(rec.routes));

        const titleEl = document.createElement("div");
        titleEl.className = "rname";
        titleEl.style.flex = "1 1 auto";
        titleEl.dataset.rawName = rec.name || "";
        titleEl.innerHTML = withRERIcon(translateStopName(rec.name));

        item.appendChild(count);
        item.appendChild(titleEl);

        item.addEventListener("click", () => {
          openDbusStopPanelForName(rec);
          if (rec.centerLatLng) centerWithPreview(rec.centerLatLng, { zoom: map.getZoom() });
          let bestGroupId = null;
          let bestCount = -1;
          rec.groupIds?.forEach(id => {
            const group = dbusDepartGroups.find(g => g.id === id);
            if (group && group.lineCount > bestCount) {
              bestCount = group.lineCount;
              bestGroupId = id;
            }
          });
          if (bestGroupId && dbusDepartMarkers.has(bestGroupId)) {
            setSelectedDepartMarker(dbusDepartMarkers.get(bestGroupId));
          }
        });

        $dbusDepartList.appendChild(item);
      });
    }

    function buildDbusDepartures() {
      dbusDepartGroups = [];
      dbusDepartMarkers = new Map();
      dbusDepartNameIndex = new Map();
      dbusDepartLayers.clearLayers();

      const entries = [];
      DBUS_LINES.forEach((line, lineIdx) => {
        const cat = getCategory(line);
        if (!showSchoolLines && cat === "Scolaire") return;
        if (!showFictiveLines && cat === "Autres") return;
        line.routes.forEach(route => {
          const firstStopId = route.stops[0]?.uid;
          if (typeof firstStopId === "undefined") return;
          const stop = DBUS_STOPS.get(firstStopId);
          if (!stop?.latlng) return;
          const pt = map.project(stop.latlng, maxNativeZoom);
          const { titleStart } = getRouteEndpoints(route);
          const rawStartName = titleStart || stop.name || "";
          const isProvisoireStart = hasProvisoire(stop.name) || hasProvisoire(titleStart);
          const cleanStartName = stripProvisoire(rawStartName);
          const startName = normalizeDepartName(isProvisoireStart ? `${cleanStartName} (Provisoire)` : cleanStartName);
          const entry = { line, lineIdx, route, stop, pt, startName };
          entries.push(entry);

          let nameRec = dbusDepartNameIndex.get(startName);
          if (!nameRec) {
            nameRec = { name: startName, routes: [], lineIds: new Set(), stopIds: new Set(), latlngs: [], groupIds: new Set() };
            dbusDepartNameIndex.set(startName, nameRec);
          }
          nameRec.routes.push(entry);
          nameRec.lineIds.add(line.uid);
          if (!nameRec.stopIds.has(stop.id)) {
            nameRec.stopIds.add(stop.id);
            if (stop.latlng) nameRec.latlngs.push(stop.latlng);
          }
        });
      });

      const groups = [];
      const distSq = DBUS_DEPART_MERGE_PX * DBUS_DEPART_MERGE_PX;

      entries.forEach(entry => {
        const { stop, pt } = entry;
        let target = null;
        for (const g of groups) {
          const dx = pt.x - g.centerPt.x;
          const dy = pt.y - g.centerPt.y;
          if ((dx * dx + dy * dy) <= distSq) { target = g; break; }
        }
        if (!target) {
          target = {
            id: groups.length + 1,
            centerPt: { x: pt.x, y: pt.y },
            stopIds: new Set(),
            stops: [],
            routes: [],
            lineIds: new Set(),
            nameMap: new Map()
          };
          groups.push(target);
        }
        target.routes.push(entry);
        target.lineIds.add(entry.line.uid);

        let nameRec = target.nameMap.get(entry.startName);
        if (!nameRec) {
          nameRec = { name: entry.startName, routes: [], lineIds: new Set(), stopIds: new Set() };
          target.nameMap.set(entry.startName, nameRec);
        }
        nameRec.routes.push(entry);
        nameRec.lineIds.add(entry.line.uid);
        nameRec.stopIds.add(stop.id);

        if (!target.stopIds.has(stop.id)) {
          target.stopIds.add(stop.id);
          target.stops.push(stop);
          const count = target.stops.length;
          target.centerPt.x = target.centerPt.x + (pt.x - target.centerPt.x) / count;
          target.centerPt.y = target.centerPt.y + (pt.y - target.centerPt.y) / count;
        }
      });

      groups.forEach(group => {
        const nameList = getDepartGroupNames(group);
        group.displayName = nameList.join(" / ");
        group.latlng = map.unproject(L.point(group.centerPt.x, group.centerPt.y), maxNativeZoom);
        group.lineCount = countDepartEntries(group.routes);
        group.nameMap.forEach((rec, nameKey) => {
          const nameRec = dbusDepartNameIndex.get(nameKey);
          if (nameRec) nameRec.groupIds.add(group.id);
        });
      });

      dbusDepartNameIndex.forEach(rec => {
        if (!rec.latlngs.length) return;
        let lat = 0, lng = 0;
        rec.latlngs.forEach(ll => { lat += ll.lat; lng += ll.lng; });
        rec.centerLatLng = L.latLng(lat / rec.latlngs.length, lng / rec.latlngs.length);
      });

      dbusDepartGroups = groups;

      groups.forEach(group => {
        const icon = L.divIcon({
          className: "dbus-depart-icon",
          html: `<div class="dbus-depart-dot">${group.lineCount}</div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        const marker = L.marker(group.latlng, { icon, riseOnHover: true });
        marker._departGroupId = group.id;
        marker._departHover = false;
        marker.on("click", () => {
          openDbusStopPanelForGroup(group);
          setSelectedDepartMarker(marker);
        });
        marker.on("mouseover", () => setDepartMarkerHover(marker, true));
        marker.on("mouseout", () => setDepartMarkerHover(marker, false));

        const tooltipHtml = escapeHTML(group.displayName);
        const tooltipOpts = { direction: "top", className: "dbus-depart-tooltip", offset: [0, -10] };
        marker.bindTooltip(tooltipHtml, tooltipOpts);

        dbusDepartMarkers.set(group.id, marker);
        dbusDepartLayers.addLayer(marker);
      });

      dbusDepartFilterKey = `${showSchoolLines}-${showFictiveLines}`;
      renderDbusDepartList();
    }

    function showDbusDepartures() {
      if (!DBUS_LINES.length || !DBUS_STOPS.size) return;
      if (!dbusDepartGroups.length || dbusDepartFilterKey !== `${showSchoolLines}-${showFictiveLines}`) buildDbusDepartures();
      if (!map.hasLayer(dbusDepartLayers)) dbusDepartLayers.addTo(map);
    }

    function hideDbusDepartures() {
      if (map.hasLayer(dbusDepartLayers)) map.removeLayer(dbusDepartLayers);
      clearDepartMarkerSelection();
    }

    async function initDbusUI(){
      try{
        await loadStops();
        await loadLines();
      }catch(err){
        console.error("DBus: chargement √©chou√©", err);
        return;
      }

      $dbusList.innerHTML = "";

      const URBAIN_CUSTOM_ORDER = ["24","63","109","112","114","121","124","221","303","351","reseau titus"]; 
      function normLineId(x){
        return String(x||"").trim().toLowerCase()
          .replace(/[√©√É¬®√™√É¬†√Ç¬´]/g,'e')
          .replace(/\.(png|jpg|jpeg|webp)$/,'');
      }

      function compareUrbainLines(a,b){
        const ai = URBAIN_CUSTOM_ORDER.indexOf(normLineId(a.number));
        const bi = URBAIN_CUSTOM_ORDER.indexOf(normLineId(b.number));
        if (ai !== -1 || bi !== -1) {
          return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
        }

        const aNum = isNumericOnly(a.number);
        const bNum = isNumericOnly(b.number);
        if (aNum && !bNum) return -1;
        if (!aNum && bNum) return 1;
        if (aNum && bNum) return (parseInt(a.number,10)||0) - (parseInt(b.number,10)||0);

        return String(a.number).localeCompare(String(b.number), 'fr', {numeric:true});
      }

      function buildLineBuckets(){
        const buckets = { "Urbain": [], "FlixBus": [], "Noctilien": [], "Autres": [], "Scolaire": [] };
        DBUS_LINES.forEach(line => {
          const cat = getCategory(line);
          if (!showSchoolLines && cat === "Scolaire") return;
          if (!showFictiveLines && cat === "Autres") return;
          buckets[cat].push(line);
        });

        if (buckets["Noctilien"] && buckets["Noctilien"].length) {
          buckets["Urbain"].push(...buckets["Noctilien"]);
          buckets["Noctilien"] = [];
        }

        buckets["Urbain"].sort(compareUrbainLines);
        buckets["Noctilien"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
        buckets["FlixBus"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
        buckets["Autres"].sort((a,b)=> String(a.number).localeCompare(String(b.number), 'fr', {numeric:true}));
        buckets["Scolaire"].sort((a, b) => {
          return String(a.number).localeCompare(String(b.number), 'fr', {numeric:true});
        });
        return buckets;
      }

      function buildRouteBuckets(){
        const buckets = { "Urbain": [], "FlixBus": [], "Noctilien": [], "Autres": [], "Scolaire": [] };
        DBUS_LINES.forEach(line => {
          const cat = getCategory(line);
          if (!showSchoolLines && cat === "Scolaire") return;
          if (!showFictiveLines && cat === "Autres") return;
          line.routes.forEach(route => buckets[cat].push({ line, route }));
        });
        if (buckets["Noctilien"] && buckets["Noctilien"].length) {
          buckets["Urbain"].push(...buckets["Noctilien"]);
          buckets["Noctilien"] = [];
        }
        Object.values(buckets).forEach(list => {
          list.sort((a, b) => {
            const diff = (b.route.totalMinutes || 0) - (a.route.totalMinutes || 0);
            if (diff) return diff;
            return String(a.route.name || "").localeCompare(String(b.route.name || ""), 'fr', {numeric:true, sensitivity:"base"});
          });
        });
        return buckets;
      }

      function renderSection(key, lines) {
        if (!lines.length) return;
        const title = dbusCategoryTitle(key);

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        let totalRoutes = 0;
        lines.forEach(line => {
          totalRoutes += (line.routes ? line.routes.length : 0);
        });

        const isOpenByDefault = (key === "Urbain" || key === "Noctilien");

        const head = document.createElement("div");
        head.className = "dbus-sechead";
        head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
        head.dataset.cat = key;
        head.dataset.count = String(totalRoutes);
        head.innerHTML = `
          <span>${title} (${totalRoutes})</span>
          <span class="chev" style="margin-left:auto">‚ñº</span>
        `;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = !isOpenByDefault; 
        sec.appendChild(body);

        head.addEventListener("click", () => {
          const expanded = head.getAttribute("aria-expanded") === "true";
          head.setAttribute("aria-expanded", expanded ? "false" : "true");
          body.hidden = expanded;
          if (expanded) {
            clearDbusSelection(body);
            return;
          }
        });

        const showSchoolLogo = key === "Scolaire";
        if (key === "Scolaire") {
          const allRoutes = [];
          lines.forEach(line => {
            line.routes.forEach(route => allRoutes.push({ line, route }));
          });

          allRoutes.sort((a, b) => {
            const depA = String(a.route.name).split(">")[0].trim();
            const depB = String(b.route.name).split(">")[0].trim();
            return depA.localeCompare(depB, 'fr', { numeric: true, sensitivity: "base" });
          });

          allRoutes.forEach(({ line, route }) => renderLineItem(line, route, body, { showLogo: showSchoolLogo }));
        } else {
          lines.forEach(line => {
            line.routes.forEach(route => renderLineItem(line, route, body, { showLogo: showSchoolLogo }));
          });
        }
      }

      function renderSectionGrid(key, lines) {
        if (!lines.length) return;
        const title = dbusCategoryTitle(key);

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        let totalRoutes = 0;
        lines.forEach(line => { totalRoutes += (line.routes ? line.routes.length : 0); });

        const isOpenByDefault = (key === "Urbain" || key === "Noctilien");

        const head = document.createElement("div");
        head.className = "dbus-sechead";
        head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
        head.dataset.cat = key;
        head.dataset.count = String(totalRoutes);
        head.innerHTML = `<span>${title} (${totalRoutes})</span><span class=\"chev\" style=\"margin-left:auto\">‚ñº</span>`;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = !isOpenByDefault; 
        sec.appendChild(body);

        function clearLocal(){
          selectedLineUid = null;
          routesHost.innerHTML = "";
          routesHost.style.margin = "8px 6px 0";
          body.querySelectorAll('.dbus-logo').forEach(el=>{
            el.style.outline='none';
            el.classList.remove('dim','sel');
            el.style.removeProperty('--selColor');
          });
          try { currentSelectedKey = ""; } catch {}
          try { if (typeof hideAllRoutes === 'function') hideAllRoutes(); } catch {}
          try { if (typeof hideLinePreview === 'function') hideLinePreview(); } catch {}
        }

        head.addEventListener("click", () => {
          const expanded = head.getAttribute("aria-expanded") === "true";
          head.setAttribute("aria-expanded", expanded ? "false" : "true");
          body.hidden = expanded;
          if (expanded) {
            clearLocal();
            if (window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section === key) {
              window.__DBUS_GRID_OPEN = null;
            }
          }
        });

        const grid = document.createElement("div");
        grid.className = "dbus-grid";
        body.appendChild(grid);

        const routesHost = document.createElement("div");
        routesHost.className = "routes-host";
        routesHost.style.margin = "8px 6px 0";

        let selectedLineUid = null;

        function selectionColorForLine(line) {
          const rawNum = String(line.number || "").trim();
          if (isTitusLine(line)) return "#ffffff";
          if (/^N\d+$/i.test(rawNum)) return noctilienStripeColor(rawNum);
          return null;
        }

        function createLogoForLine(line) {
          const raw = String(line.number || "").trim();
          const norm = raw.toLowerCase().replace('√©','e');
          const isTitus = /reseau\s*titus/.test(norm);

          const wrap = document.createElement('div');
          wrap.className = 'dbus-logo';

          if (isTitusLine(line)) {
           
            wrap.classList.add('dbus-logo--titus');
            wrap.style.background = 'transparent';
            const img = document.createElement('img');
            img.alt = 'R√©seau Titus';
            img.src = overlayPath("reseau_titus.png");
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            img.onerror = () => {
              wrap.textContent = 'R√©seau Titus';
              wrap.style.color = '#522a8a';
              wrap.style.background = 'transparent';
            };
            wrap.appendChild(img);
            return wrap;
          }

          const num = raw;
          const badge = makeLineBadge(num, "#444", "#fff", "88x36");
          badge.classList.add("dbus-logo");
          getLineColors(num).then(([bg,text])=>{
            badge.style.background = bg; badge.style.color = text;
            if (isNoctilien2(num)) { ensureStripe(badge, noctilienStripeColor(num)); }
            if (getCategory(line) === "Autres") { ensureFictiveStripe(badge); }
          });
          return badge;
        }

        function renderRoutesForLine(line, container){
          container.innerHTML = "";
          line.routes.forEach(route => renderLineItem(line, route, container));
        }

        if (title === "IDFM") {
          const normals = lines.filter(l => isNumericOnly(l.number));
          normals.sort(compareUrbainLines);
          const nocti = lines.filter(l => isNoctilien(l));
          const autresReseaux = lines.filter(l => !isNumericOnly(l.number) && !isNoctilien(l));

          function renderSub(key, items){
            if (!items.length) return;
            const map = {
              urban: "dbus_sub_urban",
              noctilien: "dbus_sub_noctilien",
              other_networks: "dbus_sub_other_networks"
            };
            const labelKey = map[key] || key;
            const h = document.createElement('h4');
            h.textContent = t(labelKey);
            h.dataset.subKey = labelKey;
            body.appendChild(h);
            const subGrid = document.createElement('div'); subGrid.className = 'dbus-grid'; body.appendChild(subGrid);

            items.sort((a, b) => {
                const an = parseInt(a.number.replace(/\D/g,'')) || 0;
                const bn = parseInt(b.number.replace(/\D/g,'')) || 0;
                return an - bn;
            });

            items.forEach(line => {
              const block = document.createElement('div'); block.className = 'line-block';
              const logo = createLogoForLine(line); block.appendChild(logo);

              function closeNonGridSections() {
                try {
                  const heads = $dbusList.querySelectorAll('.dbus-sechead');
                  heads.forEach(h => {
                    const txt = (h.textContent || '').trim().toLowerCase();
                if (!/^idfm\b/.test(txt) && !/^noctiliens\b/.test(txt)) {
                      h.setAttribute('aria-expanded','false');
                      const b = h.nextElementSibling;
                      if (b && b.classList.contains('dbus-secbody')) b.hidden = true;
                    }
                  });
                } catch {}
              }

              logo.addEventListener('click', () => {
                const isSame = (selectedLineUid === line.uid);
                if (!isSame && window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section !== key) {
                  try { window.__DBUS_GRID_OPEN.clear && window.__DBUS_GRID_OPEN.clear(); } catch {}
                  window.__DBUS_GRID_OPEN = null;
                }
                if (isSame) { clearLocal(); if (window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section === key) { window.__DBUS_GRID_OPEN = null; } return; }
                clearLocal(); selectedLineUid = line.uid;
                const raw = String(line.number||''); const norm = raw.toLowerCase().replace('√©','e');
                const selColor = selectionColorForLine(line);
                if (selColor) { logo.style.setProperty('--selColor', selColor); }
                else { getLineColors(raw).then(([bg])=>{ logo.style.setProperty('--selColor', bg); }); }
                routesHost.style.margin = '8px 6px 25px';
                renderRoutesForLine(line, routesHost);
                body.querySelectorAll('.dbus-logo').forEach(el=>{ if (el!==logo) el.classList.add('dim'); else el.classList.remove('dim'); });
                body.querySelectorAll('.dbus-logo.sel').forEach(el=> el.classList.remove('sel'));
                logo.classList.add('sel');
                closeNonGridSections();
                window.__DBUS_GRID_OPEN = { section: key, clear: clearLocal };
              });

              subGrid.appendChild(block);
            });
          }

          renderSub('urban', normals);
          renderSub('noctilien', nocti);
          renderSub('other_networks', autresReseaux);
          body.appendChild(routesHost);
        } else {
          lines.forEach(line => {
            const block = document.createElement('div');
            block.className = 'line-block';
            const logo = createLogoForLine(line);
            block.appendChild(logo);

            function closeNonGridSections() {
              try {
                const heads = $dbusList.querySelectorAll('.dbus-sechead');
                heads.forEach(h => {
                  const txt = (h.textContent || '').trim().toLowerCase();
              if (!/^idfm\b/.test(txt) && !/^noctiliens\b/.test(txt)) {
                    h.setAttribute('aria-expanded','false');
                    const b = h.nextElementSibling;
                    if (b && b.classList.contains('dbus-secbody')) b.hidden = true;
                  }
                });
              } catch {}
            }

            logo.addEventListener('click', () => {
              const isSame = (selectedLineUid === line.uid);
              if (!isSame && window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section !== key) {
                try { window.__DBUS_GRID_OPEN.clear && window.__DBUS_GRID_OPEN.clear(); } catch {}
                window.__DBUS_GRID_OPEN = null;
              }
              if (isSame) { clearLocal(); if (window.__DBUS_GRID_OPEN && window.__DBUS_GRID_OPEN.section === key) { window.__DBUS_GRID_OPEN = null; } return; }
              clearLocal(); selectedLineUid = line.uid;
              const raw = String(line.number||''); const norm = raw.toLowerCase().replace('√©','e');
              const selColor = selectionColorForLine(line);
              if (selColor) { logo.style.setProperty('--selColor', selColor); }
              else { getLineColors(raw).then(([bg])=>{ logo.style.setProperty('--selColor', bg); }); }
              routesHost.style.margin = '8px 6px 25px';
              renderRoutesForLine(line, routesHost);
              grid.querySelectorAll('.dbus-logo').forEach(el=>{ if (el!==logo) el.classList.add('dim'); else el.classList.remove('dim'); });
              body.querySelectorAll('.dbus-logo.sel').forEach(el=> el.classList.remove('sel'));
              logo.classList.add('sel');
              closeNonGridSections();
              window.__DBUS_GRID_OPEN = { section: key, clear: clearLocal };
            });

            grid.appendChild(block);
          });
          body.appendChild(routesHost);
        }
      }

      function getLineId(line, route) {
        if (line.number && line.number !== "?") {
          return line.number;
        }
        const { lineNumber } = parseRouteName(route.name || "");
        return lineNumber || "?";
      }

      function renderLineItem(line, route, container, { showLogo = false } = {}) {
        const item = document.createElement("div");
        item.className = "dbus-item";

      const { lineNumber, routeTitle, flag } = parseRouteName(route.name || "");
      const mTitus = /^titus\s*(\d+)/i.exec(String(lineNumber||""));
      const displayNumber = mTitus ? mTitus[1] : lineNumber;
      const isScolaire = getCategory(line) === "Scolaire";
      const badge = isScolaire ? null : makeLineBadge(displayNumber, "#444", "#fff", "72x32");
      appendRouteLogo(item, line, lineNumber, showLogo);
        
        const titleEl = document.createElement("div");
        titleEl.className = "rname";
        titleEl.style.flex = "1 1 auto";
        const displayTitle = translateRouteTitle(routeTitle);
        titleEl.dataset.routeKind = "line";
        titleEl.dataset.routeTitle = routeTitle || "";
        if (flag) titleEl.dataset.routeFlag = flag;
        let titleHtml = withRERIcon(displayTitle || routeTitle);
        if (flag) {
          titleHtml = titleHtml + ` <span class="route-flag">${flag}</span>`;
        }
        titleEl.innerHTML = titleHtml;

        const duration = document.createElement("div");
        duration.className = "dbus-duration";

        const stopCount = route.stops.length;

        let durationText;
        if (route.totalMinutes >= 60) {
          const h = Math.floor(route.totalMinutes / 60);
          const m = route.totalMinutes % 60;
          if (m > 0) {
            durationText = `${h} h ${m} min`;
          } else {
            durationText = `${h} h`;
          }
        } else {
          durationText = `${route.totalMinutes} min`;
        }

        setStopDurationText(duration, stopCount, durationText, "paren");

      if (badge) item.appendChild(badge);
      item.appendChild(titleEl);
      item.appendChild(duration);

        function effectiveLineNumber(line, route) {
          if (line.number && line.number !== "?") return line.number;
          const { lineNumber } = parseRouteName(route.name || "");
          return lineNumber || "?";
        }

        const effNum = effectiveLineNumber(line, route);

        const colorKey = mTitus ? lineNumber : getLineNumber(line, route);
      if (badge) {
        getLineColors(colorKey).then(([bg,text])=>{
          badge.style.background = bg;
          badge.style.color = text;
          if (isNoctilien2(getLineNumber(line, route))) {
            ensureStripe(badge, noctilienStripeColor(getLineNumber(line, route)));
          }
          if (getCategory(line) === "Autres") {
            ensureFictiveStripe(badge);
          }
        });
      }


        item.addEventListener("click", ()=> {
          $dbusList.querySelectorAll(".dbus-item").forEach(it=>{
            it.classList.remove("active");
            it.style.outline = "none";
          });
          item.classList.add("active");
          getLineColors(lineNumber).then(([bg])=>{
            item.style.outline = `2px solid ${bg}`;
          });

          currentSelectedKey = `${line.uid}:${route.uid}`;
          showOnlyRoute(0, line, route);
          renderSelectedChip();
          closeDbusPanel();
        });

        container.appendChild(item);
      }

      function renderSectionByDuration(title, entries) {
        if (!entries.length) return;

        const sec = document.createElement("div");
        sec.className = "dbus-sec";
        $dbusList.appendChild(sec);

        const isOpenByDefault = (title === "IDFM" || title === "Noctiliens");

        const head = document.createElement("div");
        head.className = "dbus-sechead";
        head.setAttribute("aria-expanded", isOpenByDefault ? "true" : "false");
        head.innerHTML = `
          <span>${title} (${entries.length})</span>
          <span class="chev" style="margin-left:auto">‚ñº</span>
        `;
        sec.appendChild(head);

        const body = document.createElement("div");
        body.className = "dbus-secbody";
        body.hidden = !isOpenByDefault;
        sec.appendChild(body);

        head.addEventListener("click", () => {
          const expanded = head.getAttribute("aria-expanded") === "true";
          const willOpen = !expanded;
          head.setAttribute("aria-expanded", expanded ? "false" : "true");
          body.hidden = expanded;
          if (expanded) {
            clearDbusSelection(body);
            return;
          }
          if (willOpen) {
            try {
              $dbusList.querySelectorAll('.dbus-sechead').forEach(h => {
                if (h !== head) {
                  h.setAttribute('aria-expanded','false');
                  const b = h.nextElementSibling;
                  if (b && b.classList.contains('dbus-secbody')) {
                    b.hidden = true;
                    clearDbusSelection(b);
                  }
                }
              });
              if (window.__DBUS_GRID_OPEN && typeof window.__DBUS_GRID_OPEN.clear === 'function') {
                window.__DBUS_GRID_OPEN.clear();
                window.__DBUS_GRID_OPEN = null;
              }
            } catch {}
          }
        });

        entries.forEach(({ line, route }) => renderLineItem(line, route, body, { showLogo: true }));
      }

      function renderDbusLinesListInner(mode) {
        if (!$dbusList) return;
        $dbusList.innerHTML = "";
        if (mode === DBUS_MODES.LENGTH) {
          const routeBuckets = buildRouteBuckets();
          const entries = [];
          Object.values(routeBuckets).forEach(list => entries.push(...list));
          entries.sort((a, b) => {
            const diff = (b.route.totalMinutes || 0) - (a.route.totalMinutes || 0);
            if (diff) return diff;
            return String(a.route.name || "").localeCompare(
              String(b.route.name || ""),
              "fr",
              { numeric: true, sensitivity: "base" }
            );
          });
          if (!entries.length) {
            const empty = document.createElement("div");
            empty.className = "dbus-none";
            empty.textContent = t("none");
            $dbusList.appendChild(empty);
            return;
          }
          entries.forEach(({ line, route }) => renderLineItem(line, route, $dbusList, { showLogo: true }));
          return;
        }
        const lineBuckets = buildLineBuckets();
        renderSectionGrid("Urbain",  lineBuckets["Urbain"]);
        renderSectionGrid("Noctilien",  lineBuckets["Noctilien"]);
        renderSection("FlixBus", lineBuckets["FlixBus"]);
        renderSection("Scolaire",  lineBuckets["Scolaire"]);
        renderSection("Autres",  lineBuckets["Autres"]);
      }

      renderDbusLinesList = renderDbusLinesListInner;
      renderDbusLinesList(currentDbusMode);
      applyI18N();
      buildDbusDepartures();
      if (currentDbusMode === DBUS_MODES.DEPARTS && dbusDepartPreviewActive) showDbusDepartures();

    }
    initDbusUI().then(()=>renderSelectedChip()).catch(()=>{});

    let currentActiveStopId = null;
    function clearActiveStop(){
      PREVIEW_STOP_ELEMS.forEach(({el}) => el.classList.remove('active'));
      currentActiveStopId = null;
    }

    function norm(s){
      return String(s||"")
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ')
        .trim();
    }
    function includesNorm(hay, needle){ return norm(hay).includes(norm(needle)); }

    function detectTypeFilter(q){
      const n = norm(q);

      const MAP = [
        {types:["Atelier"],      keys:["atelier","atelier de reparation","reparation","atelier reparation"]},
        {types:["Agence"],       keys:["agence","agence de recrutement","recrutement"]},
        {types:["Garage"],       keys:["garage"]},
        {types:["Concessionnaire"], keys:["concessionnaire","dealer","concess"]},
        {types:["Entreprise"],   keys:["entreprise","societe","company"]},
        {types:["Ville"],        keys:["ville","commune","city"]},
        {types:["Monument"],     keys:["monument","monuments","monu","lieu","lieu embl√©matique","lieux embl√©matiques","lieux","embl√©matique","embl√©matiques"]},
      ];

      for(const row of MAP){
        for(const k of row.keys){
          if(n === k || n.startsWith(k+" ") || n.endsWith(" "+k) || n.includes(" "+k+" ")){
            return { types: row.types, hit: k };
          }
        }
      }
      return null;
    }
      
    let sectionState = {};
    function getExpanded(key){ return sectionState[key] !== false; }
    function setExpanded(key, val){ sectionState[key] = !!val; }
    
    const ORDER = [
      ["Ville","Villes"],
      ["Monument","Lieux Embl√©matiques"],
      ["Atelier","Ateliers de r√©paration"],
      ["Agence","Agences de recrutement"],
      ["Concessionnaire","Concessionnaires"],
      ["Entreprise","Entreprises"]
    ];
    const PLURIEL = Object.fromEntries(ORDER);

    const SEARCH_CATEGORIES = [SEARCH_CATEGORY_ALL, ...ALL_TYPES];
    function setActiveSearchCategory(next){
      if (!next || ACTIVE_SEARCH_CATEGORY === next) return;
      ACTIVE_SEARCH_CATEGORY = next;
    }
    function filterSearchList(list, raw, allowTypeFilter){
      const nQ = norm(raw);
      if (nQ === "") return list.slice();
      let filtered = list.slice();
      const typeInfo = allowTypeFilter ? detectTypeFilter(nQ) : null;

      if (typeInfo){
        filtered = filtered.filter(it => typeInfo.types.includes(it.type));
        let rest = norm(raw.replace(new RegExp(typeInfo.hit,'i'), '').trim())
                    .replace(/^[\s,;:>-]+|[\s,;:>-]+$/g,'');
        if (rest){
          filtered = filtered.filter(it => {
            const hay = [it.name, it.city, it.brand].filter(Boolean).join(" ");
            return includesNorm(hay, rest);
          });
        }
      } else {
        const words = norm(raw).split(/\s+/).filter(Boolean);
        filtered = filtered.filter(it => {
          const hay = [it.type, it.name, it.city, it.brand].filter(Boolean).join(" ");
          const normHay = norm(hay);
          return words.every(w => normHay.includes(w));
        });
      }
      return filtered;
    }
    function updateSearchCategoryCounts(list){
      const counts = Object.fromEntries(ALL_TYPES.map(t => [t, 0]));
      for (const it of list){
        if (counts[it.type] !== undefined) counts[it.type] += 1;
      }
      SEARCH_CATEGORY_COUNTS = counts;
      SEARCH_CATEGORY_TOTAL = Object.values(counts).reduce((sum, n) => sum + n, 0);
    }

    function buildResultsFilterBar(host = ($searchFilters || $results)){
      if (!host) return;
      host.querySelector(".results-filters")?.remove();

      const bar = document.createElement("div");
      bar.className = "search-categories results-filters";

      SEARCH_CATEGORIES.forEach(typeKey=>{
        const labelText = searchCategoryButtonLabel(typeKey);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "dbus-mode-btn";
        btn.dataset.category = typeKey;
        const active = typeKey === ACTIVE_SEARCH_CATEGORY;
        btn.classList.toggle("active", active);
        btn.setAttribute("aria-pressed", active ? "true" : "false");
        btn.textContent = labelText;
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (ACTIVE_SEARCH_CATEGORY === typeKey) return;
          setActiveSearchCategory(typeKey);
          doSearch($search.value);
        });
        bar.appendChild(btn);
      });

      host.prepend(bar);
    }

    function renderResults(list){
      $results.innerHTML = "";
      buildResultsFilterBar();
      if (!list.length){
        const empty = document.createElement("div");
        empty.className = "result-empty";
        empty.textContent = resultsEmptyText();
        $results.appendChild(empty);
        $results.hidden = false;
        return;
      }

      const buckets = {
        "Ville": [],
        "Atelier": [],
        "Agence": [],
        "Garage": [],
        "Concessionnaire": [],
        "Entreprise": [],
        "Monument": []
      };
      for (const it of list){ if (buckets[it.type]) buckets[it.type].push(it); }

      function addSectionBlockLocal(typeKey, label, count){
        const head = document.createElement("div");
        head.className = "result-sechead";
        const mapLbl = {
          "Ville": t("villes"),
          "Monument": t("emblematic"),
          "Atelier": t("repair_shops"),
          "Agence": t("agencies"),
          "Concessionnaire": t("dealers"),
          "Entreprise": t("companies")
        };
        const base = mapLbl[typeKey] || label;
        head.dataset.type = typeKey;
        head.dataset.count = String(count);
        head.textContent = `${base} (${count})`;
        $results.appendChild(head);

        const body = document.createElement("div");
        body.className = "result-secbody";
        $results.appendChild(body);

        return body;
      }

      function addItem(container, item){
        const div = document.createElement("div");
        div.className = "result-item";

          if (item.type === "Lignes DBus") {
          const img = document.createElement("img");
          img.className = "ico ico-service";
          img.src = overlayPath("bus_ico.png");
          img.alt = "Bus";
          div.appendChild(img);

          let lineNumber = "";
          let routeName  = "";
          if (item.name.includes(":")) {
            const [left, right] = item.name.split(":");
            lineNumber = left.replace("Ligne","").trim();
            routeName  = right.trim();
          } else {
            lineNumber = item.name.trim();
            routeName  = "";
          }

          const category = getCategory({ number: lineNumber });

          if (category !== "Autres") {
            const tnum = item.titusNum || (/^titus\s*(\d+)/i.exec(String(lineNumber||""))?.[1] ?? null);
            if (tnum) {
              const wrap = document.createElement('div');
              wrap.style.display = 'inline-flex';
              wrap.style.alignItems = 'center';
              wrap.style.gap = '6px';
              const img = document.createElement('img');
              img.src = overlayPath("reseau_titus.png");
              img.alt = 'R√©seau Titus';
              img.style.height = '22px';
              img.style.width = 'auto';
              const [bg, text] = getLineColorsSync('Titus ' + tnum);
              const chip = makeLineBadge(tnum, bg, text, '48x24');
              wrap.appendChild(img);
              wrap.appendChild(chip);
              div.appendChild(wrap);
            } else {
              const [bg, text] = getLineColorsSync(lineNumber);
              const badge = makeLineBadge(
                lineNumber,
                bg,
                text,
                "72x32",
                isNoctilien2(lineNumber) ? noctilienStripeColor(lineNumber) : null,
                false
              );
              div.appendChild(badge);
            }
          }

          const span = document.createElement("div");
          span.className = "result-text";
          const cleanTitle = routeName.replace(/^\s*Titus\s*\d+\s*[:-]?\s*/i, '');
          span.dataset.routeTitle = cleanTitle;
          span.textContent = translateRouteTitle(cleanTitle);
          div.appendChild(span);
        } else {
          if (item.logo) {
            const img = document.createElement("img");
            img.className = "ico";
            if (["Atelier","Agence","Garage","Ville","Monument","Centre commercial"].includes(item.type)) {
              img.classList.add("ico-service");
            }
            img.src = item.logo;
            img.alt = "";
            img.onerror = () => {
              if (item.fallbackLogo && img.src !== item.fallbackLogo) img.src = item.fallbackLogo;
            };
            div.appendChild(img);
          }

          let label;
          if (item.type === "Concessionnaire"){
            const brand = (item.brand || String(item.name||"").replace(/^Concessionnaire\s+/i,"")).trim();
            label = item.city ? `${brand} - ${item.city}` : brand;
          } else if (["Atelier","Agence","Garage"].includes(item.type)){
            label = item.city || typeFallbackLabel(item.type);
          } else if (item.type === "Monument"){
            label = item.city ? `${item.name} - ${item.city}` : item.name; 
          } else {
            label = item.city ? `${item.name} - ${item.city}` : item.name;
          }

          const span = document.createElement("div");
          span.className = "result-text";
          span.textContent = label;
          div.appendChild(span);
        }

        div.addEventListener("click", () => {
          closeSearchUI({ reset: true });
          map.setView(item.center, Math.max(map.getZoom(), minNativeZoom + 4));
          if (item.open) setTimeout(()=> item.open(), 150);
        });

        container.appendChild(div);
      }



      let shown = 0;
      for (const [typeKey,label] of ORDER){
        const arr = buckets[typeKey];
        if (!arr.length) continue;
        const body = addSectionBlockLocal(typeKey,label, arr.length);
        for (const it of arr){
          if (shown >= 250) break;
          addItem(body,it);
          shown++;
        }
        if (shown >= 250) break;
      }

      $results.hidden = false;
      applyI18N();
    }

    function doSearch(q){
      const raw = String(q||"");
      const allowTypeFilter = ACTIVE_SEARCH_CATEGORY === SEARCH_CATEGORY_ALL;
      const baseFiltered = filterSearchList(searchIndex, raw, allowTypeFilter);
      updateSearchCategoryCounts(baseFiltered);

      const activeTypes = (ACTIVE_SEARCH_CATEGORY === SEARCH_CATEGORY_ALL)
        ? ALL_TYPES
        : [ACTIVE_SEARCH_CATEGORY];
      const ALLOWED = new Set(activeTypes);
      let filtered = baseFiltered.filter(it => ALLOWED.has(it.type));

      if (!raw.trim()){
        renderResults(filtered);
        $results.hidden = false;
        return;
      }

      filtered.sort((a,b)=>{
        const pa = (a.type==="Ville")?0:1, pb=(b.type==="Ville")?0:1;
        if(pa!==pb) return pa-pb;
        return String(a.name).localeCompare(String(b.name), LANG==='en'?'en':'fr', {numeric:true});
      });

      filtered.sort((a,b)=>{
        if (a.type === "Lignes DBus" && b.type === "Lignes DBus") {
          return (a.num ?? Infinity) - (b.num ?? Infinity);
        }
        return 0;
      });



      renderResults(filtered);
      $results.hidden = false;
    }

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }
    const doSearchDebounced = debounce(q => {
      doSearch(String(q||''));
      openSearchUI();
      _resIdx = -1;
    }, 120);

    $search.addEventListener('focus', () => { closeDbusPanel(); doSearch($search.value); });
    $search.addEventListener('input', e => doSearchDebounced(e.target.value));
    $search.addEventListener('keydown', e => { if (e.key === 'Enter') { const first = $results.querySelector('.result-item'); if (first) first.click(); } });

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof Element)) return;
      const path = (typeof e.composedPath === "function") ? e.composedPath() : [];
      const clickInSearch = path.includes($searchPanel)
        || path.includes($btnSearch)
        || ((!!$searchPanel && $searchPanel.contains(target)) || target === $btnSearch);
      const clickInDbus   = (!!$panelDbus && $panelDbus.contains(target))
        || (!!$dbusStopPanel && $dbusStopPanel.contains(target))
        || target === $btnDbus;
      const clickOnMarker = !!target.closest(".leaflet-marker-icon")
        || !!target.closest(".dbus-depart-icon")
        || !!target.closest(".dbus-depart-dot")
        || !!target.closest(".leaflet-popup")
        || !!target.closest(".leaflet-tooltip");

      if (!clickInSearch) closeSearchUI({ reset: true });
      if (!clickInDbus && !clickOnMarker) closeDbusPanel();
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('lpClose')?.click();
        closeSearchUI({ reset: true });
        closeDbusPanel();
        try { map.closePopup(); } catch {}
        updateUiOverlays();
      }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        openSearchUI({ focus: true, refresh: true });
      }
    });
  </script>

  <script>
    const CLOSED = false 
      || (new URLSearchParams(location.search).get('closed') === '1');

    if (CLOSED) {
      const html = `
        <div style="
          position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
          background:#0b1118;color:#e8eefb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
          text-align:center;padding:24px
        ">
          <div>
            <div style="font-size:28px;font-weight:800;margin-bottom:10px">${t("maintenance_title")}</div>
          </div>
        </div>
      `;
      document.body.innerHTML = html;
      throw new Error('Maintenance');
    }
  </script>

</body>
</html>























